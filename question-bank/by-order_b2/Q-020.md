# Question 20

## Question
A data engineer is using a foreachBatch logic to upsert data in a target Delta table.




The function to be called at each new microbatch processing is displayed below with a blank:



```

- def upsert_data(microBatchDF, batch_id):
-     microBatchDF.createOrReplaceTempView("sales_microbatch")
-     
-     sql_query = """
-       MERGE INTO sales_silver a
-       USING sales_microbatch b
-       ON a.item_id=b.item_id AND a.item_timestamp=b.item_timestamp
-       WHEN NOT MATCHED THEN INSERT *
-     """    
-    
-     ________________
```





Which option correctly fills in the blank to execute the sql query in the function on a cluster with recent Databricks Runtime above 10.5 ?

## Options
- A. microBatchDF._jdf.sparkSession().sql(sql_query) 
- B. microBatchDF.sparkSession.sql(sql_query) (Correct)
- C. microBatchDF.sql(sql_query) 
- D. spark.sql(sql_query) 

## Explanation
Usually, we use spark.sq() function to run SQL queries. However, in this particular case, the spark session can not be accessed from within the microbatch process. Instead, we can access the local spark session from the microbatch dataframe.




For clusters with recent Databricks Runtime version above 10.5, the syntax to access the local spark session is:

microBatchDF.sparkSession.sql(sql_query)







Reference: https://docs.gcp.databricks.com/structured-streaming/delta-lake.html#language-python




Study materials from our exam preparation course on Udemy:

Hands-on
