# Question #110

---

## é¡Œç›®è³‡è¨Š

### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-110`

### ä¾†æº
**ä¾†æº:** Mock Exam / Community Contributed

### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L2-Intermediate`

---

## é¡Œç›®å…§å®¹

### é¡Œå¹¹

A large company seeks to implement a **near real-time solution** involving **hundreds of pipelines** with **parallel updates** of many tables with **extremely high volume and high velocity** data.

Which of the following solutions would you implement to achieve this requirement?

### é¸é …

- **A.** Use Databricks High Concurrency clusters, which leverage optimized cloud storage connections to maximize data throughput.
- **B.** Partition ingestion tables by a small time duration to allow for many data files to be written in parallel.
- **C.** Configure Databricks to save all data to attached SSD volumes instead of object storage, increasing file I/O significantly.
- **D.** Isolate Delta Lake tables in their own storage containers to avoid API limits imposed by cloud vendors.
- **E.** Store all tables in a single database to ensure that the Databricks Catalyst Metastore can load balance overall throughput.

---

## æ¨™ç±¤ç³»çµ±

### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `Performance-Optimization`, `Parallel-Processing`, `Partitioning`, `High-Throughput`

### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** `Cluster-Type-Confusion`, `Architecture-Misconception`

### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** Data Engineering / Performance & Cost Optimization

---

## ç­”æ¡ˆèˆ‡ä¾†æº

### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `B`

### ç­”æ¡ˆä¾†æº
- **ä¾†æºæ¨™è¨»ç­”æ¡ˆ:** B
- **ç¤¾ç¾¤å…±è­˜:** B

---

# é¡Œç›®è§£æ

---

## ğŸ“ è€ƒé»è­˜åˆ¥

**æ ¸å¿ƒæŠ€è¡“:** High-Throughput Parallel Writes  
**é—œéµæ¦‚å¿µ:** Partitioning Strategyã€Write Parallelismã€Concurrency Control

**é¡Œç›®é—œéµå­—ï¼š**
- Near real-timeï¼ˆæº–å³æ™‚ï¼‰
- Hundreds of pipelinesï¼ˆæ•¸ç™¾æ¢ç®¡é“ï¼‰
- Parallel updatesï¼ˆä¸¦è¡Œæ›´æ–°ï¼‰
- High volume & velocityï¼ˆé«˜é‡é«˜é€Ÿï¼‰

---

## âœ… æ­£è§£èªªæ˜

### ç‚ºä»€éº¼ B æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Ÿ

**æŠ€è¡“åŸç†ï¼š**

```sql
-- âœ… ä½¿ç”¨å°æ™‚é–“ç²’åº¦åˆ†å€ï¼ˆä¾‹å¦‚ï¼šæŒ‰å°æ™‚æˆ–åˆ†é˜ï¼‰
CREATE TABLE ingestion_events (
    event_id STRING,
    user_id STRING,
    event_time TIMESTAMP,
    data STRING
) USING DELTA
PARTITIONED BY (date DATE, hour INT);  -- ç´°ç²’åº¦æ™‚é–“åˆ†å€

-- æˆ–æ›´ç´°ç²’åº¦ï¼ˆæŒ‰åˆ†é˜ï¼‰
PARTITIONED BY (date DATE, hour INT, minute INT);
```

**ç‚ºä»€éº¼æœ‰æ•ˆï¼Ÿ**

| å„ªå‹¢ | èªªæ˜ |
|------|------|
| **ä¸¦è¡Œå¯«å…¥** | ä¸åŒç®¡é“å¯«å…¥ä¸åŒåˆ†å€ï¼Œç„¡è¡çª |
| **é¿å…é–ç«¶çˆ­** | æ¯å€‹åˆ†å€ç¨ç«‹ï¼Œæ¸›å°‘ write contention |
| **é«˜ååé‡** | æ•¸ç™¾å€‹åˆ†å€å¯åŒæ™‚ä¸¦è¡Œå¯«å…¥ |
| **ç¬¦åˆå ´æ™¯** | æ™‚é–“åºåˆ—è³‡æ–™çš„è‡ªç„¶åˆ†å€æ–¹å¼ |

**ä¸¦è¡Œå¯«å…¥ç¤ºæ„ï¼š**

```
æ™‚é–“è»¸ï¼ˆæŒ‰å°æ™‚åˆ†å€ï¼‰ï¼š

Pipeline 1 â†’ å¯«å…¥ date=2026-01-19/hour=10/ âœ…
Pipeline 2 â†’ å¯«å…¥ date=2026-01-19/hour=11/ âœ…
Pipeline 3 â†’ å¯«å…¥ date=2026-01-19/hour=12/ âœ…
Pipeline 4 â†’ å¯«å…¥ date=2026-01-19/hour=13/ âœ…
...
Pipeline 100 â†’ å¯«å…¥ date=2026-01-19/hour=09/ âœ…

æ‰€æœ‰å¯«å…¥ä¸¦è¡ŒåŸ·è¡Œï¼Œç„¡é–ç«¶çˆ­ï¼
```

**å¯¦ä½œç¯„ä¾‹ï¼š**

```python
# ä½¿ç”¨å°æ™‚é–“ç²’åº¦åˆ†å€æå‡ä¸¦è¡Œå¯«å…¥
from pyspark.sql.functions import *

# è®€å–ä¸²æµè³‡æ–™
stream_df = (spark.readStream
    .format("kafka")
    .option("subscribe", "events")
    .load()
)

# æ–°å¢åˆ†å€æ¬„ä½ï¼ˆæŒ‰å°æ™‚ï¼‰
partitioned_df = stream_df.withColumn(
    "date", to_date(col("timestamp"))
).withColumn(
    "hour", hour(col("timestamp"))
)

# å¯«å…¥ Delta Lakeï¼ˆæŒ‰ date + hour åˆ†å€ï¼‰
(partitioned_df.writeStream
    .format("delta")
    .partitionBy("date", "hour")  # â† é—œéµï¼šç´°ç²’åº¦æ™‚é–“åˆ†å€
    .option("checkpointLocation", "/checkpoints/events")
    .trigger(processingTime="1 minute")
    .table("ingestion.events")
)

# çµæœï¼šæ•¸ç™¾æ¢ç®¡é“å¯ä¸¦è¡Œå¯«å…¥ä¸åŒçš„å°æ™‚åˆ†å€
```

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### A - High Concurrency Clusters

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

```python
# High Concurrency Cluster çš„ç”¨é€”
```

**âŒ å•é¡Œï¼š**

| å•é¡Œ | èªªæ˜ |
|------|------|
| **ç”¨é€”éŒ¯èª¤** | High Concurrency æ˜¯ç‚º**äº’å‹•æŸ¥è©¢**è¨­è¨ˆï¼Œéé«˜ååå¯«å…¥ |
| **å¯«å…¥é™åˆ¶** | å–®ä¸€è¡¨çš„ä¸¦è¡Œå¯«å…¥ä»å—é™æ–¼ Delta Lake çš„ä½µç™¼æ§åˆ¶ |
| **éå„ªåŒ–é€£æ¥** | æ²’æœ‰ç‰¹æ®Šçš„ã€Œå„ªåŒ–é›²ç«¯å„²å­˜é€£æ¥ã€åŠŸèƒ½ |
| **æˆæœ¬é«˜** | High Concurrency cluster æˆæœ¬è¼ƒé«˜ï¼Œä¸”ä¸è§£æ±ºåˆ†å€å•é¡Œ |

**High Concurrency vs Standard Clusterï¼š**

| ç‰¹æ€§ | High Concurrency | Standard | 
|------|-----------------|----------|
| **é©ç”¨å ´æ™¯** | å¤šä½¿ç”¨è€…æŸ¥è©¢ | æ‰¹æ¬¡è™•ç†ã€ä¸²æµ |
| **éš”é›¢** | å¼·éš”é›¢ï¼ˆNotebook é–“ï¼‰ | ç„¡éš”é›¢ |
| **å¯«å…¥å„ªåŒ–** | âŒ ç„¡ç‰¹åˆ¥å„ªåŒ– | âœ… é©åˆå¤§é‡å¯«å…¥ |

### C - SSD Volumes Instead of Object Storage

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

```python
# Databricks ä¸æ”¯æ´ç›´æ¥å„²å­˜æ‰€æœ‰è³‡æ–™åˆ° SSD
```

**âŒ å•é¡Œï¼š**

| å•é¡Œ | èªªæ˜ |
|------|------|
| **æ¶æ§‹éŒ¯èª¤** | Delta Lake è¨­è¨ˆç‚ºå„²å­˜åœ¨ Object Storageï¼ˆS3/ADLS/GCSï¼‰ |
| **ç„¡æ³•æŒä¹…åŒ–** | SSD volumes æ˜¯æš«å­˜çš„ï¼Œcluster çµ‚æ­¢å°±æ¶ˆå¤± |
| **æˆæœ¬æ¥µé«˜** | SSD å„²å­˜æˆæœ¬é é«˜æ–¼ Object Storage |
| **ä¸ç¬¦å¯¦å‹™** | ç”Ÿç”¢ç’°å¢ƒå¿…é ˆä½¿ç”¨æŒä¹…åŒ–çš„ Object Storage |

**æ­£ç¢ºçš„ SSD ä½¿ç”¨æ–¹å¼ï¼š**
- SSD ç”¨æ–¼**å¿«å–**ï¼ˆcacheï¼‰ï¼Œéä¸»è¦å„²å­˜
- Delta Lake è³‡æ–™ä»å­˜æ–¼ Object Storage

### D - Isolate Tables in Storage Containers

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

```python
# æ¯å€‹è¡¨æ”¾åœ¨ç¨ç«‹çš„ storage container
```

**âŒ å•é¡Œï¼š**

| å•é¡Œ | èªªæ˜ |
|------|------|
| **ç„¡æ³•è§£æ±ºä¸¦è¡Œ** | åˆ†é–‹å®¹å™¨ä¸å½±éŸ¿å–®ä¸€è¡¨çš„ä¸¦è¡Œå¯«å…¥é™åˆ¶ |
| **ç®¡ç†è¤‡é›œ** | æ•¸ç™¾å€‹è¡¨ = æ•¸ç™¾å€‹å®¹å™¨ï¼Œç®¡ç†å›°é›£ |
| **API é™åˆ¶èª¤è§£** | é›²ç«¯ API é™åˆ¶é€šå¸¸æ˜¯é‡å°**å–®ä¸€æª”æ¡ˆæ“ä½œ**ï¼Œéå®¹å™¨å±¤ç´š |
| **éç“¶é ¸** | é«˜ååå¯«å…¥çš„ç“¶é ¸åœ¨**åˆ†å€ç­–ç•¥**ï¼Œéå®¹å™¨éš”é›¢ |

**å¯¦éš›çš„ API é™åˆ¶ï¼š**
- é™åˆ¶åœ¨**æ¯ç§’è«‹æ±‚æ•¸**ï¼ˆrequests/secï¼‰
- èˆ‡å®¹å™¨æ•¸é‡ç„¡é—œ
- é€éåˆ†å€ä¸¦è¡Œå¯«å…¥æ›´æœ‰æ•ˆ

### E - Single Database for Load Balancing

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

```python
# æ‰€æœ‰è¡¨æ”¾åœ¨å–®ä¸€ database
```

**âŒ å•é¡Œï¼š**

| å•é¡Œ | èªªæ˜ |
|------|------|
| **æ¦‚å¿µéŒ¯èª¤** | Metastore ä¸æœƒã€Œload balance throughputã€|
| **åæ•ˆæœ** | å–®ä¸€ database åè€Œå¢åŠ  metadata å£“åŠ› |
| **ç„¡é—œåå** | Database åªæ˜¯é‚è¼¯å‘½åç©ºé–“ï¼Œä¸å½±éŸ¿å¯«å…¥æ•ˆèƒ½ |
| **å»ºè­°ç›¸å** | ç”Ÿç”¢ç’°å¢ƒé€šå¸¸**åˆ†é–‹** databasesï¼ˆbronze/silver/goldï¼‰|

---

## ğŸ§  è¨˜æ†¶æ³•

### å£è¨£

**ã€Œé«˜é€Ÿä¸¦è¡Œå¯«ï¼Œæ™‚é–“ç´°åˆ†å€ã€**

```
High Throughput + Parallel Writes
  â†“
Fine-grained Time Partitioning
  â†“
Many partitions â†’ No write contention
```

### è§£é¡Œé—œéµ

**çœ‹åˆ°é€™äº›é—œéµå­— â†’ é¸åˆ†å€æ–¹æ¡ˆï¼š**
- âœ… High volume / velocity
- âœ… Parallel updates
- âœ… Hundreds of pipelines
- âœ… Near real-time

**ç­”æ¡ˆé€šå¸¸æ˜¯ï¼šç´°ç²’åº¦æ™‚é–“åˆ†å€**

### ä¸¦è¡Œå¯«å…¥å°æ¯”

| æ–¹æ¡ˆ | ä¸¦è¡Œåº¦ | æ•ˆæœ |
|------|--------|------|
| **ç„¡åˆ†å€** | ä½ï¼ˆå–®ä¸€è¡¨é–ï¼‰ | âŒ å¯«å…¥è¡çª |
| **ç²—åˆ†å€ï¼ˆæŒ‰æœˆï¼‰** | ä½ï¼ˆå–®ä¸€åˆ†å€ç«¶çˆ­ï¼‰ | âŒ ä»æœ‰ç“¶é ¸ |
| **ç´°åˆ†å€ï¼ˆæŒ‰å°æ™‚/åˆ†é˜ï¼‰** | é«˜ï¼ˆå¤šåˆ†å€ä¸¦è¡Œï¼‰ | âœ… é«˜åå |

---

## ğŸ“š å®˜æ–¹æ–‡ä»¶

- [Delta Lake Concurrency Control](https://docs.databricks.com/delta/concurrency-control.html)
- [Partitioning for High Throughput](https://docs.databricks.com/delta/best-practices.html#partitioning)

---

## ğŸ’¡ å¯¦å‹™å»ºè­°

### é«˜ååå¯«å…¥æœ€ä½³å¯¦å‹™

```python
# âœ… æœ€ä½³å¯¦å‹™ï¼šç´°ç²’åº¦æ™‚é–“åˆ†å€

# 1. æŒ‰å°æ™‚åˆ†å€ï¼ˆé©åˆå¤§å¤šæ•¸å ´æ™¯ï¼‰
PARTITIONED BY (date, hour)

# 2. æŒ‰åˆ†é˜åˆ†å€ï¼ˆæ¥µé«˜é€Ÿå ´æ™¯ï¼‰
PARTITIONED BY (date, hour, minute)

# 3. é¿å…éç²—ç²’åº¦
PARTITIONED BY (date)  # âš ï¸ æ‰€æœ‰ç®¡é“å¯«å…¥åŒä¸€åˆ†å€ï¼Œæœƒç«¶çˆ­

# 4. é¿å…éç´°ç²’åº¦
PARTITIONED BY (timestamp)  # âŒ åˆ†å€æ•¸çˆ†ç‚¸
```

### åˆ†å€ç²’åº¦é¸æ“‡

| è³‡æ–™é€Ÿç‡ | å»ºè­°åˆ†å€ç²’åº¦ | èªªæ˜ |
|---------|-------------|------|
| **< 1 GB/hour** | æŒ‰æ—¥ï¼ˆdateï¼‰ | é©ä¸­ |
| **1-10 GB/hour** | æŒ‰å°æ™‚ï¼ˆhourï¼‰ | æ¨è–¦ âœ… |
| **> 10 GB/hour** | æŒ‰åˆ†é˜ï¼ˆminuteï¼‰ | æ¥µé«˜é€Ÿ |

---

## ğŸ¯ è€ƒè©¦æŠ€å·§

**å¿«é€Ÿåˆ¤æ–·æ³•ï¼š**

```
é¡Œç›®é—œéµå­—ï¼š
- "parallel updates" 
- "high volume/velocity"
- "hundreds of pipelines"

â†“

ç­”æ¡ˆæ–¹å‘ï¼š
- åˆ†å€ç­–ç•¥ï¼ˆPartitioningï¼‰
- ç´°ç²’åº¦æ™‚é–“åˆ†å€
- å…è¨±ä¸¦è¡Œå¯«å…¥

â†“

æœ¬é¡Œç­”æ¡ˆï¼šB âœ…
```

**æ’é™¤æ³•ï¼š**
1. âŒ A - High Concurrencyï¼ˆç”¨é€”éŒ¯èª¤ï¼‰
2. âœ… B - æ™‚é–“åˆ†å€ï¼ˆæ­£ç¢ºï¼‰
3. âŒ C - SSD å„²å­˜ï¼ˆæ¶æ§‹éŒ¯èª¤ï¼‰
4. âŒ D - éš”é›¢å®¹å™¨ï¼ˆç„¡æ³•è§£æ±ºä¸¦è¡Œï¼‰
5. âŒ E - å–®ä¸€ databaseï¼ˆæ¦‚å¿µéŒ¯èª¤ï¼‰

---

**[è¿”å›é¡Œç›®](#question-110)**