# Question #113

---

## é¡Œç›®è³‡è¨Š

### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-113`

### ä¾†æº
**ä¾†æº:** Mock Exam / Community Contributed

### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L2-Intermediate`

---

## é¡Œç›®å…§å®¹

### é¡Œå¹¹

A Delta Lake table in the Lakehouse named `customer_churn_params` is used in churn prediction by the machine learning team. The table contains information about customers derived from a number of upstream sources. 

Currently, the data engineering team **populates this table nightly by overwriting** the table with the current valid values derived from upstream data sources.

**Immediately after each update succeeds**, the data engineering team would like to **determine the difference between the new version and the previous version** of the table.

Given the current implementation, which method can be used?

### é¸é …

- **A.** Execute a query to calculate the difference between the new version and the previous version using Delta Lake's built-in versioning and **time travel** functionality
- **B.** Parse the Delta Lake transaction log to identify all newly written data files
- **C.** Parse the Spark event logs to identify those rows that were updated, inserted, or deleted
- **D.** Execute `DESCRIBE HISTORY customer_churn_params` to obtain the full operation metrics for the update, including a log of all records that have been added or modified
- **E.** Use Delta Lake's **change data feed** to identify those records that have been updated, inserted, or deleted

---

## æ¨™ç±¤ç³»çµ±

### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `Delta-Lake`, `Change-Data-Feed`, `Time-Travel`, `Versioning`

### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** `Feature-Requirement-Assumption`, `CDF-vs-TimeTravel`

### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** Data Engineering / Development

---

## ç­”æ¡ˆèˆ‡ä¾†æº

### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `E` (å®˜æ–¹ç­”æ¡ˆ) / `A` (å¯¦å‹™ä¸Šä¹Ÿå¯è¡Œ)

### ç­”æ¡ˆä¾†æº
- **ä¾†æºæ¨™è¨»ç­”æ¡ˆ:** E
- **ç¤¾ç¾¤å…±è­˜:** E
- **å¯¦å‹™çˆ­è­°:** A ä¹Ÿå¯è¡Œï¼ˆè‹¥æœªå•Ÿç”¨ CDFï¼‰

---

# é¡Œç›®è§£æ

---

## ğŸ“ è€ƒé»è­˜åˆ¥

**æ ¸å¿ƒæŠ€è¡“:** Delta Lake Change Data Feed (CDF) vs Time Travel  
**é—œéµæ¦‚å¿µ:** ç‰ˆæœ¬å·®ç•°è¿½è¹¤ã€è®Šæ›´è³‡æ–™æ•ç²

**é¡Œç›®é—œéµå­—ï¼š**
- **Overwriting** (å…¨é‡è¦†è“‹)
- **Determine the difference** (åˆ¤æ–·å·®ç•°)
- **New version vs previous version** (æ–°ç‰ˆæœ¬ vs èˆŠç‰ˆæœ¬)

---

## âœ… æ­£è§£èªªæ˜

### ç‚ºä»€éº¼ E (Change Data Feed) æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Ÿ

**æŠ€è¡“åŸç†ï¼š**

```sql
-- 1. å•Ÿç”¨ Change Data Feed
ALTER TABLE customer_churn_params 
SET TBLPROPERTIES (delta.enableChangeDataFeed = true);

-- 2. åŸ·è¡Œ Overwrite æ“ä½œ
INSERT OVERWRITE TABLE customer_churn_params
SELECT * FROM upstream_source;

-- 3. æŸ¥è©¢è®Šæ›´è¨˜éŒ„ï¼ˆCDF è‡ªå‹•è¿½è¹¤ï¼‰
SELECT * FROM table_changes('customer_churn_params', 1, 2)
-- å›å‚³: _change_type æ¬„ä½æ¨™ç¤º insert/update/delete
```

**CDF çš„æ ¸å¿ƒå„ªå‹¢ï¼š**

| ç‰¹æ€§ | èªªæ˜ |
|------|------|
| **è‡ªå‹•è¿½è¹¤** | è‡ªå‹•è¨˜éŒ„æ‰€æœ‰è®Šæ›´ï¼ˆINSERT/UPDATE/DELETEï¼‰ |
| **çµæ§‹åŒ–è¼¸å‡º** | æä¾› `_change_type` æ¬„ä½æ¨™ç¤ºè®Šæ›´é¡å‹ |
| **é«˜æ•ˆèƒ½** | ä¸éœ€å…¨è¡¨æƒæï¼Œç›´æ¥è®€å–è®Šæ›´è³‡æ–™ |
| **ç°¡åŒ–é‚è¼¯** | ç„¡éœ€æ‰‹å‹•æ¯”å°ç‰ˆæœ¬å·®ç•° |

**CDF è¼¸å‡ºç¯„ä¾‹ï¼š**

```
+------+--------+-------------+-------------------+
| id   | value  | _change_type| _commit_timestamp |
+------+--------+-------------+-------------------+
| 1    | 100    | update_pre  | 2024-01-20 01:00  |
| 1    | 150    | update_post | 2024-01-20 01:00  |
| 2    | 200    | insert      | 2024-01-20 01:00  |
| 3    | 300    | delete      | 2024-01-20 01:00  |
+------+--------+-------------+-------------------+
```

---

## ğŸ”„ æ›¿ä»£æ–¹æ¡ˆï¼šA (Time Travel)

### ç‚ºä»€éº¼ A ä¹Ÿå¯è¡Œï¼ˆä½†ä¸æ˜¯æœ€ä½³ç­”æ¡ˆï¼‰ï¼Ÿ

**æŠ€è¡“åŸç†ï¼š**

```sql
-- æ–¹æ³• A: ä½¿ç”¨ Time Travel æ¯”å°ç‰ˆæœ¬
SELECT 'deleted' as change_type, *
FROM customer_churn_params VERSION AS OF 1  -- èˆŠç‰ˆæœ¬
WHERE id NOT IN (SELECT id FROM customer_churn_params)  -- æ–°ç‰ˆæœ¬

UNION ALL

SELECT 'inserted' as change_type, *
FROM customer_churn_params  -- æ–°ç‰ˆæœ¬
WHERE id NOT IN (SELECT id FROM customer_churn_params VERSION AS OF 1)

UNION ALL

SELECT 'updated' as change_type, new.*
FROM customer_churn_params new
JOIN customer_churn_params VERSION AS OF 1 old ON new.id = old.id
WHERE new.value != old.value
```

**Time Travel çš„é™åˆ¶ï¼š**

| å•é¡Œ | èªªæ˜ |
|------|------|
| **éœ€è¦å…¨è¡¨æƒæ** | å¿…é ˆæ¯”å°å…©å€‹å®Œæ•´ç‰ˆæœ¬ |
| **æ•ˆèƒ½è¼ƒå·®** | è³‡æ–™é‡å¤§æ™‚æœƒå¾ˆæ…¢ |
| **é‚è¼¯è¤‡é›œ** | éœ€è¦æ‰‹å‹•æ’°å¯« UNION æŸ¥è©¢ |
| **ä¸æ˜¯æœ€ä½³å¯¦å‹™** | Databricks æ¨è–¦ä½¿ç”¨ CDF |

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### B - Parse Delta Lake transaction log

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

```python
# é¸é … B
# è®€å– _delta_log/ ç›®éŒ„çš„ JSON æª”æ¡ˆ
```

**âŒ å•é¡Œï¼š**

| å•é¡Œ | èªªæ˜ |
|------|------|
| **åªæœ‰æª”æ¡ˆåˆ—è¡¨** | äº¤æ˜“æ—¥èªŒåªè¨˜éŒ„æ–°å¢/åˆªé™¤çš„æª”æ¡ˆè·¯å¾‘ |
| **ç„¡æ³•è­˜åˆ¥ row-level è®Šæ›´** | ä¸çŸ¥é“å…·é«”å“ªäº› rows è¢«æ›´æ–° |
| **éœ€è¦è¤‡é›œè§£æ** | å¿…é ˆæ‰‹å‹•è®€å– Parquet æª”æ¡ˆæ¯”å° |
| **æ•ˆç‡ä½** | å¤§é‡ I/O æ“ä½œ |

### C - Parse Spark event logs

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

```python
# é¸é … C
# è®€å– Spark event logs (JSON æ ¼å¼)
```

**âŒ å•é¡Œï¼š**

| å•é¡Œ | èªªæ˜ |
|------|------|
| **ä¸åŒ…å«è³‡æ–™å…§å®¹** | Event logs åªæœ‰åŸ·è¡Œè¨ˆç•«å’Œ metrics |
| **ç„¡ row-level è³‡è¨Š** | åªè¨˜éŒ„ taskã€stage ç­‰åŸ·è¡Œè³‡è¨Š |
| **ä¸é©åˆæ­¤ç”¨é€”** | ç”¨æ–¼æ•ˆèƒ½åˆ†æï¼Œéè³‡æ–™æ¯”å° |

### D - DESCRIBE HISTORY

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

```sql
-- é¸é … D
DESCRIBE HISTORY customer_churn_params;
```

**âŒ å•é¡Œï¼š**

| å•é¡Œ | èªªæ˜ |
|------|------|
| **åªæœ‰ metadata** | åªé¡¯ç¤ºæ“ä½œé¡å‹ã€æ™‚é–“ã€user ç­‰ |
| **ç„¡å…·é«”è®Šæ›´å…§å®¹** | ä¸åŒ…å«å“ªäº› rows è¢«ä¿®æ”¹ |
| **åªæœ‰çµ±è¨ˆæ•¸å­—** | ä¾‹å¦‚ numOutputRowsã€numFiles |

**DESCRIBE HISTORY è¼¸å‡ºç¯„ä¾‹ï¼š**

```
+-------+-------------------+---------+----------+
|version|timestamp          |operation|numFiles  |
+-------+-------------------+---------+----------+
|2      |2024-01-20 01:00:00|WRITE    |10        |
|1      |2024-01-19 01:00:00|WRITE    |10        |
+-------+-------------------+---------+----------+
```

âŒ æ²’æœ‰å…·é«”çš„ row-level è®Šæ›´è³‡è¨Š

---

## ğŸ§  è¨˜æ†¶æ³•

### å£è¨£

**ã€Œè¿½è¹¤è®Šæ›´ç”¨ CDFï¼Œæ¯”å°ç‰ˆæœ¬ç”¨ Time Travelã€**

```
éœ€æ±‚: æŒçºŒè¿½è¹¤è®Šæ›´ â†’ CDF (E) âœ…
éœ€æ±‚: å¶çˆ¾æ¯”å°ç‰ˆæœ¬ â†’ Time Travel (A) âš ï¸
```

### CDF vs Time Travel å°æ¯”

| ç‰¹æ€§ | Change Data Feed (E) | Time Travel (A) |
|------|---------------------|-----------------|
| **æ•ˆèƒ½** | â­â­â­â­â­ é«˜æ•ˆ | â­â­ éœ€å…¨è¡¨æƒæ |
| **æ˜“ç”¨æ€§** | â­â­â­â­â­ è‡ªå‹• | â­â­ éœ€æ‰‹å‹•é‚è¼¯ |
| **å•Ÿç”¨æ¢ä»¶** | éœ€è¨­å®š property | é è¨­å¯ç”¨ |
| **é©ç”¨å ´æ™¯** | æŒçºŒè¿½è¹¤è®Šæ›´ | å¶çˆ¾ç‰ˆæœ¬æ¯”å° |
| **è€ƒè©¦ç­”æ¡ˆ** | âœ… æ¨è–¦ | âš ï¸ å¯è¡Œä½†éæœ€ä½³ |

### å¿«é€Ÿåˆ¤æ–·

```
é¡Œç›®é—œéµå­— = "determine the difference"
  â†“
æœ€ä½³æ–¹å¼ = Change Data Feed (CDF)
  â†“
ç­”æ¡ˆ = E âœ…
```

---

## ğŸ“š å®˜æ–¹æ–‡ä»¶

- [Delta Lake Change Data Feed](https://docs.databricks.com/delta/delta-change-data-feed.html)
- [Delta Lake Time Travel](https://docs.databricks.com/delta/delta-batch.html#deltatimetravel)
- [Table Versioning](https://docs.databricks.com/delta/versioning.html)

---

## ğŸ’¡ å¯¦å‹™å»ºè­°

### ä½•æ™‚ä½¿ç”¨ CDFï¼Ÿ

```sql
-- âœ… é©åˆä½¿ç”¨ CDF çš„å ´æ™¯
-- 1. éœ€è¦æŒçºŒè¿½è¹¤è®Šæ›´ï¼ˆCDCï¼‰
-- 2. ä¸‹æ¸¸ç³»çµ±éœ€è¦å¢é‡æ›´æ–°
-- 3. å¯©è¨ˆèˆ‡åˆè¦éœ€æ±‚

-- å•Ÿç”¨ CDF
CREATE TABLE customer_churn_params (...)
TBLPROPERTIES (delta.enableChangeDataFeed = true);

-- æˆ–å°ç¾æœ‰è¡¨å•Ÿç”¨
ALTER TABLE customer_churn_params 
SET TBLPROPERTIES (delta.enableChangeDataFeed = true);
```

### ä½•æ™‚ä½¿ç”¨ Time Travelï¼Ÿ

```sql
-- âš ï¸ é©åˆä½¿ç”¨ Time Travel çš„å ´æ™¯
-- 1. å¶çˆ¾éœ€è¦ç‰ˆæœ¬æ¯”å°
-- 2. æœªå•Ÿç”¨ CDF
-- 3. éœ€è¦å®Œæ•´æ­·å²å¿«ç…§

-- æŸ¥è©¢ç‰¹å®šç‰ˆæœ¬
SELECT * FROM table_name VERSION AS OF 1;
SELECT * FROM table_name TIMESTAMP AS OF '2024-01-20';
```

### ä½¿ç”¨å ´æ™¯å°æ¯”

| å ´æ™¯ | æ¨è–¦æ–¹å¼ | åŸå›  |
|------|---------|------|
| **CDC ç®¡é“** | CDF | æ•ˆèƒ½é«˜ã€è‡ªå‹•åŒ– |
| **å¯©è¨ˆè¿½è¹¤** | CDF | çµæ§‹åŒ–è®Šæ›´è¨˜éŒ„ |
| **è³‡æ–™æ¢å¾©** | Time Travel | å®Œæ•´å¿«ç…§ |
| **è‡¨æ™‚æ¯”å°** | Time Travel | ç„¡éœ€é å…ˆå•Ÿç”¨ |

---

## ğŸ¯ è€ƒè©¦æŠ€å·§

### å¿«é€Ÿåˆ¤æ–·æ³•

```
é¡Œç›®æåˆ° "determine the difference" 
+ Delta Lake table
  â†“
å„ªå…ˆè€ƒæ…®: Change Data Feed (CDF)
  â†“
ç­”æ¡ˆ: E âœ…
```

### é—œéµå­—è­˜åˆ¥

| é—œéµå­— | æ¨è–¦æ–¹å¼ |
|--------|---------|
| **determine difference** | CDF (E) |
| **track changes** | CDF (E) |
| **CDC**, **incremental** | CDF (E) |
| **compare versions** | Time Travel (A) |
| **restore**, **rollback** | Time Travel (A) |

### ç­”æ¡ˆçˆ­è­°èªªæ˜

**ç‚ºä»€éº¼ E å„ªæ–¼ Aï¼Ÿ**

é›–ç„¶ A (Time Travel) æŠ€è¡“ä¸Šå¯è¡Œï¼Œä½†ï¼š
1. âœ… **E æ˜¯ Databricks æ¨è–¦çš„æœ€ä½³å¯¦å‹™**
2. âœ… **E æ•ˆèƒ½æ›´å¥½ï¼ˆç„¡éœ€å…¨è¡¨æƒæï¼‰**
3. âœ… **E è‡ªå‹•åŒ–ç¨‹åº¦æ›´é«˜**
4. âš ï¸ **A éœ€è¦æ‰‹å‹•æ’°å¯«è¤‡é›œæŸ¥è©¢**

---

## âš ï¸ é‡é»ç¸½çµ

1. **Change Data Feed (CDF) æ˜¯è¿½è¹¤è®Šæ›´çš„æœ€ä½³æ–¹å¼**
   - è‡ªå‹•è¨˜éŒ„æ‰€æœ‰è®Šæ›´é¡å‹
   - æä¾›çµæ§‹åŒ–çš„è®Šæ›´è³‡æ–™
   - æ•ˆèƒ½å„ªæ–¼æ‰‹å‹•æ¯”å°

2. **Time Travel å¯è¡Œä½†éæœ€ä½³**
   - éœ€è¦å…¨è¡¨æƒææ¯”å°
   - é‚è¼¯è¤‡é›œï¼Œæ•ˆèƒ½è¼ƒå·®
   - é©åˆå¶çˆ¾çš„ç‰ˆæœ¬æ¯”å°

3. **è€ƒè©¦é¸ Eï¼Œå¯¦å‹™è¦–æƒ…æ³**
   - è€ƒè©¦ç­”æ¡ˆ: E (CDF)
   - å¯¦å‹™: è‹¥æœªå•Ÿç”¨ CDFï¼Œå¯ç”¨ A (Time Travel)

**è¨˜æ†¶å£è¨£ï¼šã€ŒæŒçºŒè¿½è¹¤é¸ CDFï¼Œå¶çˆ¾æ¯”å°ç”¨ Time Travelã€**

---

**[è¿”å›é¡Œç›®](#question-113)**