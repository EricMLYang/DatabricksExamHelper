# Question #72

---

## é¡Œç›®è³‡è¨Š

### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-072`

### ä¾†æº
**ä¾†æº:** Community Contributed (Real Exam-style)

### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L2-Intermediate`

---

## é¡Œç›®å…§å®¹

### é¡Œå¹¹
A data team's Structured Streaming job is configured to calculate running aggregates for item sales to update a downstream marketing dashboard. The marketing team has introduced a new promotion, and they would like to add a new field to track the number of times this promotion code is used for each item. A junior data engineer suggests updating the existing query as follows (changes in bold).

**åŸå§‹æŸ¥è©¢ (Original query)ï¼š**
```python
df.groupBy("item") \
  .agg(count("item").alias("total_count"),
       mean("sale_price").alias("avg_price")) \
  .writeStream \
  .outputMode("complete") \
  .option("checkpointLocation", "/item_agg/_checkpoint") \
  .start("/item_agg")
```

**å»ºè­°æŸ¥è©¢ (Proposed query)ï¼š**
```python
df.groupBy("item") \
  .agg(count("item").alias("total_count"),
       mean("sale_price").alias("avg_price"),
       count("promo_code = 'NEW_MEMBER'").alias("new_member_promo")) \
  .writeStream \
  .outputMode("complete") \
  .option('mergeSchema', 'true') \
  .option("checkpointLocation", "/item_agg/_checkpoint") \
  .start("/item_agg")
```

**å•é¡Œï¼š**
Which step must also be completed to put the proposed query into production?

### é¸é …
- **A.** Specify a new checkpointLocation
- **B.** Increase the shuffle partitions to account for additional aggregates
- **C.** Run `REFRESH TABLE delta.'/item_agg'`
- **D.** Register the data in the "/item_agg" directory to the Hive metastore
- **E.** Remove `.option('mergeSchema', 'true')` from the streaming write

---

## æ¨™ç±¤ç³»çµ±

### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `Streaming`, `Spark-Performance`

### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** `Execution-Behavior`, `Similar-Function`

### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** `Streaming`

---

## ç­”æ¡ˆèˆ‡è§£æé€£çµ

### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `A`

### è§£ææª”æ¡ˆ
**è©³ç´°è§£æ:** ä¸‹æ–¹æ•´åˆè§£æ

---

## ç›¸é—œè³‡æº

### å®˜æ–¹æ–‡ä»¶
- [Streaming checkpoints and state](https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html#recovering-from-failures-with-checkpointing)
- [Schema changes in streaming queries](https://docs.databricks.com/structured-streaming/schema.html)

---

## è§£é¡Œè§£æï¼ˆæ•´åˆï¼‰

### ç‚ºä»€éº¼ A æ˜¯æ­£ç¢ºçš„ï¼Ÿ
- è®Šæ›´è¼¸å‡ºæ¨¡å¼èˆ‡èšåˆ schemaï¼ˆæ–°å¢æ¬„ä½ `new_member_promo`ï¼‰æ™‚ï¼ŒèˆŠ checkpoint å…§çš„ state/schema å¯èƒ½èˆ‡æ–°æŸ¥è©¢ä¸ç›¸å®¹ï¼›æœ€ä½³å¯¦å‹™æ˜¯ä½¿ç”¨**å…¨æ–° checkpoint ä½ç½®**ä»¥é¿å…èˆŠç‹€æ…‹è¡çªä¸¦è®“æŸ¥è©¢ä¹¾æ·¨å•Ÿå‹•ã€‚
- æ¯å€‹ä¸²æµæŸ¥è©¢éœ€è¦ç¨ç«‹ checkpointï¼›ä¿®æ”¹æŸ¥è©¢çµæ§‹æ™‚å…±ç”¨èˆŠ checkpoint æ˜“å°è‡´ state è®€å–éŒ¯èª¤æˆ–ç„¡æ³•å•Ÿå‹•ã€‚

### éŒ¯èª¤é¸é …æ’é™¤
- **B**ï¼šæ˜¯å¦èª¿æ•´ shuffle partitions å–æ±ºæ–¼å·¥ä½œé‡èˆ‡å¢é›†è³‡æºï¼Œéå¿…é ˆæ­¥é©Ÿä¸”é¡Œç›®å•ã€Œå¿…é ˆã€ã€‚
- **C**ï¼šcomplete mode ç›´æ¥å¯«ç›®éŒ„ï¼›`REFRESH TABLE` ä¸æ˜¯å¿…è¦æ¢ä»¶ï¼ˆä¸”ç›®æ¨™è·¯å¾‘ä¸¦éå·²è¨»å†Šè¡¨ï¼‰ã€‚
- **D**ï¼šå•é¡Œæƒ…å¢ƒæ˜¯ç¹¼çºŒå¯«åˆ°ç›®éŒ„ï¼›ä¸éœ€é¡å¤–è¨»å†Šåˆ° metastore æ‰èƒ½é‹è¡ŒæŸ¥è©¢ã€‚
- **E**ï¼š`mergeSchema` èˆ‡ checkpoint è¡çªç„¡é—œï¼›ç§»é™¤å®ƒç„¡æ³•è§£æ±ºèˆŠç‹€æ…‹èˆ‡æ–° schema ä¸ç›¸å®¹å•é¡Œã€‚

### è¨˜æ†¶å£è¨£
- **ã€Œæ”¹ schemaï¼Œæ› checkpointã€**ï¼šä¸²æµæŸ¥è©¢è®Šæ›´æ¬„ä½æˆ–èšåˆçµæ§‹æ™‚ï¼Œä½¿ç”¨æ–°çš„ checkpoint é¿å…èˆŠ state é€ æˆè¡çªã€‚

### è§£é¡Œæ­¥é©Ÿ
1. è§€å¯Ÿè®Šæ›´ï¼šæ–°å¢èšåˆæ¬„ä½ â†’ è¼¸å‡º schema æ”¹è®Šã€‚
2. æª¢æŸ¥ä¸²æµç‹€æ…‹ï¼šèˆŠ checkpoint/state èˆ‡æ–° schema ä¸ç¬¦ â†’ éœ€æ–° checkpointã€‚
3. æ’é™¤éå¿…é ˆæˆ–ä¸ç›¸é—œçš„è¨­å®šï¼ˆshuffle èª¿æ•´ã€metastoreã€refreshï¼‰ã€‚

### å¸¸è¦‹é™·é˜±è­¦ç¤º
- âš ï¸ æ²¿ç”¨èˆŠ checkpointï¼šæœƒå› ç‹€æ…‹æˆ– schema ä¸ç›¸å®¹è€Œä½¿ä½œæ¥­å•Ÿå‹•å¤±æ•—æˆ–çµæœéŒ¯èª¤ã€‚
- âš ï¸ ä»¥ç‚º `mergeSchema` èƒ½è™•ç†ç‹€æ…‹ï¼šå®ƒåƒ…å½±éŸ¿å¯«å…¥ schema åˆä½µï¼Œç„¡æ³•è§£æ±ºèˆŠ state è¡çªã€‚

---

## ğŸ·ï¸ æ¨™ç±¤èˆ‡åˆ†é¡
**Topics:** `Streaming`, `Spark-Performance`
**Traps:** `Execution-Behavior`, `Similar-Function`
**Difficulty:** `L2-Intermediate`
