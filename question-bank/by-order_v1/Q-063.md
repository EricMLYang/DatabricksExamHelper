# Question #63

---

## é¡Œç›®è³‡è¨Š

### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-063`

### ä¾†æº
**ä¾†æº:** Real Exam Recall

### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L2-Intermediate`

---

## é¡Œç›®å…§å®¹

### é¡Œå¹¹

A Databricks SQL dashboard has been configured to monitor the total number of records present in a collection of Delta Lake tables using the following query pattern:

```sql
SELECT COUNT(*) FROM table
```

Which of the following describes how results are generated each time the dashboard is updated?

### é¸é …

- **A.** The total count of rows is calculated by scanning all data files
- **B.** The total count of rows will be returned from cached results unless REFRESH is run
- **C.** The total count of records is calculated from the Delta transaction logs
- **D.** The total count of records is calculated from the parquet file metadata
- **E.** The total count of records is calculated from the Hive metastore

---

## æ¨™ç±¤ç³»çµ±

### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `COUNT-Queries`, `Delta-Lake`, `Transaction-Log`, `Query-Optimization`

### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** `Statistics-Source`, `COUNT-Optimization`

### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** `Delta Lake`

---

## ç­”æ¡ˆèˆ‡è§£æé€£çµ

### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `C`

---

## ğŸ“ è€ƒé»è­˜åˆ¥

### ä¸»è¦è€ƒé»
**æ ¸å¿ƒæŠ€è¡“:** Delta Lake COUNT æŸ¥è©¢å„ªåŒ–
**çŸ¥è­˜é ˜åŸŸ:** Delta Lake æ¶æ§‹èˆ‡æ•ˆèƒ½å„ªåŒ–
**é—œéµæ¦‚å¿µ:** Transaction Logã€çµ±è¨ˆè³‡æ–™ç·©å­˜ã€æŸ¥è©¢å„ªåŒ–

### æ¬¡è¦è€ƒé»
- COUNT(*) æŸ¥è©¢çš„åŸ·è¡Œæ©Ÿåˆ¶
- Delta Lake æª”æ¡ˆçµæ§‹èˆ‡ metadata
- æŸ¥è©¢æ•ˆèƒ½å„ªåŒ–ç­–ç•¥

---

## âœ… æ­£è§£èªªæ˜

### ç‚ºä»€éº¼ C æ˜¯æ­£ç¢ºçš„ï¼Ÿ

**æŠ€è¡“åŸç†:**
Delta Lake é€é transaction logï¼ˆäº‹å‹™æ—¥èªŒï¼‰ç¶­è­·è¡¨çš„ metadataï¼ŒåŒ…æ‹¬æ¯å€‹è³‡æ–™æª”æ¡ˆçš„çµ±è¨ˆè³‡è¨Šã€‚ç•¶åŸ·è¡Œ `COUNT(*)` æŸ¥è©¢æ™‚ï¼ŒDelta Lake å¯ä»¥ç›´æ¥å¾ transaction log ä¸­è®€å–é€™äº›çµ±è¨ˆè³‡è¨Šä¾†è¨ˆç®—ç¸½è¨˜éŒ„æ•¸ï¼Œè€Œä¸éœ€è¦æƒæå¯¦éš›çš„è³‡æ–™æª”æ¡ˆã€‚

**ç¬¦åˆéœ€æ±‚:**
å°æ–¼ Databricks SQL dashboard çš„ç›£æ§éœ€æ±‚ï¼Œä½¿ç”¨ transaction log æä¾›äº†æœ€ä½³çš„æ•ˆèƒ½è¡¨ç¾ï¼š
- å¿«é€Ÿå›æ‡‰ï¼šç„¡éœ€æƒæå¤§é‡è³‡æ–™æª”æ¡ˆ
- æº–ç¢ºæ€§ï¼štransaction log ä¿è­‰è³‡æ–™ä¸€è‡´æ€§
- è³‡æºæ•ˆç‡ï¼šå¤§å¹…æ¸›å°‘ I/O æ“ä½œ

**å¯¦å‹™æ‡‰ç”¨:**
```sql
-- é€™å€‹æŸ¥è©¢æœƒå¾ transaction log è®€å–çµ±è¨ˆè³‡è¨Š
SELECT COUNT(*) FROM my_delta_table;

-- å°æ–¼å¤§å‹è¡¨æ ¼ï¼Œé€™ç¨®å„ªåŒ–å¯ä»¥å°‡æŸ¥è©¢æ™‚é–“å¾åˆ†é˜ç¸®çŸ­åˆ°ç§’ç´š
```

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### é¸é … A - æƒææ‰€æœ‰è³‡æ–™æª”æ¡ˆè¨ˆç®—

**éŒ¯èª¤åŸå› :** æ•ˆèƒ½ä½ä¸‹ä¸”ä¸å¿…è¦

**è©³ç´°åˆ†æ:**
é›–ç„¶é€™æ˜¯æœ€ç›´è§€çš„æ–¹æ³•ï¼Œä½† Delta Lake çš„è¨­è¨ˆæ­£æ˜¯ç‚ºäº†é¿å…é€™ç¨®ä½æ•ˆç‡çš„æ“ä½œã€‚æƒææ‰€æœ‰è³‡æ–™æª”æ¡ˆæœƒï¼š
- æ¶ˆè€—å¤§é‡ I/O è³‡æº
- ç”¢ç”Ÿä¸å¿…è¦çš„ç¶²è·¯æµé‡
- å¤§å¹…å¢åŠ æŸ¥è©¢å»¶é²æ™‚é–“
- åœ¨å¤§å‹è¡¨æ ¼ä¸Šè®Šå¾—ç„¡æ³•å¯¦ç”¨

**æ˜“æ··æ·†é»:**
åˆå­¸è€…å®¹æ˜“èªç‚º COUNT å¿…é ˆæƒææ‰€æœ‰æ•¸æ“šï¼Œä½†é€™å¿½ç•¥äº† Delta Lake çš„å„ªåŒ–æ©Ÿåˆ¶ã€‚

---

### é¸é … B - å¾å¿«å–çµæœå›å‚³ï¼ˆé™¤éåŸ·è¡Œ REFRESHï¼‰

**éŒ¯èª¤åŸå› :** æ··æ·†äº†ä¸åŒå±¤ç´šçš„å¿«å–æ©Ÿåˆ¶

**è©³ç´°åˆ†æ:**
é›–ç„¶ Databricks ç¢ºå¯¦æœ‰æŸ¥è©¢å¿«å–æ©Ÿåˆ¶ï¼Œä½† COUNT(*) æŸ¥è©¢çš„å„ªåŒ–ä¸»è¦ä¾†è‡ªæ–¼ Delta Lake æœ¬èº«çš„ metadataï¼Œè€Œä¸æ˜¯ä¾è³´å¤–éƒ¨å¿«å–ï¼š
- Delta çš„çµ±è¨ˆè³‡è¨Šæ˜¯å³æ™‚æ›´æ–°çš„
- ä¸éœ€è¦é¡å¤–çš„ REFRESH æŒ‡ä»¤ä¾†ç²å¾—æº–ç¢ºçµæœ
- é€™ç¨®èªªæ³•æ›´é©ç”¨æ–¼ materialized view æˆ–å…¶ä»–å¿«å–æ©Ÿåˆ¶

**æ˜“æ··æ·†é»:**
å°‡ Delta Lake çš„å…§å»ºå„ªåŒ–èˆ‡æŸ¥è©¢å¿«å–æ··ç‚ºä¸€è«‡ã€‚

---

### é¸é … D - å¾ parquet æª”æ¡ˆ metadata è¨ˆç®—

**éŒ¯èª¤åŸå› :** æŠ€è¡“å¯¦ä½œç´°ç¯€ä¸æ­£ç¢º

**è©³ç´°åˆ†æ:**
é›–ç„¶ Delta Lake åº•å±¤ä½¿ç”¨ Parquet æ ¼å¼ï¼Œä½†è¨ˆç®—ç¸½è¨˜éŒ„æ•¸çš„é‚è¼¯ç™¼ç”Ÿåœ¨æ›´é«˜å±¤ç´šï¼š
- Parquet metadata åŒ…å«å„æª”æ¡ˆçš„è¨˜éŒ„æ•¸
- ä½†éœ€è¦é€é Delta çš„ transaction log ä¾†ç¢ºå®šå“ªäº›æª”æ¡ˆæ˜¯ç•¶å‰ç‰ˆæœ¬
- ç›´æ¥å¾ Parquet metadata ç„¡æ³•è™•ç† Delta Lake çš„æ™‚é–“æ—…è¡Œå’Œç‰ˆæœ¬æ§åˆ¶

**æ˜“æ··æ·†é»:**
æ··æ·†äº†å„²å­˜æ ¼å¼ï¼ˆParquetï¼‰èˆ‡è¡¨æ ¼æ ¼å¼ï¼ˆDelta Lakeï¼‰çš„è·è²¬åˆ†å·¥ã€‚

---

### é¸é … E - å¾ Hive metastore è¨ˆç®—

**éŒ¯èª¤åŸå› :** æ¶æ§‹å±¤ç´šéŒ¯èª¤

**è©³ç´°åˆ†æ:**
Hive metastore ä¸»è¦å„²å­˜è¡¨æ ¼çš„ schema å’Œä½ç½®è³‡è¨Šï¼Œè€Œä¸åŒ…å«å³æ™‚çš„è¨˜éŒ„æ•¸çµ±è¨ˆï¼š
- Metastore ä¸æœƒè¿½è¹¤æ¯æ¬¡è³‡æ–™ç•°å‹•å¾Œçš„è¨˜éŒ„æ•¸è®ŠåŒ–
- é€™ç¨®è³‡è¨Šéœ€è¦å®šæœŸçš„ ANALYZE TABLE æŒ‡ä»¤ä¾†æ›´æ–°
- å°æ–¼ç¶“å¸¸ç•°å‹•çš„ Delta è¡¨æ ¼ï¼Œé€™ç¨®æ–¹æ³•æœƒæä¾›éæœŸè³‡è¨Š

**æ˜“æ··æ·†é»:**
å°‡å‚³çµ± Hive è¡¨æ ¼çš„çµ±è¨ˆæ©Ÿåˆ¶å¥—ç”¨åˆ° Delta Lakeã€‚

---

## ğŸ§  è¨˜æ†¶æ³•èˆ‡è§£é¡ŒæŠ€å·§

### è¨˜æ†¶å£è¨£
**ã€ŒDelta æ—¥èªŒè¨˜ä¸€åˆ‡ï¼ŒCOUNT æŸ¥è©¢ä¸ç”¨ç­‰ã€**
- Delta Lake çš„ transaction log è¨˜éŒ„æ‰€æœ‰ metadata
- COUNT(*) ç›´æ¥è®€å–çµ±è¨ˆè³‡è¨Šï¼Œç„¡éœ€æƒæè³‡æ–™

### è§£é¡Œæ­¥é©Ÿ
1. **è­˜åˆ¥é¡Œç›®é¡å‹** - çœ‹åˆ° COUNT(*) æŸ¥è©¢å„ªåŒ–ç›¸é—œé¡Œç›®
2. **æ’é™¤æƒææ–¹æ¡ˆ** - Delta Lake è¨­è¨ˆå°±æ˜¯ç‚ºäº†é¿å…å…¨è¡¨æƒæ
3. **ç¢ºèª metadata ä¾†æº** - Transaction log æ˜¯ Delta çš„æ ¸å¿ƒå„ªå‹¢
4. **æ’é™¤å¤–éƒ¨ä¾è³´** - ä¸ä¾è³´å¿«å–ã€metastore ç­‰å¤–éƒ¨æ©Ÿåˆ¶

### å¸¸è¦‹é™·é˜±è­¦ç¤º
âš ï¸ **é™·é˜± 1:** ä»¥ç‚º COUNT å¿…é ˆæƒæè³‡æ–™ - Delta Lake çš„è¨­è¨ˆå°±æ˜¯è¦é¿å…é€™é»
âš ï¸ **é™·é˜± 2:** æ··æ·†ä¸åŒå±¤ç´šçš„å„ªåŒ–æ©Ÿåˆ¶ - è¦å€åˆ† Delta Lakeã€Sparkã€Databricks å„å±¤çš„åŠŸèƒ½

---

## ğŸ“š å®˜æ–¹æ–‡ä»¶èˆ‡å»¶ä¼¸é–±è®€

### å®˜æ–¹æ–‡ä»¶
1. **[Delta Lake Transaction Log Protocol](https://docs.databricks.com/delta/delta-log.html)** - è©³ç´°èªªæ˜ transaction log çš„çµæ§‹èˆ‡åŠŸèƒ½
2. **[Delta Lake Optimizations](https://docs.databricks.com/delta/optimizations/index.html)** - åŒ…å« COUNT æŸ¥è©¢ç­‰å„ç¨®å„ªåŒ–æŠ€è¡“

### å»¶ä¼¸é–±è®€
- [Databricks Blog: Delta Lake Performance](https://databricks.com/blog/2019/08/21/diving-into-delta-lake-unpacking-the-transaction-log.html)

### ç›¸é—œé¡Œç›®
- å…¶ä»– Delta Lake å„ªåŒ–ç›¸é—œé¡Œç›®
- Query æ•ˆèƒ½èª¿æ ¡ç›¸é—œé¡Œç›®

---

## ç›¸é—œè³‡æº

### å®˜æ–¹æ–‡ä»¶
- [Delta Lake Statistics](https://docs.databricks.com/delta/optimizations/file-mgmt.html#data-skipping)
- [COUNT Optimization](https://docs.databricks.com/optimizations/index.html)
