# Question #97

---

## é¡Œç›®è³‡è¨Š

### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-097`

### ä¾†æº
**ä¾†æº:** Mock Exam / Community Contributed

### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L2-Intermediate`

---

## é¡Œç›®å…§å®¹

### é¡Œå¹¹

A data architect has heard about Delta Lake's built-in versioning and time travel capabilities. For auditing purposes, they have a requirement to maintain a full record of all valid street addresses as they appear in the customers table.

The architect is interested in implementing a Type 1 table, overwriting existing records with new values and relying on Delta Lake time travel to support long-term auditing. A data engineer on the project feels that a Type 2 table will provide better performance and scalability.

Which piece of information is critical to this decision?

### é¸é …

- **A.** Data corruption can occur if a query fails in a partially completed state because Type 2 tables require setting multiple fields in a single update.
- **B.** Shallow clones can be combined with Type 1 tables to accelerate historic queries for long-term versioning.
- **C.** Delta Lake time travel cannot be used to query previous versions of these tables because Type 1 changes modify data files in place.
- **D.** Delta Lake time travel does not scale well in cost or latency to provide a long-term versioning solution.
- **E.** Delta Lake only supports Type 0 tables; once records are inserted to a Delta Lake table, they cannot be modified.

---

## æ¨™ç±¤ç³»çµ±

### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `Delta-Lake`, `Data-Modeling`, `Time-Travel`

### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** `Feature-Limitation`, `Cost-Performance`

### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** Data Engineering / Lakehouse Architecture

---

## ç­”æ¡ˆèˆ‡ä¾†æº

### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `D`

### ç­”æ¡ˆä¾†æº
- **ä¾†æºæ¨™è¨»ç­”æ¡ˆ:** D
- **ç¤¾ç¾¤æŠ•ç¥¨ç­”æ¡ˆ:** D (100%)

---

# é¡Œç›®è§£æ

---

## é¡Œç›®å›é¡§

### é¡Œç›®ç·¨è™Ÿèˆ‡é€£çµ
**é¡Œç›® ID:** `Q-097`
**é¡Œç›®é€£çµ:** [é»æ­¤è¿”å›é¡Œç›®](#question-97)

### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `D`

---

## ğŸ“ è€ƒé»è­˜åˆ¥

### ä¸»è¦è€ƒé»
**æ ¸å¿ƒæŠ€è¡“:** Delta Lake Time Travel Limitations & SCD Patterns
**çŸ¥è­˜é ˜åŸŸ:** Data Modeling / Performance Optimization
**é—œéµæ¦‚å¿µ:**
- Delta Lake Time Travel çš„é•·æœŸä½¿ç”¨é™åˆ¶ï¼ˆæˆæœ¬èˆ‡å»¶é²ï¼‰
- Type 1 vs Type 2 SCDï¼ˆSlowly Changing Dimensionï¼‰çš„è¨­è¨ˆæ¬Šè¡¡
- Delta Lake ç‰ˆæœ¬ä¿ç•™ç­–ç•¥ï¼ˆVACUUM èˆ‡ data retentionï¼‰

### æ¬¡è¦è€ƒé»
- Delta Lake çš„ç‰ˆæœ¬æ§åˆ¶æ©Ÿåˆ¶
- æ­·å²è³‡æ–™ç¨½æ ¸éœ€æ±‚çš„å¯¦ä½œç­–ç•¥
- å„²å­˜æˆæœ¬èˆ‡æŸ¥è©¢æ•ˆèƒ½çš„å¹³è¡¡

---

## âœ… æ­£è§£èªªæ˜

### ç‚ºä»€éº¼ D æ˜¯æ­£ç¢ºçš„ï¼Ÿ

**æŠ€è¡“åŸç†:**

Delta Lake Time Travel å…è¨±æŸ¥è©¢è¡¨æ ¼çš„æ­·å²ç‰ˆæœ¬ï¼Œä½† **ä¸é©åˆä½œç‚ºé•·æœŸç‰ˆæœ¬æ§åˆ¶æ–¹æ¡ˆ**ï¼ŒåŸå› å¦‚ä¸‹ï¼š

**1. æˆæœ¬ï¼ˆCostï¼‰å•é¡Œ:**
- æ¯æ¬¡è®Šæ›´éƒ½æœƒç”¢ç”Ÿ **æ–°çš„è³‡æ–™æª”æ¡ˆ**ï¼ˆParquet filesï¼‰
- èˆŠç‰ˆæœ¬çš„æª”æ¡ˆæœƒæŒçºŒä½”ç”¨å„²å­˜ç©ºé–“
- å¦‚æœé »ç¹æ›´æ–°ï¼ˆå¦‚æ¯å¤©æ›´æ–°å®¢æˆ¶åœ°å€ï¼‰ï¼Œæ­·å²æª”æ¡ˆæœƒå¿«é€Ÿç´¯ç©
- ä¾‹å¦‚ï¼š1 å€‹å®¢æˆ¶åœ°å€è®Šæ›´ 10 æ¬¡ = è‡³å°‘ 10 å€‹ç‰ˆæœ¬çš„è³‡æ–™æª”æ¡ˆ

**2. å»¶é²ï¼ˆLatencyï¼‰å•é¡Œ:**
- æŸ¥è©¢èˆŠç‰ˆæœ¬éœ€è¦ï¼š
  - è®€å– transaction log æ‰¾åˆ°å°æ‡‰ç‰ˆæœ¬
  - å®šä½è©²ç‰ˆæœ¬çš„è³‡æ–™æª”æ¡ˆ
  - è®€å–å¯èƒ½å·²ç¶“å¾ˆèˆŠçš„ Parquet æª”æ¡ˆ
- ç‰ˆæœ¬è¶ŠèˆŠï¼Œtransaction log è¶Šé•·ï¼ŒæŸ¥è©¢æ•ˆèƒ½è¶Šå·®
- è·¨å¤šå€‹ç‰ˆæœ¬çš„ç¨½æ ¸æŸ¥è©¢æœƒéå¸¸æ…¢

**3. VACUUM é™åˆ¶:**
- Delta Lake é è¨­ä¿ç•™ **7 å¤©** çš„æ­·å²è³‡æ–™ï¼ˆ`delta.deletedFileRetentionDuration`ï¼‰
- VACUUM æ“ä½œæœƒåˆªé™¤è¶…éä¿ç•™æœŸçš„èˆŠæª”æ¡ˆ
- å¦‚æœéœ€è¦ã€Œé•·æœŸç¨½æ ¸ã€ï¼ˆå¦‚ä¿ç•™æ•¸å¹´ï¼‰ï¼Œå¿…é ˆï¼š
  - ç¦ç”¨æˆ–å»¶é•· VACUUM æ™‚é–“ â†’ å„²å­˜æˆæœ¬æš´å¢
  - æˆ–æ¥å—èˆŠè³‡æ–™è¢«åˆªé™¤ â†’ ç„¡æ³•æ»¿è¶³ç¨½æ ¸éœ€æ±‚

**ç¬¦åˆéœ€æ±‚:**

é¡Œç›®çš„é—œéµéœ€æ±‚æ˜¯ã€Œmaintain a full record of all valid street addressesã€ï¼ˆç¶­è­·å®Œæ•´çš„åœ°å€è®Šæ›´è¨˜éŒ„ï¼‰ï¼Œé€™æ˜¯å…¸å‹çš„ **æ­·å²ç¨½æ ¸éœ€æ±‚**ã€‚

**æ­£ç¢ºæ±ºç­–:**
- **Type 2 SCD** æ›´é©åˆé•·æœŸç‰ˆæœ¬æ§åˆ¶ï¼š
  - æ¯ç­†è¨˜éŒ„åŒ…å«æœ‰æ•ˆèµ·å§‹/çµæŸæ™‚é–“ï¼ˆ`valid_from`, `valid_to`ï¼‰
  - æ–°è®Šæ›´ç›´æ¥æ’å…¥æ–°è¨˜éŒ„ï¼Œä¸åˆªé™¤èˆŠè³‡æ–™
  - æŸ¥è©¢ç‰¹å®šæ™‚é–“é»çš„è³‡æ–™ï¼š`WHERE valid_from <= '2024-01-01' AND valid_to > '2024-01-01'`
  - å„²å­˜æ•ˆç‡é«˜ï¼ŒæŸ¥è©¢é€Ÿåº¦å¿«ï¼ˆå–®æ¬¡è¡¨æƒæå³å¯ï¼‰

- **Type 1 + Time Travel** ä¸é©åˆé•·æœŸç¨½æ ¸ï¼š
  - éœ€è¦ä¿ç•™æ‰€æœ‰ç‰ˆæœ¬çš„è³‡æ–™æª”æ¡ˆ
  - æˆæœ¬éš¨æ™‚é–“ç·šæ€§å¢é•·
  - æŸ¥è©¢æ­·å²ç‰ˆæœ¬çš„å»¶é²éš¨ç‰ˆæœ¬æ•¸å¢åŠ 

**å¯¦å‹™ç¯„ä¾‹:**

```sql
-- âŒ Type 1 + Time Travelï¼ˆä¸é©åˆé•·æœŸç¨½æ ¸ï¼‰
UPDATE customers 
SET street_address = 'æ–°åœ°å€' 
WHERE customer_id = 123;

-- æŸ¥è©¢æ­·å²ç‰ˆæœ¬ï¼ˆéœ€è¦æŒ‡å®šç‰ˆæœ¬è™Ÿæˆ–æ™‚é–“æˆ³ï¼‰
SELECT * FROM customers VERSION AS OF 100 WHERE customer_id = 123;
-- âš ï¸ å•é¡Œï¼šç‰ˆæœ¬è™Ÿæœƒä¸æ–·å¢é•·ï¼ŒèˆŠç‰ˆæœ¬æª”æ¡ˆéœ€æ°¸ä¹…ä¿ç•™

-- âœ… Type 2 SCDï¼ˆé©åˆé•·æœŸç¨½æ ¸ï¼‰
INSERT INTO customers VALUES (
  123, 'æ–°åœ°å€', '2024-01-01', '9999-12-31', 1  -- current = true
);
UPDATE customers 
SET valid_to = '2024-01-01', current = 0 
WHERE customer_id = 123 AND current = 1;

-- æŸ¥è©¢æ­·å²åœ°å€ï¼ˆç°¡å–®é«˜æ•ˆï¼‰
SELECT * FROM customers 
WHERE customer_id = 123 
  AND valid_from <= '2023-12-01' 
  AND valid_to > '2023-12-01';
```

**æˆæœ¬å°æ¯”:**

| æ–¹æ¡ˆ | å„²å­˜æˆæœ¬ | æŸ¥è©¢å»¶é² | VACUUM å½±éŸ¿ | é•·æœŸå¯è¡Œæ€§ |
|-----|---------|---------|-----------|-----------|
| **Type 1 + Time Travel** | ğŸ“ˆ ç·šæ€§å¢é•· | â±ï¸ éš¨ç‰ˆæœ¬æ•¸å¢åŠ  | âš ï¸ å¿…é ˆç¦ç”¨æˆ–å»¶é•· | âŒ ä¸é©åˆ |
| **Type 2 SCD** | ğŸ“Š åƒ…å¢é‡å¢é•· | âš¡ å›ºå®šï¼ˆè¡¨æƒæï¼‰ | âœ… ä¸å½±éŸ¿æ­·å²è¨˜éŒ„ | âœ… é©åˆé•·æœŸ |

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### é¸é … A - "Data corruption can occur if a query fails in a partially completed state..."

**éŒ¯èª¤åŸå› :** æœæ’°çš„æŠ€è¡“å•é¡Œï¼ŒDelta Lake çš„ ACID ä¿è­‰ä¸æœƒç™¼ç”Ÿé€™ç¨®æƒ…æ³

**è©³ç´°åˆ†æ:**
- Delta Lake æä¾› **ACID äº‹å‹™ä¿è­‰**ï¼Œå³ä½¿æ›´æ–°å¤±æ•—ä¹Ÿä¸æœƒå°è‡´è³‡æ–™æå£
- Type 2 SCD çš„å¤šæ¬„ä½æ›´æ–°ï¼ˆ`valid_to`, `current` flagï¼‰æ˜¯ **åŸå­æ€§æ“ä½œ**
- å¦‚æœæ›´æ–°å¤±æ•—ï¼Œæ•´å€‹äº‹å‹™æœƒå›æ»¾ï¼Œè¡¨æ ¼ç‹€æ…‹ä¿æŒä¸€è‡´

**æ˜“æ··æ·†é»:**
å¯èƒ½è®“äººè¯æƒ³åˆ°ã€Œå¤šæ¬„ä½æ›´æ–°å®¹æ˜“å‡ºéŒ¯ã€ï¼Œä½† Delta Lake çš„äº‹å‹™æ©Ÿåˆ¶ç¢ºä¿ä¸æœƒç™¼ç”Ÿã€‚

---

### é¸é … B - "Shallow clones can be combined with Type 1 tables to accelerate historic queries..."

**éŒ¯èª¤åŸå› :** Shallow clones ä¸èƒ½è§£æ±ºé•·æœŸç‰ˆæœ¬æ§åˆ¶å•é¡Œ

**è©³ç´°åˆ†æ:**
- **Shallow clone** åªæ˜¯å»ºç«‹ metadata å±¤ç´šçš„è¤‡è£½ï¼ŒæŒ‡å‘åŸå§‹è³‡æ–™æª”æ¡ˆ
- ç•¶åŸå§‹è¡¨åŸ·è¡Œ VACUUM å¾Œï¼Œshallow clone æŒ‡å‘çš„æª”æ¡ˆæœƒè¢«åˆªé™¤
- ç„¡æ³•æä¾›ã€Œé•·æœŸç‰ˆæœ¬æ§åˆ¶ã€åŠŸèƒ½
- ä¸” Type 1 + Shallow clone ä»ç„¡æ³•è§£æ±ºã€ŒæŸ¥è©¢ç‰¹å®šæ™‚é–“é»è³‡æ–™ã€çš„éœ€æ±‚

**æ˜“æ··æ·†é»:**
ã€ŒClone + Time Travelã€è½èµ·ä¾†åƒæ˜¯ç‰ˆæœ¬æ§åˆ¶è§£æ±ºæ–¹æ¡ˆï¼Œä½†å¯¦éš›ä¸Šç„¡æ³•æ›¿ä»£ Type 2 SCDã€‚

---

### é¸é … C - "Delta Lake time travel cannot be used... because Type 1 changes modify data files in place."

**éŒ¯èª¤åŸå› :** æŠ€è¡“åŸç†å®Œå…¨éŒ¯èª¤

**è©³ç´°åˆ†æ:**
- Delta Lake **ä¸æœƒ** ä¿®æ”¹ç¾æœ‰è³‡æ–™æª”æ¡ˆï¼ˆParquet files æ˜¯ immutable çš„ï¼‰
- æ¯æ¬¡æ›´æ–°éƒ½æœƒç”¢ç”Ÿ **æ–°çš„è³‡æ–™æª”æ¡ˆ**ï¼Œä¸¦åœ¨ transaction log ä¸­è¨˜éŒ„
- Time Travel **å¯ä»¥** æŸ¥è©¢ Type 1 è¡¨çš„æ­·å²ç‰ˆæœ¬ï¼ˆåªè¦æª”æ¡ˆæœªè¢« VACUUM åˆªé™¤ï¼‰

**æ­£ç¢ºç†è§£:**
Delta Lake ä½¿ç”¨ **copy-on-write** ç­–ç•¥ï¼Œæ‰€æœ‰è®Šæ›´éƒ½æ˜¯æ–°å¢æª”æ¡ˆï¼Œä¸æ˜¯ä¿®æ”¹ç¾æœ‰æª”æ¡ˆã€‚

---

### é¸é … E - "Delta Lake only supports Type 0 tables; once records are inserted..."

**éŒ¯èª¤åŸå› :** å®Œå…¨éŒ¯èª¤ï¼ŒDelta Lake æ”¯æ´æ‰€æœ‰ SCD é¡å‹

**è©³ç´°åˆ†æ:**
- Delta Lake æ”¯æ´ **UPDATE**, **DELETE**, **MERGE** æ“ä½œ
- å¯ä»¥å¯¦ä½œ Type 0, Type 1, Type 2, Type 3 ç­‰æ‰€æœ‰ SCD æ¨¡å¼
- é€™å€‹é¸é …æ˜¯å®Œå…¨æœæ’°çš„é™åˆ¶

**æ˜“æ··æ·†é»:**
å¯èƒ½è®“äººè¯æƒ³åˆ°ã€ŒAppend-only è¡¨æ ¼ã€ï¼Œä½†é‚£æ˜¯è¨­è¨ˆé¸æ“‡ï¼Œä¸æ˜¯ Delta Lake çš„é™åˆ¶ã€‚

---

## ğŸ§  è¨˜æ†¶æ³•èˆ‡å°æ¯”

### è¨˜æ†¶å£è¨£
**ã€ŒTime Travel çŸ­æœŸç”¨ï¼ŒType 2 é•·æœŸç•™ã€**
- **çŸ­æœŸç”¨**: Time Travel é©åˆçŸ­æœŸå›æº¯ï¼ˆå¹¾å¤©åˆ°å¹¾é€±ï¼‰
- **é•·æœŸç•™**: Type 2 SCD é©åˆé•·æœŸç¨½æ ¸ï¼ˆæ•¸æœˆåˆ°æ•¸å¹´ï¼‰

### é—œéµå°æ¯”è¡¨

| ç‰¹æ€§ | Type 1 + Time Travel | Type 2 SCD |
|------|---------------------|-----------|
| **æ­·å²ä¿å­˜æ–¹å¼** | Delta Lake ç‰ˆæœ¬æ§åˆ¶ | è³‡æ–™åˆ—å…§å»ºæ™‚é–“æˆ³ |
| **å„²å­˜æˆæœ¬** | ğŸ“ˆ éš¨ç‰ˆæœ¬æ•¸ç·šæ€§å¢é•· | ğŸ“Š åƒ…å¢é‡å¢é•·ï¼ˆæ–°è¨˜éŒ„ï¼‰ |
| **æŸ¥è©¢è¤‡é›œåº¦** | éœ€æŒ‡å®šç‰ˆæœ¬æˆ–æ™‚é–“æˆ³ | æ¨™æº– WHERE æ¢ä»¶å³å¯ |
| **VACUUM å½±éŸ¿** | âš ï¸ èˆŠç‰ˆæœ¬æœƒè¢«åˆªé™¤ | âœ… ä¸å½±éŸ¿æ­·å²è¨˜éŒ„ |
| **é•·æœŸå¯è¡Œæ€§** | âŒ æˆæœ¬èˆ‡å»¶é²å•é¡Œ | âœ… é©åˆé•·æœŸç¨½æ ¸ |
| **å¯¦ä½œè¤‡é›œåº¦** | ç°¡å–®ï¼ˆç›´æ¥ UPDATEï¼‰ | ä¸­ç­‰ï¼ˆéœ€ç®¡ç†æ™‚é–“æˆ³ï¼‰ |

### SCD é¡å‹é€ŸæŸ¥

| SCD é¡å‹ | æè¿° | Delta Lake å¯¦ä½œ | é©ç”¨æƒ…å¢ƒ |
|---------|------|----------------|---------|
| **Type 0** | ä¸å…è¨±è®Šæ›´ | INSERT only | ä¸å¯è®Šè³‡æ–™ï¼ˆå¦‚äº¤æ˜“è¨˜éŒ„ï¼‰ |
| **Type 1** | è¦†å¯«èˆŠå€¼ | UPDATE | åªéœ€ç•¶å‰å€¼ï¼ˆå¦‚å®¢æˆ¶é›»è©±ï¼‰ |
| **Type 2** | ä¿ç•™æ­·å²è¨˜éŒ„ | INSERT + UPDATE flags | ç¨½æ ¸éœ€æ±‚ï¼ˆå¦‚åœ°å€è®Šæ›´ï¼‰ |
| **Type 3** | ä¿ç•™éƒ¨åˆ†æ­·å² | å¢åŠ  `previous_*` æ¬„ä½ | åªéœ€ä¿ç•™å‰ä¸€å€‹å€¼ |

### å¯¦å‹™æ±ºç­–æ¨¹

```
éœ€æ±‚ï¼šé•·æœŸç¶­è­·è³‡æ–™è®Šæ›´æ­·å²
â”œâ”€ æŸ¥è©¢é »ç‡é«˜ï¼Ÿ
â”‚  â”œâ”€ æ˜¯ â†’ Type 2 SCDï¼ˆæŸ¥è©¢æ•ˆèƒ½å„ªï¼‰
â”‚  â””â”€ å¦ â†’ è€ƒæ…® Time Travelï¼ˆå¯¦ä½œç°¡å–®ï¼‰
â”œâ”€ ä¿ç•™æœŸé™ï¼Ÿ
â”‚  â”œâ”€ < 7 å¤© â†’ Time Travel è¶³å¤ 
â”‚  â”œâ”€ 7-30 å¤© â†’ Time Travelï¼ˆå»¶é•· VACUUMï¼‰
â”‚  â””â”€ > 30 å¤© â†’ Type 2 SCDï¼ˆé¿å…æˆæœ¬æš´å¢ï¼‰
â””â”€ å„²å­˜é ç®—ï¼Ÿ
   â”œâ”€ æœ‰é™ â†’ Type 2 SCD
   â””â”€ å……è¶³ â†’ å¯è€ƒæ…® Time Travel
```

---

## ğŸ“š å»¶ä¼¸å­¸ç¿’

### å®˜æ–¹æ–‡ä»¶
- [Delta Lake Time Travel](https://docs.databricks.com/delta/history.html)
- [Delta Lake VACUUM](https://docs.databricks.com/delta/vacuum.html)
- [Slowly Changing Dimensions in Delta Lake](https://docs.databricks.com/delta/data-transformation-patterns.html)

### ç›¸é—œé¡Œç›®
- Q-XXX: Delta Lake VACUUM çš„è¨­å®šèˆ‡å½±éŸ¿
- Q-XXX: MERGE æ“ä½œå¯¦ä½œ Type 2 SCD
- Q-XXX: Delta Lake å…‹éš†ï¼ˆCloneï¼‰çš„é¡å‹èˆ‡æ‡‰ç”¨

---

## ğŸ¯ é‡é»æé†’

> **æ ¸å¿ƒè§€å¿µ:** Delta Lake Time Travel æ˜¯çŸ­æœŸå›æº¯åŠŸèƒ½ï¼Œä¸é©åˆä½œç‚ºé•·æœŸç‰ˆæœ¬æ§åˆ¶è§£æ±ºæ–¹æ¡ˆã€‚å°æ–¼éœ€è¦é•·æœŸç¶­è­·æ­·å²è¨˜éŒ„çš„ç¨½æ ¸éœ€æ±‚ï¼ŒType 2 SCD åœ¨æˆæœ¬ã€æ•ˆèƒ½ã€å¯ç¶­è­·æ€§ä¸Šéƒ½æ›´å„ªã€‚

**è€ƒè©¦é™·é˜±:**
- âŒ èª¤ä»¥ç‚º Time Travel å¯ä»¥ç„¡é™æœŸä¿ç•™æ­·å²
- âŒ å¿½ç•¥ VACUUM å° Time Travel çš„å½±éŸ¿
- âŒ ä½ä¼°é•·æœŸä½¿ç”¨ Time Travel çš„æˆæœ¬

**æ­£ç¢ºæ€ç¶­:**
- âœ… Time Travel = çŸ­æœŸå›æº¯ï¼ˆé™¤éŒ¯ã€å¿«é€Ÿæ¢å¾©ï¼‰
- âœ… Type 2 SCD = é•·æœŸç¨½æ ¸ï¼ˆæ­·å²è¿½è¹¤ã€åˆè¦éœ€æ±‚ï¼‰
- âœ… æˆæœ¬èˆ‡æ•ˆèƒ½æ˜¯é—œéµæ±ºç­–å› ç´ 