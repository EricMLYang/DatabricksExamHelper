# Question #60

---

## é¡Œç›®è³‡è¨Š

### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-060`

### ä¾†æº
**ä¾†æº:** Real Exam Recall

### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L3-Advanced`

---

## é¡Œç›®å…§å®¹

### é¡Œå¹¹

The data engineering team maintains a table of aggregate statistics through batch nightly updates.

This includes total sales for the previous day alongside totals and averages for a variety of time periods including the 7 previous days, year-to-date, and quarter-to-date.

This table is named store_sales_summary and the schema is as follows:

```
store_id INT, total_sales_qtd FLOAT, avg_daily_sales_qtd FLOAT, total_sales_ytd FLOAT, avg_daily_sales_ytd FLOAT, previous_day_sales FLOAT, total_sales_7d FLOAT, avg_daily_sales_7d FLOAT, updated TIMESTAMP
```

The table daily_store_sales contains all the information needed to update store_sales_summary.

The schema for this table is:

```
store_id INT, sales_date DATE, total_sales FLOAT
```

If daily_store_sales is implemented as a Type 1 table and the total_sales column might be adjusted after manual data auditing, which approach is the safest to generate accurate reports in the store_sales_summary table?

### é¸é …

- **A.** Implement the appropriate aggregate logic as a batch read against the daily_store_sales table and overwrite the store_sales_summary table with each Update.
- **B.** Implement the appropriate aggregate logic as a batch read against the daily_store_sales table and append new rows nightly to the store_sales_summary table.
- **C.** Implement the appropriate aggregate logic as a batch read against the daily_store_sales table and use upsert logic to update results in the store_sales_summary table.
- **D.** Implement the appropriate aggregate logic as a Structured Streaming read against the daily_store_sales table and use upsert logic to update results in the store_sales_summary table.
- **E.** Use Structured Streaming to subscribe to the change data feed for daily_store_sales and apply changes to the aggregates in the store_sales_summary table with each update.

---

## æ¨™ç±¤ç³»çµ±

### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `Aggregate-Tables`, `Type-1-SCD`, `Batch-Processing`, `Data-Auditing`

### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** `Update-Strategy`, `Batch-vs-Stream`

### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** `Data Engineering`

---

## ç­”æ¡ˆèˆ‡è§£æé€£çµ

### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `C`

### è§£ææª”æ¡ˆ
**è©³ç´°è§£æ:** [é»æ­¤æŸ¥çœ‹è§£æ](../analysis/Q-060-analysis.md)

**å‚™è¨»:** Community discussion has splits between A and C/E.

---

# è©³ç´°è§£æ

## ğŸ“ è€ƒé»è­˜åˆ¥

### ä¸»è¦è€ƒé»
**æ ¸å¿ƒæŠ€è¡“:** Type 1 SCD èˆ‡èšåˆè¡¨ç¶­è­·ç­–ç•¥  
**çŸ¥è­˜é ˜åŸŸ:** æ•¸æ“šå»ºæ¨¡èˆ‡æ‰¹æ¬¡è™•ç†  
**é—œéµæ¦‚å¿µ:** Upsert vs Overwriteã€æ•¸æ“šä¸€è‡´æ€§ã€Type 1 SCD ç‰¹æ€§

### æ¬¡è¦è€ƒé»
- Batch vs Streaming è™•ç†é¸æ“‡
- æ•¸æ“šç¨½æ ¸å°ä¸‹æ¸¸å½±éŸ¿
- èšåˆè¡¨æ›´æ–°ç­–ç•¥

---

## âœ… æ­£è§£èªªæ˜

### ç‚ºä»€éº¼ C æ˜¯æ­£ç¢ºçš„ï¼Ÿ

**æŠ€è¡“åŸç†:**
åœ¨ Type 1 SCD å¯¦ä½œä¸­ï¼Œæ­·å²æ•¸æ“šå¯èƒ½å› ç‚ºç¨½æ ¸è€Œè¢«ä¿®æ­£ã€‚ä½¿ç”¨ MERGE INTO (upsert) å¯ä»¥ï¼š
- ç•¶ store_id å­˜åœ¨æ™‚æ›´æ–°ç¾æœ‰è¨˜éŒ„
- ç•¶ store_id ä¸å­˜åœ¨æ™‚æ’å…¥æ–°è¨˜éŒ„
- ç¢ºä¿æ¯æ¬¡æ‰¹æ¬¡è™•ç†éƒ½èƒ½åæ˜ æœ€æ–°çš„æ•¸æ“šç‹€æ…‹

**ç¬¦åˆéœ€æ±‚:**
- **è™•ç†æ•¸æ“šä¿®æ­£:** ç•¶ daily_store_sales ä¸­çš„æ­·å²æ•¸æ“šè¢«ç¨½æ ¸ä¿®æ­£æ™‚ï¼Œupsert èƒ½é‡æ–°è¨ˆç®—ä¸¦æ›´æ–°å°æ‡‰çš„èšåˆçµ±è¨ˆ
- **ä¿æŒæº–ç¢ºæ€§:** é¿å…å› æ­·å²æ•¸æ“šä¿®æ­£è€Œç”¢ç”Ÿçš„èšåˆçµæœä¸ä¸€è‡´
- **æ‰¹æ¬¡è™•ç†:** ä½¿ç”¨æ‰¹æ¬¡è®€å–å¯ä»¥å®Œæ•´æƒææ‰€æœ‰ç›¸é—œæ­·å²æ•¸æ“šé€²è¡Œé‡æ–°è¨ˆç®—

**å¯¦å‹™æ‡‰ç”¨:**
```sql
MERGE INTO store_sales_summary AS target
USING (
  SELECT 
    store_id,
    SUM(CASE WHEN sales_date >= quarter_start THEN total_sales END) as total_sales_qtd,
    AVG(CASE WHEN sales_date >= quarter_start THEN total_sales END) as avg_daily_sales_qtd,
    -- å…¶ä»–èšåˆè¨ˆç®—...
  FROM daily_store_sales 
  WHERE sales_date <= current_date()
  GROUP BY store_id
) AS source
ON target.store_id = source.store_id
WHEN MATCHED THEN UPDATE SET *
WHEN NOT MATCHED THEN INSERT *
```

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### é¸é … A - å®Œå…¨è¦†å¯«è¡¨æ ¼
**éŒ¯èª¤åŸå› :** éåº¦æš´åŠ›ä¸”ä¸å¿…è¦

**è©³ç´°åˆ†æ:**
é›–ç„¶è¦†å¯«æ•´å€‹è¡¨æ ¼ä¹Ÿèƒ½è§£æ±ºæ•¸æ“šä¸€è‡´æ€§å•é¡Œï¼Œä½†é€™ç¨®åšæ³•ï¼š
- **æ•ˆèƒ½å•é¡Œ:** æ¯æ¬¡éƒ½é‡å¯«æ•´å€‹è¡¨æ ¼ï¼Œå³ä½¿åªæœ‰å°‘æ•¸è¨˜éŒ„éœ€è¦æ›´æ–°
- **è³‡æºæµªè²»:** éœ€è¦é‡æ–°è¨ˆç®—æ‰€æœ‰ store çš„çµ±è¨ˆæ•¸æ“š
- **é–å®šæ™‚é–“é•·:** è¦†å¯«æ“ä½œæœƒé–å®šæ•´å€‹è¡¨æ ¼æ›´ä¹…
- **ç‰ˆæœ¬æ­·å²ä¸Ÿå¤±:** å¤±å» Delta Lake çš„ç‰ˆæœ¬æ§åˆ¶å„ªå‹¢

**æ˜“æ··æ·†é»:**
è¦†å¯«ç¢ºå¯¦èƒ½ä¿è­‰æ•¸æ“šä¸€è‡´æ€§ï¼Œä½†åœ¨æ•ˆèƒ½å’Œè³‡æºä½¿ç”¨ä¸Šä¸å¦‚ upsert ç²¾ç¢º

### é¸é … B - åªåš Append æ“ä½œ
**éŒ¯èª¤åŸå› :** ç„¡æ³•è™•ç†æ•¸æ“šä¿®æ­£æƒ…æ³

**è©³ç´°åˆ†æ:**
Append æ“ä½œåªèƒ½æ–°å¢è³‡æ–™ï¼Œç„¡æ³•æ›´æ–°ç¾æœ‰è¨˜éŒ„ï¼š
- **ç„¡æ³•ä¿®æ­£:** ç•¶æ­·å²æ•¸æ“šè¢«ç¨½æ ¸ä¿®æ­£æ™‚ï¼Œç„¡æ³•æ›´æ–°å·²å­˜åœ¨çš„èšåˆçµ±è¨ˆ
- **æ•¸æ“šé‡è¤‡:** æ¯æ¬¡æ‰¹æ¬¡éƒ½æœƒç”¢ç”Ÿæ–°çš„è¨˜éŒ„ï¼Œé€ æˆåŒä¸€å€‹ store_id æœ‰å¤šç­†è¨˜éŒ„
- **æŸ¥è©¢è¤‡é›œåŒ–:** ä¸‹æ¸¸ç³»çµ±éœ€è¦é¡å¤–é‚è¼¯ä¾†é¸æ“‡æœ€æ–°çš„çµ±è¨ˆæ•¸æ“š

**æ˜“æ··æ·†é»:**
æ–°æ‰‹å®¹æ˜“èªç‚º append æ¯”è¼ƒç°¡å–®å®‰å…¨ï¼Œä½†å¿½ç•¥äº†æ•¸æ“šä¿®æ­£çš„éœ€æ±‚

### é¸é … D - ä½¿ç”¨ Structured Streaming + Upsert
**éŒ¯èª¤åŸå› :** æ¶æ§‹éåº¦è¤‡é›œä¸”ä¸é©åˆæ­¤å ´æ™¯

**è©³ç´°åˆ†æ:**
é›–ç„¶ upsert é‚è¼¯æ­£ç¢ºï¼Œä½†ä½¿ç”¨ Streaming æœ‰å•é¡Œï¼š
- **æ­·å²æ•¸æ“šè™•ç†:** Streaming ä¸»è¦è™•ç†å¢é‡æ•¸æ“šï¼Œé›£ä»¥æœ‰æ•ˆè™•ç†å¤§ç¯„åœçš„æ­·å²æ•¸æ“šä¿®æ­£
- **è¤‡é›œåº¦æå‡:** éœ€è¦ç¶­è­·é¡å¤–çš„ streaming job å’Œç‹€æ…‹ç®¡ç†
- **å»¶é²å•é¡Œ:** streaming çš„å¾®æ‰¹æ¬¡è™•ç†å¯èƒ½ä¸å¦‚æ‰¹æ¬¡è™•ç†ä¾†å¾—åŠæ™‚å®Œæ•´

**æ˜“æ··æ·†é»:**
streaming + upsert åœ¨æŠ€è¡“ä¸Šå¯è¡Œï¼Œä½†å°æ–¼æ‰¹æ¬¡å¤œé–“æ›´æ–°çš„å ´æ™¯éæ–¼è¤‡é›œ

### é¸é … E - CDC + Streaming è™•ç†
**éŒ¯èª¤åŸå› :** æŠ€è¡“æ¶æ§‹èˆ‡éœ€æ±‚ä¸åŒ¹é…

**è©³ç´°åˆ†æ:**
Change Data Feed (CDC) é©åˆå³æ™‚è™•ç†å¢é‡è®Šæ›´ï¼Œä½†æ­¤å ´æ™¯ï¼š
- **æ‰¹æ¬¡ç‰¹æ€§:** é¡Œç›®æ˜ç¢ºæåˆ°æ˜¯ "batch nightly updates"
- **èšåˆç¯„åœ:** éœ€è¦è·¨æ™‚é–“ç¯„åœçš„èšåˆè¨ˆç®— (QTD, YTD, 7å¤©)ï¼ŒCDC é›£ä»¥é«˜æ•ˆè™•ç†
- **è¤‡é›œåº¦éé«˜:** éœ€è¦ç¶­è­·è¤‡é›œçš„å¢é‡èšåˆé‚è¼¯
- **è³‡æºæ¶ˆè€—:** æŒçºŒç›£æ§è®Šæ›´æœƒæ¶ˆè€—æ›´å¤šè³‡æº

**æ˜“æ··æ·†é»:**
CDC æ˜¯ç¾ä»£åŒ–æ•¸æ“šè™•ç†çš„è¶‹åŠ¿ï¼Œä½†è¦é¸æ“‡åˆé©çš„å ´æ™¯ä½¿ç”¨

---

## ğŸ§  è¨˜æ†¶æ³•èˆ‡è§£é¡ŒæŠ€å·§

### è¨˜æ†¶å£è¨£
**"Type 1 æœƒä¿®æ­£ï¼ŒUpsert æœ€å®‰å¿ƒ"** - Type 1 SCD æœƒä¿®æ”¹æ­·å²æ•¸æ“šï¼Œæ‰€ä»¥éœ€è¦èƒ½æ›´æ–°çš„ç­–ç•¥

**"æ‰¹æ¬¡å¤œæ›´æ–°ï¼Œä¸ç”¨ Stream æ¹Šç†±é¬§"** - æ˜ç¢ºçš„æ‰¹æ¬¡æ›´æ–°å ´æ™¯ä¸éœ€è¦è¤‡é›œçš„ streaming æ¶æ§‹

### è§£é¡Œæ­¥é©Ÿ
1. **è­˜åˆ¥é¡Œç›®é¡å‹** - çœ‹åˆ° "Type 1 SCD" + "æ•¸æ“šç¨½æ ¸ä¿®æ­£" = éœ€è¦æ”¯æ´æ›´æ–°çš„ç­–ç•¥
2. **æ’é™¤æ˜é¡¯éŒ¯èª¤** - æ’é™¤åªèƒ½ append çš„é¸é … B
3. **æ¯”è¼ƒå‰©é¤˜é¸é …** - åœ¨ overwriteã€upsertã€streaming ä¸­é¸æ“‡æœ€é©åˆæ‰¹æ¬¡æ›´æ–°çš„
4. **ç¢ºèªæ­£è§£** - upsert æä¾›ç²¾ç¢ºæ›´æ–° + æ‰¹æ¬¡è™•ç†æä¾›å®Œæ•´æƒæ

### å¸¸è¦‹é™·é˜±è­¦ç¤º
âš ï¸ **é™·é˜± 1: éåº¦è¨­è¨ˆ** - çœ‹åˆ°æ–°æŠ€è¡“ (CDC, Streaming) å°±æƒ³ä½¿ç”¨ï¼Œå¿½ç•¥å¯¦éš›éœ€æ±‚çš„ç°¡æ½”æ€§
âš ï¸ **é™·é˜± 2: å¿½ç•¥æ•¸æ“šä¿®æ­£** - æ²’æ³¨æ„åˆ° "manual data auditing" æš—ç¤ºæ­·å²æ•¸æ“šå¯èƒ½è®Šæ›´

---

## ğŸ“š å®˜æ–¹æ–‡ä»¶èˆ‡å»¶ä¼¸é–±è®€

### å®˜æ–¹æ–‡ä»¶
1. **[MERGE INTO SQL Statement](https://docs.databricks.com/sql/language-manual/delta-merge-into.html)** - Delta Lake çš„ upsert æ“ä½œå®Œæ•´èªæ³•èˆ‡ç¯„ä¾‹
2. **[Type 1 and Type 2 SCD Patterns](https://docs.databricks.com/delta/slowly-changing-dimensions.html)** - ç·©æ…¢è®ŠåŒ–ç¶­åº¦çš„è™•ç†ç­–ç•¥

### å»¶ä¼¸é–±è®€
- [Delta Lake Best Practices for Aggregate Tables](https://docs.databricks.com/optimizations/semi-structured.html)
- [Batch vs Stream Processing Decision Guide](https://docs.databricks.com/structured-streaming/concepts.html)

### ç›¸é—œé¡Œç›®
- `Q-031` - Delta Lake MERGE INTO èªæ³•æ‡‰ç”¨
- `Q-047` - æ‰¹æ¬¡è™•ç† vs ä¸²æµè™•ç†é¸æ“‡ç­–ç•¥

---

## ç›¸é—œè³‡æº

### å®˜æ–¹æ–‡ä»¶
- [MERGE INTO](https://docs.databricks.com/sql/language-manual/delta-merge-into.html)
- [Aggregate Tables Best Practices](https://docs.databricks.com/optimizations/semi-structured.html)
