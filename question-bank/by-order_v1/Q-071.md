# Question #71

---

## é¡Œç›®è³‡è¨Š

### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-071`

### ä¾†æº
**ä¾†æº:** Community Contributed (Real Exam-style)

### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L2-Intermediate`

---

## é¡Œç›®å…§å®¹

### é¡Œå¹¹
A junior data engineer has been asked to develop a streaming data pipeline with a grouped aggregation using DataFrame `df`. The pipeline needs to calculate the average humidity and average temperature for each non-overlapping five-minute interval. Incremental state information should be maintained for 10 minutes for late-arriving data.

Streaming DataFrame `df` schema: `device_id INT, event_time TIMESTAMP, temp FLOAT, humidity FLOAT`

ç¨‹å¼ç¢¼å€å¡Šï¼š
```python
df \
[ç©ºç™½è™•] \
.groupBy(
    window("event_time", "5 minutes").alias("time"),
    "device_id"
) \
.agg(
    avg("temp").alias("avg_temp"),
    avg("humidity").alias("avg_humidity")
) \
.writeStream \
.format("delta") \
.saveAsTable("sensor_avg")
```

### é¸é …
- **A.** `withWatermark("event_time", "10 minutes")`
- **B.** `awaitArrival("event_time", "10 minutes")`
- **C.** `await("event_time + '10 minutes")`
- **D.** `slidingWindow("event_time", "10 minutes")`
- **E.** `delayWrite("event_time", "10 minutes")`

---

## æ¨™ç±¤ç³»çµ±

### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `Streaming`, `Streaming-Windowing`

### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** `Execution-Behavior`, `Similar-Function`

### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** `Streaming`

---

## ç­”æ¡ˆèˆ‡è§£æé€£çµ

### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `A`

### è§£ææª”æ¡ˆ
**è©³ç´°è§£æ:** ä¸‹æ–¹æ•´åˆè§£æ

---

## ç›¸é—œè³‡æº

### å®˜æ–¹æ–‡ä»¶
- [Watermarking late data](https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html#handling-late-data-and-watermarking)
- [Window operations on event-time](https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html#window-operations-on-event-time)

---

## è§£é¡Œè§£æï¼ˆæ•´åˆï¼‰

### ç‚ºä»€éº¼ A æ˜¯æ­£ç¢ºçš„ï¼Ÿ
- `withWatermark("event_time", "10 minutes")` æ˜¯ Structured Streaming è™•ç†é²åˆ°è³‡æ–™çš„å®˜æ–¹æ–¹å¼ï¼Œè¨­å®š 10 åˆ†é˜æµ®æ°´å°å³å¯åœ¨ 5 åˆ†é˜ç¿»è½‰è¦–çª—å…§ä¿ç•™å¢é‡ç‹€æ…‹ï¼Œç´å…¥ 10 åˆ†é˜å…§çš„ late eventsã€‚
- é¡Œç›®è¦æ±‚ã€Œä¸é‡ç–Šçš„äº”åˆ†é˜é–“éš”ã€å·²ç”± `window("event_time", "5 minutes")` è™•ç†ï¼Œä¸éœ€è¦ sliding windowï¼›åªéœ€åœ¨ groupBy ä¹‹å‰åŠ ä¸Š watermark å³å¯ã€‚
- ç¤¾ç¾¤èˆ‡å°ˆå®¶æŒ‡å‡ºåŸæ¨™è¨»ç­”æ¡ˆ D å…¶å¯¦ä¸ç¬¦æ¢ä»¶ï¼š`slidingWindow` ä¸ä½†èªæ³•ä¸åŒï¼Œä¹Ÿæœƒç”¢ç”Ÿé‡ç–Šè¦–çª—ï¼Œé•åã€Œnon-overlappingã€æ•˜è¿°ã€‚

### éŒ¯èª¤é¸é …æ’é™¤
- **B / C / E**ï¼šä¸¦é Spark APIï¼Œå±¬è™›æ§‹æˆ–éŒ¯èª¤æ–¹æ³•ï¼Œç„¡æ³•è¨­å®š late data é–¾å€¼ã€‚
- **D**ï¼š`slidingWindow` æœƒå»ºç«‹é‡ç–Šè¦–çª—ä¸”éœ€è¦ä¸åŒèªæ³•ï¼Œèˆ‡é¡Œç›®ã€Œnon-overlapping five-minute intervalã€ä¸ç¬¦ï¼Œä¸”ä¸è™•ç† watermarkï¼›ç„¡æ³•é”æˆ 10 åˆ†é˜é²åˆ°ä¿ç•™éœ€æ±‚ã€‚

### è¨˜æ†¶å£è¨£
- **ã€Œçª—å£å®šé•·åº¦ï¼Œæµ®æ°´å°å®šé²åˆ°ã€**ï¼š`window()` æ±ºå®šè¦–çª—å½¢ç‹€èˆ‡é•·åº¦ï¼Œ`withWatermark()` æ±ºå®šé²åˆ°è³‡æ–™ä¿ç•™æœŸé™ã€‚

### è§£é¡Œæ­¥é©Ÿ
1. è­˜åˆ¥éœ€æ±‚ï¼šç¿»è½‰è¦–çª— 5 åˆ†é˜ + late data 10 åˆ†é˜ã€‚
2. è¦–çª—ç”¨ `window(col, '5 minutes')`ï¼›é²åˆ°è™•ç†ç”¨ `withWatermark(col, '10 minutes')`ã€‚
3. æ’é™¤é API æˆ–æœƒå°è‡´é‡ç–Šè¦–çª—/ä¸è™•ç† watermark çš„é¸é …ã€‚

### å¸¸è¦‹é™·é˜±è­¦ç¤º
- âš ï¸ æŠŠ `slidingWindow` ç•¶æˆ watermarkï¼šå®ƒåªå®šç¾©è¦–çª—å½¢ç‹€ï¼Œç„¡æ³•è™•ç†é²åˆ°é–¾å€¼ã€‚
- âš ï¸ å¿˜è¨˜ watermarkï¼šæ²’æœ‰ `withWatermark` æ™‚ï¼Œç‹€æ…‹ä¸æœƒåŠæ™‚æ¸…é™¤ï¼Œæˆ–ç„¡æ³•ä¿ç•™é²åˆ°è³‡æ–™çš„æœŸæœ›æ™‚é–“ã€‚

---

## ğŸ·ï¸ æ¨™ç±¤èˆ‡åˆ†é¡
**Topics:** `Streaming`, `Streaming-Windowing`
**Traps:** `Execution-Behavior`, `Similar-Function`
**Difficulty:** `L2-Intermediate`
