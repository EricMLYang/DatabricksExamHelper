# Q-092

## é¡Œç›®è³‡è¨Š

**ID:** `Q-092`

**ä¾†æº:** Mock Exam

**é›£åº¦:** `L2-Intermediate`

---

## é¡Œç›®å…§å®¹

### é¡Œå¹¹

In order to prevent accidental commits to production data, a senior data engineer has instituted a policy that all development work will reference clones of Delta Lake tables. After testing both DEEP and SHALLOW CLONE, development tables are created using SHALLOW CLONE.

A few weeks after initial table creation, the cloned versions of several tables implemented as Type 1 Slowly Changing Dimension (SCD) stop working. The transaction logs for the source tables show that VACUUM was run the day before.

Which statement describes why the cloned tables are no longer working?

### é¸é …

- **A.** Because Type 1 changes overwrite existing records, Delta Lake cannot guarantee data consistency for cloned tables.
- **B.** Running VACUUM automatically invalidates any shallow clones of a table; DEEP CLONE should always be used when a cloned table will be repeatedly queried.
- **C.** Tables created with SHALLOW CLONE are automatically deleted after their default retention threshold of 7 days.
- **D.** The metadata created by the CLONE operation is referencing data files that were purged as invalid by the VACUUM command.
- **E.** The data files compacted by VACUUM are not tracked by the cloned metadata; running REFRESH on the cloned table will pull in recent changes.

---

## æ¨™ç±¤ç³»çµ±

**Topics:** `Delta-Lake`, `Table-Cloning`, `VACUUM`

**Traps:** `Clone-Type-Confusion`, `VACUUM-Side-Effect`

**Domain:** `é–‹ç™¼èˆ‡è½‰æ› (Development & Transformation)`

---

## ç­”æ¡ˆèˆ‡åˆ†æ

### æ­£ç¢ºç­”æ¡ˆ

**æ­£è§£:** `D`

**ç¤¾ç¾¤æŠ•ç¥¨:** D (89%)
**ä¾†æºæ¨™è¨»:** D

---

## ğŸ“ è€ƒé»è­˜åˆ¥

### ä¸»è¦è€ƒé»
**æ ¸å¿ƒæŠ€è¡“:** Delta Lake SHALLOW CLONE vs DEEP CLONE
**çŸ¥è­˜é ˜åŸŸ:** é–‹ç™¼èˆ‡è½‰æ› - Delta Lake è¡¨å…‹éš†èˆ‡è³‡æ–™ç®¡ç†
**é—œéµæ¦‚å¿µ:** 
- SHALLOW CLONE çš„ metadata-only ç‰¹æ€§
- VACUUM åˆªé™¤è³‡æ–™æª”æ¡ˆçš„æ©Ÿåˆ¶
- Clone è¡¨èˆ‡ä¾†æºè¡¨çš„ä¾è³´é—œä¿‚

### æ¬¡è¦è€ƒé»
- Type 1 SCD çš„å¯¦ä½œæ–¹å¼
- Delta Lake äº‹å‹™æ—¥èªŒ
- VACUUM çš„é è¨­ä¿ç•™æœŸé™ï¼ˆ7 å¤©ï¼‰

---

## âœ… æ­£è§£èªªæ˜

### ç‚ºä»€éº¼ D æ˜¯æ­£ç¢ºçš„ï¼Ÿ

**æŠ€è¡“åŸç†:**

**SHALLOW CLONE çš„é‹ä½œæ©Ÿåˆ¶ï¼š**

```
SHALLOW CLONE ç‰¹æ€§ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Source Table (ç”Ÿç”¢è¡¨)                 â”‚
â”‚  â”œâ”€ Metadata (transaction log)        â”‚
â”‚  â””â”€ Data Files (Parquet files)        â”‚
â”‚       â”œâ”€ file1.parquet                 â”‚
â”‚       â”œâ”€ file2.parquet                 â”‚
â”‚       â””â”€ file3.parquet                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ SHALLOW CLONE
         â†“ (åªè¤‡è£½ metadata)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cloned Table (é–‹ç™¼è¡¨)                 â”‚
â”‚  â”œâ”€ Metadata (ç¨ç«‹çš„ transaction log) â”‚
â”‚  â””â”€ Data Files â† å¼•ç”¨ä¾†æºè¡¨çš„æª”æ¡ˆï¼     â”‚
â”‚       â”œâ”€ â†’ file1.parquet (reference)   â”‚
â”‚       â”œâ”€ â†’ file2.parquet (reference)   â”‚
â”‚       â””â”€ â†’ file3.parquet (reference)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é—œéµï¼šSHALLOW CLONE ä¸è¤‡è£½è³‡æ–™æª”æ¡ˆï¼Œ
      åªæ˜¯å»ºç«‹æŒ‡å‘ä¾†æºæª”æ¡ˆçš„ metadata å¼•ç”¨
```

**VACUUM çš„å½±éŸ¿ï¼š**

```
æ™‚é–“è»¸ï¼š

Week 1: å»ºç«‹ SHALLOW CLONE
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Source Table            â”‚
â”‚ â”œâ”€ file1.parquet        â”‚
â”‚ â”œâ”€ file2.parquet        â”‚
â”‚ â””â”€ file3.parquet        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ SHALLOW CLONE
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cloned Table            â”‚
â”‚ â””â”€ References:          â”‚
â”‚    file1, file2, file3  â”‚ âœ“ å¯ä»¥æ­£å¸¸å·¥ä½œ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Week 2-3: Type 1 SCD æ›´æ–°ï¼ˆè¦†å¯«èˆŠè¨˜éŒ„ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Source Table            â”‚
â”‚ â”œâ”€ file1.parquet (èˆŠ)   â”‚ â† ä¸å†è¢«ä¾†æºè¡¨ä½¿ç”¨
â”‚ â”œâ”€ file4.parquet (æ–°)   â”‚ â† æ–°è³‡æ–™
â”‚ â”œâ”€ file5.parquet (æ–°)   â”‚
â”‚ â””â”€ file6.parquet (æ–°)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cloned Table            â”‚
â”‚ â””â”€ References:          â”‚
â”‚    file1, file2, file3  â”‚ âœ“ æª”æ¡ˆä»å­˜åœ¨ï¼Œé‚„èƒ½å·¥ä½œ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Week 4: VACUUM åŸ·è¡Œï¼ˆé è¨­ä¿ç•™ 7 å¤©ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VACUUM åˆªé™¤èˆŠæª”æ¡ˆï¼š      â”‚
â”‚ âœ— file1.parquet åˆªé™¤    â”‚
â”‚ âœ— file2.parquet åˆªé™¤    â”‚
â”‚ âœ— file3.parquet åˆªé™¤    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Source Table            â”‚
â”‚ â”œâ”€ file4.parquet        â”‚
â”‚ â”œâ”€ file5.parquet        â”‚
â”‚ â””â”€ file6.parquet        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ âœ“ æ­£å¸¸å·¥ä½œ

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cloned Table            â”‚
â”‚ â””â”€ References:          â”‚
â”‚    file1 â† æ‰¾ä¸åˆ°ï¼âŒ    â”‚
â”‚    file2 â† æ‰¾ä¸åˆ°ï¼âŒ    â”‚
â”‚    file3 â† æ‰¾ä¸åˆ°ï¼âŒ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ âœ— ç„¡æ³•å·¥ä½œï¼
```

**ç‚ºä½• VACUUM æœƒåˆªé™¤é€™äº›æª”æ¡ˆï¼š**

1. **VACUUM çš„åˆ¤æ–·é‚è¼¯ï¼š**
   - VACUUM æª¢æŸ¥ä¾†æºè¡¨çš„ transaction log
   - æ‰¾å‡ºä¸å†è¢«ä¾†æºè¡¨å¼•ç”¨çš„è³‡æ–™æª”æ¡ˆ
   - åˆªé™¤è¶…éä¿ç•™æœŸé™ï¼ˆé è¨­ 7 å¤©ï¼‰çš„èˆŠæª”æ¡ˆ

2. **VACUUM ä¸çŸ¥é“ SHALLOW CLONE çš„å­˜åœ¨ï¼š**
   - VACUUM åªæª¢æŸ¥**ä¾†æºè¡¨è‡ªå·±çš„ transaction log**
   - **ä¸æœƒæª¢æŸ¥å…¶ä»–è¡¨**ï¼ˆåŒ…æ‹¬ shallow cloneï¼‰æ˜¯å¦å¼•ç”¨é€™äº›æª”æ¡ˆ
   - å› æ­¤æœƒèª¤åˆª shallow clone éœ€è¦çš„æª”æ¡ˆ

**ç¬¦åˆé¡Œç›®æƒ…å¢ƒ:**

```sql
-- Week 1: å»ºç«‹ SHALLOW CLONE
CREATE TABLE dev.customers_clone
SHALLOW CLONE prod.customers;

-- Week 2-3: Type 1 SCD æ›´æ–°ï¼ˆè¦†å¯«èˆŠè¨˜éŒ„ï¼‰
MERGE INTO prod.customers t
USING updates s
ON t.id = s.id
WHEN MATCHED THEN UPDATE SET *  -- è¦†å¯«èˆŠè¨˜éŒ„ï¼ˆType 1 SCDï¼‰
WHEN NOT MATCHED THEN INSERT *;

-- æ­¤æ™‚ç”¢ç”Ÿæ–°è³‡æ–™æª”æ¡ˆï¼ŒèˆŠæª”æ¡ˆè®Šæˆã€Œä¸å†è¢«ä¾†æºè¡¨å¼•ç”¨ã€

-- Week 4: VACUUM åŸ·è¡Œ
VACUUM prod.customers RETAIN 168 HOURS;  -- 7 å¤©
-- VACUUM åˆªé™¤äº†èˆŠæª”æ¡ˆï¼ˆfile1, file2, file3ï¼‰

-- å˜—è©¦æŸ¥è©¢ clone è¡¨
SELECT * FROM dev.customers_clone;
-- éŒ¯èª¤ï¼FileNotFoundException: file1.parquet not found
```

**éŒ¯èª¤è¨Šæ¯ç¯„ä¾‹ï¼š**

```
pyspark.sql.utils.AnalysisException: 
[DELTA_FILE_NOT_FOUND] 
A file referenced in the transaction log cannot be found. 
This occurs when data has been manually deleted from the file system 
rather than using the table `DELETE` statement.
Path: s3://bucket/prod/customers/file1.parquet
```

**å¯¦å‹™æ‡‰ç”¨:**

**è§£æ±ºæ–¹æ¡ˆ 1ï¼šä½¿ç”¨ DEEP CLONE**

```sql
-- DEEP CLONE è¤‡è£½è³‡æ–™æª”æ¡ˆï¼Œä¸ä¾è³´ä¾†æºè¡¨
CREATE TABLE dev.customers_clone
DEEP CLONE prod.customers;

-- å³ä½¿ä¾†æºè¡¨åŸ·è¡Œ VACUUMï¼Œclone è¡¨ä»å¯æ­£å¸¸å·¥ä½œ
```

**è§£æ±ºæ–¹æ¡ˆ 2ï¼šå»¶é•· VACUUM ä¿ç•™æœŸé™**

```sql
-- å»¶é•·ä¿ç•™æœŸé™åˆ° 30 å¤©
VACUUM prod.customers RETAIN 720 HOURS;

-- æˆ–åœ¨ table properties è¨­å®š
ALTER TABLE prod.customers 
SET TBLPROPERTIES (
  'delta.deletedFileRetentionDuration' = 'interval 30 days'
);
```

**è§£æ±ºæ–¹æ¡ˆ 3ï¼šå®šæœŸé‡æ–°å»ºç«‹ SHALLOW CLONE**

```sql
-- æ¯é€±é‡æ–°å»ºç«‹ cloneï¼ˆåœ¨ VACUUM ä¹‹å‰ï¼‰
DROP TABLE IF EXISTS dev.customers_clone;
CREATE TABLE dev.customers_clone
SHALLOW CLONE prod.customers;
```

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### é¸é … A - Type 1 changes cannot guarantee consistency

**éŒ¯èª¤åŸå› :** Type 1 SCD æœ¬èº«**ä¸æ˜¯å°è‡´ clone è¡¨å¤±æ•ˆçš„åŸå› **

**è©³ç´°åˆ†æ:**

**Type 1 SCD çš„ç‰¹æ€§ï¼š**

```sql
-- Type 1 SCD: è¦†å¯«èˆŠè¨˜éŒ„ï¼ˆç„¡æ­·å²ï¼‰
MERGE INTO customers t
USING updates s
ON t.id = s.id
WHEN MATCHED THEN UPDATE SET 
  t.name = s.name,
  t.address = s.address,
  t.updated_at = current_timestamp()
WHEN NOT MATCHED THEN INSERT *;

-- çµæœï¼šç”¢ç”Ÿæ–°è³‡æ–™æª”æ¡ˆï¼ŒèˆŠæª”æ¡ˆæ¨™è¨˜ç‚ºåˆªé™¤
```

**ç‚ºä½• Type 1 ä¸æ˜¯å•é¡Œï¼š**

1. **Delta Lake ä¿è­‰è³‡æ–™ä¸€è‡´æ€§**
   - ç„¡è«– Type 1 æˆ– Type 2 SCD
   - Delta Lake çš„ ACID ç‰¹æ€§ç¢ºä¿ä¸€è‡´æ€§

2. **çœŸæ­£çš„å•é¡Œæ˜¯ VACUUM**
   - Type 1 SCD â†’ ç”¢ç”Ÿæ–°æª”æ¡ˆï¼ŒèˆŠæª”æ¡ˆæ¨™è¨˜ç‚ºåˆªé™¤
   - èˆŠæª”æ¡ˆä»å­˜åœ¨ï¼ŒSHALLOW CLONE ä»å¯å·¥ä½œ
   - **VACUUM åˆªé™¤èˆŠæª”æ¡ˆ** â†’ SHALLOW CLONE å¤±æ•ˆ

**å°æ¯”é©—è­‰ï¼š**

```
æƒ…å¢ƒ 1: Type 1 SCD + æ²’æœ‰ VACUUM
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SHALLOW CLONE å¼•ç”¨èˆŠæª”æ¡ˆ         â”‚
â”‚ èˆŠæª”æ¡ˆä»å­˜åœ¨ï¼ˆé›–ç„¶è¢«æ¨™è¨˜ç‚ºåˆªé™¤ï¼‰  â”‚
â”‚ çµæœï¼šâœ“ CLONE è¡¨æ­£å¸¸å·¥ä½œ         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æƒ…å¢ƒ 2: Type 1 SCD + åŸ·è¡Œ VACUUM
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SHALLOW CLONE å¼•ç”¨èˆŠæª”æ¡ˆ         â”‚
â”‚ VACUUM åˆªé™¤èˆŠæª”æ¡ˆ                â”‚
â”‚ çµæœï¼šâœ— CLONE è¡¨å¤±æ•ˆ             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

çµè«–ï¼šå•é¡Œåœ¨æ–¼ VACUUMï¼Œä¸æ˜¯ Type 1 SCD
```

**æ˜“æ··æ·†é»:**
é¡Œç›®åˆ»æ„æåˆ°ã€ŒType 1 SCDã€ä¾†èª¤å°ï¼Œä½†çœŸæ­£åŸå› æ˜¯ VACUUM

---

### é¸é … B - VACUUM invalidates shallow clones automatically

**éŒ¯èª¤åŸå› :** æè¿°**éƒ¨åˆ†æ­£ç¢ºä½†ä¸ç²¾ç¢º** - VACUUM ä¸æ˜¯ã€Œè‡ªå‹•ä½¿ clone å¤±æ•ˆã€ï¼Œè€Œæ˜¯ã€Œåˆªé™¤äº† clone å¼•ç”¨çš„æª”æ¡ˆã€

**è©³ç´°åˆ†æ:**

**é¸é … B çš„å•é¡Œï¼š**

1. **ã€Œautomatically invalidatesã€æè¿°ä¸ç²¾ç¢º**
   - VACUUM æ²’æœ‰ã€Œä¸»å‹•ä½¿ clone å¤±æ•ˆã€çš„æ©Ÿåˆ¶
   - è€Œæ˜¯ã€Œç„¡æ„ä¸­åˆªé™¤äº† clone éœ€è¦çš„æª”æ¡ˆã€
   - å·®åˆ¥ï¼šVACUUM ä¸çŸ¥é“ clone çš„å­˜åœ¨

2. **ã€Œshould always be usedã€å¤ªçµ•å°**
   - SHALLOW CLONE åœ¨æŸäº›æƒ…å¢ƒä¸‹ä»å¯å®‰å…¨ä½¿ç”¨
   - åªè¦ç®¡ç†å¥½ VACUUM ç­–ç•¥å³å¯

**å°æ¯”é¸é … Dï¼š**

| ç‰¹æ€§ | é¸é … B | é¸é … D |
|------|-------|-------|
| æè¿°ç²¾ç¢ºåº¦ | ä¸ç²¾ç¢º | ç²¾ç¢º |
| å› æœé—œä¿‚ | æ¨¡ç³Š | æ¸…æ¥š |
| æŠ€è¡“ç´°ç¯€ | æ¬ ç¼º | å®Œæ•´ |

**é¸é … B vs D çš„é—œéµå·®ç•°ï¼š**

```
é¸é … B çš„æè¿°ï¼š
ã€ŒVACUUM ä½¿ shallow clone å¤±æ•ˆã€
â†’ è½èµ·ä¾†åƒ VACUUM æœ‰æ„è­˜åœ°é‡å° clone

é¸é … D çš„æè¿°ï¼šâœ… æ›´ç²¾ç¢º
ã€ŒClone metadata å¼•ç”¨çš„è³‡æ–™æª”æ¡ˆè¢« VACUUM æ¸…é™¤ã€
â†’ èªªæ˜äº†å…·é«”çš„æ©Ÿåˆ¶å’Œå› æœé—œä¿‚
```

**SHALLOW CLONE çš„é©ç”¨å ´æ™¯ï¼š**

```sql
-- é©åˆä½¿ç”¨ SHALLOW CLONE çš„æƒ…å¢ƒï¼š
-- 1. çŸ­æœŸæ¸¬è©¦ï¼ˆå¹¾å¤©å…§ï¼‰
CREATE TABLE test.temp_analysis
SHALLOW CLONE prod.large_table;

-- 2. ä¾†æºè¡¨å¾ˆå°‘æ›´æ–°
CREATE TABLE archive.snapshot_2024
SHALLOW CLONE prod.stable_reference_table;

-- 3. å»¶é•· VACUUM ä¿ç•™æœŸé™
ALTER TABLE prod.source_table
SET TBLPROPERTIES (
  'delta.deletedFileRetentionDuration' = 'interval 90 days'
);
CREATE TABLE dev.working_copy
SHALLOW CLONE prod.source_table;
```

**æ˜“æ··æ·†é»:**
é¸é … B è½èµ·ä¾†ã€Œæœ‰é“ç†ã€ï¼Œä½†æŠ€è¡“æè¿°ä¸å¦‚é¸é … D ç²¾ç¢º

---

### é¸é … C - SHALLOW CLONE tables are automatically deleted after 7 days

**éŒ¯èª¤åŸå› :** SHALLOW CLONE å»ºç«‹çš„è¡¨**ä¸æœƒè‡ªå‹•åˆªé™¤**

**è©³ç´°åˆ†æ:**

**7 å¤©çš„çœŸæ­£å«ç¾©ï¼š**

```
éŒ¯èª¤ç†è§£ï¼ˆé¸é … Cï¼‰ï¼š
SHALLOW CLONE è¡¨ 7 å¤©å¾Œè‡ªå‹•åˆªé™¤ âœ—

æ­£ç¢ºç†è§£ï¼š
VACUUM çš„é è¨­ä¿ç•™æœŸé™æ˜¯ 7 å¤© âœ“
```

**VACUUM ä¿ç•™æœŸé™ vs è¡¨çš„å­˜åœ¨æ™‚é–“ï¼š**

| æ¦‚å¿µ | èªªæ˜ | é è¨­å€¼ |
|------|------|-------|
| **VACUUM retention** | ä¿ç•™ã€Œæ¨™è¨˜ç‚ºåˆªé™¤ã€çš„æª”æ¡ˆå¤šä¹… | 7 å¤©ï¼ˆ168 å°æ™‚ï¼‰|
| **Table lifetime** | è¡¨çš„å­˜åœ¨æ™‚é–“ | âˆï¼ˆæ°¸ä¹…ï¼Œé™¤éæ‰‹å‹•åˆªé™¤ï¼‰|

**é©—è­‰ï¼š**

```sql
-- Day 1: å»ºç«‹ SHALLOW CLONE
CREATE TABLE dev.test_clone
SHALLOW CLONE prod.source_table;

-- Day 8 (è¶…é 7 å¤©)
SELECT * FROM dev.test_clone;
-- âœ“ è¡¨ä»ç„¶å­˜åœ¨ï¼
-- âœ“ Metadata ä»ç„¶å­˜åœ¨ï¼
-- å•é¡Œï¼šå¦‚æœä¾†æºè¡¨åŸ·è¡Œäº† VACUUMï¼Œè³‡æ–™æª”æ¡ˆå¯èƒ½ä¸å­˜åœ¨

-- æª¢æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
SHOW TABLES IN dev LIKE 'test_clone';
-- çµæœï¼šè¡¨ä»åœ¨åˆ—è¡¨ä¸­ âœ“

-- æª¢æŸ¥ table properties
DESCRIBE DETAIL dev.test_clone;
-- çµæœï¼šå¯ä»¥çœ‹åˆ° metadataï¼Œè¡¨çš„å®šç¾©å®Œæ•´ âœ“
```

**7 å¤©ä¿ç•™æœŸé™çš„å¯¦éš›ä½œç”¨ï¼š**

```
Timeline:

Day 0: ä¾†æºè¡¨æœ‰ file1.parquet
Day 1: å»ºç«‹ SHALLOW CLONEï¼ˆå¼•ç”¨ file1.parquetï¼‰
Day 2: ä¾†æºè¡¨æ›´æ–°ï¼Œfile1 æ¨™è¨˜ç‚ºåˆªé™¤ï¼Œæ–°å¢ file2.parquet
Day 3-8: file1 ä»å­˜åœ¨ç£ç¢Ÿä¸Šï¼ˆåœ¨ä¿ç•™æœŸé™å…§ï¼‰
Day 9: VACUUM åŸ·è¡Œï¼Œåˆªé™¤ file1ï¼ˆè¶…é 7 å¤©ä¿ç•™æœŸé™ï¼‰
Day 10: SHALLOW CLONE ç„¡æ³•è®€å–è³‡æ–™ï¼ˆfile1 ä¸å­˜åœ¨ï¼‰

æ³¨æ„ï¼šSHALLOW CLONE è¡¨æœ¬èº«æ²’æœ‰è¢«åˆªé™¤ï¼
      åªæ˜¯å®ƒå¼•ç”¨çš„è³‡æ–™æª”æ¡ˆè¢«åˆªé™¤äº†
```

**Clone è¡¨çš„ç”Ÿå‘½é€±æœŸï¼š**

```sql
-- Clone è¡¨æœƒä¸€ç›´å­˜åœ¨ï¼Œç›´åˆ°æ˜ç¢ºåˆªé™¤
CREATE TABLE dev.my_clone SHALLOW CLONE prod.source;

-- 1 å€‹æœˆå¾Œ
SELECT * FROM dev.my_clone;  
-- è¡¨ä»å­˜åœ¨ï¼Œä½†å¯èƒ½ç„¡æ³•è®€å–è³‡æ–™ï¼ˆå¦‚æœ VACUUM æ¸…é™¤äº†æª”æ¡ˆï¼‰

-- å¿…é ˆæ˜ç¢ºåˆªé™¤
DROP TABLE dev.my_clone;
```

**æ˜“æ··æ·†é»:**
å°‡ã€ŒVACUUM ä¿ç•™æœŸé™ 7 å¤©ã€èª¤è§£ç‚ºã€ŒClone è¡¨å­˜åœ¨æ™‚é–“ 7 å¤©ã€

---

### é¸é … E - VACUUM compacted files + REFRESH will fix

**éŒ¯èª¤åŸå› :** æœ‰å…©å€‹éŒ¯èª¤ï¼š
1. VACUUM ä¸æ˜¯ã€Œå£“ç¸® (compact)ã€æª”æ¡ˆ
2. REFRESH ç„¡æ³•æ¢å¾©å·²åˆªé™¤çš„æª”æ¡ˆ

**è©³ç´°åˆ†æ:**

**éŒ¯èª¤ 1: VACUUM â‰  Compaction**

```sql
-- VACUUM: åˆªé™¤èˆŠçš„è³‡æ–™æª”æ¡ˆ
VACUUM table_name RETAIN 168 HOURS;
-- ä½œç”¨ï¼šåˆªé™¤ä¸å†è¢«å¼•ç”¨çš„æª”æ¡ˆ

-- OPTIMIZE: å£“ç¸®ï¼ˆåˆä½µï¼‰å°æª”æ¡ˆ
OPTIMIZE table_name;
-- ä½œç”¨ï¼šå°‡å¤šå€‹å°æª”æ¡ˆåˆä½µæˆå¤§æª”æ¡ˆï¼Œæå‡æŸ¥è©¢æ•ˆèƒ½
```

**VACUUM vs OPTIMIZE å°æ¯”ï¼š**

| æ“ä½œ | ç›®çš„ | å°æª”æ¡ˆçš„å½±éŸ¿ | æ˜¯å¦åˆªé™¤è³‡æ–™ |
|------|------|-------------|------------|
| **VACUUM** | æ¸…ç†ä¸éœ€è¦çš„æª”æ¡ˆ | åˆªé™¤èˆŠæª”æ¡ˆ | æ˜¯ï¼ˆèˆŠç‰ˆæœ¬ï¼‰ |
| **OPTIMIZE** | æå‡æŸ¥è©¢æ•ˆèƒ½ | åˆä½µå°æª”æ¡ˆ | å¦ï¼ˆä¿ç•™æ‰€æœ‰è³‡æ–™ï¼‰|

**éŒ¯èª¤ 2: REFRESH ç„¡æ³•æ¢å¾©å·²åˆªé™¤çš„æª”æ¡ˆ**

```sql
-- REFRESH çš„å¯¦éš›ä½œç”¨
REFRESH TABLE table_name;
-- ç”¨é€”ï¼š
-- 1. é‡æ–°æƒæè³‡æ–™ç›®éŒ„ï¼ˆå¤–éƒ¨è¡¨ï¼‰
-- 2. æ›´æ–° metastore ä¸­çš„ metadata
-- 3. ç™¼ç¾æ–°å¢çš„æª”æ¡ˆ

-- REFRESH ç„¡æ³•ï¼š
-- âœ— æ¢å¾©å·²åˆªé™¤çš„æª”æ¡ˆ
-- âœ— ä¿®å¾© SHALLOW CLONE èˆ‡ä¾†æºè¡¨çš„é€£çµ
-- âœ— å¾ä¾†æºè¡¨æ‹‰å–æ–°è³‡æ–™åˆ° clone
```

**é©—è­‰ REFRESH ç„¡æ³•è§£æ±ºå•é¡Œï¼š**

```sql
-- å•é¡Œæƒ…å¢ƒï¼šVACUUM åˆªé™¤äº† SHALLOW CLONE éœ€è¦çš„æª”æ¡ˆ
SELECT * FROM dev.my_clone;
-- éŒ¯èª¤: FileNotFoundException: file1.parquet

-- å˜—è©¦ä½¿ç”¨ REFRESH
REFRESH TABLE dev.my_clone;
-- æ²’æœ‰éŒ¯èª¤ï¼Œä½†...

SELECT * FROM dev.my_clone;
-- ä»ç„¶éŒ¯èª¤: FileNotFoundException: file1.parquet
-- REFRESH ç„¡æ³•æ¢å¾©å·²åˆªé™¤çš„æª”æ¡ˆï¼
```

**æ­£ç¢ºçš„ä¿®å¾©æ–¹æ³•ï¼š**

```sql
-- æ–¹æ³• 1: é‡æ–°å»ºç«‹ SHALLOW CLONE
DROP TABLE dev.my_clone;
CREATE TABLE dev.my_clone SHALLOW CLONE prod.source_table;
-- ç¾åœ¨å¼•ç”¨ä¾†æºè¡¨ç•¶å‰çš„è³‡æ–™æª”æ¡ˆ

-- æ–¹æ³• 2: æ”¹ç”¨ DEEP CLONEï¼ˆå¦‚æœéœ€è¦é•·æœŸä½¿ç”¨ï¼‰
DROP TABLE dev.my_clone;
CREATE TABLE dev.my_clone DEEP CLONE prod.source_table;
-- è¤‡è£½è³‡æ–™æª”æ¡ˆï¼Œä¸ä¾è³´ä¾†æºè¡¨

-- æ–¹æ³• 3: å¾å‚™ä»½æ¢å¾©ï¼ˆå¦‚æœæœ‰ Time Travelï¼‰
RESTORE TABLE prod.source_table TO VERSION AS OF 100;
-- æ¢å¾©ä¾†æºè¡¨åˆ°åŒ…å«èˆŠæª”æ¡ˆçš„ç‰ˆæœ¬ï¼ˆå¦‚æœåœ¨ä¿ç•™æœŸé™å…§ï¼‰
```

**VACUUM èˆ‡ OPTIMIZE çš„æ­£ç¢ºç†è§£ï¼š**

```sql
-- Scenario 1: OPTIMIZE å¾Œçš„ VACUUM
OPTIMIZE prod.customers;  -- åˆä½µå°æª”æ¡ˆ
-- ç”¢ç”Ÿï¼šfile_optimized_1.parquet (å¤§æª”æ¡ˆ)
-- æ¨™è¨˜ç‚ºåˆªé™¤ï¼šfile1.parquet, file2.parquet, ... (å°æª”æ¡ˆ)

VACUUM prod.customers RETAIN 168 HOURS;
-- åˆªé™¤èˆŠçš„å°æª”æ¡ˆ

-- çµæœï¼š
-- - Source table: âœ“ ä½¿ç”¨æ–°çš„å¤§æª”æ¡ˆ
-- - SHALLOW CLONE: âœ— å¦‚æœå¼•ç”¨èˆŠçš„å°æª”æ¡ˆï¼Œæœƒå¤±æ•ˆ

-- Scenario 2: åªæœ‰ VACUUMï¼ˆæ²’æœ‰ OPTIMIZEï¼‰
MERGE INTO prod.customers ...;  -- Type 1 SCD æ›´æ–°
-- ç”¢ç”Ÿï¼šfile_new.parquet
-- æ¨™è¨˜ç‚ºåˆªé™¤ï¼šfile_old.parquet

VACUUM prod.customers;
-- åˆªé™¤ file_old.parquet

-- çµæœï¼š
-- - Source table: âœ“ ä½¿ç”¨ file_new.parquet
-- - SHALLOW CLONE: âœ— å¦‚æœå¼•ç”¨ file_old.parquetï¼Œæœƒå¤±æ•ˆ
```

**æ˜“æ··æ·†é»:**
- æ··æ·† VACUUMï¼ˆåˆªé™¤ï¼‰èˆ‡ OPTIMIZEï¼ˆå£“ç¸®ï¼‰
- èª¤ä»¥ç‚º REFRESH å¯ä»¥æ¢å¾©åˆªé™¤çš„æª”æ¡ˆ

---

## ğŸ§  è¨˜æ†¶æ³•èˆ‡æŠ€å·§

### å£è¨£
**ã€ŒSHALLOW å¼•ç”¨æª”ï¼ŒVACUUM åˆªèˆŠæª”ï¼ŒClone æ‰¾ä¸åˆ°æª”ã€**

### é—œéµå°æ¯”è¡¨

| Clone é¡å‹ | Metadata | Data Files | VACUUM å½±éŸ¿ | é©ç”¨å ´æ™¯ |
|-----------|----------|------------|------------|---------|
| **SHALLOW** | è¤‡è£½ | å¼•ç”¨åŸå§‹æª”æ¡ˆ | âŒ æœƒå¤±æ•ˆ | çŸ­æœŸæ¸¬è©¦ |
| **DEEP** | è¤‡è£½ | è¤‡è£½æª”æ¡ˆ | âœ… ä¸å½±éŸ¿ | é•·æœŸä½¿ç”¨ |

### SHALLOW CLONE å¤±æ•ˆæ©Ÿåˆ¶è¦–è¦ºåŒ–

```
æ­¥é©Ÿ 1: å»ºç«‹ SHALLOW CLONE
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Source Table                 â”‚
â”‚ data/file1.parquet â”€â”€â”€â”€â”     â”‚
â”‚ data/file2.parquet â”€â”€â”€â”€â”¤     â”‚
â”‚ data/file3.parquet â”€â”€â”€â”€â”¤     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”˜
                          â”‚
                   (å¼•ç”¨ï¼Œä¸è¤‡è£½)
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”
â”‚ Clone Table              â†“   â”‚
â”‚ metadata æŒ‡å‘: file1, 2, 3   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ­¥é©Ÿ 2: ä¾†æºè¡¨æ›´æ–° (Type 1 SCD)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Source Table                 â”‚
â”‚ data/file1.parquet (èˆŠ)      â”‚ â† æ¨™è¨˜åˆªé™¤
â”‚ data/file2.parquet (èˆŠ)      â”‚ â† æ¨™è¨˜åˆªé™¤
â”‚ data/file4.parquet (æ–°)      â”‚
â”‚ data/file5.parquet (æ–°)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ­¥é©Ÿ 3: VACUUM åŸ·è¡Œ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VACUUM åˆªé™¤ï¼š                â”‚
â”‚ âœ— file1.parquet åˆªé™¤         â”‚
â”‚ âœ— file2.parquet åˆªé™¤         â”‚
â”‚ âœ— file3.parquet åˆªé™¤         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ­¥é©Ÿ 4: Clone è¡¨å¤±æ•ˆ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Clone Table                  â”‚
â”‚ metadata æŒ‡å‘: file1, 2, 3   â”‚
â”‚                â†“             â”‚
â”‚          FileNotFound âŒ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

çµè«–ï¼šé¸é … D ç²¾ç¢ºæè¿°äº†é€™å€‹æ©Ÿåˆ¶ âœ…
```

### åˆ¤æ–·æŠ€å·§

**è­˜åˆ¥é—œéµå­—ï¼š**
- âœ… "metadata...referencing data files...purged" â†’ ç²¾ç¢ºæè¿°äº†æ©Ÿåˆ¶
- âŒ "Type 1 cannot guarantee consistency" â†’ èª¤å°ï¼ŒType 1 ä¸æ˜¯å•é¡Œ
- âŒ "automatically invalidates" â†’ æè¿°ä¸ç²¾ç¢º
- âŒ "automatically deleted after 7 days" â†’ è¡¨ä¸æœƒè‡ªå‹•åˆªé™¤
- âŒ "REFRESH...pull in changes" â†’ REFRESH ç„¡æ³•æ¢å¾©åˆªé™¤çš„æª”æ¡ˆ

**å¿«é€Ÿæ’é™¤æ³•ï¼š**

```
é¡Œç›®é—œéµè³‡è¨Šï¼š
1. ä½¿ç”¨ SHALLOW CLONE âœ“
2. å¹¾é€±å¾Œå¤±æ•ˆ âœ“
3. å‰ä¸€å¤©åŸ·è¡Œäº† VACUUM âœ“

æ€è€ƒæµç¨‹ï¼š
SHALLOW CLONE å¼•ç”¨åŸå§‹è³‡æ–™æª”æ¡ˆ
    â†“
VACUUM åˆªé™¤ä¸å†è¢«ä¾†æºè¡¨ä½¿ç”¨çš„æª”æ¡ˆ
    â†“
SHALLOW CLONE å¼•ç”¨çš„æª”æ¡ˆè¢«åˆªé™¤
    â†“
Clone è¡¨ç„¡æ³•æ‰¾åˆ°è³‡æ–™æª”æ¡ˆ
    â†“
é¸é … D: metadata å¼•ç”¨çš„æª”æ¡ˆè¢« VACUUM æ¸…é™¤ âœ…
```

### CLONE ç­–ç•¥æ±ºç­–æ¨¹

```
éœ€è¦ Clone è¡¨ï¼Ÿ
    â†“
ä½¿ç”¨æœŸé™å¤šé•·ï¼Ÿ
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
â”‚               â”‚
çŸ­æœŸï¼ˆ< 7 å¤©ï¼‰   é•·æœŸï¼ˆ> 7 å¤©ï¼‰
â†“               â†“
å¯ç”¨ SHALLOW    è€ƒæ…®å› ç´ ï¼š
+ å¿«é€Ÿå»ºç«‹      â”œâ”€ ä¾†æºè¡¨æ›´æ–°é »ç‡ï¼Ÿ
+ ç¯€çœç©ºé–“      â”œâ”€ VACUUM åŸ·è¡Œé »ç‡ï¼Ÿ
                â”œâ”€ æ˜¯å¦éœ€è¦ç¨ç«‹ç®¡ç†ï¼Ÿ
                â†“
                é«˜é »æ›´æ–° / é »ç¹ VACUUM
                â†’ ä½¿ç”¨ DEEP CLONE
                
                ä½é »æ›´æ–° / å»¶é•·ä¿ç•™æœŸé™
                â†’ å¯ç”¨ SHALLOW CLONE
```

---

## ğŸ“š å»¶ä¼¸é–±è®€

### å®˜æ–¹æ–‡ä»¶
- [Delta Lake - Clone a Delta table](https://docs.databricks.com/delta/clone.html)
- [Delta Lake - VACUUM](https://docs.databricks.com/delta/vacuum.html)
- [Delta Lake - Shallow vs Deep Clone](https://docs.databricks.com/delta/clone.html#shallow-clone-vs-deep-clone)

### ç›¸é—œæ¦‚å¿µ
- Delta Lake Time Travel
- Type 1 vs Type 2 SCD
- Delta Lake äº‹å‹™æ—¥èªŒç®¡ç†
- è³‡æ–™ä¿ç•™ç­–ç•¥

### å¯¦å‹™ç¯„ä¾‹

**1. å®‰å…¨åœ°ä½¿ç”¨ SHALLOW CLONEï¼š**

```sql
-- æ–¹æ¡ˆ 1: å»¶é•· VACUUM ä¿ç•™æœŸé™
ALTER TABLE prod.source_table
SET TBLPROPERTIES (
  'delta.deletedFileRetentionDuration' = 'interval 30 days'
);

-- å»ºç«‹ SHALLOW CLONEï¼ˆç¾åœ¨æœ‰ 30 å¤©å®‰å…¨æœŸï¼‰
CREATE TABLE dev.clone_table
SHALLOW CLONE prod.source_table;

-- æ–¹æ¡ˆ 2: çŸ­æœŸæ¸¬è©¦ä½¿ç”¨ SHALLOW CLONE
CREATE TABLE test.quick_analysis
SHALLOW CLONE prod.large_table;

-- å®Œæˆæ¸¬è©¦å¾Œç«‹å³åˆªé™¤
DROP TABLE test.quick_analysis;

-- æ–¹æ¡ˆ 3: å®šæœŸé‡å»º SHALLOW CLONE
-- åœ¨ Databricks Workflow ä¸­è¨­å®šæ¯é€±ä»»å‹™
DROP TABLE IF EXISTS dev.weekly_clone;
CREATE TABLE dev.weekly_clone
SHALLOW CLONE prod.source_table;
```

**2. ç›£æ§ Clone è¡¨çš„å¥åº·ç‹€æ…‹ï¼š**

```python
# æª¢æŸ¥ SHALLOW CLONE è¡¨æ˜¯å¦ä»ç„¶å¯ç”¨
def check_clone_health(clone_table):
    try:
        # å˜—è©¦æŸ¥è©¢è¡¨
        df = spark.sql(f"SELECT * FROM {clone_table} LIMIT 1")
        df.count()
        print(f"âœ“ {clone_table} is healthy")
        return True
    except Exception as e:
        if "FileNotFoundException" in str(e):
            print(f"âœ— {clone_table} has missing data files")
            print(f"   Possible cause: Source table was VACUUMed")
            return False
        else:
            raise e

# æª¢æŸ¥æ‰€æœ‰ clone è¡¨
clone_tables = [
    "dev.customers_clone",
    "dev.orders_clone",
    "dev.products_clone"
]

for table in clone_tables:
    check_clone_health(table)
```

**3. è‡ªå‹•åŒ– Clone è¡¨é‡å»ºï¼š**

```python
# Databricks Notebook: Rebuild Shallow Clones

from datetime import datetime

clone_configs = [
    {"source": "prod.customers", "target": "dev.customers_clone"},
    {"source": "prod.orders", "target": "dev.orders_clone"},
    {"source": "prod.products", "target": "dev.products_clone"}
]

for config in clone_configs:
    source = config["source"]
    target = config["target"]
    
    print(f"Rebuilding {target} from {source}...")
    
    # åˆªé™¤èˆŠçš„ clone
    spark.sql(f"DROP TABLE IF EXISTS {target}")
    
    # å»ºç«‹æ–°çš„ SHALLOW CLONE
    spark.sql(f"""
        CREATE TABLE {target}
        SHALLOW CLONE {source}
    """)
    
    # è¨˜éŒ„é‡å»ºæ™‚é–“
    spark.sql(f"""
        ALTER TABLE {target}
        SET TBLPROPERTIES (
            'last_cloned_at' = '{datetime.now().isoformat()}'
        )
    """)
    
    print(f"âœ“ {target} rebuilt successfully")

# åœ¨ Databricks Workflows ä¸­è¨­å®šï¼š
# - Schedule: æ¯é€±æ—¥æ—©ä¸ŠåŸ·è¡Œ
# - åœ¨ä¾†æºè¡¨åŸ·è¡Œ VACUUM ä¹‹å‰åŸ·è¡Œ
```

**4. DEEP CLONE ç”¨æ–¼ç”Ÿç”¢ç’°å¢ƒè¤‡è£½ï¼š**

```sql
-- Scenario: å»ºç«‹ç”Ÿç”¢ç’°å¢ƒçš„å®Œæ•´å‰¯æœ¬ç”¨æ–¼æ¸¬è©¦
-- ä½¿ç”¨ DEEP CLONE ç¢ºä¿å®Œå…¨ç¨ç«‹

-- å»ºç«‹æ¸¬è©¦ç’°å¢ƒçš„å®Œæ•´å‰¯æœ¬
CREATE DATABASE IF NOT EXISTS test_env;

-- è¤‡è£½æ‰€æœ‰è¡¨
CREATE TABLE test_env.customers
DEEP CLONE prod.customers;

CREATE TABLE test_env.orders
DEEP CLONE prod.orders;

CREATE TABLE test_env.products
DEEP CLONE prod.products;

-- å„ªé»ï¼š
-- 1. å®Œå…¨ç¨ç«‹ï¼Œä¸å—ç”Ÿç”¢ç’°å¢ƒ VACUUM å½±éŸ¿
-- 2. å¯ä»¥è‡ªç”±æ¸¬è©¦ï¼Œä¸æ“”å¿ƒå½±éŸ¿ä¾†æºè¡¨
-- 3. å¯ä»¥ä¿ç•™æ¸¬è©¦çµæœ

-- æ¸¬è©¦å®Œæˆå¾Œæ¸…ç†
DROP DATABASE test_env CASCADE;
```

**5. ä½¿ç”¨ Time Travel æ¢å¾© VACUUM ä¹‹å‰çš„ç‹€æ…‹ï¼š**

```sql
-- å¦‚æœ SHALLOW CLONE å¤±æ•ˆï¼Œæª¢æŸ¥æ˜¯å¦å¯ä»¥ç”¨ Time Travel æ¢å¾©

-- æŸ¥çœ‹ä¾†æºè¡¨çš„æ­·å²ç‰ˆæœ¬
DESCRIBE HISTORY prod.source_table;

-- å˜—è©¦æ¢å¾©åˆ° VACUUM ä¹‹å‰çš„ç‰ˆæœ¬
-- æ³¨æ„ï¼šåªæœ‰åœ¨ Time Travel ä¿ç•™æœŸé™å…§æ‰æœ‰æ•ˆ
SELECT * FROM prod.source_table VERSION AS OF 50;

-- å¦‚æœè³‡æ–™ä»å¯ç”¨ï¼Œé‡å»º SHALLOW CLONE
DROP TABLE dev.clone_table;
CREATE TABLE dev.clone_table
SHALLOW CLONE prod.source_table VERSION AS OF 50;

-- æˆ–ä½¿ç”¨æ™‚é–“æˆ³
CREATE TABLE dev.clone_table
SHALLOW CLONE prod.source_table TIMESTAMP AS OF '2024-01-01';
```

**6. æœ€ä½³å¯¦è¸ï¼šClone ç­–ç•¥çŸ©é™£**

```sql
-- æ ¹æ“šä½¿ç”¨æƒ…å¢ƒé¸æ“‡ Clone ç­–ç•¥

/*
æƒ…å¢ƒ 1: å¿«é€Ÿæ¸¬è©¦ï¼ˆ< 1 å¤©ï¼‰
ç­–ç•¥ï¼šSHALLOW CLONE
ç†ç”±ï¼šå¿«é€Ÿã€ç¯€çœç©ºé–“ã€æ¸¬è©¦å®Œå³åˆªé™¤
*/
CREATE TABLE test.adhoc_analysis
SHALLOW CLONE prod.large_table;
-- å®Œæˆå¾Œ: DROP TABLE test.adhoc_analysis;

/*
æƒ…å¢ƒ 2: é–‹ç™¼ç’°å¢ƒï¼ˆæŒçºŒä½¿ç”¨ï¼‰
ç­–ç•¥ï¼šDEEP CLONE + å®šæœŸåŒæ­¥
ç†ç”±ï¼šç¨ç«‹ã€ç©©å®šã€ä¸å—ç”Ÿç”¢ç’°å¢ƒå½±éŸ¿
*/
CREATE TABLE dev.working_copy
DEEP CLONE prod.source_table;
-- æ¯é€±æ›´æ–°: DROP + DEEP CLONE

/*
æƒ…å¢ƒ 3: è³‡æ–™ç§‘å­¸å¯¦é©—ï¼ˆä¸­æœŸä½¿ç”¨ï¼‰
ç­–ç•¥ï¼šDEEP CLONE
ç†ç”±ï¼šéœ€è¦ç©©å®šçš„è³‡æ–™å¿«ç…§é€²è¡Œå¯¦é©—
*/
CREATE TABLE ds.experiment_dataset_v1
DEEP CLONE prod.analytics_table;

/*
æƒ…å¢ƒ 4: å‚™ä»½/æ­¸æª”ï¼ˆé•·æœŸä¿ç•™ï¼‰
ç­–ç•¥ï¼šDEEP CLONE
ç†ç”±ï¼šå®Œå…¨ç¨ç«‹ã€é•·æœŸä¿å­˜
*/
CREATE TABLE archive.prod_snapshot_2024_q1
DEEP CLONE prod.source_table;

/*
æƒ…å¢ƒ 5: çŸ­æœŸé–‹ç™¼ï¼ˆ< ä¿ç•™æœŸé™ï¼‰
ç­–ç•¥ï¼šSHALLOW CLONE + å»¶é•·ä¿ç•™æœŸé™
ç†ç”±ï¼šç¯€çœç©ºé–“ï¼Œä¿ç•™æœŸé™è¶³å¤ é•·
*/
-- å…ˆè¨­å®šä¿ç•™æœŸé™
ALTER TABLE prod.source_table
SET TBLPROPERTIES (
  'delta.deletedFileRetentionDuration' = 'interval 30 days'
);
-- ç„¶å¾Œå»ºç«‹ SHALLOW CLONE
CREATE TABLE dev.temp_dev
SHALLOW CLONE prod.source_table;
```

---

## ğŸ”— ç›¸é—œé¡Œç›®
- Q-XXX: DEEP CLONE vs SHALLOW CLONE æ•ˆèƒ½èˆ‡æˆæœ¬æ¯”è¼ƒ
- Q-XXX: VACUUM ä¿ç•™æœŸé™èˆ‡ Time Travel
- Q-XXX: Delta Lake äº‹å‹™æ—¥èªŒç®¡ç†
- Q-001: VACUUM æŒ‡ä»¤çš„ä¿ç•™æœŸé™ï¼ˆå·²æœ‰æ­¤é¡Œï¼‰
