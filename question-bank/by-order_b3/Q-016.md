# Question #016

---

## é¡Œç›®è³‡è¨Š
### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-016`
### ä¾†æº
**ä¾†æº:** Community
### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L2-Intermediate`

---

## é¡Œç›®å…§å®¹
### é¡Œå¹¹
<!-- âš ï¸ ä¿æŒè‹±æ–‡åŸæ–‡ï¼Œä¸è¦ç¿»è­¯ -->
The data engineering team has a Silver table called 'sales_cleaned' where new sales data is appended in near real-time.

They want to create a new Gold-layer entity against the 'sales_cleaned' table to calculate the year-to-date (YTD) of the sales amount. The new entity will have the following schema:

country_code STRING, category STRING, ytd_total_sales FLOAT, updated TIMESTAMP

It's enough for these metrics to be recalculated once daily. But since they will be queried very frequently by several business teams, the data engineering team wants to cut down the potential costs and latency associated with materializing the results.

Which of the following solutions meets these requirements?

### é¸é …
<!-- âš ï¸ ä¿æŒè‹±æ–‡åŸæ–‡ï¼Œä¸è¦ç¿»è­¯ -->
- **A.** Define the new entity as a view to avoid persisting the results each time the metrics are recalculated
- **B.** Create multiple tables, one per business team so the metrics can be queried quickly and efficiently.
- **C.** Configuring a nightly batch job to recalculate the metrics and store them as a table overwritten with each update.
- **D.** Define the new entity as a global temporary view since it can be shared between notebooks or jobs that share computing resources.

---

## æ¨™ç±¤ç³»çµ±
### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `Delta-Lake`, `Medallion-Architecture`
### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** `Concept-Confusion`, `Scenario-Based`
### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** Data Engineering / Data Architecture

---

## ç­”æ¡ˆèˆ‡ä¾†æº
### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `C`
### ç­”æ¡ˆä¾†æº
- **ä¾†æºæ¨™è¨»ç­”æ¡ˆ:** C
- **ç¤¾ç¾¤å…±è­˜:** C

---

# é¡Œç›®è§£æ

---

## ğŸ“ è€ƒé»è­˜åˆ¥
**æ ¸å¿ƒæŠ€è¡“:** View vs Table / Materialization Strategy
**é—œéµæ¦‚å¿µ:** æ‰¹æ¬¡è™•ç†ã€æŸ¥è©¢æ•ˆèƒ½ã€æˆæœ¬å„ªåŒ–
**é¡Œç›®é—œéµå­—ï¼š**
- **recalculated once daily**: æ¯å¤©é‡æ–°è¨ˆç®—ä¸€æ¬¡
- **queried very frequently**: é »ç¹æŸ¥è©¢
- **cut down costs and latency**: é™ä½æˆæœ¬å’Œå»¶é²

---

## âœ… æ­£è§£èªªæ˜
### ç‚ºä»€éº¼ C æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Ÿ

**æ¯æ™šæ‰¹æ¬¡ä½œæ¥­ + è¡¨æ ¼è¦†å¯«**æ˜¯æœ€ä½³æ–¹æ¡ˆï¼Œå› ç‚ºï¼š
- æ¯å¤©åªè¨ˆç®—ä¸€æ¬¡ï¼ˆç¬¦åˆéœ€æ±‚ï¼‰
- çµæœæŒä¹…åŒ–ç‚ºè¡¨æ ¼ï¼ˆæŸ¥è©¢å¿«é€Ÿï¼‰
- å¤šå€‹åœ˜éšŠæŸ¥è©¢æ™‚ä¸éœ€é‡æ–°è¨ˆç®—

#### éœ€æ±‚åˆ†æ
```
éœ€æ±‚ï¼š
â”œâ”€â”€ æ›´æ–°é »ç‡ï¼šæ¯å¤©ä¸€æ¬¡
â”œâ”€â”€ æŸ¥è©¢é »ç‡ï¼šéå¸¸é »ç¹
â”œâ”€â”€ ä½¿ç”¨è€…ï¼šå¤šå€‹æ¥­å‹™åœ˜éšŠ
â””â”€â”€ ç›®æ¨™ï¼šé™ä½æˆæœ¬å’Œå»¶é²

æœ€ä½³è§£æ³•ï¼š
â”œâ”€â”€ æ‰¹æ¬¡ä½œæ¥­ï¼ˆæ¯å¤©ä¸€æ¬¡ï¼‰
â”œâ”€â”€ çµæœå­˜ç‚ºè¡¨æ ¼ï¼ˆæŒä¹…åŒ–ï¼‰
â””â”€â”€ æŸ¥è©¢æ™‚ç›´æ¥è®€è¡¨ï¼ˆç„¡è¨ˆç®—æˆæœ¬ï¼‰
```

#### å¯¦ä½œç¯„ä¾‹
```python
# æ¯æ™šåŸ·è¡Œçš„æ‰¹æ¬¡ä½œæ¥­
from pyspark.sql import functions as F

# è¨ˆç®— YTD éŠ·å”®é¡
ytd_sales = spark.table("sales_cleaned") \
    .groupBy("country_code", "category") \
    .agg(
        F.sum("sales_amount").alias("ytd_total_sales"),
        F.current_timestamp().alias("updated")
    )

# è¦†å¯«ç›®æ¨™è¡¨
ytd_sales.write \
    .mode("overwrite") \
    .saveAsTable("gold_ytd_sales")
```

#### æˆæœ¬åˆ†æ
| æ–¹æ¡ˆ | è¨ˆç®—æˆæœ¬ | æŸ¥è©¢æˆæœ¬ | å„²å­˜æˆæœ¬ |
|------|----------|----------|----------|
| **æ‰¹æ¬¡è¡¨æ ¼ï¼ˆCï¼‰** | æ¯å¤© 1 æ¬¡ | ä½ï¼ˆç›´æ¥è®€è¡¨ï¼‰ | ä¸­ |
| Viewï¼ˆAï¼‰ | æ¯æ¬¡æŸ¥è©¢ | é«˜ï¼ˆæ¯æ¬¡è¨ˆç®—ï¼‰ | ç„¡ |
| å¤šè¡¨ï¼ˆBï¼‰ | æ¯å¤© N æ¬¡ | ä½ | é«˜ |

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### A. Define the new entity as a view
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- View æ¯æ¬¡æŸ¥è©¢éƒ½è¦**é‡æ–°è¨ˆç®—**
- é »ç¹æŸ¥è©¢æœƒå°è‡´**é«˜è¨ˆç®—æˆæœ¬**
- ä¸é©åˆã€Œé »ç¹æŸ¥è©¢ã€çš„å ´æ™¯

```
View çš„å•é¡Œï¼š
â”œâ”€â”€ æŸ¥è©¢ 1 â†’ è¨ˆç®—ä¸€æ¬¡
â”œâ”€â”€ æŸ¥è©¢ 2 â†’ å†è¨ˆç®—ä¸€æ¬¡
â”œâ”€â”€ æŸ¥è©¢ 3 â†’ åˆè¨ˆç®—ä¸€æ¬¡
â””â”€â”€ ...
ç¸½è¨ˆç®—æ¬¡æ•¸ = æŸ¥è©¢æ¬¡æ•¸ï¼ˆéå¸¸å¤šï¼ï¼‰
```

### B. Create multiple tables, one per business team
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- **è³‡æ–™é‡è¤‡**ï¼Œæµªè²»å„²å­˜ç©ºé–“
- ç¶­è­·å¤šä»½ç›¸åŒè³‡æ–™
- æ²’æœ‰å¯¦è³ªå¥½è™•

### D. Define the new entity as a global temporary view
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- Global Temp View ä¹Ÿæ˜¯æ¯æ¬¡æŸ¥è©¢éƒ½è¦è¨ˆç®—
- åªèƒ½åœ¨ **Spark Session å­˜æ´»æœŸé–“**ä½¿ç”¨
- å¢é›†é‡å•Ÿå¾Œæ¶ˆå¤±
- ä¸é©åˆç”Ÿç”¢ç’°å¢ƒ

```
Global Temp View é™åˆ¶ï¼š
â”œâ”€â”€ åƒ…é™ SparkSession å…§
â”œâ”€â”€ å¢é›†é‡å•Ÿå¾Œæ¶ˆå¤±
â”œâ”€â”€ ä»éœ€æ¯æ¬¡è¨ˆç®—
â””â”€â”€ ä¸æ˜¯æŒä¹…åŒ–è§£æ±ºæ–¹æ¡ˆ
```

---

## ğŸ§  è¨˜æ†¶æ³•
### å£è¨£
**ã€Œé »ç¹æŸ¥è©¢ç”¨è¡¨æ ¼ï¼Œå¶çˆ¾æ›´æ–°æ‰¹æ¬¡è·‘ã€**

### View vs Table é¸æ“‡æŒ‡å—
| å ´æ™¯ | é¸æ“‡ | åŸå›  |
|------|------|------|
| é »ç¹æŸ¥è©¢ + å¶çˆ¾æ›´æ–° | **Table** | é è¨ˆç®—ï¼ŒæŸ¥è©¢å¿« |
| å¶çˆ¾æŸ¥è©¢ + è³‡æ–™å³æ™‚ | **View** | ä¸ä½”ç©ºé–“ï¼Œå³æ™‚çµæœ |
| ç°¡å–®æŸ¥è©¢ + å°è³‡æ–™é‡ | **View** | è¨ˆç®—æˆæœ¬ä½ |
| è¤‡é›œèšåˆ + å¤šäººä½¿ç”¨ | **Table** | é¿å…é‡è¤‡è¨ˆç®— |

### Gold Layer æœ€ä½³å¯¦è¸
```
Gold Layer è¨­è¨ˆåŸå‰‡ï¼š
â”œâ”€â”€ é å…ˆè¨ˆç®—èšåˆçµæœ
â”œâ”€â”€ æŒä¹…åŒ–ç‚º Delta Table
â”œâ”€â”€ æ‰¹æ¬¡æ›´æ–°ï¼ˆæ¯å°æ™‚/æ¯å¤©ï¼‰
â””â”€â”€ å„ªåŒ–æŸ¥è©¢æ•ˆèƒ½

ä¸å»ºè­°ï¼š
â”œâ”€â”€ ä½¿ç”¨ View è™•ç†è¤‡é›œèšåˆ
â”œâ”€â”€ æ¯æ¬¡æŸ¥è©¢éƒ½é‡æ–°è¨ˆç®—
â””â”€â”€ å³æ™‚è¨ˆç®—å¤§é‡è³‡æ–™
```

### Medallion Architecture
```
Bronze â†’ Silver â†’ Gold

Gold Layer ç‰¹é»ï¼š
â”œâ”€â”€ æ¥­å‹™å±¤ç´šèšåˆ
â”œâ”€â”€ é å…ˆè¨ˆç®—
â”œâ”€â”€ ä½å»¶é²æŸ¥è©¢
â””â”€â”€ å¤šåœ˜éšŠå…±äº«
```

---

## ğŸ“š å®˜æ–¹æ–‡ä»¶
- [Views vs Tables](https://docs.databricks.com/sql/language-manual/sql-ref-syntax-ddl-create-view.html)
- [Medallion Architecture](https://docs.databricks.com/lakehouse/medallion.html)
- [Delta Lake Best Practices](https://docs.databricks.com/delta/best-practices.html)

---

**[è¿”å›é¡Œç›®](#question-016)**
