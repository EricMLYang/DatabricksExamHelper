# Question #009

---

## é¡Œç›®è³‡è¨Š
### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-009`
### ä¾†æº
**ä¾†æº:** Community
### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L2-Intermediate`

---

## é¡Œç›®å…§å®¹
### é¡Œå¹¹
<!-- âš ï¸ ä¿æŒè‹±æ–‡åŸæ–‡ï¼Œä¸è¦ç¿»è­¯ -->
A data engineer at a healthcare organization manages a Delta Lake table patient_records with columns: patient_id, name, department, and diagnosis. They want to create a user-defined function that masks the diagnosis column so that only doctors can view values in that column.

Which of the following functions can the data engineer use to achieve this?

### é¸é …
<!-- âš ï¸ ä¿æŒè‹±æ–‡åŸæ–‡ï¼Œä¸è¦ç¿»è­¯ -->
- **A.**
```sql
CREATE FUNCTION patient_mask(diagnosis STRING)
RETURN CASE WHEN is_account_group_member('doctors') THEN 'CONFIDENTIAL' ELSE diagnosis END;
```
- **B.**
```sql
CREATE FUNCTION patient_mask(doctors STRING)
RETURN CASE WHEN is_account_group_member('diagnosis') THEN doctors ELSE 'CONFIDENTIAL' END;
```
- **C.**
```sql
CREATE FUNCTION patient_mask(diagnosis STRING)
RETURN CASE WHEN is_account_group_member('doctors') THEN diagnosis ELSE 'CONFIDENTIAL' END;
```
- **D.**
```sql
CREATE FUNCTION patient_mask(diagnosis STRING)
RETURN CASE WHEN diagnosis IS NOT NULL THEN diagnosis ELSE 'CONFIDENTIAL' END;
```

---

## æ¨™ç±¤ç³»çµ±
### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `UC-Data-Governance`, `Access-Control`, `Spark-UDF`
### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** `Logical-Trap`, `Syntax-Confusion`
### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** Data Engineering / Security & Governance

---

## ç­”æ¡ˆèˆ‡ä¾†æº
### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `C`
### ç­”æ¡ˆä¾†æº
- **ä¾†æºæ¨™è¨»ç­”æ¡ˆ:** C
- **ç¤¾ç¾¤å…±è­˜:** C

---

# é¡Œç›®è§£æ

---

## ğŸ“ è€ƒé»è­˜åˆ¥
**æ ¸å¿ƒæŠ€è¡“:** Column Masking / Row-level Security
**é—œéµæ¦‚å¿µ:** is_account_group_member()ã€æ¢ä»¶å¼è³‡æ–™é®ç½©
**é¡Œç›®é—œéµå­—ï¼š**
- **masks the diagnosis column**: é®ç½©è¨ºæ–·æ¬„ä½
- **only doctors can view**: åªæœ‰é†«ç”Ÿå¯ä»¥çœ‹åˆ°
- **is_account_group_member**: æª¢æŸ¥ç¾¤çµ„æˆå“¡

---

## âœ… æ­£è§£èªªæ˜
### ç‚ºä»€éº¼ C æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Ÿ

é¸é … C æ­£ç¢ºå¯¦ä½œäº†åŸºæ–¼è§’è‰²çš„è³‡æ–™é®ç½©é‚è¼¯ï¼š
- å¦‚æœæ˜¯ **doctors ç¾¤çµ„æˆå“¡** â†’ é¡¯ç¤º**çœŸå¯¦ diagnosis**
- å¦å‰‡ â†’ é¡¯ç¤º **'CONFIDENTIAL'**

#### æ­£ç¢ºçš„é‚è¼¯
```sql
CREATE FUNCTION patient_mask(diagnosis STRING)
RETURN CASE
    WHEN is_account_group_member('doctors') THEN diagnosis  -- é†«ç”Ÿçœ‹çœŸå¯¦å€¼
    ELSE 'CONFIDENTIAL'                                     -- å…¶ä»–äººçœ‹é®ç½©å€¼
END;
```

#### is_account_group_member() å‡½æ•¸
```sql
-- æª¢æŸ¥ç•¶å‰ç”¨æˆ¶æ˜¯å¦å±¬æ–¼æŒ‡å®šç¾¤çµ„
is_account_group_member('group_name')
-- è¿”å› TRUE æˆ– FALSE
```

#### ä½¿ç”¨æ–¹å¼
```sql
-- å»ºç«‹é®ç½©å‡½æ•¸
CREATE FUNCTION patient_mask(diagnosis STRING)
RETURN CASE WHEN is_account_group_member('doctors') THEN diagnosis ELSE 'CONFIDENTIAL' END;

-- å¥—ç”¨åˆ°è¡¨æ ¼ï¼ˆColumn Maskingï¼‰
ALTER TABLE patient_records
ALTER COLUMN diagnosis
SET MASK patient_mask;

-- æŸ¥è©¢çµæœ
-- é†«ç”Ÿï¼šSELECT diagnosis â†’ 'Cancer'
-- éé†«ç”Ÿï¼šSELECT diagnosis â†’ 'CONFIDENTIAL'
```

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### A. THEN 'CONFIDENTIAL' ELSE diagnosis
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- **é‚è¼¯é¡›å€’**
- é€™å€‹é‚è¼¯æ˜¯ï¼šé†«ç”Ÿçœ‹åˆ° 'CONFIDENTIAL'ï¼Œå…¶ä»–äººçœ‹åˆ°çœŸå¯¦å€¼
- å®Œå…¨ç›¸åæ–¼éœ€æ±‚

```sql
-- A çš„é‚è¼¯ï¼ˆéŒ¯èª¤ï¼‰ï¼š
WHEN is_account_group_member('doctors') THEN 'CONFIDENTIAL'  -- é†«ç”Ÿåè€Œè¢«é®ç½©ï¼Ÿ
ELSE diagnosis  -- éé†«ç”Ÿåè€Œçœ‹åˆ°çœŸå¯¦å€¼ï¼Ÿ
```

### B. åƒæ•¸å’Œç¾¤çµ„åç¨±éŒ¯èª¤
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- åƒæ•¸åç¨±æ‡‰è©²æ˜¯ `diagnosis`ï¼Œä¸æ˜¯ `doctors`
- ç¾¤çµ„åç¨±æ‡‰è©²æ˜¯ `'doctors'`ï¼Œä¸æ˜¯ `'diagnosis'`
- èªæ„å®Œå…¨æ··äº‚

### D. åªæª¢æŸ¥ NULL
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- **æ²’æœ‰å¯¦ä½œè§’è‰²æª¢æŸ¥**
- åªæª¢æŸ¥ diagnosis æ˜¯å¦ç‚º NULL
- æ²’æœ‰ä½¿ç”¨ `is_account_group_member()`
- ç„¡æ³•é”åˆ°ã€Œåªæœ‰é†«ç”Ÿå¯ä»¥çœ‹ã€çš„éœ€æ±‚

```sql
-- D çš„é‚è¼¯ï¼ˆéŒ¯èª¤ï¼‰ï¼š
WHEN diagnosis IS NOT NULL THEN diagnosis  -- åªè¦ä¸æ˜¯ NULL å°±é¡¯ç¤º
-- å®Œå…¨æ²’æœ‰æ¬Šé™æ§åˆ¶ï¼
```

---

## ğŸ§  è¨˜æ†¶æ³•
### å£è¨£
**ã€Œis_account_group_member æŸ¥ç¾¤çµ„ï¼ŒTHEN é¡¯ç¤º ELSE é®ç½©ã€**

### Column Masking é‚è¼¯
```
é®ç½©é‚è¼¯ï¼š
â”œâ”€â”€ æœ‰æ¬Šé™ â†’ é¡¯ç¤ºçœŸå¯¦å€¼
â””â”€â”€ ç„¡æ¬Šé™ â†’ é¡¯ç¤ºé®ç½©å€¼

ç¨‹å¼ç¢¼ï¼š
CASE WHEN is_account_group_member('authorized_group')
     THEN real_value
     ELSE masked_value
END
```

### å¸¸è¦‹é®ç½©æ¨¡å¼
| å ´æ™¯ | æœ‰æ¬Šé™é¡¯ç¤º | ç„¡æ¬Šé™é¡¯ç¤º |
|------|-----------|-----------|
| è¨ºæ–·è³‡æ–™ | 'Cancer' | 'CONFIDENTIAL' |
| ä¿¡ç”¨å¡è™Ÿ | '1234-5678-9012-3456' | 'XXXX-XXXX-XXXX-3456' |
| é›»å­éƒµä»¶ | 'john@company.com' | 'j***@company.com' |
| è–ªè³‡ | 100000 | NULL |

### Unity Catalog è³‡æ–™é®ç½©
```sql
-- 1. å»ºç«‹é®ç½©å‡½æ•¸
CREATE FUNCTION mask_salary(salary INT)
RETURN CASE WHEN is_account_group_member('hr_team') THEN salary ELSE NULL END;

-- 2. å¥—ç”¨åˆ°æ¬„ä½
ALTER TABLE employees ALTER COLUMN salary SET MASK mask_salary;

-- 3. ç§»é™¤é®ç½©
ALTER TABLE employees ALTER COLUMN salary DROP MASK;
```

### å¸¸è¦‹éŒ¯èª¤
```
éŒ¯èª¤ 1ï¼šé‚è¼¯é¡›å€’
â”œâ”€â”€ æ­£ç¢ºï¼šæœ‰æ¬Šé™ â†’ é¡¯ç¤ºçœŸå¯¦å€¼
â””â”€â”€ éŒ¯èª¤ï¼šæœ‰æ¬Šé™ â†’ é¡¯ç¤ºé®ç½©å€¼

éŒ¯èª¤ 2ï¼šå¿˜è¨˜æª¢æŸ¥æ¬Šé™
â”œâ”€â”€ æ­£ç¢ºï¼šä½¿ç”¨ is_account_group_member()
â””â”€â”€ éŒ¯èª¤ï¼šåªæª¢æŸ¥ NULL æˆ–å…¶ä»–æ¢ä»¶

éŒ¯èª¤ 3ï¼šåƒæ•¸æ··æ·†
â”œâ”€â”€ æ­£ç¢ºï¼šå‡½æ•¸åƒæ•¸æ˜¯è¦é®ç½©çš„æ¬„ä½
â””â”€â”€ éŒ¯èª¤ï¼šåƒæ•¸åç¨±èˆ‡ç¾¤çµ„åç¨±æ··æ·†
```

---

## ğŸ“š å®˜æ–¹æ–‡ä»¶
- [Column Masking](https://docs.databricks.com/data-governance/unity-catalog/row-and-column-filters.html#column-masks)
- [is_account_group_member](https://docs.databricks.com/sql/language-manual/functions/is_account_group_member.html)
- [Dynamic Data Masking](https://docs.databricks.com/data-governance/unity-catalog/row-and-column-filters.html)

---

**[è¿”å›é¡Œç›®](#question-009)**
