# Question #010

---

## é¡Œç›®è³‡è¨Š
### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-010`
### ä¾†æº
**ä¾†æº:** Community
### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L2-Intermediate`

---

## é¡Œç›®å…§å®¹
### é¡Œå¹¹
<!-- âš ï¸ ä¿æŒè‹±æ–‡åŸæ–‡ï¼Œä¸è¦ç¿»è­¯ -->
Given a Delta table 'products' with the following schema:

name STRING, category STRING, expiration_date DATE, price FLOAT

When executing the below query:

```sql
SELECT * FROM products
WHERE price > 30.5
```

Which of the following will be leveraged by the query optimizer to identify the data files to load?

### é¸é …
<!-- âš ï¸ ä¿æŒè‹±æ–‡åŸæ–‡ï¼Œä¸è¦ç¿»è­¯ -->
- **A.** Columns statistics in the Hive metastore
- **B.** Files statistics in Unity Catalog metastore
- **C.** Columns statistics in the metadata of Parquet files
- **D.** Files statistics in the Delta transaction log

---

## æ¨™ç±¤ç³»çµ±
### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `Delta-Lake`, `Delta-Optimization`, `Spark-Performance`
### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** `Concept-Confusion`
### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** Data Engineering / Performance Optimization

---

## ç­”æ¡ˆèˆ‡ä¾†æº
### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `D`
### ç­”æ¡ˆä¾†æº
- **ä¾†æºæ¨™è¨»ç­”æ¡ˆ:** D
- **ç¤¾ç¾¤å…±è­˜:** D

---

# é¡Œç›®è§£æ

---

## ğŸ“ è€ƒé»è­˜åˆ¥
**æ ¸å¿ƒæŠ€è¡“:** Delta Lake Data Skipping / Transaction Log
**é—œéµæ¦‚å¿µ:** æª”æ¡ˆçµ±è¨ˆè³‡è¨Šã€æŸ¥è©¢å„ªåŒ–ã€è³‡æ–™è·³é
**é¡Œç›®é—œéµå­—ï¼š**
- **query optimizer**: æŸ¥è©¢å„ªåŒ–å™¨
- **identify the data files to load**: æ±ºå®šè¦è¼‰å…¥å“ªäº›æª”æ¡ˆ
- **Delta transaction log**: Delta äº¤æ˜“æ—¥èªŒ

---

## âœ… æ­£è§£èªªæ˜
### ç‚ºä»€éº¼ D æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Ÿ

Delta Lake åœ¨ **Transaction Log** ä¸­å„²å­˜æ¯å€‹æª”æ¡ˆçš„çµ±è¨ˆè³‡è¨Šï¼Œç”¨æ–¼ **Data Skipping**ã€‚

#### Delta Transaction Log å„²å­˜çš„çµ±è¨ˆè³‡è¨Š
| çµ±è¨ˆé …ç›® | èªªæ˜ |
|----------|------|
| **numRecords** | æª”æ¡ˆä¸­çš„è¨˜éŒ„æ•¸é‡ |
| **minValues** | å‰ 32 æ¬„çš„æœ€å°å€¼ |
| **maxValues** | å‰ 32 æ¬„çš„æœ€å¤§å€¼ |
| **nullCount** | å‰ 32 æ¬„çš„ NULL æ•¸é‡ |

#### Data Skipping åŸç†
```
æŸ¥è©¢ï¼šSELECT * FROM products WHERE price > 30.5

Transaction Log ä¸­çš„æª”æ¡ˆçµ±è¨ˆï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    File      â”‚ min(price)â”‚ max(price)â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ file_001.par â”‚    10.0   â”‚    25.0   â”‚ â† è·³éï¼ˆmax < 30.5ï¼‰
â”‚ file_002.par â”‚    20.0   â”‚    40.0   â”‚ â† è®€å–ï¼ˆå¯èƒ½æœ‰åŒ¹é…ï¼‰
â”‚ file_003.par â”‚    35.0   â”‚    50.0   â”‚ â† è®€å–ï¼ˆå¯èƒ½æœ‰åŒ¹é…ï¼‰
â”‚ file_004.par â”‚    5.0    â”‚    15.0   â”‚ â† è·³éï¼ˆmax < 30.5ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

çµæœï¼šåªéœ€è®€å– 2 å€‹æª”æ¡ˆï¼Œè·³é 2 å€‹æª”æ¡ˆ
```

#### Transaction Log çµæ§‹
```
_delta_log/
â”œâ”€â”€ 00000000000000000000.json  â† åŒ…å«æª”æ¡ˆçµ±è¨ˆ
â”œâ”€â”€ 00000000000000000001.json
â”œâ”€â”€ 00000000000000000002.json
â””â”€â”€ ...

æ¯å€‹ JSON åŒ…å«ï¼š
{
  "add": {
    "path": "file_001.parquet",
    "stats": {
      "numRecords": 1000,
      "minValues": {"price": 10.0, "name": "A"},
      "maxValues": {"price": 25.0, "name": "Z"},
      "nullCount": {"price": 0, "name": 5}
    }
  }
}
```

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### A. Columns statistics in the Hive metastore
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- Hive metastore å„²å­˜çš„æ˜¯**è¡¨æ ¼å±¤ç´š**çš„ metadata
- ä¸å„²å­˜æ¯å€‹æª”æ¡ˆçš„çµ±è¨ˆè³‡è¨Š
- Delta Lake ä¸ä¾è³´ Hive metastore é€²è¡Œ data skipping

### B. Files statistics in Unity Catalog metastore
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- Unity Catalog å„²å­˜çš„æ˜¯**æ²»ç†å’Œæ¬Šé™**è³‡è¨Š
- æª”æ¡ˆçµ±è¨ˆè³‡è¨Šå„²å­˜åœ¨ Delta Transaction Log
- Unity Catalog ä¸ç›´æ¥åƒèˆ‡æŸ¥è©¢å„ªåŒ–

### C. Columns statistics in the metadata of Parquet files
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- Parquet æª”æ¡ˆç¢ºå¯¦æœ‰å…§éƒ¨çµ±è¨ˆï¼ˆRow Group çµ±è¨ˆï¼‰
- ä½† **Delta Lake å„ªå…ˆä½¿ç”¨ Transaction Log** ä¸­çš„çµ±è¨ˆ
- ä¸éœ€è¦æ‰“é–‹ Parquet æª”æ¡ˆå°±èƒ½è·³éä¸ç›¸é—œçš„æª”æ¡ˆ
- Transaction Log çš„çµ±è¨ˆåœ¨æª”æ¡ˆå±¤ç´šï¼Œæ›´é«˜æ•ˆ

```
Parquet å…§éƒ¨çµ±è¨ˆ vs Delta Transaction Logï¼š

Parquet çµ±è¨ˆï¼šéœ€è¦è®€å–æª”æ¡ˆ footer æ‰èƒ½çŸ¥é“
Delta çµ±è¨ˆï¼šåœ¨ _delta_log ä¸­ï¼Œä¸éœ€è¦è®€å–å¯¦éš›è³‡æ–™æª”æ¡ˆ
```

---

## ğŸ§  è¨˜æ†¶æ³•
### å£è¨£
**ã€ŒDelta Log å­˜çµ±è¨ˆï¼ŒData Skipping é å®ƒè·³ã€**

### Delta Lake çµ±è¨ˆè³‡è¨Šä½ç½®
```
çµ±è¨ˆè³‡è¨Šå„²å­˜ä½ç½®ï¼š
â”œâ”€â”€ Delta Transaction Log (_delta_log/)  â† ç”¨æ–¼ Data Skipping
â”œâ”€â”€ Parquet Row Group Statistics         â† ç”¨æ–¼æª”æ¡ˆå…§éƒ¨è·³é
â””â”€â”€ Metastore (Hive/Unity Catalog)       â† ç”¨æ–¼è¡¨æ ¼ metadata
```

### Data Skipping æ•ˆç‡
| çµ±è¨ˆä¾†æº | è®€å–æˆæœ¬ | æ•ˆç‡ |
|----------|----------|------|
| **Delta Transaction Log** | åªè®€ JSON | æœ€é«˜ |
| Parquet Footer | éœ€è®€æª”æ¡ˆ | ä¸­ç­‰ |
| å…¨è¡¨æƒæ | è®€æ‰€æœ‰è³‡æ–™ | æœ€ä½ |

### çµ±è¨ˆè³‡è¨Šé™åˆ¶
```
æ³¨æ„äº‹é …ï¼š
â”œâ”€â”€ åªçµ±è¨ˆå‰ 32 å€‹æ¬„ä½
â”œâ”€â”€ åªå° min/max æœ‰æ„ç¾©çš„é¡å‹æœ‰æ•ˆ
â”œâ”€â”€ BINARY é¡å‹é è¨­ä¸çµ±è¨ˆ
â””â”€â”€ å¯é€é table property èª¿æ•´

èª¿æ•´çµ±è¨ˆæ¬„ä½æ•¸é‡ï¼š
ALTER TABLE products
SET TBLPROPERTIES ('delta.dataSkippingNumIndexedCols' = 50);
```

### å„ªåŒ–å»ºè­°
```
æå‡ Data Skipping æ•ˆç‡ï¼š
â”œâ”€â”€ ä½¿ç”¨ Z-ORDER èšé›†ç›¸é—œè³‡æ–™
â”œâ”€â”€ ä½¿ç”¨ Liquid Clusteringï¼ˆæ–°åŠŸèƒ½ï¼‰
â”œâ”€â”€ å°‡å¸¸ç”¨ç¯©é¸æ¬„ä½æ”¾åœ¨å‰ 32 æ¬„
â””â”€â”€ åŸ·è¡Œ OPTIMIZE æ¸›å°‘å°æª”æ¡ˆ
```

---

## ğŸ“š å®˜æ–¹æ–‡ä»¶
- [Delta Lake Data Skipping](https://docs.databricks.com/delta/optimizations/data-skipping.html)
- [Delta Transaction Log](https://docs.databricks.com/delta/delta-utility.html#transaction-log)
- [Statistics Collection](https://docs.databricks.com/delta/optimizations/file-mgmt.html#data-skipping)

---

**[è¿”å›é¡Œç›®](#question-010)**
