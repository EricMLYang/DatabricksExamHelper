# Question #001

---

## é¡Œç›®è³‡è¨Š
### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-001`
### ä¾†æº
**ä¾†æº:** Community
### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L2-Intermediate`

---

## é¡Œç›®å…§å®¹
### é¡Œå¹¹
<!-- âš ï¸ ä¿æŒè‹±æ–‡åŸæ–‡ï¼Œä¸è¦ç¿»è­¯ -->
A data engineer is using the following spark configurations in a pipeline to enable Optimized Writes and Auto Compaction:

```python
spark.conf.set("spark.databricks.delta.optimizeWrite.enabled", True)
spark.conf.set("spark.databricks.delta.autoCompact.enabled", True)
```

They also want to enable Z-order indexing with Auto Compaction to leverage data skipping on all the pipeline's tables.

Which of the following solutions allows the data engineer to complete this task?

### é¸é …
<!-- âš ï¸ ä¿æŒè‹±æ–‡åŸæ–‡ï¼Œä¸è¦ç¿»è­¯ -->
- **A.** Use spark.conf.set("spark.databricks.delta.autoZorder.enabled", True)
- **B.** Z-order indexing with Auto Compaction can only be enabled on each table separately using: ALTER TABLE table_name SET TBLPROPERTIES (delta.autoOptimize.zorder.enabled = true)
- **C.** There is no way to enable Z-order indexing with Auto Compaction since it does not support Z-Ordering
- **D.** Use spark.conf.set("spark.databricks.delta.autoCompact.zorder.enabled", True)

---

## æ¨™ç±¤ç³»çµ±
### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `Delta-Optimization`, `Spark-Performance`
### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** `Concept-Confusion`, `Similar-Function`
### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** Data Engineering / Performance Optimization

---

## ç­”æ¡ˆèˆ‡ä¾†æº
### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `C`
### ç­”æ¡ˆä¾†æº
- **ä¾†æºæ¨™è¨»ç­”æ¡ˆ:** C
- **ç¤¾ç¾¤å…±è­˜:** C

---

# é¡Œç›®è§£æ

---

## ğŸ“ è€ƒé»è­˜åˆ¥
**æ ¸å¿ƒæŠ€è¡“:** Delta Lake Auto Compaction / Z-ORDER
**é—œéµæ¦‚å¿µ:** Auto Compaction çš„é™åˆ¶ã€Z-ORDER çš„åŸ·è¡Œæ–¹å¼
**é¡Œç›®é—œéµå­—ï¼š**
- **Auto Compaction**: è‡ªå‹•å£“ç¸®å°æª”æ¡ˆ
- **Z-order indexing**: è³‡æ–™æ’åºå„ªåŒ–
- **data skipping**: è³‡æ–™è·³éå„ªåŒ–

---

## âœ… æ­£è§£èªªæ˜
### ç‚ºä»€éº¼ C æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Ÿ

**Auto Compaction ä¸æ”¯æ´ Z-ORDER**ï¼Œå› ç‚º Z-ORDER çš„è¨ˆç®—æˆæœ¬é é«˜æ–¼å–®ç´”çš„æª”æ¡ˆå£“ç¸®ã€‚

#### Auto Compaction vs Z-ORDER çš„å·®ç•°
| ç‰¹æ€§ | Auto Compaction | Z-ORDER |
|------|-----------------|---------|
| **ç”¨é€”** | åˆä½µå°æª”æ¡ˆ | è³‡æ–™æ’åºå„ªåŒ– |
| **è¨ˆç®—æˆæœ¬** | ä½ | é«˜ |
| **åŸ·è¡Œæ™‚æ©Ÿ** | å¯«å…¥å¾Œè‡ªå‹• | æ‰‹å‹•åŸ·è¡Œ OPTIMIZE |
| **æ”¯æ´è‡ªå‹•åŒ–** | âœ… | âŒ |

#### ç‚ºä»€éº¼ä¸æ”¯æ´è‡ªå‹• Z-ORDERï¼Ÿ
```
Z-ORDER çš„è¨ˆç®—æˆæœ¬ï¼š
â”œâ”€â”€ éœ€è¦è®€å–æ‰€æœ‰è³‡æ–™
â”œâ”€â”€ éœ€è¦è¨ˆç®—å¤šç¶­åº¦æ’åº
â”œâ”€â”€ éœ€è¦é‡å¯«æ‰€æœ‰æª”æ¡ˆ
â””â”€â”€ è¨ˆç®—è¤‡é›œåº¦é«˜ï¼Œä¸é©åˆæ¯æ¬¡å¯«å…¥éƒ½åŸ·è¡Œ

Auto Compaction çš„è¨­è¨ˆç›®æ¨™ï¼š
â”œâ”€â”€ è¼•é‡ç´šæ“ä½œ
â”œâ”€â”€ å¿«é€Ÿåˆä½µå°æª”æ¡ˆ
â”œâ”€â”€ ä¸å½±éŸ¿å¯«å…¥æ•ˆèƒ½
â””â”€â”€ åªåšç°¡å–®çš„æª”æ¡ˆåˆä½µ
```

#### æ­£ç¢ºçš„ Z-ORDER ä½¿ç”¨æ–¹å¼
```sql
-- Z-ORDER å¿…é ˆæ‰‹å‹•åŸ·è¡Œ
OPTIMIZE table_name ZORDER BY (column1, column2);

-- å¯ä»¥æ’ç¨‹åŸ·è¡Œï¼Œä½†ä¸èƒ½è‡ªå‹•è§¸ç™¼
-- ä¾‹å¦‚ï¼šæ¯å¤©å‡Œæ™¨åŸ·è¡Œä¸€æ¬¡ OPTIMIZE ZORDER
```

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### A. spark.conf.set("spark.databricks.delta.autoZorder.enabled", True)
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- **é€™å€‹è¨­å®šä¸å­˜åœ¨**
- Databricks æ²’æœ‰æä¾›è‡ªå‹• Z-ORDER çš„ Spark è¨­å®š
- è™›æ§‹çš„é¸é …

### B. ALTER TABLE ... SET TBLPROPERTIES (delta.autoOptimize.zorder.enabled = true)
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- **é€™å€‹ Table Property ä¸å­˜åœ¨**
- æ²’æœ‰ä»»ä½•æ–¹å¼å¯ä»¥åœ¨è¡¨æ ¼å±¤ç´šå•Ÿç”¨è‡ªå‹• Z-ORDER
- è™›æ§‹çš„é¸é …

### D. spark.conf.set("spark.databricks.delta.autoCompact.zorder.enabled", True)
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- **é€™å€‹è¨­å®šä¸å­˜åœ¨**
- Auto Compaction ä¸æ”¯æ´ Z-ORDERï¼Œæ‰€ä»¥æ²’æœ‰é€™å€‹é¸é …
- è™›æ§‹çš„é¸é …

---

## ğŸ§  è¨˜æ†¶æ³•
### å£è¨£
**ã€ŒAuto Compact åªå£“ç¸®ï¼ŒZ-ORDER è¦æ‰‹å‹•ã€**

### Delta Lake è‡ªå‹•å„ªåŒ–åŠŸèƒ½
| åŠŸèƒ½ | æ”¯æ´è‡ªå‹•ï¼Ÿ | è¨­å®šæ–¹å¼ |
|------|-----------|----------|
| **Optimized Writes** | âœ… | `spark.databricks.delta.optimizeWrite.enabled` |
| **Auto Compaction** | âœ… | `spark.databricks.delta.autoCompact.enabled` |
| **Z-ORDER** | âŒ | `OPTIMIZE ... ZORDER BY` |
| **Liquid Clustering** | âœ… | æ›¿ä»£ Z-ORDER çš„æ–°æ–¹æ¡ˆ |

### å„ªåŒ–ç­–ç•¥é¸æ“‡
```
éœ€è¦è³‡æ–™æ’åºå„ªåŒ–ï¼Ÿ
â”‚
â”œâ”€â”€ æ˜¯ï¼Œä¸”å¸Œæœ›è‡ªå‹•åŒ–
â”‚   â””â”€â”€ ä½¿ç”¨ Liquid Clusteringï¼ˆæ–°åŠŸèƒ½ï¼‰
â”‚
â”œâ”€â”€ æ˜¯ï¼Œå¯ä»¥æ‰‹å‹•æ’ç¨‹
â”‚   â””â”€â”€ ä½¿ç”¨ OPTIMIZE ZORDER BY
â”‚
â””â”€â”€ å¦ï¼Œåªéœ€è¦æ¸›å°‘å°æª”æ¡ˆ
    â””â”€â”€ ä½¿ç”¨ Auto Compaction
```

### ç›¸é—œè¨­å®šä¸€è¦½
```python
# å•Ÿç”¨ Optimized Writesï¼ˆæ¸›å°‘å¯«å…¥æ™‚çš„å°æª”æ¡ˆï¼‰
spark.conf.set("spark.databricks.delta.optimizeWrite.enabled", True)

# å•Ÿç”¨ Auto Compactionï¼ˆå¯«å…¥å¾Œè‡ªå‹•åˆä½µå°æª”æ¡ˆï¼‰
spark.conf.set("spark.databricks.delta.autoCompact.enabled", True)

# Z-ORDER åªèƒ½æ‰‹å‹•åŸ·è¡Œ
# OPTIMIZE my_table ZORDER BY (col1, col2)
```

---

## ğŸ“š å®˜æ–¹æ–‡ä»¶
- [Auto Compaction](https://docs.databricks.com/delta/optimizations/auto-optimize.html#auto-compaction)
- [Optimized Writes](https://docs.databricks.com/delta/optimizations/auto-optimize.html#optimized-writes)
- [Z-ORDER Clustering](https://docs.databricks.com/delta/optimizations/file-mgmt.html#z-ordering-multi-dimensional-clustering)

---

**[è¿”å›é¡Œç›®](#question-001)**
