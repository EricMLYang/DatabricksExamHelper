# Question #020

---

## é¡Œç›®è³‡è¨Š
### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-020`
### ä¾†æº
**ä¾†æº:** Community
### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L2-Intermediate`

---

## é¡Œç›®å…§å®¹
### é¡Œå¹¹
<!-- âš ï¸ ä¿æŒè‹±æ–‡åŸæ–‡ï¼Œä¸è¦ç¿»è­¯ -->
A data engineer is building a Lakeflow Declarative Pipeline to process product sales data. The pipeline needs to enforce the following data quality rules:

`valid_products = {"valid_id": "products_id IS NOT NULL", "recent_sales": "date >= '2025-01-01", "quantity_within_range": "quantity BETWEEN 0 AND 1000"}`

Any invalid records should still be written to the target, while metrics about these violations are captured by the pipeline.

Which of the following configurations would satisfy these requirements?

### é¸é …
<!-- âš ï¸ ä¿æŒè‹±æ–‡åŸæ–‡ï¼Œä¸è¦ç¿»è­¯ -->
- **A.**
```python
@dlt.table
@dlt.expect_all(valid_products)
def silver_sales():
    return dlt.read_stream("bronze_sales")
```
- **B.**
```python
@dlt.table
@dlt.expect_or_fail(valid_products)
def silver_sales():
    return dlt.read_stream("bronze_sales")
```
- **C.**
```python
@dlt.table
@dlt.expect(valid_products)
def silver_sales():
    return dlt.read_stream("bronze_sales")
```
- **D.**
```python
@dlt.table
@dlt.expect_or_drop(valid_products)
def silver_sales():
    return dlt.read_stream("bronze_sales")
```

---

## æ¨™ç±¤ç³»çµ±
### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `Lakeflow-DLP`, `Data-Quality`
### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** `Syntax-Confusion`
### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** Data Engineering / Data Quality

---

## ç­”æ¡ˆèˆ‡ä¾†æº
### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `A`
### ç­”æ¡ˆä¾†æº
- **ä¾†æºæ¨™è¨»ç­”æ¡ˆ:** A
- **ç¤¾ç¾¤å…±è­˜:** A

---

# é¡Œç›®è§£æ

---

## ğŸ“ è€ƒé»è­˜åˆ¥
**æ ¸å¿ƒæŠ€è¡“:** Lakeflow DLP Expectations
**é—œéµæ¦‚å¿µ:** expect_allã€è³‡æ–™å“è³ªè¦å‰‡ã€å¤šè¦å‰‡é©—è­‰
**é¡Œç›®é—œéµå­—ï¼š**
- **invalid records should still be written**: ç„¡æ•ˆè¨˜éŒ„ä»è¦å¯«å…¥
- **metrics about violations are captured**: æ•æ‰é•è¦æŒ‡æ¨™
- **multiple rules**: å¤šå€‹è¦å‰‡ï¼ˆå­—å…¸å½¢å¼ï¼‰

---

## âœ… æ­£è§£èªªæ˜
### ç‚ºä»€éº¼ A æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Ÿ

**`expect_all`** å¯ä»¥ï¼š
- ä¸€æ¬¡å¥—ç”¨**å¤šå€‹è¦å‰‡**ï¼ˆå­—å…¸å½¢å¼ï¼‰
- **ä¿ç•™æ‰€æœ‰è¨˜éŒ„**ï¼ˆåŒ…æ‹¬ç„¡æ•ˆçš„ï¼‰
- **è¨˜éŒ„é•è¦æŒ‡æ¨™**ä¾›ç›£æ§

#### expect_all è¡Œç‚º
```
expect_all è¡Œç‚ºï¼š
â”œâ”€â”€ é©—è­‰æ‰€æœ‰è¦å‰‡
â”œâ”€â”€ ç„¡æ•ˆè¨˜éŒ„ â†’ ä»ç„¶å¯«å…¥
â”œâ”€â”€ é•è¦æŒ‡æ¨™ â†’ è¨˜éŒ„åˆ° event log
â””â”€â”€ Pipeline â†’ ç¹¼çºŒåŸ·è¡Œ
```

#### ç¨‹å¼ç¢¼è§£æ
```python
# å¤šå€‹è¦å‰‡å®šç¾©
valid_products = {
    "valid_id": "products_id IS NOT NULL",
    "recent_sales": "date >= '2025-01-01'",
    "quantity_within_range": "quantity BETWEEN 0 AND 1000"
}

@dlt.table
@dlt.expect_all(valid_products)  # å¥—ç”¨æ‰€æœ‰è¦å‰‡
def silver_sales():
    return dlt.read_stream("bronze_sales")

# çµæœï¼š
# - æ‰€æœ‰è¨˜éŒ„éƒ½å¯«å…¥ silver_sales
# - é•è¦è¨˜éŒ„è¢«æ¨™è¨˜ä¸¦è¨˜éŒ„æŒ‡æ¨™
# - å¯ä»¥åœ¨ event log ä¸­æŸ¥çœ‹é•è¦æ•¸é‡
```

#### Expectation é¡å‹æ¯”è¼ƒ
| å‡½æ•¸ | ç„¡æ•ˆè¨˜éŒ„è™•ç† | å¤šè¦å‰‡æ”¯æ´ | Pipeline è¡Œç‚º |
|------|-------------|-----------|--------------|
| **expect** | ä¿ç•™ | å–®ä¸€è¦å‰‡ | ç¹¼çºŒ |
| **expect_all** | ä¿ç•™ | å¤šè¦å‰‡ | ç¹¼çºŒ |
| **expect_or_drop** | ä¸Ÿæ£„ | å–®ä¸€è¦å‰‡ | ç¹¼çºŒ |
| **expect_all_or_drop** | ä¸Ÿæ£„ | å¤šè¦å‰‡ | ç¹¼çºŒ |
| **expect_or_fail** | å¤±æ•— | å–®ä¸€è¦å‰‡ | åœæ­¢ |
| **expect_all_or_fail** | å¤±æ•— | å¤šè¦å‰‡ | åœæ­¢ |

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### B. expect_or_fail(valid_products)
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- **Pipeline æœƒåœ¨é•è¦æ™‚åœæ­¢**
- é¡Œç›®è¦æ±‚ã€Œç„¡æ•ˆè¨˜éŒ„ä»è¦å¯«å…¥ã€
- expect_or_fail æœƒè®“ Pipeline å¤±æ•—

```
expect_or_fail è¡Œç‚ºï¼š
â”œâ”€â”€ ç™¼ç¾é•è¦ â†’ Pipeline åœæ­¢
â”œâ”€â”€ ç„¡æ•ˆè¨˜éŒ„ â†’ ä¸æœƒå¯«å…¥
â””â”€â”€ ä¸ç¬¦åˆé¡Œç›®éœ€æ±‚
```

### C. expect(valid_products)
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- **expect åªæ¥å—å–®ä¸€è¦å‰‡**ï¼Œä¸æ˜¯å­—å…¸
- æ­£ç¢ºèªæ³•ï¼š`@dlt.expect("rule_name", "condition")`
- å‚³å…¥å­—å…¸æœƒé€ æˆéŒ¯èª¤

```python
# expect æ­£ç¢ºç”¨æ³•ï¼ˆå–®ä¸€è¦å‰‡ï¼‰
@dlt.expect("valid_id", "products_id IS NOT NULL")

# expect éŒ¯èª¤ç”¨æ³•
@dlt.expect(valid_products)  # ä¸èƒ½å‚³å­—å…¸ï¼
```

### D. expect_or_drop(valid_products)
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- **æœƒä¸Ÿæ£„ç„¡æ•ˆè¨˜éŒ„**
- é¡Œç›®è¦æ±‚ã€Œç„¡æ•ˆè¨˜éŒ„ä»è¦å¯«å…¥ã€
- ä¸” expect_or_drop ä¹Ÿåªæ¥å—å–®ä¸€è¦å‰‡

```
expect_or_drop è¡Œç‚ºï¼š
â”œâ”€â”€ ç™¼ç¾é•è¦ â†’ ä¸Ÿæ£„è©²è¨˜éŒ„
â”œâ”€â”€ åªæœ‰æœ‰æ•ˆè¨˜éŒ„å¯«å…¥
â””â”€â”€ ä¸ç¬¦åˆé¡Œç›®éœ€æ±‚
```

---

## ğŸ§  è¨˜æ†¶æ³•
### å£è¨£
**ã€Œexpect_all å¤šè¦å‰‡ï¼Œè¨˜éŒ„ä¿ç•™æŒ‡æ¨™ç®—ã€**

### Expectation å‡½æ•¸é¸æ“‡æŒ‡å—
```
å¦‚ä½•é¸æ“‡ Expectation å‡½æ•¸ï¼Ÿ

Q1: æœ‰å¤šå°‘è¦å‰‡ï¼Ÿ
â”œâ”€â”€ å¤šå€‹è¦å‰‡ â†’ ä½¿ç”¨ _all ç‰ˆæœ¬
â””â”€â”€ å–®ä¸€è¦å‰‡ â†’ ä½¿ç”¨åŸºæœ¬ç‰ˆæœ¬

Q2: é•è¦æ™‚å¦‚ä½•è™•ç†ï¼Ÿ
â”œâ”€â”€ ä¿ç•™è¨˜éŒ„ â†’ expect / expect_all
â”œâ”€â”€ ä¸Ÿæ£„è¨˜éŒ„ â†’ expect_or_drop / expect_all_or_drop
â””â”€â”€ åœæ­¢ Pipeline â†’ expect_or_fail / expect_all_or_fail
```

### å‡½æ•¸å‘½åè¦å‰‡
```
å‘½åè¦å‰‡ï¼š
â”œâ”€â”€ expect â†’ ä¿ç•™è¨˜éŒ„
â”œâ”€â”€ expect_or_drop â†’ ä¸Ÿæ£„é•è¦è¨˜éŒ„
â”œâ”€â”€ expect_or_fail â†’ Pipeline å¤±æ•—
â””â”€â”€ _all å¾Œç¶´ â†’ æ”¯æ´å¤šè¦å‰‡ï¼ˆå­—å…¸ï¼‰
```

### å¸¸è¦‹ä½¿ç”¨å ´æ™¯
| å ´æ™¯ | å»ºè­°å‡½æ•¸ |
|------|----------|
| å¤šè¦å‰‡ã€ä¿ç•™é•è¦ | `expect_all` |
| å¤šè¦å‰‡ã€ä¸Ÿæ£„é•è¦ | `expect_all_or_drop` |
| å¤šè¦å‰‡ã€åš´æ ¼é©—è­‰ | `expect_all_or_fail` |
| å–®ä¸€è¦å‰‡ã€ä¿ç•™é•è¦ | `expect` |

### ç›£æ§é•è¦æŒ‡æ¨™
```python
# é•è¦æŒ‡æ¨™æœƒè¨˜éŒ„åœ¨ï¼š
# - Pipeline event log
# - DLT ç›£æ§ä»‹é¢
# - å¯ä»¥è¨­å®šå‘Šè­¦

# æŸ¥çœ‹æŒ‡æ¨™
SELECT * FROM event_log
WHERE details:expectation IS NOT NULL
```

---

## ğŸ“š å®˜æ–¹æ–‡ä»¶
- [DLT Expectations](https://docs.databricks.com/delta-live-tables/expectations.html)
- [expect_all](https://docs.databricks.com/delta-live-tables/expectations.html#expect-all)
- [Data Quality Monitoring](https://docs.databricks.com/delta-live-tables/observability.html)

---

**[è¿”å›é¡Œç›®](#question-020)**
