# Question #019

---

## é¡Œç›®è³‡è¨Š
### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-019`

### ä¾†æº
**ä¾†æº:** Sample / Batch 1

### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L2-Intermediate`

---

## é¡Œç›®å…§å®¹
### é¡Œå¹¹
The data engineering team has a large external Delta table where new changes are merged very frequently. They enabled Optimized writes and Auto Compaction on the table in order to automatically compact small data files to target files of size 128 MB. However, when they look at the table directory, they see that most data files are smaller than 128 MB.

Which of the following likely explains these smaller file sizes?

### é¸é …
- **A.** Auto compaction supports Auto Z-Ordering which is more expensive than just compaction.

- **B.** Optimized Writes and Auto Compaction have no effect on external tables. The table needs to be managed in order to store the information of file sizes in the Hive metastore.

- **C.** Optimized Writes and Auto Compaction automatically generate smaller data files to reduce the duration of future MERGE operations.

- **D.** Optimized Writes and Auto Compaction have no effect on large Delta tables. The table needs to be partitioned so Auto Compaction can be applied at partition level.

---

## æ¨™ç±¤ç³»çµ±
### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `Delta-Lake`, `Delta-Optimization`

### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** `Concept-Confusion`

### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** Data Engineering / Storage Optimization

---

## ç­”æ¡ˆèˆ‡ä¾†æº
### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `C`

### ç­”æ¡ˆä¾†æº
- **ä¾†æºæ¨™è¨»ç­”æ¡ˆ:** C
- **ç¤¾ç¾¤å…±è­˜:** C

---

# é¡Œç›®è§£æ

---

## ğŸ“ è€ƒé»è­˜åˆ¥

**æ ¸å¿ƒæŠ€è¡“:** Delta Lake Autotune File Size Based on Workload

**é—œéµæ¦‚å¿µ:**
- å·¥ä½œè² è¼‰è‡ªé©æ‡‰æª”æ¡ˆå¤§å°èª¿æ•´
- MERGE æ“ä½œèˆ‡æª”æ¡ˆå¤§å°çš„é—œä¿‚
- Auto Compaction çš„æ™ºæ…§è¡Œç‚º

**é¡Œç›®é—œéµå­—ï¼š**
- **merged very frequently**: é »ç¹çš„ MERGE æ“ä½œæ˜¯è§¸ç™¼è‡ªå‹•èª¿æ•´çš„é—œéµ
- **smaller than 128 MB**: é æœŸ 128 MB ä½†å¯¦éš›æ›´å°
- **Optimized Writes and Auto Compaction**: å…©å€‹ Auto Optimize åŠŸèƒ½

---

## âœ… æ­£è§£èªªæ˜

### ç‚ºä»€éº¼ C æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Ÿ

**æŠ€è¡“åŸç†ï¼š**

Databricks æœƒæ ¹æ“š**å·¥ä½œè² è¼‰ç‰¹æ€§**è‡ªå‹•èª¿æ•´ Delta è¡¨æ ¼çš„ç›®æ¨™æª”æ¡ˆå¤§å°ã€‚ç•¶åµæ¸¬åˆ°è¡¨æ ¼æœ‰**é »ç¹çš„ MERGEã€DELETE æˆ– UPDATE æ“ä½œ**æ™‚ï¼Œç³»çµ±æœƒ**è‡ªå‹•ç”¢ç”Ÿè¼ƒå°çš„æª”æ¡ˆ**ï¼Œä»¥å„ªåŒ–é€™äº›æ“ä½œçš„æ•ˆèƒ½ã€‚

#### Autotune File Size æ©Ÿåˆ¶

```
é »ç¹ MERGE çš„è¡¨æ ¼ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‚³çµ± 128 MB æª”æ¡ˆ                         â”‚
â”‚ MERGE æ™‚éœ€è¦è®€å–ã€ä¿®æ”¹ã€é‡å¯«æ•´å€‹ 128 MB   â”‚
â”‚ â†’ å³ä½¿åªæ”¹ä¸€ç­†è³‡æ–™ï¼Œä¹Ÿè¦é‡å¯« 128 MB       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â†“ Autotune èª¿æ•´

â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ 32MB â”‚ â”‚ 32MB â”‚ â”‚ 32MB â”‚ â”‚ 32MB â”‚
â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜
MERGE æ™‚åªéœ€é‡å¯«å—å½±éŸ¿çš„å°æª”æ¡ˆ
â†’ æ¸›å°‘ I/Oï¼ŒåŠ é€Ÿ MERGE æ“ä½œ
```

#### ç‚ºä»€éº¼å°æª”æ¡ˆå° MERGE æœ‰åˆ©ï¼Ÿ

1. **æ¸›å°‘é‡å¯«ç¯„åœ**ï¼š
   - MERGE æ“ä½œéœ€è¦é‡å¯«åŒ…å«ç›®æ¨™è³‡æ–™çš„æª”æ¡ˆ
   - æª”æ¡ˆè¶Šå°ï¼Œæ¯æ¬¡é‡å¯«çš„è³‡æ–™é‡è¶Šå°‘

2. **æé«˜ä¸¦è¡Œåº¦**ï¼š
   - æ›´å¤šå°æª”æ¡ˆ = æ›´å¤šå¹³è¡Œè™•ç†å–®ä½
   - å¯ä»¥åŒæ™‚è™•ç†å¤šå€‹æª”æ¡ˆçš„ MERGE

3. **æ¸›å°‘è³‡æºç«¶çˆ­**ï¼š
   - å¯«å…¥é–å®šçš„ç¯„åœæ›´å°
   - ä½µç™¼ MERGE æ“ä½œæ›´å°‘ç™¼ç”Ÿè¡çª

#### Autotune çš„é‹ä½œé‚è¼¯

```python
# Databricks å…§éƒ¨é‚è¼¯ï¼ˆæ¦‚å¿µèªªæ˜ï¼‰
if table_has_frequent_merge_operations():
    target_file_size = calculate_optimal_size()  # å¯èƒ½æ˜¯ 32MB, 64MB ç­‰
else:
    target_file_size = 128  # MBï¼ˆAuto Compaction é è¨­ï¼‰
    # æˆ– 1024 MBï¼ˆæ¨™æº– OPTIMIZE é è¨­ï¼‰
```

#### æŸ¥çœ‹è¡¨æ ¼çš„æª”æ¡ˆå¤§å°åˆ†ä½ˆ

```sql
-- æª¢æŸ¥æª”æ¡ˆå¤§å°åˆ†ä½ˆ
DESCRIBE DETAIL my_table;

-- æŸ¥çœ‹è©³ç´°æª”æ¡ˆè³‡è¨Š
SELECT
    size / 1024 / 1024 AS size_mb,
    COUNT(*) AS file_count
FROM (
    SELECT input_file_size() AS size
    FROM my_table
)
GROUP BY 1
ORDER BY 1;
```

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### é¸é … A
**Auto compaction supports Auto Z-Ordering which is more expensive than just compaction.**

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

1. **Auto Compaction ä¸æ”¯æ´ Z-Ordering**ï¼š
   - å¦‚åŒ Q-016 æ‰€è¿°ï¼ŒAuto Compaction **ä¸æ”¯æ´** Z-Ordering
   - Z-Ordering éœ€è¦æ‰‹å‹•åŸ·è¡Œ `OPTIMIZE ... ZORDER BY`

2. **èˆ‡æª”æ¡ˆå¤§å°ç„¡é—œ**ï¼š
   - å³ä½¿æœ‰ Z-Orderingï¼Œä¹Ÿä¸æœƒè§£é‡‹ç‚ºä»€éº¼æª”æ¡ˆæ¯” 128 MB å°
   - Z-Ordering æ˜¯è³‡æ–™æ’åˆ—æ–¹å¼ï¼Œä¸å½±éŸ¿æª”æ¡ˆå¤§å°ç›®æ¨™

---

### é¸é … B
**Optimized Writes and Auto Compaction have no effect on external tables.**

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

1. **External Tables å®Œå…¨æ”¯æ´ Auto Optimize**ï¼š
   - Optimized Writes å’Œ Auto Compaction å° external tables æœ‰æ•ˆ
   - é€™äº›åŠŸèƒ½ä½œç”¨æ–¼ Delta Lake å±¤ç´šï¼Œä¸å— table type é™åˆ¶

2. **Hive Metastore ä¸å„²å­˜æª”æ¡ˆå¤§å°è³‡è¨Š**ï¼š
   - æª”æ¡ˆå¤§å°è³‡è¨Šå­˜åœ¨ Delta transaction log ä¸­
   - èˆ‡ Hive metastore ç„¡é—œ

```sql
-- External table ä¹Ÿå¯ä»¥å•Ÿç”¨ Auto Optimize
ALTER TABLE external_delta_table
SET TBLPROPERTIES (
    delta.autoOptimize.optimizeWrite = true,
    delta.autoOptimize.autoCompact = true
);
```

---

### é¸é … D
**Optimized Writes and Auto Compaction have no effect on large Delta tables.**

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

1. **è¡¨æ ¼å¤§å°ä¸å½±éŸ¿ Auto Optimize åŠŸèƒ½**ï¼š
   - Auto Optimize å°ä»»ä½•å¤§å°çš„è¡¨æ ¼éƒ½æœ‰æ•ˆ
   - å¯¦éš›ä¸Šï¼Œå¤§è¡¨æ ¼æ›´éœ€è¦é€™äº›å„ªåŒ–åŠŸèƒ½

2. **ä¸éœ€è¦ Partitioning**ï¼š
   - Auto Compaction å¯ä»¥åœ¨æœªåˆ†å€çš„è¡¨æ ¼ä¸Šé‹ä½œ
   - åˆ†å€æ˜¯å¯é¸çš„ï¼Œä¸æ˜¯å¿…è¦æ¢ä»¶

3. **é¡Œç›®çš„çœŸæ­£åŸå› **ï¼š
   - ä¸æ˜¯åŠŸèƒ½ã€Œæ²’æ•ˆæœã€
   - è€Œæ˜¯åŠŸèƒ½**æ™ºæ…§åœ°é¸æ“‡äº†è¼ƒå°çš„ç›®æ¨™å¤§å°**

---

## ğŸ§  è¨˜æ†¶æ³•

### å£è¨£
**ã€Œé »ç¹ MERGE å°æª”å¥½ï¼Œé‡å¯«ç¯„åœå°‘åˆå¦™ã€**
â†’ é »ç¹ MERGE çš„è¡¨æ ¼ï¼ŒDatabricks æœƒè‡ªå‹•ä½¿ç”¨è¼ƒå°çš„æª”æ¡ˆå¤§å°

### Autotune è§¸ç™¼æ¢ä»¶

| å·¥ä½œè² è¼‰é¡å‹ | ç›®æ¨™æª”æ¡ˆå¤§å° | åŸå›  |
|-------------|-------------|------|
| **é »ç¹ MERGE/DELETE** | **è¼ƒå°**ï¼ˆå¦‚ 32-64 MBï¼‰ | æ¸›å°‘é‡å¯«ç¯„åœ |
| **é »ç¹ INSERTï¼ˆappendï¼‰** | **è¼ƒå¤§**ï¼ˆå¦‚ 128 MB+ï¼‰ | æ¸›å°‘æª”æ¡ˆæ•¸é‡ |
| **è®€å–å¯†é›†** | **è¼ƒå¤§**ï¼ˆå¦‚ 1 GBï¼‰ | æ¸›å°‘æª”æ¡ˆæƒææ¬¡æ•¸ |

### æª”æ¡ˆå¤§å° vs æ“ä½œæ•ˆèƒ½

```
æª”æ¡ˆå¤§å°å°ä¸åŒæ“ä½œçš„å½±éŸ¿ï¼š

        å°æª”æ¡ˆ (32MB)              å¤§æª”æ¡ˆ (1GB)
            â†“                          â†“
MERGE    âœ… å¿«ï¼ˆé‡å¯«å°‘ï¼‰           âŒ æ…¢ï¼ˆé‡å¯«å¤šï¼‰
DELETE   âœ… å¿«ï¼ˆé‡å¯«å°‘ï¼‰           âŒ æ…¢ï¼ˆé‡å¯«å¤šï¼‰
UPDATE   âœ… å¿«ï¼ˆé‡å¯«å°‘ï¼‰           âŒ æ…¢ï¼ˆé‡å¯«å¤šï¼‰
SELECT   âš ï¸ éœ€è¦æƒæå¤šæª”æ¡ˆ         âœ… å¿«ï¼ˆæª”æ¡ˆå°‘ï¼‰
INSERT   âš ï¸ ç”¢ç”Ÿæ›´å¤šæª”æ¡ˆ           âœ… æª”æ¡ˆæ•¸è¼ƒå°‘
```

### å¯¦å‹™è€ƒé‡

**å•é¡Œ**ï¼šç‚ºä»€éº¼æˆ‘çš„è¡¨æ ¼æª”æ¡ˆæ¯”é æœŸå°ï¼Ÿ
**ç­”æ¡ˆ**ï¼š
1. æª¢æŸ¥æ˜¯å¦æœ‰é »ç¹çš„ MERGE/UPDATE/DELETE æ“ä½œ
2. Databricks Autotune æœƒæ ¹æ“šå·¥ä½œè² è¼‰è‡ªå‹•èª¿æ•´
3. é€™æ˜¯**é æœŸè¡Œç‚º**ï¼Œä¸æ˜¯å•é¡Œ

---

## ğŸ“š å®˜æ–¹æ–‡ä»¶

- [Autotune file size based on workload](https://docs.databricks.com/delta/tune-file-size.html#autotune-file-size-based-on-workload)
- [Auto Optimize](https://docs.databricks.com/delta/tune-file-size.html#auto-optimize)
- [When to use Auto Compaction](https://docs.databricks.com/delta/tune-file-size.html#when-to-use-auto-compaction)

---

**[è¿”å›é¡Œç›®](#question-019)**
