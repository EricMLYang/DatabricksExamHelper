# Question #015

---

## é¡Œç›®è³‡è¨Š

### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-015`

### ä¾†æº
**ä¾†æº:** Community

### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L2-Intermediate`

---

## é¡Œç›®å…§å®¹

### é¡Œå¹¹

A data engineering team is working on a user activity events table stored in Unity Catalog. Queries often involve filters on multiple columns like user_id and event_date.

Which data layout technique should the team implement to avoid expensive table scans?

### é¸é …

- **A.** Use partitioning on the event_date column.
- **B.** Use Z-order indexing on the user_id.
- **C.** Use liquid clustering on the combination of user_id and event_date.
- **D.** Use partitioning on the user_id column, along with Z-order indexing on the event_date column.

---

## æ¨™ç±¤ç³»çµ±

### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `Delta-Lake`, `Delta-Optimization`, `Spark-Performance`

### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** `Similar-Function`, `Concept-Confusion`

### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** Data Engineering / Performance Optimization

---

## ç­”æ¡ˆèˆ‡ä¾†æº

### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `C`

### ç­”æ¡ˆä¾†æº
- **ä¾†æºæ¨™è¨»ç­”æ¡ˆ:** C
- **ç¤¾ç¾¤å…±è­˜:** C

---

# é¡Œç›®è§£æ

---

## ğŸ“ è€ƒé»è­˜åˆ¥

**æ ¸å¿ƒæŠ€è¡“:** Delta Lake Data Layout / Liquid Clustering
**é—œéµæ¦‚å¿µ:** Liquid Clustering, Z-ORDER, Partitioning, Multi-column optimization

**é¡Œç›®é—œéµå­—ï¼š**
- **filters on multiple columns**: éœ€è¦åŒæ™‚å„ªåŒ–å¤šå€‹æ¬„ä½çš„éæ¿¾ã€‚
- **user_id and event_date**: å…©å€‹å¸¸ç”¨çš„éæ¿¾æ¬„ä½ã€‚
- **avoid expensive table scans**: éœ€è¦å„ªåŒ–æŸ¥è©¢æ•ˆèƒ½ã€‚

---

## âœ… æ­£è§£èªªæ˜

### ç‚ºä»€éº¼ C æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Ÿ

**æŠ€è¡“åŸç†ï¼š**

1. **Liquid Clustering çš„å„ªå‹¢**:
   - **å¢é‡å„ªåŒ–**: åªè™•ç†æ–°å¯«å…¥çš„è³‡æ–™ï¼Œä¸éœ€è¦é‡æ–°çµ„ç¹”æ•´å€‹è¡¨æ ¼
   - **å¤šæ¬„ä½æ”¯æ´**: å¯ä»¥åŒæ™‚å°å¤šå€‹æ¬„ä½é€²è¡Œèšé¡
   - **è‡ªå‹•ç¶­è­·**: å¯«å…¥æ™‚è‡ªå‹•å„ªåŒ–ï¼Œä¸éœ€è¦é¡å¤–çš„ OPTIMIZE å‘½ä»¤
   - **é©æ‡‰æ€§**: å¯ä»¥å‹•æ…‹èª¿æ•´èšé¡æ¬„ä½

2. **ç‚ºä»€éº¼é©åˆæ­¤å ´æ™¯**:
   - æŸ¥è©¢ç¶“å¸¸åŒæ™‚éæ¿¾ `user_id` å’Œ `event_date`
   - Liquid Clustering å¯ä»¥åŒæ™‚å„ªåŒ–é€™å…©å€‹æ¬„ä½
   - ä¸æœƒç”¢ç”Ÿéå¤šçš„å°åˆ†å€

**è¨­å®š Liquid Clusteringï¼š**

```sql
CREATE TABLE user_activity
CLUSTER BY (user_id, event_date)
AS SELECT * FROM ...;

-- æˆ–å°ç¾æœ‰è¡¨å•Ÿç”¨
ALTER TABLE user_activity
CLUSTER BY (user_id, event_date);
```

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### A - åªå° event_date åˆ†å€

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

- **åªå„ªåŒ–ä¸€å€‹ç¶­åº¦**: å° `event_date` çš„éæ¿¾æœ‰æ•ˆï¼Œä½† `user_id` éæ¿¾ä»éœ€æƒææ•´å€‹åˆ†å€ã€‚
- **åˆ†å€å…§æƒæ**: ç•¶æŸ¥è©¢åŒæ™‚éæ¿¾ user_id æ™‚ï¼Œéœ€è¦æƒæè©²æ—¥æœŸåˆ†å€çš„æ‰€æœ‰è³‡æ–™ã€‚

### B - åªå° user_id åš Z-ORDER

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

- **åªå„ªåŒ–ä¸€å€‹ç¶­åº¦**: å° `user_id` æœ‰æ•ˆï¼Œä½† `event_date` éæ¿¾æ•ˆç‡ä½ã€‚
- **Z-ORDER éœ€è¦ç¶­è­·**: éœ€è¦å®šæœŸåŸ·è¡Œ `OPTIMIZE` ä¾†ç¶­æŒæ•ˆæœã€‚

### D - user_id åˆ†å€ + event_date Z-ORDER

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

- **å°åˆ†å€å•é¡Œ**: å¦‚æœ user_id åŸºæ•¸å¾ˆé«˜ï¼ˆå¤§é‡ç”¨æˆ¶ï¼‰ï¼Œæœƒç”¢ç”Ÿå¤§é‡å°åˆ†å€ã€‚
- **ç®¡ç†è¤‡é›œ**: åˆ†å€æ•¸é‡éå¤šæœƒå½±éŸ¿ metadata ç®¡ç†æ•ˆèƒ½ã€‚
- **æ•ˆèƒ½å•é¡Œ**: å°æª”æ¡ˆå•é¡Œæœƒå°è‡´æŸ¥è©¢æ•ˆèƒ½ä¸‹é™ã€‚
- **Liquid Clustering æ›´å„ª**: å®ƒèƒ½åŒæ™‚è™•ç†å…©å€‹ç¶­åº¦ï¼Œä¸”é¿å…å°åˆ†å€å•é¡Œã€‚

---

## ğŸ§  è¨˜æ†¶æ³•

### å£è¨£

**ã€Œå¤šæ¬„éæ¿¾ç”¨ Liquidï¼Œå–®æ¬„åˆ†å€ Z-ORDERã€**

### è³‡æ–™çµ„ç¹”æŠ€è¡“æ¯”è¼ƒ

| æŠ€è¡“ | é©ç”¨å ´æ™¯ | ç¶­è­·æ–¹å¼ | æ¬„ä½æ•¸ |
|------|----------|----------|--------|
| **Partitioning** | ä½åŸºæ•¸æ¬„ä½ï¼ˆå¦‚æ—¥æœŸï¼‰ | è‡ªå‹• | 1-2 |
| **Z-ORDER** | é«˜åŸºæ•¸æ¬„ä½ | éœ€è¦ OPTIMIZE | å¤šå€‹ |
| **Liquid Clustering** | å¤šæ¬„ä½éæ¿¾ | **è‡ªå‹•å¢é‡** | å¤šå€‹ |

### é¸æ“‡æ±ºç­–æ¨¹

```
å¤šæ¬„ä½éæ¿¾?
â”œâ”€â”€ æ˜¯ â†’ Liquid Clustering âœ…
â””â”€â”€ å¦ â†’ å–®ä¸€æ¬„ä½éæ¿¾?
          â”œâ”€â”€ ä½åŸºæ•¸ â†’ Partitioning
          â””â”€â”€ é«˜åŸºæ•¸ â†’ Z-ORDER
```

### Liquid Clustering ç‰¹æ€§

| ç‰¹æ€§ | èªªæ˜ |
|------|------|
| å¢é‡å„ªåŒ– | åªè™•ç†æ–°è³‡æ–™ |
| è‡ªå‹•ç¶­è­· | å¯«å…¥æ™‚è‡ªå‹•èšé¡ |
| å¤šæ¬„ä½ | æ”¯æ´å¤šå€‹èšé¡æ¬„ä½ |
| å½ˆæ€§è®Šæ›´ | å¯ä»¥æ›´æ”¹èšé¡æ¬„ä½ |
| ç„¡å°æª”æ¡ˆ | è‡ªå‹•åˆä½µå°æª”æ¡ˆ |

---

## ğŸ“š å®˜æ–¹æ–‡ä»¶

- [Liquid Clustering](https://docs.databricks.com/delta/liquid-clustering.html)
- [Delta Lake Optimization](https://docs.databricks.com/delta/optimizations/index.html)
- [Z-ORDER vs Liquid Clustering](https://docs.databricks.com/delta/liquid-clustering.html#liquid-clustering-vs-partitioning-and-z-order)

---

**[è¿”å›é¡Œç›®](#question-015)**
