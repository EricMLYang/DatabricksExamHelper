# Question #045

---

## é¡Œç›®è³‡è¨Š
### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-045`
### ä¾†æº
**ä¾†æº:** Community
### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L1-Basic`

---

## é¡Œç›®å…§å®¹
### é¡Œå¹¹
<!-- âš ï¸ ä¿æŒè‹±æ–‡åŸæ–‡ï¼Œä¸è¦ç¿»è­¯ -->
A data engineer run the following CTAS statement in a SQL notebook attached to an All-purpose cluster:

```sql
CREATE TABLE course_students
AS (
    SELECT c.course_name, t.student_id, t.student_name
    FROM courses c
    LEFT JOIN (
        SELECT s.student_id, s.student_name, e.course_id
        FROM students s
        INNER JOIN enrollments e
        ON s.student_id = e.student_id
    ) t
    ON c.course_id = t.course_id
    WHERE c.active = true
)
```

Which statement describes the resulting course_students table?

### é¸é …
<!-- âš ï¸ ä¿æŒè‹±æ–‡åŸæ–‡ï¼Œä¸è¦ç¿»è­¯ -->
- **A.** It's a session-scoped table. The SELECT statement will be executed at the table creation, but its output will be stored in the cache of the current active Spark session.
- **B.** It's a virtual table that has no physical data. The SELECT statement will be executed each time the course_students table is queried.
- **C.** It's a cluster-scoped table. The SELECT statement will be executed at the table creation, but its output will be stored in the memory of the currently active cluster.
- **D.** It's a Delta Lake table. The SELECT statement will be executed at the table creation, and its output will be stored in Delta format on the underlying storage.

---

## æ¨™ç±¤ç³»çµ±
### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `Delta-Lake`, `Databricks-SQL`
### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** `Execution-Behavior`
### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** Data Engineering / Data Modeling

---

## ç­”æ¡ˆèˆ‡ä¾†æº
### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `D`
### ç­”æ¡ˆä¾†æº
- **ä¾†æºæ¨™è¨»ç­”æ¡ˆ:** D
- **ç¤¾ç¾¤å…±è­˜:** D

---

# é¡Œç›®è§£æ

---

## ğŸ“ è€ƒé»è­˜åˆ¥
**æ ¸å¿ƒæŠ€è¡“:** CREATE TABLE AS SELECT (CTAS)
**é—œéµæ¦‚å¿µ:** CTAS è¡Œç‚ºã€Delta Lake é è¨­æ ¼å¼
**é¡Œç›®é—œéµå­—ï¼š**
- **CTAS statement**: CREATE TABLE AS SELECT èªæ³•
- **resulting table**: çµæœè¡¨æ ¼çš„é¡å‹
- **stored**: è³‡æ–™å„²å­˜æ–¹å¼

---

## âœ… æ­£è§£èªªæ˜
### ç‚ºä»€éº¼ D æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Ÿ

åœ¨ Databricks ä¸­ï¼Œ**CTASï¼ˆCREATE TABLE AS SELECTï¼‰** æœƒå»ºç«‹**å¯¦é«”çš„ Delta Lake è¡¨æ ¼**ã€‚

#### CTAS çš„è¡Œç‚ºç‰¹æ€§
| ç‰¹æ€§ | èªªæ˜ |
|------|------|
| **æ ¼å¼** | é è¨­ç‚º Delta Lake æ ¼å¼ |
| **åŸ·è¡Œæ™‚æ©Ÿ** | å»ºç«‹æ™‚åŸ·è¡Œä¸€æ¬¡ SELECT |
| **è³‡æ–™å„²å­˜** | çµæœå„²å­˜æ–¼å¯¦é«”å„²å­˜ç©ºé–“ |
| **æŒä¹…æ€§** | è¡¨æ ¼æŒçºŒå­˜åœ¨ç›´åˆ°è¢«åˆªé™¤ |

#### CTAS åŸ·è¡Œæµç¨‹
```
CREATE TABLE course_students AS (SELECT ...)
                    â†“
           1. åŸ·è¡Œ SELECT æŸ¥è©¢
                    â†“
           2. å°‡çµæœå¯«å…¥ Delta æ ¼å¼
                    â†“
           3. åœ¨ Metastore è¨»å†Šè¡¨æ ¼
                    â†“
           4. è¡¨æ ¼æ°¸ä¹…å­˜åœ¨
```

#### ç‚ºä»€éº¼æ˜¯ Delta Lake æ ¼å¼ï¼Ÿ
```sql
-- åœ¨ Databricks ä¸­ï¼Œä»¥ä¸‹å…©å€‹èªæ³•ç­‰åƒ¹ï¼š
CREATE TABLE course_students AS (SELECT ...)

-- ç­‰åŒæ–¼
CREATE TABLE course_students
USING DELTA
AS (SELECT ...)
```

#### å¯¦é«”å„²å­˜çµæ§‹
```
course_students/
â”œâ”€â”€ _delta_log/
â”‚   â””â”€â”€ 00000000000000000000.json
â”œâ”€â”€ part-00000-xxx.parquet
â””â”€â”€ part-00001-xxx.parquet
```

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### A. ...session-scoped table...stored in the cache...
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- CTAS å»ºç«‹çš„æ˜¯**æ°¸ä¹…è¡¨æ ¼**ï¼Œä¸æ˜¯ session-scoped
- è³‡æ–™å„²å­˜åœ¨**ç£ç¢Ÿ**ï¼Œä¸æ˜¯å¿«å–
- Session çµæŸå¾Œè¡¨æ ¼ä»ç„¶å­˜åœ¨

```sql
-- Session-scoped çš„æ˜¯ Temporary Viewï¼Œä¸æ˜¯ CTAS
CREATE TEMPORARY VIEW temp_view AS (SELECT ...)
-- é€™æ‰æ˜¯ session-scoped
```

### B. ...virtual table that has no physical data...executed each time...
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- é€™æè¿°çš„æ˜¯ **Viewï¼ˆè¦–åœ–ï¼‰**ï¼Œä¸æ˜¯ CTAS
- CTAS æœƒ**å¯¦éš›å„²å­˜è³‡æ–™**
- æŸ¥è©¢ CTAS è¡¨æ ¼æ™‚è®€å–çš„æ˜¯å·²å„²å­˜çš„è³‡æ–™

```sql
-- View æ‰æ˜¯æ¯æ¬¡é‡æ–°åŸ·è¡Œ
CREATE VIEW my_view AS (SELECT ...)
-- æ¯æ¬¡æŸ¥è©¢ my_view éƒ½æœƒé‡æ–°åŸ·è¡Œ SELECT
```

### C. ...cluster-scoped table...stored in the memory...
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- CTAS ä¸æœƒå°‡è³‡æ–™å­˜åœ¨ cluster è¨˜æ†¶é«”
- è³‡æ–™å„²å­˜åœ¨**æŒä¹…å„²å­˜**ï¼ˆå¦‚ S3ã€ADLSã€GCSï¼‰
- Cluster é‡å•Ÿå¾Œè³‡æ–™ä»ç„¶å­˜åœ¨

---

## ğŸ§  è¨˜æ†¶æ³•
### å£è¨£
**ã€ŒCTAS å»ºè¡¨å­˜ç£ç¢Ÿï¼ŒDelta æ ¼å¼æ˜¯é è¨­ã€**

### CTAS vs View vs Temp View æ¯”è¼ƒ
| èªæ³• | å„²å­˜è³‡æ–™ | ç”Ÿå‘½é€±æœŸ | åŸ·è¡Œæ™‚æ©Ÿ |
|------|---------|---------|---------|
| **CTAS** | âœ… å¯¦é«”å„²å­˜ | æ°¸ä¹… | å»ºç«‹æ™‚åŸ·è¡Œä¸€æ¬¡ |
| **CREATE VIEW** | âŒ åªå­˜æŸ¥è©¢ | æ°¸ä¹… | æ¯æ¬¡æŸ¥è©¢åŸ·è¡Œ |
| **CREATE TEMP VIEW** | âŒ åªå­˜æŸ¥è©¢ | Session | æ¯æ¬¡æŸ¥è©¢åŸ·è¡Œ |

### åˆ¤æ–·æ±ºç­–æ¨¹
```
CREATE èªå¥é¡å‹åˆ¤æ–·ï¼š
â”œâ”€â”€ CREATE TABLE ... AS SELECT
â”‚   â””â”€â”€ CTAS â†’ å¯¦é«” Delta è¡¨æ ¼
â”‚
â”œâ”€â”€ CREATE VIEW ... AS SELECT
â”‚   â””â”€â”€ è¦–åœ– â†’ è™›æ“¬è¡¨æ ¼
â”‚
â””â”€â”€ CREATE TEMPORARY VIEW ... AS SELECT
    â””â”€â”€ è‡¨æ™‚è¦–åœ– â†’ Session çµæŸæ¶ˆå¤±
```

### CTAS é‡è¦ç‰¹æ€§
```
CTAS ç‰¹æ€§ï¼š
â”œâ”€â”€ åŸ·è¡Œæ™‚æ©Ÿï¼šå»ºç«‹æ™‚åŸ·è¡Œ SELECTï¼ˆä¸€æ¬¡ï¼‰
â”œâ”€â”€ è³‡æ–™æ ¼å¼ï¼šDelta Lakeï¼ˆDatabricks é è¨­ï¼‰
â”œâ”€â”€ å„²å­˜ä½ç½®ï¼šç‰©ä»¶å„²å­˜ï¼ˆS3/ADLS/GCSï¼‰
â””â”€â”€ ç”Ÿå‘½é€±æœŸï¼šæ°¸ä¹…å­˜åœ¨
```

### è¨˜æ†¶æŠ€å·§
- **CTAS** = CREATE **TABLE** = å»ºè¡¨ = å¯¦é«”è³‡æ–™
- **View** = VIEW = è¦–åœ– = è™›æ“¬çª—å£
- **Temp** = TEMPORARY = è‡¨æ™‚ = Session çµæŸæ¶ˆå¤±

---

## ğŸ“š å®˜æ–¹æ–‡ä»¶
- [CREATE TABLE](https://docs.databricks.com/en/sql/language-manual/sql-ref-syntax-ddl-create-table-using.html)
- [CREATE VIEW](https://docs.databricks.com/en/sql/language-manual/sql-ref-syntax-ddl-create-view.html)

---

**[è¿”å›é¡Œç›®](#question-045)**
