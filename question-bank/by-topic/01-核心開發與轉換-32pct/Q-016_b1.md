# Question #016

---

## é¡Œç›®è³‡è¨Š
### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-016`

### ä¾†æº
**ä¾†æº:** Sample / Batch 1

### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L2-Intermediate`

---

## é¡Œç›®å…§å®¹
### é¡Œå¹¹
Which of the following statements best describes Delta Lake Auto Compaction?

### é¸é …
- **A.** Auto Compaction occurs after a write to a table has succeeded to check if files can further be compacted; if yes, it runs an OPTIMIZE job with Z-Ordering toward a file size of 128 MB.

- **B.** Auto Compaction occurs after a write to a table has succeeded to check if files can further be compacted; if yes, it runs an OPTIMIZE job without Z-Ordering toward a file size of 128 MB.

- **C.** Auto Compaction occurs after a write to a table has succeeded to check if files can further be compacted; if yes, it runs an OPTIMIZE job without Z-Ordering toward a file size of 1 GB.

- **D.** Auto Compaction occurs after a write to a table has succeeded to check if files can further be compacted; if yes, it runs an OPTIMIZE job with Z-Ordering toward a file size of 1 GB.

---

## æ¨™ç±¤ç³»çµ±
### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `Delta-Lake`, `Delta-Optimization`

### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** `Number-Trap`, `Concept-Confusion`

### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** Data Engineering / Storage Optimization

---

## ç­”æ¡ˆèˆ‡ä¾†æº
### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `B`

### ç­”æ¡ˆä¾†æº
- **ä¾†æºæ¨™è¨»ç­”æ¡ˆ:** B
- **ç¤¾ç¾¤å…±è­˜:** B

---

# é¡Œç›®è§£æ

---

## ğŸ“ è€ƒé»è­˜åˆ¥

**æ ¸å¿ƒæŠ€è¡“:** Delta Lake Auto Optimize - Auto Compaction æ©Ÿåˆ¶

**é—œéµæ¦‚å¿µ:**
- Auto Compaction çš„è§¸ç™¼æ™‚æ©Ÿ
- Auto Compaction èˆ‡ Z-Ordering çš„é—œä¿‚
- æª”æ¡ˆå¤§å°ç›®æ¨™ï¼š128 MB vs 1 GB

**é¡Œç›®é—œéµå­—ï¼š**
- **Auto Compaction**: è‡ªå‹•å£“ç¸®åŠŸèƒ½ï¼Œåœ¨å¯«å…¥å¾Œè‡ªå‹•åŸ·è¡Œ
- **OPTIMIZE**: Delta Lake çš„æª”æ¡ˆå„ªåŒ–æŒ‡ä»¤
- **Z-Ordering**: å¤šç¶­åº¦è³‡æ–™ä½ˆå±€å„ªåŒ–
- **128 MB / 1 GB**: ä¸åŒå ´æ™¯çš„ç›®æ¨™æª”æ¡ˆå¤§å°

---

## âœ… æ­£è§£èªªæ˜

### ç‚ºä»€éº¼ B æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Ÿ

**æŠ€è¡“åŸç†ï¼š**

Auto Compaction æ˜¯ Delta Lake Auto Optimize åŠŸèƒ½çš„ä¸€éƒ¨åˆ†ã€‚å®ƒæœƒåœ¨æ¯æ¬¡å¯«å…¥æ“ä½œæˆåŠŸå¾Œï¼Œè‡ªå‹•æª¢æŸ¥æ˜¯å¦éœ€è¦åˆä½µå°æª”æ¡ˆï¼Œä¸¦åŸ·è¡Œè¼•é‡ç´šçš„ OPTIMIZE æ“ä½œã€‚

#### Auto Compaction çš„æ ¸å¿ƒç‰¹æ€§

| ç‰¹æ€§ | èªªæ˜ |
|------|------|
| **è§¸ç™¼æ™‚æ©Ÿ** | å¯«å…¥æ“ä½œæˆåŠŸå¾Œè‡ªå‹•è§¸ç™¼ |
| **Z-Ordering** | âŒ **ä¸æ”¯æ´**ï¼ˆæˆæœ¬å¤ªé«˜ï¼‰ |
| **ç›®æ¨™æª”æ¡ˆå¤§å°** | **128 MB**ï¼ˆéæ¨™æº–çš„ 1 GBï¼‰ |
| **åŸ·è¡Œæ–¹å¼** | åœ¨åŒä¸€å€‹ Spark Session ä¸­ç•°æ­¥åŸ·è¡Œ |

#### å•Ÿç”¨ Auto Compaction

```sql
-- æ–¹æ³• 1ï¼šè¡¨æ ¼å±¤ç´šè¨­å®š
ALTER TABLE my_table
SET TBLPROPERTIES (delta.autoOptimize.autoCompact = true);

-- æ–¹æ³• 2ï¼šSession å±¤ç´šè¨­å®š
SET spark.databricks.delta.autoCompact.enabled = true;

-- æ–¹æ³• 3ï¼šå»ºè¡¨æ™‚è¨­å®š
CREATE TABLE my_table (...)
TBLPROPERTIES (delta.autoOptimize.autoCompact = true);
```

#### Auto Compaction vs æ¨™æº– OPTIMIZE æ¯”è¼ƒ

| ç‰¹æ€§ | Auto Compaction | æ¨™æº– OPTIMIZE |
|------|-----------------|--------------|
| **è§¸ç™¼æ–¹å¼** | è‡ªå‹•ï¼ˆå¯«å…¥å¾Œï¼‰ | æ‰‹å‹•åŸ·è¡Œ |
| **ç›®æ¨™æª”æ¡ˆå¤§å°** | **128 MB** | **1 GB** |
| **Z-Ordering** | âŒ ä¸æ”¯æ´ | âœ… æ”¯æ´ |
| **åŸ·è¡Œæˆæœ¬** | è¼•é‡ç´š | è¼ƒé‡ï¼ˆå®Œæ•´å„ªåŒ–ï¼‰ |
| **é©ç”¨å ´æ™¯** | é »ç¹å°æ‰¹æ¬¡å¯«å…¥ | å®šæœŸç¶­è­·ä½œæ¥­ |

#### ç‚ºä»€éº¼ Auto Compaction ä½¿ç”¨ 128 MBï¼Ÿ

1. **å¿«é€ŸåŸ·è¡Œ**ï¼šè¼ƒå°çš„ç›®æ¨™æª”æ¡ˆå¤§å°æ„å‘³è‘—è¼ƒå°‘çš„è³‡æ–™ç§»å‹•
2. **æ¸›å°‘å»¶é²**ï¼šå¯«å…¥æ“ä½œå¾Œçš„é¡å¤–å»¶é²æœ€å°åŒ–
3. **å¢é‡å„ªåŒ–**ï¼šä¸éœ€è¦ä¸€æ¬¡é”åˆ°æœ€ä½³ç‹€æ…‹ï¼Œå¤šæ¬¡ Auto Compaction æœƒé€æ­¥æ”¹å–„

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### é¸é … A
**...runs an OPTIMIZE job with Z-Ordering toward a file size of 128 MB.**

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

1. **Auto Compaction ä¸æ”¯æ´ Z-Ordering**ï¼š
   - Z-Ordering éœ€è¦å°è³‡æ–™é€²è¡Œé‡æ–°æ’åºï¼Œè¨ˆç®—æˆæœ¬å¾ˆé«˜
   - æ¯æ¬¡å¯«å…¥å¾Œéƒ½åŸ·è¡Œ Z-Ordering æœƒåš´é‡å½±éŸ¿æ•ˆèƒ½
   - å®˜æ–¹æ–‡ä»¶æ˜ç¢ºæŒ‡å‡ºï¼šAuto Compaction ä¸æ”¯æ´ Z-Ordering

2. **Z-Ordering çš„æ­£ç¢ºä½¿ç”¨æ–¹å¼**ï¼š
```sql
-- Z-Ordering éœ€è¦æ‰‹å‹•åŸ·è¡Œ OPTIMIZE
OPTIMIZE my_table ZORDER BY (column1, column2);

-- æˆ–å®šæœŸæ’ç¨‹åŸ·è¡Œï¼Œè€Œéæ¯æ¬¡å¯«å…¥å¾Œè‡ªå‹•åŸ·è¡Œ
```

---

### é¸é … C
**...runs an OPTIMIZE job without Z-Ordering toward a file size of 1 GB.**

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

1. **æª”æ¡ˆå¤§å°ç›®æ¨™éŒ¯èª¤**ï¼š
   - Auto Compaction çš„ç›®æ¨™æ˜¯ **128 MB**ï¼Œä¸æ˜¯ 1 GB
   - 1 GB æ˜¯æ¨™æº– OPTIMIZE çš„ç›®æ¨™æª”æ¡ˆå¤§å°

2. **è¨­è¨ˆç†å¿µå·®ç•°**ï¼š
   - Auto Compaction è¿½æ±‚ã€Œå¿«é€Ÿã€è¼•é‡ã€ï¼Œ128 MB è¶³å¤ æ”¹å–„å°æª”æ¡ˆå•é¡Œ
   - æ¨™æº– OPTIMIZE è¿½æ±‚ã€Œå®Œæ•´å„ªåŒ–ã€ï¼Œ1 GB æ˜¯æœ€ä½³è®€å–æ•ˆèƒ½çš„ç›®æ¨™

---

### é¸é … D
**...runs an OPTIMIZE job with Z-Ordering toward a file size of 1 GB.**

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

1. **é›™é‡éŒ¯èª¤**ï¼š
   - âŒ Auto Compaction ä¸æ”¯æ´ Z-Ordering
   - âŒ ç›®æ¨™æª”æ¡ˆå¤§å°æ˜¯ 128 MBï¼Œä¸æ˜¯ 1 GB

2. **é€™å€‹æè¿°æ›´åƒæ˜¯æ‰‹å‹•åŸ·è¡Œçš„ OPTIMIZE**ï¼š
```sql
-- é€™æ‰æ˜¯ 1 GB + Z-Ordering çš„æ“ä½œï¼ˆæ‰‹å‹•åŸ·è¡Œï¼‰
OPTIMIZE my_table ZORDER BY (column1);
-- é è¨­ç›®æ¨™æª”æ¡ˆå¤§å°ç‚º 1 GB
```

---

## ğŸ§  è¨˜æ†¶æ³•

### å£è¨£
**ã€ŒAuto Compact 128ï¼ŒZ-Order ä¸æ²¾é‚Šã€**
â†’ Auto Compaction ç›®æ¨™æ˜¯ 128 MBï¼Œä¸æ”¯æ´ Z-Ordering

**ã€Œæ¨™æº– OPTIMIZE ä¸€å€‹ Gï¼ŒZ-Order æ‰èƒ½åŠ ã€**
â†’ æ¨™æº– OPTIMIZE ç›®æ¨™æ˜¯ 1 GBï¼Œå¯ä»¥æ­é… Z-Ordering

### æ•¸å­—è¨˜æ†¶

| åŠŸèƒ½ | æª”æ¡ˆå¤§å° | Z-Ordering |
|------|---------|-----------|
| Auto Compaction | **128** MB | âŒ |
| OPTIMIZE | **1** GB (1024 MB) | âœ… |

**è¨˜æ†¶æŠ€å·§**ï¼š128 æ˜¯ 1024 çš„ 1/8ï¼ŒAuto Compaction æ˜¯ã€Œè¼•é‡ç‰ˆã€æ‰€ä»¥ç›®æ¨™è¼ƒå°

### Auto Optimize å®Œæ•´é…ç½®

```sql
-- Auto Optimize = Optimized Writes + Auto Compaction
ALTER TABLE my_table SET TBLPROPERTIES (
  delta.autoOptimize.optimizeWrite = true,  -- å„ªåŒ–å¯«å…¥
  delta.autoOptimize.autoCompact = true     -- è‡ªå‹•å£“ç¸®
);
```

| åŠŸèƒ½ | èªªæ˜ |
|------|------|
| **Optimized Writes** | å¯«å…¥æ™‚è‡ªå‹•å„ªåŒ– partition çš„æª”æ¡ˆæ•¸é‡ |
| **Auto Compaction** | å¯«å…¥å¾Œè‡ªå‹•åˆä½µå°æª”æ¡ˆï¼ˆ128 MB ç›®æ¨™ï¼‰ |

---

## ğŸ“š å®˜æ–¹æ–‡ä»¶

- [Auto Compaction for Delta Lake](https://docs.databricks.com/delta/tune-file-size.html#auto-compaction-for-delta-lake-on-databricks)
- [Auto Optimize](https://docs.databricks.com/delta/tune-file-size.html#auto-optimize)
- [OPTIMIZE Command](https://docs.databricks.com/sql/language-manual/delta-optimize.html)
- [Z-Ordering](https://docs.databricks.com/delta/data-skipping.html#z-ordering)

---

**[è¿”å›é¡Œç›®](#question-016)**
