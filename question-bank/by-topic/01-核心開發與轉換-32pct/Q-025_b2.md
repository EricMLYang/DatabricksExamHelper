# Question #025

---

## é¡Œç›®è³‡è¨Š

### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-025`

### ä¾†æº
**ä¾†æº:** Community

### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L2-Intermediate`

---

## é¡Œç›®å…§å®¹

### é¡Œå¹¹

A data engineer wants to use Autoloader to ingest input data into a target table, and automatically evolve the schema of the table when new fields are detected.

They use the below query with a blank:

```python
spark.readStream
    .format("cloudFiles")
    .option("cloudFiles.format", "json")
    .option("cloudFiles.schemaLocation", checkpointPath)
    .load(source_path)
.writeStream
    .option("checkpointLocation", checkpointPath)
    .___________
    .start("target_table")
```

Which option correctly fills in the blank to meet the specified requirement?

### é¸é …

- **A.** option("mergeSchema", True)
- **B.** option("cloudFiles.mergeSchema", True)
- **C.** option("cloudFiles.schemaEvolutionMode", "addNewColumns")
- **D.** schema(schema_definition, mergeSchema=True)

---

## æ¨™ç±¤ç³»çµ±

### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `Auto-Loader`, `Delta-Lake-Schema`, `Streaming-Sources`

### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** `Read-vs-Write-Options`, `Syntax-Confusion`

### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** Data Engineering / Development

---

## ç­”æ¡ˆèˆ‡ä¾†æº

### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `A`

### ç­”æ¡ˆä¾†æº
- **ä¾†æºæ¨™è¨»ç­”æ¡ˆ:** A
- **ç¤¾ç¾¤å…±è­˜:** A

---

# é¡Œç›®è§£æ

---

## ğŸ“ è€ƒé»è­˜åˆ¥

**æ ¸å¿ƒæŠ€è¡“:** Auto Loader + Delta Lake / Schema Evolution
**é—œéµæ¦‚å¿µ:** mergeSchema, cloudFiles options, Read vs Write configuration

**é¡Œç›®é—œéµå­—ï¼š**
- **automatically evolve the schema**: è‡ªå‹•æ¼”é€² schemaã€‚
- **new fields are detected**: åµæ¸¬åˆ°æ–°æ¬„ä½æ™‚ã€‚
- **writeStream**: å¯«å…¥ç«¯çš„é…ç½®ã€‚

---

## âœ… æ­£è§£èªªæ˜

### ç‚ºä»€éº¼ A æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Ÿ

**æŠ€è¡“åŸç†ï¼š**

1. **Schema Evolution åˆ†å…©å€‹å±¤æ¬¡**:
   ```
   è®€å–ç«¯ (cloudFiles):
   - cloudFiles.schemaEvolutionMode â†’ æ§åˆ¶å¦‚ä½•è™•ç†æ–°æ¬„ä½
   - cloudFiles.schemaLocation â†’ å„²å­˜æ¨æ–·çš„ schema

   å¯«å…¥ç«¯ (Delta):
   - mergeSchema â†’ æ§åˆ¶æ˜¯å¦å°‡æ–°æ¬„ä½åˆä½µåˆ° Delta è¡¨
   ```

2. **ç‚ºä»€éº¼éœ€è¦ writeStream çš„ mergeSchema**:
   - Auto Loader åµæ¸¬åˆ°æ–°æ¬„ä½å¾Œï¼Œæœƒåœ¨ DataFrame ä¸­åŒ…å«é€™äº›æ¬„ä½
   - ä½† Delta è¡¨é è¨­ä¸æ¥å—æ–°æ¬„ä½
   - éœ€è¦ `mergeSchema` å‘Šè¨´ Delta æ¥å—ä¸¦åˆä½µæ–°æ¬„ä½

3. **æ­£ç¢ºèªæ³•**:
   ```python
   .writeStream
       .option("mergeSchema", True)  # æˆ– "true"
       .start("target_table")
   ```

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### B - cloudFiles.mergeSchema

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

- **ä¸å­˜åœ¨æ­¤é¸é …**: `cloudFiles.` å‰ç¶´ç”¨æ–¼è®€å–ç«¯é…ç½®ã€‚
- **å¯«å…¥ç«¯ä½¿ç”¨**: mergeSchema æ˜¯ Delta/Spark å¯«å…¥ç«¯çš„é¸é …ï¼Œä¸å¸¶ `cloudFiles.` å‰ç¶´ã€‚

### C - cloudFiles.schemaEvolutionMode

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

- **ä½ç½®éŒ¯èª¤**: é€™æ˜¯è®€å–ç«¯é¸é …ï¼Œæ‡‰åœ¨ `.format("cloudFiles")` ä¹‹å¾Œä½¿ç”¨ã€‚
- **ç”¨é€”ä¸åŒ**: æ§åˆ¶ Auto Loader å¦‚ä½•è™•ç†æ–°æ¬„ä½ï¼Œä¸æ§åˆ¶ Delta è¡¨çš„ schema æ¼”é€²ã€‚
- **å·²æœ‰æ¨æ–·**: é¡Œç›®å·²è¨­å®š schemaLocationï¼ŒAuto Loader æœƒè‡ªå‹•æ¨æ–· schemaã€‚

### D - schema(schema_definition, mergeSchema=True)

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

- **èªæ³•éŒ¯èª¤**: `schema()` æ–¹æ³•ä¸æ¥å— `mergeSchema` åƒæ•¸ã€‚
- **ç”¨é€”ä¸åŒ**: `schema()` ç”¨æ–¼æŒ‡å®šå›ºå®š schemaï¼Œèˆ‡è‡ªå‹•æ¼”é€²ç›¸æ‚–ã€‚

---

## ğŸ§  è¨˜æ†¶æ³•

### å£è¨£

**ã€Œè®€ç”¨ cloudFilesï¼Œå¯«ç”¨ mergeSchemaã€**

### Schema Evolution é…ç½®å°ç…§è¡¨

| è¨­å®šä½ç½® | é¸é … | ç”¨é€” |
|----------|------|------|
| **è®€å–ç«¯** | cloudFiles.schemaEvolutionMode | åµæ¸¬åˆ°æ–°æ¬„ä½çš„è™•ç†æ–¹å¼ |
| **è®€å–ç«¯** | cloudFiles.schemaLocation | å„²å­˜æ¨æ–·çš„ schema |
| **å¯«å…¥ç«¯** | mergeSchema | å…è¨± Delta è¡¨æ¥å—æ–°æ¬„ä½ |

### schemaEvolutionMode é¸é …

| æ¨¡å¼ | è¡Œç‚º |
|------|------|
| addNewColumns | è‡ªå‹•æ–°å¢æ¬„ä½ |
| rescue | æ–°æ¬„ä½æ”¾å…¥ _rescued_data |
| failOnNewColumns | é‡åˆ°æ–°æ¬„ä½å‰‡å¤±æ•— |
| none | å¿½ç•¥æ–°æ¬„ä½ |

---

## ğŸ“š å®˜æ–¹æ–‡ä»¶

- [Auto Loader Schema Evolution](https://docs.databricks.com/ingestion/auto-loader/schema.html)
- [Delta Lake Schema Evolution](https://docs.databricks.com/delta/update-schema.html#add-columns-with-automatic-schema-update)

---

**[è¿”å›é¡Œç›®](#question-025)**
