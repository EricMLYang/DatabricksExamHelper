# Question #018

---

## é¡Œç›®è³‡è¨Š

### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-018`

### ä¾†æº
**ä¾†æº:** Community

### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L2-Intermediate`

---

## é¡Œç›®å…§å®¹

### é¡Œå¹¹

A junior data engineer has created the table 'orders_backup' as a copy of the table "orders". Recently, the team started getting an error when querying the orders_backup indicating that some data files are no longer present. The transaction logs for the orders tables show a recent run of VACUUM command.

Which of the following explains how the data engineer created the orders_backup table?

### é¸é …

- **A.** The orders_backup table was created using Delta Lake's SHALLOW CLONE functionality from the orders table.
- **B.** The orders_backup table was created using CTAS statement from orders table.
- **C.** The orders_backup table was created using CRAS statement from orders table.
- **D.** The orders_backup table was created using Delta Lake's DEEP CLONE functionality from the orders table.

---

## æ¨™ç±¤ç³»çµ±

### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `Delta-Lake`, `ETL-Patterns`

### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** `Similar-Function`, `Side-Effect`

### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** Data Engineering / Data Management

---

## ç­”æ¡ˆèˆ‡ä¾†æº

### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `A`

### ç­”æ¡ˆä¾†æº
- **ä¾†æºæ¨™è¨»ç­”æ¡ˆ:** A
- **ç¤¾ç¾¤å…±è­˜:** A

---

# é¡Œç›®è§£æ

---

## ğŸ“ è€ƒé»è­˜åˆ¥

**æ ¸å¿ƒæŠ€è¡“:** Delta Lake / Clone Operations
**é—œéµæ¦‚å¿µ:** Shallow Clone vs Deep Clone, VACUUM impact, File references

**é¡Œç›®é—œéµå­—ï¼š**
- **data files are no longer present**: æª”æ¡ˆéºå¤±éŒ¯èª¤ã€‚
- **VACUUM command on source**: ä¾†æºè¡¨åŸ·è¡Œäº† VACUUMã€‚
- **backup table**: å‚™ä»½è¡¨å—åˆ°å½±éŸ¿ã€‚

---

## âœ… æ­£è§£èªªæ˜

### ç‚ºä»€éº¼ A æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Ÿ

**æŠ€è¡“åŸç†ï¼š**

1. **Shallow Clone çš„ç‰¹æ€§**:
   - åªè¤‡è£½ Delta transaction logï¼ˆmetadataï¼‰
   - **ä¸è¤‡è£½å¯¦éš›è³‡æ–™æª”æ¡ˆ**
   - Clone è¡¨æŒ‡å‘èˆ‡ä¾†æºè¡¨ç›¸åŒçš„è³‡æ–™æª”æ¡ˆ

2. **å•é¡Œç™¼ç”Ÿçš„åŸå› **:
   ```
   Shallow Clone å»ºç«‹æ™‚ï¼š
   orders (ä¾†æº) â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€ part-0001.parquet
   orders_backup â”€â”€â”€â”€â”€â”€â”˜    part-0002.parquet
                            (å…©è¡¨å…±ç”¨ç›¸åŒæª”æ¡ˆ)

   VACUUM orders å¾Œï¼š
   orders â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (æ–°æª”æ¡ˆ)
   orders_backup â”€â”€â”€â”€â”€â”€Xâ”€â”€â”€â”€ part-0001.parquet (å·²åˆªé™¤!)
                            part-0002.parquet (å·²åˆªé™¤!)
   ```

3. **éŒ¯èª¤è¨Šæ¯**:
   æŸ¥è©¢ orders_backup æ™‚ï¼Œtransaction log ä»æŒ‡å‘å·²è¢« VACUUM åˆªé™¤çš„æª”æ¡ˆï¼Œå°è‡´ã€Œfiles not foundã€éŒ¯èª¤ã€‚

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### B - CTAS (CREATE TABLE AS SELECT)

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

- **æœƒè¤‡è£½è³‡æ–™**: CTAS æœƒå»ºç«‹æ–°çš„è³‡æ–™æª”æ¡ˆã€‚
- **ç¨ç«‹å„²å­˜**: æ–°è¡¨æœ‰è‡ªå·±çš„è³‡æ–™æª”æ¡ˆï¼Œä¸å—ä¾†æºè¡¨ VACUUM å½±éŸ¿ã€‚

### C - CRAS (CREATE OR REPLACE TABLE AS SELECT)

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

- **åŒ CTAS**: ä¹Ÿæœƒè¤‡è£½è³‡æ–™åˆ°æ–°æª”æ¡ˆã€‚
- **ç¨ç«‹æ–¼ä¾†æº**: ä¸æœƒå› ä¾†æºè¡¨ VACUUM è€Œéºå¤±è³‡æ–™ã€‚

### D - Deep Clone

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

- **Deep Clone æœƒè¤‡è£½è³‡æ–™**: å»ºç«‹å®Œå…¨ç¨ç«‹çš„è³‡æ–™å‰¯æœ¬ã€‚
- **ä¸å—ä¾†æºå½±éŸ¿**: ä¾†æºè¡¨çš„ VACUUM ä¸æœƒå½±éŸ¿ Deep Cloneã€‚

---

## ğŸ§  è¨˜æ†¶æ³•

### å£è¨£

**ã€ŒShallow å…±ç”¨æª”ï¼ŒVACUUM æœƒå‡ºäº‹ã€**

### Clone é¡å‹æ¯”è¼ƒ

| é¡å‹ | è¤‡è£½å…§å®¹ | è³‡æ–™ç¨ç«‹æ€§ | VACUUM å½±éŸ¿ | é€Ÿåº¦ |
|------|----------|-----------|-------------|------|
| **Shallow Clone** | åªè¤‡è£½ metadata | **ä¸ç¨ç«‹** | **æœƒå—å½±éŸ¿** | å¿« |
| **Deep Clone** | metadata + è³‡æ–™ | ç¨ç«‹ | ä¸å—å½±éŸ¿ | æ…¢ |

### å»ºç«‹èªæ³•

```sql
-- Shallow Cloneï¼ˆå¿«é€Ÿï¼Œä½†å…±ç”¨æª”æ¡ˆï¼‰
CREATE TABLE backup SHALLOW CLONE source;

-- Deep Cloneï¼ˆæ…¢ï¼Œä½†å®Œå…¨ç¨ç«‹ï¼‰
CREATE TABLE backup DEEP CLONE source;

-- CTASï¼ˆè¤‡è£½è³‡æ–™ï¼Œç¨ç«‹ï¼‰
CREATE TABLE backup AS SELECT * FROM source;
```

### ä½¿ç”¨å ´æ™¯å»ºè­°

| å ´æ™¯ | å»ºè­°æ–¹å¼ |
|------|----------|
| å¿«é€Ÿæ¸¬è©¦/é–‹ç™¼ | Shallow Clone |
| ç”Ÿç”¢ç’°å¢ƒå‚™ä»½ | Deep Clone |
| è³‡æ–™é·ç§» | Deep Clone æˆ– CTAS |
| çŸ­æœŸå¯¦é©— | Shallow Clone |

---

## ğŸ“š å®˜æ–¹æ–‡ä»¶

- [Delta Lake Clone](https://docs.databricks.com/delta/clone.html)
- [Shallow Clone](https://docs.databricks.com/delta/clone.html#shallow-clone)
- [Deep Clone](https://docs.databricks.com/delta/clone.html#deep-clone)

---

**[è¿”å›é¡Œç›®](#question-018)**
