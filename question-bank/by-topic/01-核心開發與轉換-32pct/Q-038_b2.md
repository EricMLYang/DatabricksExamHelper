# Question #038

---

## é¡Œç›®è³‡è¨Š

### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-038`

### ä¾†æº
**ä¾†æº:** Community

### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L2-Intermediate`

---

## é¡Œç›®å…§å®¹

### é¡Œå¹¹

A data engineer has a streaming job that updates a Delta table named 'user_activities' by the results of a join between a streaming Delta table 'activity_logs' and a static Delta table 'users'.

They noticed that adding new users into the 'users' table does not automatically trigger updates to the 'user_activities' table, even when there were activities for those users in the 'activity_logs' table.

Which of the following likely explains this issue?

### é¸é …

- **A.** The static portion of the stream-static join drives this join process only in batch mode.
- **B.** The streaming portion of this stream-static join drives the join process. Only new data appearing on the streaming side of the join will trigger the processing.
- **C.** The users table must be refreshed with REFRESH TABLE command for each microbatch of this join.
- **D.** This stream-static join is not stateful by default unless they set the spark configuration delta.statefulStreamStaticJoin to true.

---

## æ¨™ç±¤ç³»çµ±

### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `Structured-Streaming`, `Stream-Static-Join`, `Delta-Lake`

### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** `Execution-Behavior`, `Concept-Confusion`

### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** Data Engineering / Development

---

## ç­”æ¡ˆèˆ‡ä¾†æº

### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `B`

### ç­”æ¡ˆä¾†æº
- **ä¾†æºæ¨™è¨»ç­”æ¡ˆ:** B
- **ç¤¾ç¾¤å…±è­˜:** B

---

# é¡Œç›®è§£æ

---

## ğŸ“ è€ƒé»è­˜åˆ¥

**æ ¸å¿ƒæŠ€è¡“:** Structured Streaming / Stream-Static Join
**é—œéµæ¦‚å¿µ:** Join driver, Streaming semantics, Static table behavior

**é¡Œç›®é—œéµå­—ï¼š**
- **streaming Delta table**: ä¸²æµè¡¨ï¼ˆé©…å‹•æ–¹ï¼‰ã€‚
- **static Delta table**: éœæ…‹è¡¨ï¼ˆè¢«å‹•æ–¹ï¼‰ã€‚
- **adding new users... does not trigger updates**: æ–°å¢éœæ…‹è¡¨è³‡æ–™ä¸è§¸ç™¼è™•ç†ã€‚

---

## âœ… æ­£è§£èªªæ˜

### ç‚ºä»€éº¼ B æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Ÿ

**æŠ€è¡“åŸç†ï¼š**

1. **Stream-Static Join çš„é©…å‹•æ©Ÿåˆ¶**:
   - **ä¸²æµç«¯é©…å‹•**: åªæœ‰ä¸²æµç«¯æœ‰æ–°è³‡æ–™æ™‚æ‰æœƒè§¸ç™¼è™•ç†
   - **éœæ…‹ç«¯è¢«å‹•**: éœæ…‹è¡¨çš„è®Šæ›´ä¸æœƒè§¸ç™¼ä»»ä½•è™•ç†

2. **åŸ·è¡Œæµç¨‹**:
   ```
   activity_logs (ä¸²æµ)     users (éœæ…‹)
        â”‚                      â”‚
        â”‚ æ–°è³‡æ–™åˆ°é”            â”‚ æ–°å¢ user
        â”‚                      â”‚
        â–¼                      â–¼
   è§¸ç™¼ micro-batch         ä¸è§¸ç™¼ä»»ä½•è™•ç†
        â”‚                      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€ JOIN â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
         user_activities
   ```

3. **å•é¡Œæƒ…å¢ƒåˆ†æ**:
   - æ–°ç”¨æˆ¶åœ¨ `users` è¡¨ä¸­æ–°å¢
   - é€™äº›ç”¨æˆ¶çš„æ´»å‹•**å·²ç¶“å­˜åœ¨æ–¼** `activity_logs`
   - ä½†å› ç‚º `activity_logs` æ²’æœ‰æ–°è³‡æ–™ï¼Œä¸æœƒè§¸ç™¼ join
   - çµæœï¼šæ–°ç”¨æˆ¶çš„æ­·å²æ´»å‹•ä¸æœƒè¢«è™•ç†

4. **é‡è¦ç‰¹æ€§**:
   - éœæ…‹è¡¨åœ¨æ¯å€‹ micro-batch æœƒè¢«é‡æ–°è®€å–ï¼ˆç²å–æœ€æ–°ç‹€æ…‹ï¼‰
   - ä½†å¿…é ˆæœ‰ä¸²æµç«¯çš„æ–°è³‡æ–™æ‰æœƒè§¸ç™¼è®€å–

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### A - éœæ…‹ç«¯åªåœ¨æ‰¹æ¬¡æ¨¡å¼é©…å‹•

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

- **æè¿°ä¸æº–ç¢º**: éœæ…‹ç«¯æ ¹æœ¬ä¸ã€Œé©…å‹•ã€joinã€‚
- **æ²’æœ‰ã€Œæ‰¹æ¬¡æ¨¡å¼ã€**: Stream-static join æ˜¯ä¸²æµè™•ç†ï¼Œä¸æ˜¯æ‰¹æ¬¡ã€‚

### C - éœ€è¦ REFRESH TABLE å‘½ä»¤

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

- **ä¸éœ€è¦æ‰‹å‹•åˆ·æ–°**: Delta è¡¨çš„éœæ…‹ç«¯æœƒè‡ªå‹•è®€å–æœ€æ–°ç‰ˆæœ¬ã€‚
- **REFRESH TABLE ç”¨é€”ä¸åŒ**: ä¸»è¦ç”¨æ–¼å¤–éƒ¨è¡¨æˆ– Hive metastore åŒæ­¥ã€‚

### D - éœ€è¦è¨­å®š statefulStreamStaticJoin

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

- **é…ç½®ä¸å­˜åœ¨**: æ²’æœ‰ `delta.statefulStreamStaticJoin` é€™å€‹è¨­å®šã€‚
- **èª¤å°é¸é …**: å®Œå…¨è™›æ§‹çš„é…ç½®åç¨±ã€‚

---

## ğŸ§  è¨˜æ†¶æ³•

### å£è¨£

**ã€Œä¸²æµé©…å‹• Joinï¼Œéœæ…‹è¢«å‹•è®€ã€**

### Stream-Static Join è¡Œç‚ºåœ–è§£

```
æƒ…å¢ƒ 1ï¼šä¸²æµç«¯æœ‰æ–°è³‡æ–™
activity_logs: [æ–°æ´»å‹•] â”€â”€â”
                         â”œâ”€â”€â†’ JOIN è§¸ç™¼ â”€â”€â†’ è¼¸å‡º
users: [è®€å–æœ€æ–°ç‹€æ…‹] â”€â”€â”€â”˜

æƒ…å¢ƒ 2ï¼šåªæœ‰éœæ…‹ç«¯è®Šæ›´
activity_logs: [ç„¡æ–°è³‡æ–™] â”€â”€â”
                           â”œâ”€â”€â†’ ä¸è§¸ç™¼
users: [æ–°å¢ç”¨æˆ¶] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è§£æ±ºæ–¹æ¡ˆ

| éœ€æ±‚ | è§£æ±ºæ–¹å¼ |
|------|----------|
| æ–°ç”¨æˆ¶çš„æ­·å²æ´»å‹• | åŸ·è¡Œæ‰¹æ¬¡å›å¡«ï¼ˆbackfillï¼‰ |
| æŒçºŒè¿½è¹¤ç”¨æˆ¶è®Šæ›´ | ä½¿ç”¨ Stream-Stream Join |
| å®šæœŸæ›´æ–° | ä½¿ç”¨æ‰¹æ¬¡ Job å®šæœŸé‡æ–°è¨ˆç®— |

### Join é¡å‹æ¯”è¼ƒ

| Join é¡å‹ | é©…å‹•æ–¹ | éœæ…‹ç«¯è®Šæ›´è§¸ç™¼ |
|----------|--------|---------------|
| **Stream-Static** | ä¸²æµç«¯ | âŒ ä¸è§¸ç™¼ |
| Stream-Stream | é›™æ–¹éƒ½å¯ | âœ… è§¸ç™¼ |
| Batch | N/A | N/A |

---

## ğŸ“š å®˜æ–¹æ–‡ä»¶

- [Stream-Static Joins](https://docs.databricks.com/structured-streaming/delta-lake.html#performing-stream-static-joins)
- [Structured Streaming Programming Guide](https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html#stream-static-joins)

---

**[è¿”å›é¡Œç›®](#question-038)**
