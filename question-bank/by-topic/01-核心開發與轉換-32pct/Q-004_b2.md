# Question #004

---

## é¡Œç›®è³‡è¨Š

### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-004`

### ä¾†æº
**ä¾†æº:** Community

### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L2-Intermediate`

---

## é¡Œç›®å…§å®¹

### é¡Œå¹¹

The data engineering team has a Delta table named 'users'. A recent CHECK constraint has been added to the table using the following command:

```sql
ALTER TABLE users
ADD CONSTRAINT valid_age CHECK (age > 0);
```

The team attempted to insert a batch of new records to the table, but there were some records with negative age values which caused the write to fail because of the constraint violation.

Which statement describes the outcome of this batch insert?

### é¸é …

- **A.** None of the records have been inserted into the table.
- **B.** All records except those that violate the table constraint have been inserted in the table. Records violating the constraint have been ignored.
- **C.** Only records processed before reaching the first violating record have been inserted in the table.
- **D.** All records except those that violate the table constraint have been inserted in the table. Records violating the constraint have been recorded into the transaction log.

---

## æ¨™ç±¤ç³»çµ±

### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `Delta-Lake`, `Delta-Constraints`, `Data-Quality`

### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** `Execution-Behavior`, `Concept-Confusion`

### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** Data Engineering / Development

---

## ç­”æ¡ˆèˆ‡ä¾†æº

### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `A`

### ç­”æ¡ˆä¾†æº
- **ä¾†æºæ¨™è¨»ç­”æ¡ˆ:** A
- **ç¤¾ç¾¤å…±è­˜:** A

---

# é¡Œç›®è§£æ

---

## ğŸ“ è€ƒé»è­˜åˆ¥

**æ ¸å¿ƒæŠ€è¡“:** Delta Lake / ACID Transactions / CHECK Constraints
**é—œéµæ¦‚å¿µ:** Atomicityï¼ˆåŸå­æ€§ï¼‰, Constraint Violation, Transaction Rollback

**é¡Œç›®é—œéµå­—ï¼š**
- **CHECK constraint**: è³‡æ–™é©—è­‰ç´„æŸæ¢ä»¶ã€‚
- **batch insert**: æ‰¹æ¬¡å¯«å…¥æ“ä½œã€‚
- **write to fail**: å¯«å…¥å¤±æ•—ï¼Œè€ƒå¯Ÿå¤±æ•—å¾Œçš„è¡Œç‚ºã€‚

---

## âœ… æ­£è§£èªªæ˜

### ç‚ºä»€éº¼ A æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Ÿ

**æŠ€è¡“åŸç†ï¼š**

1. **ACID ä¸­çš„ Atomicityï¼ˆåŸå­æ€§ï¼‰**:
   Delta Lake æä¾›å®Œæ•´çš„ ACID äº¤æ˜“ä¿è­‰ã€‚å…¶ä¸­ **Atomicityï¼ˆåŸå­æ€§ï¼‰** ç¢ºä¿æ¯å€‹äº¤æ˜“è¦éº¼å®Œå…¨æˆåŠŸï¼Œè¦éº¼å®Œå…¨å¤±æ•— â€”â€” æ²’æœ‰ä¸­é–“ç‹€æ…‹ã€‚

2. **Constraint Violation çš„è¡Œç‚º**:
   ç•¶æ‰¹æ¬¡å¯«å…¥ä¸­æœ‰ä»»ä½•ä¸€ç­†è¨˜éŒ„é•å CHECK constraint æ™‚ï¼š
   - æ•´å€‹äº¤æ˜“æœƒå¤±æ•—ï¼ˆFailï¼‰
   - æ‰€æœ‰è¨˜éŒ„éƒ½ä¸æœƒè¢«å¯«å…¥ï¼ˆåŒ…æ‹¬ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„ï¼‰
   - ä¸æœƒæœ‰éƒ¨åˆ†å¯«å…¥çš„æƒ…æ³

3. **ç‚ºä»€éº¼é€™æ¨£è¨­è¨ˆï¼Ÿ**
   - **è³‡æ–™ä¸€è‡´æ€§**: ç¢ºä¿è¡¨æ ¼æ°¸é è™•æ–¼ä¸€è‡´çš„ç‹€æ…‹
   - **å¯é æ¸¬æ€§**: é–‹ç™¼è€…å¯ä»¥ç¢ºå®šå¯«å…¥è¦éº¼å…¨æˆåŠŸï¼Œè¦éº¼å…¨å¤±æ•—
   - **éŒ¯èª¤è™•ç†**: ä¾¿æ–¼è™•ç†éŒ¯èª¤ â€”â€” ä¿®æ­£å•é¡Œå¾Œé‡è©¦æ•´å€‹æ‰¹æ¬¡å³å¯

**ACID ç‰¹æ€§èªªæ˜ï¼š**

| ç‰¹æ€§ | èªªæ˜ | Delta Lake å¯¦ç¾ |
|------|------|----------------|
| **Atomicity** | å…¨æœ‰æˆ–å…¨ç„¡ | äº¤æ˜“å¤±æ•—æ™‚å®Œå…¨å›æ»¾ |
| **Consistency** | è³‡æ–™å§‹çµ‚æœ‰æ•ˆ | CHECK constraints å¼·åˆ¶åŸ·è¡Œ |
| **Isolation** | äº¤æ˜“äº’ä¸å¹²æ“¾ | Snapshot isolation |
| **Durability** | å·²æäº¤çš„è³‡æ–™æ°¸ä¹…ä¿å­˜ | Transaction log |

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### B - éƒ¨åˆ†å¯«å…¥ï¼ˆå¿½ç•¥é•è¦è¨˜éŒ„ï¼‰

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

- **é•å Atomicity**: å¦‚æœå…è¨±éƒ¨åˆ†è¨˜éŒ„å¯«å…¥ï¼Œå°±é•åäº†åŸå­æ€§åŸå‰‡ã€‚
- **Delta Lake ä¸æ˜¯é€™æ¨£å·¥ä½œçš„**: é€™ç¨®è¡Œç‚ºå¯èƒ½åœ¨æŸäº› NoSQL ç³»çµ±ä¸­å­˜åœ¨ï¼Œä½†ä¸é©ç”¨æ–¼ Delta Lakeã€‚
- **å¦‚éœ€æ­¤è¡Œç‚º**: éœ€è¦åœ¨æ‡‰ç”¨å±¤é å…ˆéæ¿¾è³‡æ–™ï¼Œæˆ–ä½¿ç”¨ `mergeSchema` ç­‰å…¶ä»–æ©Ÿåˆ¶ã€‚

### C - åªå¯«å…¥é•è¦å‰çš„è¨˜éŒ„

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

- **é•å Atomicity**: é€™ä»£è¡¨éƒ¨åˆ†æˆåŠŸï¼Œä¸æ˜¯åŸå­æ“ä½œã€‚
- **ä¸æ˜¯ Delta Lake è¡Œç‚º**: Delta Lake ä¸æœƒæŒ‰è¨˜éŒ„é †åºé€ä¸€è™•ç†ä¸¦åœ¨é‡åˆ°éŒ¯èª¤æ™‚åœæ­¢ã€‚
- **æ•´é«”é©—è­‰**: ç´„æŸæª¢æŸ¥æ˜¯åœ¨æ•´å€‹æ‰¹æ¬¡å®Œæˆå¾Œé€²è¡Œï¼Œè€Œä¸æ˜¯é€ç­†é€²è¡Œã€‚

### D - éƒ¨åˆ†å¯«å…¥ + è¨˜éŒ„åˆ° Transaction Log

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

- **åŒæ¨£é•å Atomicity**: éƒ¨åˆ†å¯«å…¥çš„è¡Œç‚ºä¸ç¬¦åˆ ACID åŸå‰‡ã€‚
- **Transaction Log ç”¨é€”**: Transaction Log è¨˜éŒ„çš„æ˜¯æˆåŠŸæäº¤çš„æ“ä½œï¼Œä¸æ˜¯å¤±æ•—çš„è¨˜éŒ„ã€‚
- **æ··æ·†æ¦‚å¿µ**: é€™å€‹é¸é …æ··æ·†äº† Transaction Log çš„çœŸæ­£ç”¨é€”ã€‚

---

## ğŸ§  è¨˜æ†¶æ³•

### å£è¨£

**ã€ŒACID ä¿å¹³å®‰ï¼Œå…¨é€²æˆ–å…¨é€€ã€**

- **A**tomicity â†’ å…¨æœ‰æˆ–å…¨ç„¡ï¼ˆAll or Nothingï¼‰
- é•åç´„æŸ â†’ å…¨éƒ¨å›æ»¾ï¼ˆComplete Rollbackï¼‰

### ACID é€Ÿè¨˜

```
A - Atomic    â†’ ä¸å¯åˆ†å‰²ï¼Œè¦å˜›å…¨æˆåŠŸï¼Œè¦å˜›å…¨å¤±æ•—
C - Consistent â†’ è³‡æ–™æ°¸é ç¬¦åˆæ‰€æœ‰ç´„æŸæ¢ä»¶
I - Isolated   â†’ äº¤æ˜“ä¹‹é–“äº’ä¸å¹²æ“¾
D - Durable    â†’ ä¸€æ—¦æäº¤ï¼Œæ°¸ä¹…ä¿å­˜
```

### CHECK Constraint è¡Œç‚ºæ¯”è¼ƒ

| æƒ…å¢ƒ | çµæœ |
|------|------|
| æ‰€æœ‰è¨˜éŒ„ç¬¦åˆç´„æŸ | å…¨éƒ¨æˆåŠŸå¯«å…¥ |
| ä»»ä¸€è¨˜éŒ„é•åç´„æŸ | **å…¨éƒ¨å¤±æ•—ï¼Œç„¡è¨˜éŒ„å¯«å…¥** |
| ç©ºæ‰¹æ¬¡ | æˆåŠŸï¼ˆç„¡æ“ä½œï¼‰ |

---

## ğŸ“š å®˜æ–¹æ–‡ä»¶

- [Delta Lake ACID Transactions](https://docs.databricks.com/delta/acid-transactions.html)
- [Delta Lake Constraints](https://docs.databricks.com/delta/delta-constraints.html)
- [What is ACID?](https://www.databricks.com/glossary/acid-transactions)

---

**[è¿”å›é¡Œç›®](#question-004)**
