# Question #008

---

## é¡Œç›®è³‡è¨Š

### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-008`

### ä¾†æº
**ä¾†æº:** Sample / Community

### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L2-Intermediate`

---

## é¡Œç›®å…§å®¹

### é¡Œå¹¹

A data engineering team at a large cloud services company is responsible for ensuring high availability and performance of hundreds of servers. To proactively detect unusual spikes or drops in CPU utilization that could indicate potential issues, the team decides to analyze server CPU usage. They want to capture both the minimum and maximum CPU usage during predefined intervals for each server.

The team writes the following query:

```sql
SELECT
    server_id,
    window.start AS window_start,
    window.end AS window_end,
    MIN(cpu_usage) AS min_cpu,
    MAX(cpu_usage) AS max_cpu
FROM server_metrics
GROUP BY server_id,
         window(event_time, '10 minutes', '10 minutes', '3 minutes')
ORDER BY server_id,
         window_start;
```

What is the primary purpose of this query in the context of the data engineering team's objectives?

### é¸é …

- **A.** To calculate the metrics per server for every 10-minute interval, sliding every 3 minutes, with a 10-minute offset.
- **B.** To calculate the metrics per server for every non-overlapping 10-minute interval, offset by 3 minutes.
- **C.** To calculate the metrics per server for every non-overlapping 3-minute interval, offset by 10 minutes.
- **D.** To calculate the metrics per server for every 3-minute interval, sliding every 10 minutes, with a 10-minute offset.

---

## æ¨™ç±¤ç³»çµ±

### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `Streaming`, `Streaming-Windowing`

### Trap Tags (é™·é˜±é¡žåž‹æ¨™ç±¤)
**Traps:** `Parameter-Order`

### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** Data Engineering / Development

---

## ç­”æ¡ˆèˆ‡ä¾†æº

### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `B`

### ç­”æ¡ˆä¾†æº
- **ä¾†æºæ¨™è¨»ç­”æ¡ˆ:** B
- **ç¤¾ç¾¤å…±è­˜:** B

---

# é¡Œç›®è§£æž

---

## ðŸ“ è€ƒé»žè­˜åˆ¥

**æ ¸å¿ƒæŠ€è¡“:** Spark SQL Window Functions (Time Windows)  
**é—œéµæ¦‚å¿µ:** `window()` å‡½æ•¸åƒæ•¸é †åº (Window Duration vs Slide Duration vs Start Time)

**é¡Œç›®é—œéµå­—ï¼š**
- **`window(event_time, '10 minutes', '10 minutes', '3 minutes')`**: é€™æ˜¯è§£é¡Œæ ¸å¿ƒã€‚éœ€è¦è§£æžé€™ä¸‰å€‹æ™‚é–“åƒæ•¸çš„æ„ç¾©ã€‚

---

## âœ… æ­£è§£èªªæ˜Ž

### ç‚ºä»€éº¼ B æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Ÿ

**æŠ€è¡“åŽŸç†ï¼š**

Spark SQL çš„ `window()` å‡½æ•¸å®Œæ•´ç°½åå¦‚ä¸‹ï¼š

```sql
window(timeColumn, windowDuration, slideDuration, startTime)
```

**åƒæ•¸è§£æžï¼š**

1.  **`timeColumn`**: `event_time`
2.  **`windowDuration` (è¦–çª—å¤§å°)**: `'10 minutes'`
    *   è¡¨ç¤ºæ¯å€‹è¦–çª—æ¶µè“‹ 10 åˆ†é˜çš„è³‡æ–™ã€‚
3.  **`slideDuration` (æ»‘å‹•æ­¥é•·)**: `'10 minutes'`
    *   è¡¨ç¤ºæ¯éš” 10 åˆ†é˜é–‹å§‹ä¸€å€‹æ–°è¦–çª—ã€‚
    *   **é‡è¦åˆ¤æ–·**: ç•¶ `slideDuration` **ç­‰æ–¼** `windowDuration` æ™‚ï¼Œé€™æ˜¯ **Tumbling Window (æ»¾å‹•è¦–çª—)**ï¼Œè¦–çª—ä¹‹é–“ **Non-overlapping (ä¸é‡ç–Š)**ã€‚
4.  **`startTime` (åç§»é‡/èµ·å§‹æ™‚é–“)**: `'3 minutes'`
    *   è¡¨ç¤ºè¦–çª—çš„èµ·å§‹æ™‚é–“ç›¸å°æ–¼æ•´é»žçš„åç§»é‡ã€‚
    *   åŽŸæœ¬çš„ 10 åˆ†é˜è¦–çª—é€šå¸¸æ˜¯ `00:00-00:10`, `00:10-00:20`ã€‚
    *   åŠ ä¸Š 3 åˆ†é˜åç§»å¾Œï¼Œè¦–çª—è®Šç‚º `00:03-00:13`, `00:13-00:23`ã€‚

**ç¶œåˆçµè«–ï¼š**
é€™æ˜¯ä¸€å€‹ **10-minute non-overlapping interval** (å› ç‚º window = slide)ï¼Œä¸¦ä¸”æœ‰ä¸€å€‹ **3-minute offset**ã€‚å®Œå…¨ç¬¦åˆé¸é … B çš„æè¿°ã€‚

---

## âŒ éŒ¯èª¤é¸é …æŽ’é™¤

### A - Sliding every 3 minutes

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- é¸é …è²ç¨± "sliding every 3 minutes"ï¼Œé€™æ„å‘³è‘— `slideDuration` æ‡‰è©²æ˜¯ `'3 minutes'`ã€‚
- ä½†ç¨‹å¼ç¢¼ä¸­çš„ç¬¬ä¸‰å€‹åƒæ•¸ (Start Time) æ‰æ˜¯ `'3 minutes'`ï¼Œç¬¬äºŒå€‹åƒæ•¸ (Slide Duration) æ˜¯ `'10 minutes'`ã€‚

### C - 3-minute interval

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- é¸é …è²ç¨± "3-minute interval"ï¼Œé€™æ„å‘³è‘— `windowDuration` æ‡‰è©²æ˜¯ 3 åˆ†é˜ã€‚
- ä½†ç¨‹å¼ç¢¼ä¸­çš„ç¬¬ä¸€å€‹åƒæ•¸ (Window Duration) æ˜¯ `'10 minutes'`ã€‚

### D - 3-minute interval

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- åŒ Cï¼ŒéŒ¯èª¤åœ°å°‡ Offset èª¤èªç‚º Window Sizeã€‚

---

## ðŸ§  è¨˜æ†¶æ³•

### å£è¨£

**ã€Œä¸€çœ‹å¤§å°ï¼ŒäºŒçœ‹æ»‘å‹•ï¼Œä¸‰çœ‹åç§»ã€**

åƒæ•¸é †åºæ˜¯é—œéµï¼š
1.  **Size** (Duration): å¤šä¹…ï¼Ÿ(`10m`)
2.  **Slide**: å¤šå¸¸ï¼Ÿ(`10m` -> ç­‰æ–¼ Size å°±æ˜¯ä¸é‡ç–Š)
3.  **Start** (Offset): å¹¾é»žé–‹å§‹ï¼Ÿ(`3m`)

### åƒæ•¸ä½ç½®åœ–è§£

```python
window(
    col,
    "10 min",  # 1. Window Size (Duration)
    "10 min",  # 2. Slide Duration (== Size -> Non-overlapping)
    "3 min"    # 3. Start Time (Offset)
)
```

---

## ðŸ“š å®˜æ–¹æ–‡ä»¶

- [Window Functions (Spark SQL)](https://spark.apache.org/docs/latest/sql-ref-functions-builtin.html#window-functions)
- [Structured Streaming - Window Operations](https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html#window-operations-on-event-time)

---

**[è¿”å›žé¡Œç›®](#question-008)**
