# Question #046

---

## é¡Œç›®è³‡è¨Š
### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-046`
### ä¾†æº
**ä¾†æº:** Community
### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L2-Intermediate`

---

## é¡Œç›®å…§å®¹
### é¡Œå¹¹
<!-- âš ï¸ ä¿æŒè‹±æ–‡åŸæ–‡ï¼Œä¸è¦ç¿»è­¯ -->
Which statement regarding streaming state in Stream-Stream Joins is correct?

### é¸é …
<!-- âš ï¸ ä¿æŒè‹±æ–‡åŸæ–‡ï¼Œä¸è¦ç¿»è­¯ -->
- **A.** Spark buffers past inputs as a streaming state only for the right input stream, so that it can match future left inputs with past right inputs.
- **B.** Spark buffers past inputs as a streaming state for both input streams, so that it can match every future input with past inputs.
- **C.** Stream-Stream Joins are not stateful. Spark does not buffers past inputs as a streaming state for the input streams
- **D.** Spark buffers past inputs as a streaming state only for the left input stream, so that it can match future right inputs with past left inputs.

---

## æ¨™ç±¤ç³»çµ±
### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `Streaming`, `Streaming-Stateful`, `Spark-Joins`
### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** `Concept-Confusion`
### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** Data Engineering / Structured Streaming

---

## ç­”æ¡ˆèˆ‡ä¾†æº
### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `B`
### ç­”æ¡ˆä¾†æº
- **ä¾†æºæ¨™è¨»ç­”æ¡ˆ:** B
- **ç¤¾ç¾¤å…±è­˜:** B

---

# é¡Œç›®è§£æ

---

## ğŸ“ è€ƒé»è­˜åˆ¥
**æ ¸å¿ƒæŠ€è¡“:** Structured Streaming Stream-Stream Joins
**é—œéµæ¦‚å¿µ:** Stateful Streamingã€State Managementã€Watermarks
**é¡Œç›®é—œéµå­—ï¼š**
- **Stream-Stream Join**: å…©å€‹ä¸²æµä¹‹é–“çš„ join æ“ä½œ
- **Streaming state**: ä¸²æµè™•ç†ä¸­ä¿å­˜çš„ä¸­é–“ç‹€æ…‹
- **Buffers past inputs**: ç·©è¡æ­·å²è¼¸å…¥è³‡æ–™ç”¨æ–¼åŒ¹é…

---

## âœ… æ­£è§£èªªæ˜
### ç‚ºä»€éº¼ B æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Ÿ

Stream-Stream Join æ˜¯**æœ‰ç‹€æ…‹ï¼ˆStatefulï¼‰**çš„æ“ä½œï¼ŒSpark å¿…é ˆç·©è¡**é›™æ–¹**ä¸²æµçš„æ­·å²è³‡æ–™ã€‚

#### ç‚ºä»€éº¼éœ€è¦ç·©è¡é›™æ–¹ï¼Ÿ
```
Stream A (å·¦): â”€â”€[a1]â”€â”€â”€â”€â”€â”€[a2]â”€â”€â”€â”€â”€â”€[a3]â”€â”€â†’ æ™‚é–“
Stream B (å³): â”€â”€â”€â”€â”€â”€â”€â”€[b1]â”€â”€â”€â”€â”€â”€[b2]â”€â”€â”€â”€â”€â”€â†’ æ™‚é–“

åŒ¹é…éœ€æ±‚ï¼š
- a1 å¯èƒ½è¦èˆ‡æœªä¾†åˆ°é”çš„ b1 åŒ¹é…
- b1 å¯èƒ½è¦èˆ‡éå»çš„ a1 æˆ–æœªä¾†çš„ a2 åŒ¹é…
- ä»»ä½•ä¸€æ–¹çš„è³‡æ–™éƒ½å¯èƒ½èˆ‡å°æ–¹çš„éå»/æœªä¾†è³‡æ–™åŒ¹é…
```

#### ç‹€æ…‹ç·©è¡æ©Ÿåˆ¶
```python
# Stream-Stream Join ç¯„ä¾‹
ordersStream = spark.readStream.table("orders")
shipmentsStream = spark.readStream.table("shipments")

# ç•¶åŸ·è¡Œæ­¤ join æ™‚ï¼ŒSpark æœƒç·©è¡é›™æ–¹è³‡æ–™
joinedStream = ordersStream.join(
    shipmentsStream,
    ordersStream.order_id == shipmentsStream.order_id,
    "inner"
)
```

#### ä½¿ç”¨ Watermark é™åˆ¶ç‹€æ…‹å¤§å°
```python
# æ²’æœ‰ watermarkï¼šç‹€æ…‹æœƒç„¡é™å¢é•·ï¼
# ä½¿ç”¨ watermark ä¾†é™åˆ¶ç·©è¡ç¯„åœ

ordersStream = (spark.readStream.table("orders")
    .withWatermark("order_time", "1 hour"))

shipmentsStream = (spark.readStream.table("shipments")
    .withWatermark("shipment_time", "2 hours"))

# ç¾åœ¨ Spark åªæœƒä¿ç•™ watermark ç¯„åœå…§çš„ç‹€æ…‹
joinedStream = ordersStream.join(
    shipmentsStream,
    expr("""
        order_id = shipment_order_id AND
        shipment_time >= order_time AND
        shipment_time <= order_time + interval 1 hour
    """),
    "inner"
)
```

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### A. ...only for the right input stream...
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- åªç·©è¡å³é‚Šæœƒå°è‡´ç„¡æ³•åŒ¹é…ã€Œæœªä¾†å·¦é‚Š vs éå»å³é‚Šã€
- ä½†ä¹Ÿç„¡æ³•åŒ¹é…ã€Œæœªä¾†å³é‚Š vs éå»å·¦é‚Šã€
- å¿…é ˆç·©è¡é›™æ–¹æ‰èƒ½å®Œæ•´åŒ¹é…

### C. Stream-Stream Joins are not stateful...
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- Stream-Stream Join **æ˜¯æœ‰ç‹€æ…‹çš„**æ“ä½œ
- é€™æ˜¯æœ€åŸºæœ¬çš„æ¦‚å¿µéŒ¯èª¤
- å¦‚æœä¸ä¿å­˜ç‹€æ…‹ï¼Œå°±ç„¡æ³•åŒ¹é…è·¨æ™‚é–“åˆ°é”çš„è³‡æ–™

### D. ...only for the left input stream...
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- èˆ‡é¸é … A ç›¸åŒçš„å•é¡Œ
- åªç·©è¡ä¸€é‚Šç„¡æ³•å¯¦ç¾å®Œæ•´çš„é›™å‘åŒ¹é…
- å·¦å³ä¸¦ç„¡ç‰¹æ®Šå·®ç•°

---

## ğŸ§  è¨˜æ†¶æ³•
### å£è¨£
**ã€Œé›™æµ Join é›™ç·©è¡ï¼ŒWatermark ä¾†é™é‡ã€**

### Stream-Stream Join ç‹€æ…‹ç®¡ç†åœ–
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Stream-Stream Join            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Left Stream    â”‚    Right Stream      â”‚
â”‚   State Buffer   â”‚    State Buffer      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚ Past L1  â”‚   â”‚   â”‚ Past R1  â”‚       â”‚
â”‚   â”‚ Past L2  â”‚â—„â”€â”€â”¼â”€â”€â–ºâ”‚ Past R2  â”‚       â”‚
â”‚   â”‚ Past L3  â”‚   â”‚   â”‚ Past R3  â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                  â”‚                      â”‚
â”‚  â†“ æ–°è³‡æ–™åˆ°é”    â”‚   â†“ æ–°è³‡æ–™åˆ°é”        â”‚
â”‚  èˆ‡å³é‚Šæ­·å²åŒ¹é…   â”‚   èˆ‡å·¦é‚Šæ­·å²åŒ¹é…       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Streaming æ“ä½œç‹€æ…‹åˆ†é¡
| æ“ä½œé¡å‹ | æ˜¯å¦æœ‰ç‹€æ…‹ | èªªæ˜ |
|---------|-----------|------|
| `select`, `filter` | ç„¡ç‹€æ…‹ | åªè™•ç†ç•¶å‰è³‡æ–™ |
| `groupBy().count()` | æœ‰ç‹€æ…‹ | éœ€ç´¯ç©è¨ˆæ•¸ |
| `Stream-Stream Join` | **æœ‰ç‹€æ…‹** | éœ€ç·©è¡é›™æ–¹ |
| `mapGroupsWithState` | æœ‰ç‹€æ…‹ | è‡ªè¨‚ç‹€æ…‹é‚è¼¯ |

### ç‚ºä»€éº¼éœ€è¦ Watermarkï¼Ÿ
| ç„¡ Watermark | æœ‰ Watermark |
|-------------|--------------|
| ç‹€æ…‹ç„¡é™å¢é•· | ç‹€æ…‹æœ‰é™åˆ¶ |
| è¨˜æ†¶é«”è€—ç›¡é¢¨éšª | å¯æ§è³‡æºä½¿ç”¨ |
| ç­‰å¾…æ‰€æœ‰å¯èƒ½åŒ¹é… | åªåœ¨æ™‚é–“ç¯„åœå…§åŒ¹é… |

---

## ğŸ“š å®˜æ–¹æ–‡ä»¶
- [Stream-stream Joins](https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html#stream-stream-joins)
- [Introducing Stream-Stream Joins in Apache Spark 2.3](https://www.databricks.com/blog/2018/03/13/introducing-stream-stream-joins-in-apache-spark-2-3.html)

---

**[è¿”å›é¡Œç›®](#question-046)**
