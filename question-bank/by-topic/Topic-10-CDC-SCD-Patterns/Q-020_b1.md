# Question #020

---

## é¡Œç›®è³‡è¨Š
### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-020`

### ä¾†æº
**ä¾†æº:** Sample / Batch 1

### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L2-Intermediate`

---

## é¡Œç›®å…§å®¹
### é¡Œå¹¹
The data engineering team maintains a Type 1 table that is overwritten each night with new data received from the source system.

A junior data engineer has suggested enabling the Change Data Feed (CDF) feature on the table in order to identify those rows that were updated, inserted, or deleted.

Which response to the junior data engineer's suggestion is correct?

### é¸é …
- **A.** CDF is useful when the table is a Slowly Changing Dimension (SCD) of Type 2.

- **B.** CDF can not be enabled on existing tables. It can only be enabled on newly created tables.

- **C.** CDF is useful when only a small fraction of records are updated in each batch.

- **D.** Table's data changes captured by CDF can only be read in streaming mode.

---

## æ¨™ç±¤ç³»çµ±
### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `Delta-Lake`, `Delta-CDC`

### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** `Concept-Confusion`

### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** Data Engineering / Data Management

---

## ç­”æ¡ˆèˆ‡ä¾†æº
### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `C`

### ç­”æ¡ˆä¾†æº
- **ä¾†æºæ¨™è¨»ç­”æ¡ˆ:** C
- **ç¤¾ç¾¤å…±è­˜:** C

---

# é¡Œç›®è§£æ

---

## ğŸ“ è€ƒé»è­˜åˆ¥

**æ ¸å¿ƒæŠ€è¡“:** Delta Lake Change Data Feed (CDF) çš„é©ç”¨å ´æ™¯

**é—œéµæ¦‚å¿µ:**
- CDF çš„æœ€ä½³ä½¿ç”¨æƒ…å¢ƒ
- CDF çš„æ•ˆèƒ½è€ƒé‡
- Type 1 è¡¨æ ¼èˆ‡ CDF çš„ä¸é©é…

**é¡Œç›®é—œéµå­—ï¼š**
- **Type 1 table**: ç›´æ¥è¦†è“‹èˆŠè³‡æ–™ï¼Œä¸ä¿ç•™æ­·å²
- **overwritten each night**: æ¯æ™šå®Œæ•´è¦†å¯«
- **Change Data Feed (CDF)**: è¿½è¹¤è¡¨æ ¼è®Šæ›´çš„åŠŸèƒ½
- **small fraction of records**: CDF é©ç”¨çš„å ´æ™¯

---

## âœ… æ­£è§£èªªæ˜

### ç‚ºä»€éº¼ C æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Ÿ

**æŠ€è¡“åŸç†ï¼š**

C é¸é …æ­£ç¢ºæè¿°äº† CDF çš„æœ€ä½³ä½¿ç”¨å ´æ™¯ï¼š**ç•¶æ¯æ‰¹æ¬¡åªæœ‰å°‘é‡è¨˜éŒ„è¢«æ›´æ–°æ™‚**ï¼ŒCDF æ‰èƒ½ç™¼æ®æœ€å¤§æ•ˆç›Šã€‚

#### CDF é©ç”¨å ´æ™¯åˆ†æ

| å ´æ™¯ | CDF é©ç”¨æ€§ | åŸå›  |
|------|-----------|------|
| **å°‘é‡æ›´æ–°** | âœ… é©åˆ | CDF ç´€éŒ„å¢é‡è®Šæ›´ï¼Œæ•ˆç‡é«˜ |
| **å¤§é‡æ›´æ–°ï¼ˆ>50%ï¼‰** | âŒ ä¸é©åˆ | CDF ç´€éŒ„éå¤šï¼Œæ•ˆç›Šä½ |
| **å®Œæ•´è¦†å¯«** | âŒ ä¸é©åˆ | æ¯ç­†éƒ½æ˜¯ã€Œè®Šæ›´ã€ï¼Œç„¡æ„ç¾© |

#### é¡Œç›®æƒ…å¢ƒåˆ†æ

```
é¡Œç›®æè¿°ï¼š
- Type 1 tableï¼ˆä¸ä¿ç•™æ­·å²ï¼‰
- overwritten each nightï¼ˆæ¯æ™šå®Œæ•´è¦†å¯«ï¼‰

                â†“ å•Ÿç”¨ CDF æœƒç™¼ç”Ÿä»€éº¼ï¼Ÿ

æ¯æ™š CDF æœƒè¨˜éŒ„ï¼š
- æ‰€æœ‰èˆŠè¨˜éŒ„æ¨™è¨˜ç‚º DELETE
- æ‰€æœ‰æ–°è¨˜éŒ„æ¨™è¨˜ç‚º INSERT
â†’ å¹¾ä¹ç­‰æ–¼è¨˜éŒ„æ•´å€‹è¡¨æ ¼å…©æ¬¡ï¼Œç„¡æ„ç¾©ä¸”æµªè²»å„²å­˜ç©ºé–“
```

#### CDF æœ€ä½³ä½¿ç”¨æŒ‡å—

```python
# âœ… å¥½çš„ CDF ä½¿ç”¨å ´æ™¯ï¼šCDC å¢é‡æ›´æ–°
# æ¯å¤©åªæœ‰ 1-5% çš„è³‡æ–™è®Šæ›´
spark.sql("""
    MERGE INTO target USING source
    ON target.id = source.id
    WHEN MATCHED THEN UPDATE SET *
    WHEN NOT MATCHED THEN INSERT *
""")
# CDF åªè¨˜éŒ„è®Šæ›´çš„ 1-5% è³‡æ–™

# âŒ ä¸å¥½çš„ CDF ä½¿ç”¨å ´æ™¯ï¼šå®Œæ•´è¦†å¯«
spark.sql("""
    INSERT OVERWRITE target
    SELECT * FROM source
""")
# CDF æœƒè¨˜éŒ„ 100% çš„è³‡æ–™ç‚ºè®Šæ›´
```

#### ç‚ºä»€éº¼å›æ‡‰ Junior å·¥ç¨‹å¸«é¸æ“‡ Cï¼Ÿ

é€™æ˜¯ä¸€å€‹**æ•™è‚²æ€§è³ª**çš„å›æ‡‰ï¼š
1. ä¸æ˜¯ç›´æ¥èªªã€Œä¸è¦å•Ÿç”¨ CDFã€
2. è€Œæ˜¯è§£é‡‹ CDF çš„**æ­£ç¢ºä½¿ç”¨å ´æ™¯**
3. è®“ Junior å·¥ç¨‹å¸«ç†è§£ï¼šé€™å€‹è¡¨æ ¼ï¼ˆå®Œæ•´è¦†å¯«ï¼‰**ä¸ç¬¦åˆ** CDF çš„é©ç”¨æ¢ä»¶

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### é¸é … A
**CDF is useful when the table is a Slowly Changing Dimension (SCD) of Type 2.**

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

1. **SCD Type 2 èˆ‡ CDF çš„é—œä¿‚æ˜¯ç›¸åçš„**ï¼š
   - CDF å¹«åŠ©**è­˜åˆ¥è®Šæ›´**ï¼Œç„¶å¾Œç”¨æ–¼**å»ºç«‹** SCD Type 2
   - ä¸æ˜¯èªª SCD Type 2 è¡¨æ ¼é©åˆå•Ÿç”¨ CDF

2. **æ–¹å‘æ··æ·†**ï¼š
```
æ­£ç¢ºç†è§£ï¼š
Source Table (å•Ÿç”¨ CDF) â†’ è®€å–è®Šæ›´ â†’ å¯«å…¥ SCD Type 2 Target

éŒ¯èª¤ç†è§£ï¼ˆé¸é … A æš—ç¤ºçš„ï¼‰ï¼š
SCD Type 2 Table (å•Ÿç”¨ CDF) â†’ ???
```

---

### é¸é … B
**CDF can not be enabled on existing tables. It can only be enabled on newly created tables.**

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

1. **CDF å¯ä»¥åœ¨ç¾æœ‰è¡¨æ ¼ä¸Šå•Ÿç”¨**ï¼š
```sql
-- åœ¨ç¾æœ‰è¡¨æ ¼ä¸Šå•Ÿç”¨ CDF
ALTER TABLE existing_table
SET TBLPROPERTIES (delta.enableChangeDataFeed = true);
```

2. **é™åˆ¶èªªæ˜**ï¼š
   - å•Ÿç”¨å¾Œï¼Œåªæœƒè¿½è¹¤**å•Ÿç”¨ä¹‹å¾Œ**çš„è®Šæ›´
   - ä¸æœƒå›æº¯è¿½è¹¤å•Ÿç”¨ä¹‹å‰çš„è®Šæ›´
   - ä½†é€™ä¸ä»£è¡¨ç„¡æ³•åœ¨ç¾æœ‰è¡¨æ ¼ä¸Šå•Ÿç”¨

---

### é¸é … D
**Table's data changes captured by CDF can only be read in streaming mode.**

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

1. **CDF æ”¯æ´æ‰¹æ¬¡å’Œä¸²æµå…©ç¨®è®€å–æ¨¡å¼**ï¼š

```python
# âœ… ä¸²æµæ¨¡å¼è®€å– CDF
stream_df = (spark.readStream
    .format("delta")
    .option("readChangeFeed", "true")
    .option("startingVersion", 0)
    .table("my_table")
)

# âœ… æ‰¹æ¬¡æ¨¡å¼è®€å– CDF
batch_df = (spark.read
    .format("delta")
    .option("readChangeFeed", "true")
    .option("startingVersion", 5)
    .option("endingVersion", 10)
    .table("my_table")
)
```

2. **å…©ç¨®æ¨¡å¼çš„ä½¿ç”¨å ´æ™¯**ï¼š

| æ¨¡å¼ | ä½¿ç”¨å ´æ™¯ |
|------|---------|
| **Streaming** | æŒçºŒç›£æ§è®Šæ›´ï¼Œå³æ™‚è™•ç† |
| **Batch** | å®šæœŸè™•ç†ç‰¹å®šç‰ˆæœ¬ç¯„åœçš„è®Šæ›´ |

---

## ğŸ§  è¨˜æ†¶æ³•

### å£è¨£
**ã€ŒCDF è¿½å¢é‡ï¼Œå…¨è¦†å¯«åˆ¥æƒ³ã€**
â†’ CDF é©åˆè¿½è¹¤å¢é‡è®Šæ›´ï¼Œå®Œæ•´è¦†å¯«çš„å ´æ™¯ä¸é©ç”¨

### CDF é©ç”¨æ€§å¿«é€Ÿåˆ¤æ–·

| å•é¡Œ | ç­”æ¡ˆ | CDF é©ç”¨æ€§ |
|------|------|-----------|
| æ¯æ‰¹æ¬¡æ›´æ–°æ¯”ä¾‹ï¼Ÿ | < 10% | âœ… éå¸¸é©åˆ |
| æ¯æ‰¹æ¬¡æ›´æ–°æ¯”ä¾‹ï¼Ÿ | 10-50% | âš ï¸ å¯è€ƒæ…® |
| æ¯æ‰¹æ¬¡æ›´æ–°æ¯”ä¾‹ï¼Ÿ | > 50% | âŒ ä¸å»ºè­° |
| æ˜¯å¦å®Œæ•´è¦†å¯«ï¼Ÿ | æ˜¯ | âŒ ä¸é©åˆ |

### CDF vs CDC å€åˆ†

| æ¦‚å¿µ | å…¨å | ç”¨é€” |
|------|------|------|
| **CDF** | Change Data Feed | Delta Lake è¿½è¹¤è¡¨æ ¼è®Šæ›´çš„**è¼¸å‡º**åŠŸèƒ½ |
| **CDC** | Change Data Capture | å¾ä¾†æºç³»çµ±**æ¥æ”¶**è®Šæ›´è³‡æ–™çš„æ¨¡å¼ |

```
å…¸å‹æµç¨‹ï¼š
Source System â†’ CDC Feed â†’ MERGE INTO Delta â†’ CDF è¼¸å‡º â†’ ä¸‹æ¸¸ç³»çµ±
               (è¼¸å…¥)                        (è¼¸å‡º)
```

### å•Ÿç”¨ CDF çš„æ±ºç­–æµç¨‹

```
æ˜¯å¦å•Ÿç”¨ CDFï¼Ÿ

1. æ¯æ‰¹æ¬¡è®Šæ›´æ¯”ä¾‹ > 50%ï¼Ÿ
   â†’ æ˜¯ï¼šä¸å»ºè­°å•Ÿç”¨
   â†’ å¦ï¼šç¹¼çºŒ

2. æ˜¯å¦æœ‰ä¸‹æ¸¸ç³»çµ±éœ€è¦å¢é‡è³‡æ–™ï¼Ÿ
   â†’ å¦ï¼šä¸éœ€è¦å•Ÿç”¨
   â†’ æ˜¯ï¼šç¹¼çºŒ

3. èƒ½æ¥å—é¡å¤–å„²å­˜æˆæœ¬å—ï¼Ÿ
   â†’ å¦ï¼šä¸å»ºè­°å•Ÿç”¨
   â†’ æ˜¯ï¼šå»ºè­°å•Ÿç”¨ âœ…
```

---

## ğŸ“š å®˜æ–¹æ–‡ä»¶

- [Delta Lake Change Data Feed](https://docs.databricks.com/delta/delta-change-data-feed.html)
- [When to use Change Data Feed](https://www.databricks.com/blog/2021/06/09/how-to-simplify-cdc-with-delta-lakes-change-data-feed.html)
- [Enable Change Data Feed](https://docs.databricks.com/delta/delta-change-data-feed.html#enable-change-data-feed)

---

**[è¿”å›é¡Œç›®](#question-020)**
