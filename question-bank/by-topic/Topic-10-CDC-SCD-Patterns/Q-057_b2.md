# Question #057

---

## é¡Œç›®è³‡è¨Š
### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-057`
### ä¾†æº
**ä¾†æº:** Community
### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L2-Intermediate`

---

## é¡Œç›®å…§å®¹
### é¡Œå¹¹
<!-- âš ï¸ ä¿æŒè‹±æ–‡åŸæ–‡ï¼Œä¸è¦ç¿»è­¯ -->
Which of the following is considered a limitation when using the MERGE INTO command?

### é¸é …
<!-- âš ï¸ ä¿æŒè‹±æ–‡åŸæ–‡ï¼Œä¸è¦ç¿»è­¯ -->
- **A.** Merge can not be performed if multiple source rows matched and attempted to modify the same target row in the table
- **B.** Merge does not support records deletion. It supports only upsert operations.
- **C.** Merge can not be performed in streaming jobs unless it uses Watermarking
- **D.** Merge can not be performed if single source row matched and attempted to modify the multiple target rows in the table

---

## æ¨™ç±¤ç³»çµ±
### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `Delta-MERGE`, `Delta-Lake`, `ETL-Patterns`
### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** `Concept-Confusion`, `Logical-Trap`
### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** Data Engineering / Development

---

## ç­”æ¡ˆèˆ‡ä¾†æº
### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `A`
### ç­”æ¡ˆä¾†æº
- **ä¾†æºæ¨™è¨»ç­”æ¡ˆ:** A
- **ç¤¾ç¾¤å…±è­˜:** A

---

# é¡Œç›®è§£æ

---

## ğŸ“ è€ƒé»è­˜åˆ¥
**æ ¸å¿ƒæŠ€è¡“:** Delta Lake MERGE INTO
**é—œéµæ¦‚å¿µ:** MERGE é™åˆ¶æ¢ä»¶ã€å¤šå°ä¸€åŒ¹é…å•é¡Œ
**é¡Œç›®é—œéµå­—ï¼š**
- **limitation**: é™åˆ¶æ¢ä»¶
- **MERGE INTO**: Delta Lake åˆä½µæŒ‡ä»¤
- **multiple source rows**: å¤šå€‹ä¾†æºè³‡æ–™åˆ—

---

## âœ… æ­£è§£èªªæ˜
### ç‚ºä»€éº¼ A æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Ÿ

**MERGE ä¸å…è¨±å¤šå€‹ä¾†æºåˆ—åŒ¹é…åŒä¸€å€‹ç›®æ¨™åˆ—**ï¼Œå› ç‚ºé€™æœƒå°è‡´ä¸ç¢ºå®šçš„çµæœã€‚

#### MERGE çš„å¤šå°ä¸€å•é¡Œ
```
å•é¡Œæƒ…å¢ƒï¼š

Source Table:              Target Table:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”
â”‚   id   â”‚ value â”‚         â”‚   id   â”‚ value â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   1    â”‚  100  â”‚ â”€â”€â”€â”€â”   â”‚   1    â”‚  50   â”‚ â† å“ªå€‹å€¼è©²ç”¨ï¼Ÿ
â”‚   1    â”‚  200  â”‚ â”€â”€â”€â”€â”˜   â”‚   2    â”‚  60   â”‚
â”‚   2    â”‚  300  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜

éŒ¯èª¤ï¼šDELTA_MULTIPLE_SOURCE_ROW_MATCHING_TARGET_ROW_IN_MERGE
```

#### ç‚ºä»€éº¼é€™æ˜¯é™åˆ¶ï¼Ÿ
```
çµæœä¸ç¢ºå®šæ€§ï¼š
â”œâ”€â”€ id=1 åœ¨ source æœ‰å…©ç­† (100 å’Œ 200)
â”œâ”€â”€ target ä¸­çš„ id=1 æ‡‰è©²æ›´æ–°ç‚ºå“ªå€‹å€¼ï¼Ÿ
â”‚   â”œâ”€â”€ 100? é‚„æ˜¯ 200?
â”‚   â””â”€â”€ Spark ç„¡æ³•æ±ºå®š
â””â”€â”€ å› æ­¤æ‹‹å‡ºéŒ¯èª¤è€ŒéçŒœæ¸¬
```

#### éŒ¯èª¤è¨Šæ¯
```
AnalysisException: Cannot perform MERGE as multiple source rows matched
and attempted to modify the same target row in the Delta table.

Error code: DELTA_MULTIPLE_SOURCE_ROW_MATCHING_TARGET_ROW_IN_MERGE
```

#### è§£æ±ºæ–¹æ¡ˆ
```sql
-- æ–¹æ³• 1ï¼šé è™•ç† Sourceï¼Œå»é™¤é‡è¤‡
WITH deduplicated_source AS (
  SELECT id, MAX(value) as value  -- é¸æ“‡ä¸€å€‹å€¼
  FROM source
  GROUP BY id
)
MERGE INTO target t
USING deduplicated_source s
ON t.id = s.id
WHEN MATCHED THEN UPDATE SET t.value = s.value;

-- æ–¹æ³• 2ï¼šä½¿ç”¨ ROW_NUMBER å–æœ€æ–°ä¸€ç­†
WITH ranked_source AS (
  SELECT *, ROW_NUMBER() OVER (PARTITION BY id ORDER BY timestamp DESC) as rn
  FROM source
)
MERGE INTO target t
USING (SELECT * FROM ranked_source WHERE rn = 1) s
ON t.id = s.id
WHEN MATCHED THEN UPDATE SET t.value = s.value;
```

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### B. Merge does not support records deletion. It supports only upsert operations.
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- **å®Œå…¨éŒ¯èª¤** - MERGE **æ”¯æ´åˆªé™¤**
- `WHEN MATCHED THEN DELETE` æ˜¯æœ‰æ•ˆçš„èªæ³•
- MERGE æ”¯æ´ INSERTã€UPDATEã€DELETE ä¸‰ç¨®æ“ä½œ

```sql
-- MERGE æ”¯æ´åˆªé™¤
MERGE INTO target t
USING source s
ON t.id = s.id
WHEN MATCHED AND s.deleted = true THEN DELETE  -- âœ… æ”¯æ´
WHEN MATCHED THEN UPDATE SET *
WHEN NOT MATCHED THEN INSERT *;
```

### C. Merge can not be performed in streaming jobs unless it uses Watermarking
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- MERGE å¯ä»¥åœ¨ **foreachBatch** ä¸­ä½¿ç”¨æ–¼ä¸²æµ
- **ä¸éœ€è¦** Watermarking
- Watermarking æ˜¯ç”¨æ–¼è¦–çª—èšåˆå’Œç‹€æ…‹ç®¡ç†ï¼Œèˆ‡ MERGE ç„¡é—œ

```python
# ä¸²æµä¸­ä½¿ç”¨ MERGE - ä¸éœ€è¦ Watermark
def upsert_to_delta(batch_df, batch_id):
    batch_df.createOrReplaceTempView("updates")
    batch_df.sparkSession.sql("""
        MERGE INTO target USING updates
        ON target.id = updates.id
        WHEN MATCHED THEN UPDATE SET *
        WHEN NOT MATCHED THEN INSERT *
    """)

df.writeStream.foreachBatch(upsert_to_delta).start()
```

### D. Merge can not be performed if single source row matched and attempted to modify the multiple target rows in the table
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- **ä¸€å°å¤šæ˜¯å…è¨±çš„** - å–®ä¸€ä¾†æºåˆ—å¯ä»¥åŒ¹é…å¤šå€‹ç›®æ¨™åˆ—
- é€™ç¨®æƒ…æ³æœ‰ç¢ºå®šçš„çµæœï¼ˆæ‰€æœ‰åŒ¹é…çš„ç›®æ¨™åˆ—éƒ½æ›´æ–°ç›¸åŒå€¼ï¼‰
- åªæœ‰**å¤šå°ä¸€**æ‰æœƒç”¢ç”Ÿä¸ç¢ºå®šæ€§

```sql
-- ä¸€å°å¤šæ˜¯å…è¨±çš„
-- Source: 1 row (id=1)
-- Target: 3 rows with id=1
-- çµæœï¼šæ‰€æœ‰ 3 å€‹ target rows éƒ½æœƒè¢«æ›´æ–° âœ…
```

---

## ğŸ§  è¨˜æ†¶æ³•
### å£è¨£
**ã€Œå¤šæºä¸€ç›®ä¸è¡Œï¼Œä¸€æºå¤šç›®å¯è¡Œã€**

### MERGE åŒ¹é…è¦å‰‡
| æƒ…å¢ƒ | å…è¨±ï¼Ÿ | åŸå›  |
|------|--------|------|
| 1 Source â†’ 1 Target | âœ… | æ­£å¸¸æƒ…æ³ |
| 1 Source â†’ N Target | âœ… | ç¢ºå®šçš„çµæœ |
| N Source â†’ 1 Target | âŒ | ä¸ç¢ºå®šç”¨å“ªå€‹ |

### MERGE æ”¯æ´çš„æ“ä½œ
| æ“ä½œ | èªæ³• | æ”¯æ´ï¼Ÿ |
|------|------|--------|
| INSERT | `WHEN NOT MATCHED THEN INSERT` | âœ… |
| UPDATE | `WHEN MATCHED THEN UPDATE` | âœ… |
| DELETE | `WHEN MATCHED THEN DELETE` | âœ… |

### MERGE å¸¸è¦‹éŒ¯èª¤
```
å¸¸è¦‹éŒ¯èª¤èˆ‡è§£æ±ºï¼š
â”œâ”€â”€ DELTA_MULTIPLE_SOURCE_ROW_MATCHING_TARGET_ROW_IN_MERGE
â”‚   â””â”€â”€ è§£æ±ºï¼šé è™•ç† Source å»é‡
â”œâ”€â”€ DELTA_MERGE_INTO_UPDATE_OPERATION_ON_STRUCT_FIELD
â”‚   â””â”€â”€ è§£æ±ºï¼šä½¿ç”¨å®Œæ•´çš„ struct æ¬„ä½
â””â”€â”€ Schema mismatch
    â””â”€â”€ è§£æ±ºï¼šç¢ºä¿ Source å’Œ Target schema ç›¸å®¹
```

### MERGE æœ€ä½³å¯¦è¸
```
æœ€ä½³å¯¦è¸ï¼š
â”œâ”€â”€ ç¢ºä¿ Source ä¸­çš„ join key å”¯ä¸€
â”œâ”€â”€ ä½¿ç”¨ spark.conf.set("spark.sql.shuffle.partitions", N) èª¿å„ª
â”œâ”€â”€ å°å¤§è¡¨ä½¿ç”¨ ZORDER å„ªåŒ– join æ•ˆèƒ½
â””â”€â”€ è€ƒæ…®ä½¿ç”¨ spark.databricks.delta.merge.repartitionBeforeWrite
```

---

## ğŸ“š å®˜æ–¹æ–‡ä»¶
- [Delta Lake MERGE INTO](https://docs.databricks.com/delta/merge.html)
- [MERGE Limitations](https://docs.databricks.com/error-messages/index.html#delta_multiple_source_row_matching_target_row_in_merge)
- [Upsert into Delta Lake Tables](https://docs.databricks.com/delta/merge.html#upsert-into-a-delta-lake-table)

---

**[è¿”å›é¡Œç›®](#question-057)**
