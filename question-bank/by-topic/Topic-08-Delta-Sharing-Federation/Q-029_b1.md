# Question #029

---

## é¡Œç›®è³‡è¨Š
### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-029`

### ä¾†æº
**ä¾†æº:** Sample / Batch 1

### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L2-Intermediate`

---

## é¡Œç›®å…§å®¹
### é¡Œå¹¹
A data engineer has a Delta Lake table "products" with Change Data Feed (CDF) enabled. They want to share this table with external recipients using Delta Sharing, allowing the recipients to:

- Use the table_changes() function to consume incremental changes.
- Perform time travel queries on the table.

Which of the following commands should the data engineer run to achieve this?

### é¸é …
- **A.** ALTER SHARE sales_share ADD TABLE products WITH TIME TRAVEL;

- **B.** ALTER SHARE sales_share ADD TABLE products WITH (CDF AND TIME TRAVEL);

- **C.** ALTER SHARE sales_share ADD TABLE products WITH HISTORY;

- **D.** ALTER SHARE sales_share ADD TABLE products WITH CDF;

---

## æ¨™ç±¤ç³»çµ±
### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `UC-Sharing`, `Delta-CDC`

### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** `Syntax-Confusion`

### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** Data Engineering / Data Sharing

---

## ç­”æ¡ˆèˆ‡ä¾†æº
### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `C`

### ç­”æ¡ˆä¾†æº
- **ä¾†æºæ¨™è¨»ç­”æ¡ˆ:** C
- **ç¤¾ç¾¤å…±è­˜:** C

---

# é¡Œç›®è§£æ

---

## ğŸ“ è€ƒé»è­˜åˆ¥

**æ ¸å¿ƒæŠ€è¡“:** Delta Sharing - åˆ†äº«è¡¨æ ¼æ­·å²è¨˜éŒ„

**é—œéµæ¦‚å¿µ:**
- WITH HISTORY çš„åŠŸèƒ½
- CDF å’Œ Time Travel çš„æ•´åˆåˆ†äº«
- Delta Sharing èªæ³•

**é¡Œç›®é—œéµå­—ï¼š**
- **table_changes()**: è®€å– CDF çš„å‡½æ•¸
- **time travel queries**: ç‰ˆæœ¬æŸ¥è©¢
- **Delta Sharing**: è·¨çµ„ç¹”è³‡æ–™åˆ†äº«

---

## âœ… æ­£è§£èªªæ˜

### ç‚ºä»€éº¼ C æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Ÿ

**æŠ€è¡“åŸç†ï¼š**

`WITH HISTORY` æ˜¯ Delta Sharing ä¸­çš„é—œéµé¸é …ï¼Œå®ƒèƒ½å¤ **åŒæ™‚å•Ÿç”¨** CDF å­˜å–å’Œ Time Travel æŸ¥è©¢åŠŸèƒ½ã€‚

#### WITH HISTORY çš„åŠŸèƒ½

| åŠŸèƒ½ | èªªæ˜ |
|------|------|
| **CDF å­˜å–** | å…è¨±æ¥æ”¶è€…ä½¿ç”¨ `table_changes()` è®€å–è®Šæ›´ |
| **Time Travel** | å…è¨±æ¥æ”¶è€…æŸ¥è©¢æ­·å²ç‰ˆæœ¬ |
| **ç‰ˆæœ¬æ­·å²** | æš´éœ²å®Œæ•´çš„è¡¨æ ¼ç‰ˆæœ¬è¨˜éŒ„ |

#### æ­£ç¢ºèªæ³•

```sql
-- æ–°å¢è¡¨æ ¼åˆ° Shareï¼Œä¸¦å•Ÿç”¨æ­·å²åŠŸèƒ½
ALTER SHARE sales_share ADD TABLE products WITH HISTORY;
```

#### æ¥æ”¶è€…å¯ä»¥åŸ·è¡Œçš„æ“ä½œ

```sql
-- æ¥æ”¶è€…ç«¯ï¼šè®€å– CDFï¼ˆè®Šæ›´è³‡æ–™ï¼‰
SELECT * FROM table_changes('products', 1, 10);

-- æ¥æ”¶è€…ç«¯ï¼šTime Travel æŸ¥è©¢
SELECT * FROM products VERSION AS OF 5;
SELECT * FROM products TIMESTAMP AS OF '2024-01-01';
```

#### å®Œæ•´åˆ†äº«æµç¨‹

```sql
-- æ­¥é©Ÿ 1: ç¢ºä¿ä¾†æºè¡¨æ ¼å•Ÿç”¨ CDF
ALTER TABLE products SET TBLPROPERTIES (delta.enableChangeDataFeed = true);

-- æ­¥é©Ÿ 2: å»ºç«‹ Share
CREATE SHARE sales_share;

-- æ­¥é©Ÿ 3: æ–°å¢è¡¨æ ¼ï¼ˆå•Ÿç”¨æ­·å²ï¼‰
ALTER SHARE sales_share ADD TABLE products WITH HISTORY;

-- æ­¥é©Ÿ 4: æˆäºˆæ¥æ”¶è€…å­˜å–æ¬Š
GRANT SELECT ON SHARE sales_share TO RECIPIENT external_partner;
```

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### é¸é … A
**ALTER SHARE sales_share ADD TABLE products WITH TIME TRAVEL;**

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

1. **èªæ³•ä¸æ­£ç¢º**ï¼š
   - `WITH TIME TRAVEL` ä¸æ˜¯æœ‰æ•ˆçš„ Delta Sharing èªæ³•
   - æ­£ç¢ºèªæ³•æ˜¯ `WITH HISTORY`

2. **åŠŸèƒ½ä¸å®Œæ•´**ï¼š
   - å³ä½¿èªæ³•æ­£ç¢ºï¼Œä¹Ÿæ²’æœ‰æ˜ç¢ºåŒ…å« CDF åŠŸèƒ½

---

### é¸é … B
**ALTER SHARE sales_share ADD TABLE products WITH (CDF AND TIME TRAVEL);**

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

1. **èªæ³•å®Œå…¨éŒ¯èª¤**ï¼š
   - Delta Sharing ä¸æ”¯æ´ `WITH (CDF AND TIME TRAVEL)` é€™ç¨®çµ„åˆèªæ³•
   - æ²’æœ‰ç¨ç«‹çš„ `CDF` é¸é …

2. **æ­£ç¢ºæ–¹å¼**ï¼š
   - `WITH HISTORY` ä¸€å€‹é¸é …å°±åŒ…å«äº†å…©ç¨®åŠŸèƒ½

---

### é¸é … D
**ALTER SHARE sales_share ADD TABLE products WITH CDF;**

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

1. **èªæ³•ä¸å­˜åœ¨**ï¼š
   - `WITH CDF` ä¸æ˜¯æœ‰æ•ˆçš„ Delta Sharing é¸é …
   - æ²’æœ‰ç¨ç«‹å•Ÿç”¨ CDF çš„èªæ³•

2. **åŠŸèƒ½ä¸å®Œæ•´**ï¼š
   - å³ä½¿èªæ³•æ­£ç¢ºï¼Œä¹Ÿæ²’æœ‰åŒ…å« Time Travel åŠŸèƒ½

---

## ğŸ§  è¨˜æ†¶æ³•

### å£è¨£
**ã€ŒHISTORY ä¸€æ‹›æå®šï¼ŒCDF å’Œ Time Travel éƒ½èƒ½è¡Œã€**
â†’ WITH HISTORY åŒæ™‚å•Ÿç”¨ CDF å­˜å–å’Œ Time Travel åŠŸèƒ½

### Delta Sharing èªæ³•é¸é …

| é¸é … | åŠŸèƒ½ | ç”¨é€” |
|------|------|------|
| **ç„¡é¸é …** | åƒ…åˆ†äº«ç•¶å‰å¿«ç…§ | åŸºæœ¬è³‡æ–™åˆ†äº« |
| **WITH HISTORY** | åˆ†äº«å®Œæ•´æ­·å² | CDF + Time Travel |

### Delta Sharing å®Œæ•´èªæ³•

```sql
-- å»ºç«‹ Share
CREATE SHARE share_name;

-- æ–°å¢è¡¨æ ¼ï¼ˆåƒ…ç•¶å‰è³‡æ–™ï¼‰
ALTER SHARE share_name ADD TABLE catalog.schema.table;

-- æ–°å¢è¡¨æ ¼ï¼ˆå«æ­·å²ï¼‰
ALTER SHARE share_name ADD TABLE catalog.schema.table WITH HISTORY;

-- ç§»é™¤è¡¨æ ¼
ALTER SHARE share_name REMOVE TABLE catalog.schema.table;

-- æˆäºˆæ¥æ”¶è€…
GRANT SELECT ON SHARE share_name TO RECIPIENT recipient_name;

-- æ’¤éŠ·å­˜å–
REVOKE SELECT ON SHARE share_name FROM RECIPIENT recipient_name;
```

### WITH HISTORY ä½¿ç”¨å ´æ™¯

| å ´æ™¯ | éœ€è¦ WITH HISTORYï¼Ÿ |
|------|-------------------|
| æ¥æ”¶è€…åªéœ€ç•¶å‰è³‡æ–™ | âŒ ä¸éœ€è¦ |
| æ¥æ”¶è€…éœ€è¦å¢é‡æ›´æ–°ï¼ˆCDCï¼‰ | âœ… éœ€è¦ |
| æ¥æ”¶è€…éœ€è¦æŸ¥è©¢æ­·å²ç‰ˆæœ¬ | âœ… éœ€è¦ |
| æ¥æ”¶è€…éœ€è¦ç¨½æ ¸è¿½è¹¤ | âœ… éœ€è¦ |

---

## ğŸ“š å®˜æ–¹æ–‡ä»¶

- [Delta Sharing - Add Tables](https://docs.databricks.com/en/data-sharing/create-share.html)
- [Share Change Data Feed](https://docs.databricks.com/en/data-sharing/share-data.html#share-change-data-feed)
- [Delta Sharing with History](https://docs.databricks.com/en/data-sharing/read-data.html#read-shared-data-history)

---

**[è¿”å›é¡Œç›®](#question-029)**
