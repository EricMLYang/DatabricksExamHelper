# Question #011

---

## é¡Œç›®è³‡è¨Š

### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-011`

### ä¾†æº
**ä¾†æº:** Community

### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L2-Intermediate`

---

## é¡Œç›®å…§å®¹

### é¡Œå¹¹

A data engineer at a retail company shared a large Delta table with an external analytics company using Delta Sharing without history. However, the company noticed slow performance when querying the shared data.

A senior data engineer suggested using the following command to share the data with history in order to improve query performance:

```sql
ALTER SHARE sales_share ADD TABLE products WITH HISTORY;
```

Which benefit is achieved by using WITH HISTORY?

### é¸é …

- **A.** It leverages temporary security credentials from the cloud storage, scoped-down to the root directory of the provider's shared Delta table.
- **B.** It replicates the table to balance query requests through the Delta Sharing server.
- **C.** It performs a shallow clone of the table to share only the table's transaction log.
- **D.** It leverages disk caching of the Delta Sharing server, resulting in performance that is comparable to direct access to source tables.

---

## æ¨™ç±¤ç³»çµ±

### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `Delta-Lake`, `UC-Sharing`, `Spark-Performance`

### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** `Concept-Confusion`

### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** Data Engineering / Data Sharing

---

## ç­”æ¡ˆèˆ‡ä¾†æº

### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `A`

### ç­”æ¡ˆä¾†æº
- **ä¾†æºæ¨™è¨»ç­”æ¡ˆ:** A
- **ç¤¾ç¾¤å…±è­˜:** A

---

# é¡Œç›®è§£æ

---

## ğŸ“ è€ƒé»è­˜åˆ¥

**æ ¸å¿ƒæŠ€è¡“:** Delta Sharing / History Sharing
**é—œéµæ¦‚å¿µ:** WITH HISTORY, Temporary credentials, Direct storage access

**é¡Œç›®é—œéµå­—ï¼š**
- **Delta Sharing**: Databricks çš„è·¨çµ„ç¹”è³‡æ–™å…±äº«å”å®šã€‚
- **WITH HISTORY**: å•Ÿç”¨æ­·å²å…±äº«ä»¥æå‡æ•ˆèƒ½ã€‚
- **slow performance**: ä¸ä½¿ç”¨ history æ™‚çš„æ•ˆèƒ½å•é¡Œã€‚

---

## âœ… æ­£è§£èªªæ˜

### ç‚ºä»€éº¼ A æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Ÿ

**æŠ€è¡“åŸç†ï¼š**

1. **ä¸ä½¿ç”¨ WITH HISTORY æ™‚çš„å•é¡Œ**:
   - è³‡æ–™å‚³è¼¸å¿…é ˆç¶“é Delta Sharing Server
   - Server æœƒè®€å–è³‡æ–™ä¸¦è½‰é€çµ¦æ¥æ”¶æ–¹
   - é€ æˆé¡å¤–çš„ç¶²è·¯å»¶é²å’Œè™•ç†é–‹éŠ·

2. **ä½¿ç”¨ WITH HISTORY çš„æ•ˆç›Š**:
   - **ç›´æ¥å­˜å–é›²ç«¯å„²å­˜**: æ¥æ”¶æ–¹ç²å¾—æš«æ™‚æ€§çš„å®‰å…¨æ†‘è­‰
   - **æ†‘è­‰ç¯„åœé™åˆ¶**: åªèƒ½å­˜å–å…±äº«è¡¨æ ¼çš„æ ¹ç›®éŒ„
   - **æ•ˆèƒ½æ¥è¿‘ç›´æ¥å­˜å–**: è·³éä¸­é–“çš„ Delta Sharing Server

3. **Databricks-to-Databricks å°ˆå±¬å„ªåŒ–**:
   é€™é …åŠŸèƒ½ä¸»è¦ç”¨æ–¼ Databricks å·¥ä½œå€ä¹‹é–“çš„å…±äº«ï¼Œæ¥æ”¶æ–¹å¯ä»¥ï¼š
   - ç›´æ¥å¾æä¾›æ–¹çš„é›²ç«¯å„²å­˜è®€å–è³‡æ–™
   - åˆ©ç”¨ Delta Lake çš„æ™‚é–“æ—…è¡ŒåŠŸèƒ½
   - å­˜å–è¡¨æ ¼çš„æ­·å²ç‰ˆæœ¬

**æ•ˆèƒ½æ¯”è¼ƒï¼š**

```
ä¸ä½¿ç”¨ WITH HISTORY:
Provider Storage â†’ Delta Sharing Server â†’ Recipient
                        (bottleneck)

ä½¿ç”¨ WITH HISTORY:
Provider Storage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Recipient
                   (ç›´æ¥å­˜å–ï¼Œæš«æ™‚æ†‘è­‰)
```

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### B - è¤‡è£½è¡¨æ ¼ä»¥å¹³è¡¡è«‹æ±‚

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

- **ä¸æœƒè¤‡è£½è³‡æ–™**: WITH HISTORY ä¸æœƒå»ºç«‹è¡¨æ ¼å‰¯æœ¬ã€‚
- **è³‡æ–™ä½ç½®ä¸è®Š**: è³‡æ–™ä»å­˜æ”¾åœ¨åŸæœ¬çš„ä½ç½®ã€‚
- **å…±äº«çš„æ˜¯å­˜å–æ¬Š**: è€Œä¸æ˜¯è³‡æ–™æœ¬èº«ã€‚

### C - Shallow clone åªå…±äº« transaction log

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

- **ä¸æ˜¯ clone æ“ä½œ**: WITH HISTORY ä¸æœƒå»ºç«‹ cloneã€‚
- **å…±äº«çš„æ˜¯åŸå§‹è¡¨æ ¼**: åŒ…å«è³‡æ–™å’Œ transaction logã€‚
- **Shallow clone æ˜¯ä¸åŒæ¦‚å¿µ**: é‚£æ˜¯è¤‡è£½ metadata çš„æ“ä½œã€‚

### D - Delta Sharing Server ç£ç¢Ÿå¿«å–

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

- **ç¹é Server**: WITH HISTORY çš„é‡é»æ˜¯ç¹é Delta Sharing Serverï¼Œè€Œä¸æ˜¯åˆ©ç”¨å…¶å¿«å–ã€‚
- **ç›´æ¥å­˜å–å„²å­˜**: æ•ˆèƒ½æå‡ä¾†è‡ªç›´æ¥å­˜å–é›²ç«¯å„²å­˜ã€‚

---

## ğŸ§  è¨˜æ†¶æ³•

### å£è¨£

**ã€ŒWITH HISTORY çµ¦æ†‘è­‰ï¼Œç›´æ¥å­˜å–æœ€å¿«é€Ÿã€**

### Delta Sharing å…±äº«æ¨¡å¼æ¯”è¼ƒ

| æ¨¡å¼ | è³‡æ–™å­˜å–è·¯å¾‘ | æ•ˆèƒ½ | é©ç”¨å ´æ™¯ |
|------|-------------|------|----------|
| **ä¸ä½¿ç”¨ WITH HISTORY** | ç¶“é Delta Sharing Server | è¼ƒæ…¢ | è·¨å¹³å°å…±äº« |
| **WITH HISTORY** | ç›´æ¥å­˜å–é›²ç«¯å„²å­˜ | å¿« | Databricks-to-Databricks |

### WITH HISTORY é—œéµç‰¹æ€§

| ç‰¹æ€§ | èªªæ˜ |
|------|------|
| æ†‘è­‰é¡å‹ | æš«æ™‚æ€§å®‰å…¨æ†‘è­‰ (Temporary credentials) |
| å­˜å–ç¯„åœ | åƒ…é™å…±äº«è¡¨æ ¼çš„æ ¹ç›®éŒ„ |
| æ•ˆèƒ½æ°´æº– | æ¥è¿‘ç›´æ¥å­˜å–æºè¡¨æ ¼ |
| é©ç”¨å°è±¡ | Databricks-to-Databricks å…±äº« |

---

## ğŸ“š å®˜æ–¹æ–‡ä»¶

- [Delta Sharing](https://docs.databricks.com/data-sharing/index.html)
- [Share History](https://docs.databricks.com/data-sharing/share-data-databricks.html#share-history)
- [Delta Sharing Performance](https://docs.databricks.com/data-sharing/read-data-databricks.html)

---

**[è¿”å›é¡Œç›®](#question-011)**
