# Question #035

---

## é¡Œç›®è³‡è¨Š
### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-035`

### ä¾†æº
**ä¾†æº:** Sample / Batch 1

### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L2-Intermediate`

---

## é¡Œç›®å…§å®¹
### é¡Œå¹¹
A healthcare organization stores sensitive patient data within Databricks Unity Catalog. They need to share this data with an external analytics vendor, who does not use Databricks.

What is the most secure and efficient method to enable this data access?

### é¸é …
- **A.** Using Delta Sharing with the open sharing protocol

- **B.** Storing the data in an external table for direct access

- **C.** Downloading the data as protected Excel files and uploading them via SFTP

- **D.** Creating a database stored view for external use

---

## æ¨™ç±¤ç³»çµ±
### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `Delta-Sharing`, `Data-Governance`, `Security`

### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** `Concept-Confusion`

### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** Data Engineering / Data Sharing

---

## ç­”æ¡ˆèˆ‡ä¾†æº
### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `A`

### ç­”æ¡ˆä¾†æº
- **ä¾†æºæ¨™è¨»ç­”æ¡ˆ:** A
- **ç¤¾ç¾¤å…±è­˜:** A

---

# é¡Œç›®è§£æ

---

## ğŸ“ è€ƒé»è­˜åˆ¥

**æ ¸å¿ƒæŠ€è¡“:** Delta Sharing - è·¨å¹³å°å®‰å…¨è³‡æ–™åˆ†äº«

**é—œéµæ¦‚å¿µ:**
- Delta Sharing çš„é–‹æ”¾å”è­°
- è·¨çµ„ç¹”è³‡æ–™åˆ†äº«å®‰å…¨æ€§
- é Databricks ä½¿ç”¨è€…çš„è³‡æ–™å­˜å–

**é¡Œç›®é—œéµå­—ï¼š**
- **external analytics vendor**: å¤–éƒ¨å» å•†
- **does not use Databricks**: é Databricks ç”¨æˆ¶
- **secure and efficient**: å®‰å…¨ä¸”é«˜æ•ˆ

---

## âœ… æ­£è§£èªªæ˜

### ç‚ºä»€éº¼ A æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Ÿ

**æŠ€è¡“åŸç†ï¼š**

**Delta Sharing** æ˜¯ä¸€å€‹**é–‹æ”¾å”è­°**ï¼Œå°ˆé–€è¨­è¨ˆç”¨æ–¼å®‰å…¨åœ°è·¨å¹³å°åˆ†äº«è³‡æ–™ã€‚å³ä½¿æ¥æ”¶æ–¹ä¸ä½¿ç”¨ Databricksï¼Œä¹Ÿå¯ä»¥é€éå¤šç¨®æ–¹å¼å­˜å–è³‡æ–™ã€‚

#### Delta Sharing çš„é—œéµç‰¹æ€§

| ç‰¹æ€§ | èªªæ˜ |
|------|------|
| **é–‹æ”¾å”è­°** | ä¸é™å®š Databricksï¼Œæ”¯æ´ä»»ä½•å¹³å° |
| **å®‰å…¨æ€§** | åŸºæ–¼ Token çš„å­˜å–æ§åˆ¶ |
| **å³æ™‚æ€§** | ç›´æ¥è®€å–æœ€æ–°è³‡æ–™ï¼Œç„¡éœ€è¤‡è£½ |
| **æ•ˆç‡** | åƒ…å‚³è¼¸æŸ¥è©¢æ‰€éœ€çš„è³‡æ–™ |
| **ç¨½æ ¸** | å®Œæ•´çš„å­˜å–æ—¥èªŒ |

#### é Databricks ç”¨æˆ¶çš„å­˜å–æ–¹å¼

```python
# æ–¹å¼ 1: ä½¿ç”¨ Python delta-sharing å¥—ä»¶
import delta_sharing

# ä½¿ç”¨ share profile é€£æ¥
client = delta_sharing.SharingClient("/path/to/profile.share")

# åˆ—å‡ºå¯ç”¨çš„è¡¨æ ¼
tables = client.list_all_tables()

# è®€å–è³‡æ–™ç‚º Pandas DataFrame
df = delta_sharing.load_as_pandas("profile#share_name.schema.table")

# æ–¹å¼ 2: ä½¿ç”¨ Sparkï¼ˆé Databricksï¼‰
df = spark.read.format("deltaSharing").load("profile#share_name.schema.table")
```

#### Delta Sharing æ¶æ§‹

```
è³‡æ–™æä¾›è€… (Databricks)          è³‡æ–™æ¥æ”¶è€… (é Databricks)
       â”‚                               â”‚
       â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Unity Catalog â”‚ â”€â”€â”€ Delta â”€â”€â†’ â”‚ Python/Spark â”‚
â”‚   + Share    â”‚    Sharing     â”‚  pandas/SQL  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    Protocol     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                               â”‚
       â–¼                               â–¼
  å®‰å…¨æ§åˆ¶å±¤                      ä»»ä½•åˆ†æå·¥å…·
  - Token èªè­‰                    - Power BI
  - å­˜å–æ—¥èªŒ                      - Tableau
  - è¡Œ/åˆ—éæ¿¾                     - Python
```

#### åˆ†äº«æµç¨‹

```sql
-- 1. å»ºç«‹ Share
CREATE SHARE patient_analytics_share;

-- 2. æ–°å¢è¡¨æ ¼åˆ° Share
ALTER SHARE patient_analytics_share
ADD TABLE healthcare.patient_summary;

-- 3. å»ºç«‹æ¥æ”¶è€…
CREATE RECIPIENT external_vendor;

-- 4. æˆäºˆå­˜å–æ¬Š
GRANT SELECT ON SHARE patient_analytics_share
TO RECIPIENT external_vendor;

-- 5. å–å¾— activation link çµ¦å¤–éƒ¨å» å•†
-- å» å•†ç”¨æ­¤é€£çµä¸‹è¼‰ profile.share æª”æ¡ˆ
```

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### é¸é … B
**Storing the data in an external table for direct access**

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

1. **å®‰å…¨æ€§å•é¡Œ**ï¼š
   - ç›´æ¥å­˜å– storage éœ€è¦æš´éœ²é›²ç«¯å„²å­˜æ†‘è­‰
   - ç„¡æ³•ç´°ç·»æ§åˆ¶å­˜å–æ¬Šé™
   - ç¼ºä¹ç¨½æ ¸è¿½è¹¤

2. **ç®¡ç†å›°é›£**ï¼š
   - éœ€è¦ç®¡ç†å¤–éƒ¨å„²å­˜çš„æ¬Šé™
   - ç„¡æ³•å³æ™‚åæ˜ è³‡æ–™æ›´æ–°
   - å¯èƒ½éœ€è¦è³‡æ–™è¤‡è£½

```
å®‰å…¨é¢¨éšªï¼š
External Table â†’ Cloud Storage â†’ éœ€è¦çµ¦å¤–éƒ¨å» å•† Storage æ†‘è­‰
                                 â†“
                           âŒ å¯èƒ½å­˜å–å…¶ä»–æª”æ¡ˆ
                           âŒ ç„¡æ³•è¿½è¹¤èª°å­˜å–äº†ä»€éº¼
```

---

### é¸é … C
**Downloading the data as protected Excel files and uploading them via SFTP**

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

1. **æ•ˆç‡æ¥µä½**ï¼š
   - æ‰‹å‹•ä¸‹è¼‰ã€ä¸Šå‚³æµç¨‹
   - ç„¡æ³•è™•ç†å¤§é‡è³‡æ–™
   - è³‡æ–™å¯èƒ½éæ™‚

2. **å®‰å…¨æ€§å•é¡Œ**ï¼š
   - Excel å¯†ç¢¼ä¿è­·å¾ˆå¼±
   - SFTP éœ€è¦é¡å¤–åŸºç¤è¨­æ–½
   - é›£ä»¥ç¨½æ ¸æª”æ¡ˆæµå‘

3. **ä¸ç¬¦åˆç¾ä»£è³‡æ–™åˆ†äº«æœ€ä½³å¯¦è¸**ï¼š
```
å‚³çµ±æ–¹å¼ï¼š
Data â†’ Excel â†’ SFTP â†’ å¤–éƒ¨å» å•†
   â†“
âŒ æ‰‹å‹•æ“ä½œ
âŒ è³‡æ–™å»¶é²
âŒ ç‰ˆæœ¬æ··äº‚
âŒ å®‰å…¨æ€§å·®
```

---

### é¸é … D
**Creating a database stored view for external use**

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

1. **View ç„¡æ³•è¢«å¤–éƒ¨å­˜å–**ï¼š
   - è³‡æ–™åº« View åªåœ¨ Databricks å…§éƒ¨å¯ç”¨
   - å¤–éƒ¨å» å•†ã€Œdoes not use Databricksã€

2. **ä¸æ˜¯è·¨å¹³å°è§£æ±ºæ–¹æ¡ˆ**ï¼š
   - View éœ€è¦è³‡æ–™åº«é€£ç·š
   - ç„¡æ³•é€éé–‹æ”¾å”è­°å­˜å–

```sql
-- View åªåœ¨ Databricks å…§éƒ¨æœ‰æ•ˆ
CREATE VIEW patient_view AS
SELECT * FROM patient_data WHERE sensitive = false;

-- å¤–éƒ¨å» å•†ç„¡æ³•å­˜å–é€™å€‹ View
-- ä»–å€‘æ²’æœ‰ Databricks å¸³è™Ÿ
```

---

## ğŸ§  è¨˜æ†¶æ³•

### å£è¨£
**ã€Œå¤–éƒ¨åˆ†äº«ç”¨ Delta Sharingï¼Œé–‹æ”¾å”è­°è·¨å¹³å°ã€**
â†’ ç•¶æ¥æ”¶æ–¹ä¸ç”¨ Databricks æ™‚ï¼ŒDelta Sharing çš„é–‹æ”¾å”è­°æ˜¯å”¯ä¸€æ­£è¦æ–¹æ¡ˆ

### Delta Sharing ä½¿ç”¨å ´æ™¯

| å ´æ™¯ | æ˜¯å¦é©åˆ Delta Sharing |
|------|----------------------|
| åˆ†äº«çµ¦å¤–éƒ¨é Databricks ç”¨æˆ¶ | âœ… æœ€ä½³é¸æ“‡ |
| åˆ†äº«çµ¦å…¶ä»– Databricks workspace | âœ… é©åˆ |
| åˆ†äº«æ•æ„Ÿè³‡æ–™çµ¦åˆä½œå¤¥ä¼´ | âœ… é©åˆï¼ˆå¯è¨­å®šéæ¿¾ï¼‰ |
| å…§éƒ¨åœ˜éšŠè³‡æ–™å…±äº« | âš ï¸ å¯ä»¥ï¼Œä½† UC æ¬Šé™å¯èƒ½æ›´ç°¡å–® |

### Delta Sharing æ”¯æ´çš„å®¢æˆ¶ç«¯

| å®¢æˆ¶ç«¯ | ä½¿ç”¨æ–¹å¼ |
|--------|---------|
| **Python** | `delta-sharing` package |
| **Spark** | `format("deltaSharing")` |
| **pandas** | `delta_sharing.load_as_pandas()` |
| **Power BI** | Delta Sharing connector |
| **Tableau** | Delta Sharing connector |
| **REST API** | ç›´æ¥ HTTP è«‹æ±‚ |

### å®‰å…¨åˆ†äº«æœ€ä½³å¯¦è¸

```sql
-- 1. åªåˆ†äº«éœ€è¦çš„æ¬„ä½ï¼ˆColumn éæ¿¾ï¼‰
ALTER SHARE patient_share
ADD TABLE patients (name, age, diagnosis);  -- ä¸åŒ…å« SSN

-- 2. ä½¿ç”¨ WITH HISTORY æ§åˆ¶ CDF å­˜å–
ALTER SHARE patient_share
ADD TABLE patients WITH HISTORY;

-- 3. è¨­å®š Row Filterï¼ˆè¡Œç´šéæ¿¾ï¼‰
-- é€é Dynamic View å¯¦ç¾
```

---

## ğŸ“š å®˜æ–¹æ–‡ä»¶

- [Delta Sharing Overview](https://docs.databricks.com/en/data-sharing/index.html)
- [Share Data Using Open Sharing](https://docs.databricks.com/en/data-sharing/share-data-open.html)
- [Delta Sharing Recipients](https://docs.databricks.com/en/data-sharing/create-recipient.html)
- [Delta Sharing Protocol](https://github.com/delta-io/delta-sharing)

---

**[è¿”å›é¡Œç›®](#question-035)**
