# Question #040

---

## é¡Œç›®è³‡è¨Š
### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-040`
### ä¾†æº
**ä¾†æº:** Community
### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L2-Intermediate`

---

## é¡Œç›®å…§å®¹
### é¡Œå¹¹
<!-- âš ï¸ ä¿æŒè‹±æ–‡åŸæ–‡ï¼Œä¸è¦ç¿»è­¯ -->
A data engineering team is building a LDP pipeline to clean and validate hotel reservations data. Some completed reservations have null check-in or check-out dates, which violates business rules.

To handle this, they implemented the following code:

```python
rules = {
    "valid_check_in": "(check_in IS NOT NULL)",
    "valid_check_out": "(check_out IS NOT NULL)",
}
quarantine_rules = "NOT({0})".format(" AND ".join(rules.values()))

@dlt.table(partition_cols=["is_quarantined"])
@dlt.expect_all(rules)
def silver_reservations():
    return (
        spark.readStream.table("bronze_reservations")
                        .withColumn("is_quarantined", expr(quarantine_rules))
    )
```

Which of the following correctly describes what this function does?

### é¸é …
<!-- âš ï¸ ä¿æŒè‹±æ–‡åŸæ–‡ï¼Œä¸è¦ç¿»è­¯ -->
- **A.** This function streams all rows into the silver_reservations table, flags those with missing check-in or check-out values as quarantined, and partitions the table by the is_quarantined flag.
- **B.** This function partitions the bronze_reservations table by the is_quarantined flag, streams valid partitions into the silver_reservations table, and drops the invalid partitions.
- **C.** This function streams only rows with valid check-in and check-out values into the silver_reservations table, while writing invalid rows into a separate partition.
- **D.** This function streams rows based on the quarantine_rules into two separate tables: silver_reservations for valid reservations, and is_quarantined for invalid reservations.

---

## æ¨™ç±¤ç³»çµ±
### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `Streaming`, `Data-Quality`, `ETL-Patterns`
### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** `Execution-Behavior`
### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** Data Engineering / Lakeflow Declarative Pipelines

---

## ç­”æ¡ˆèˆ‡ä¾†æº
### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `A`
### ç­”æ¡ˆä¾†æº
- **ä¾†æºæ¨™è¨»ç­”æ¡ˆ:** A
- **ç¤¾ç¾¤å…±è­˜:** A

---

# é¡Œç›®è§£æ

---

## ğŸ“ è€ƒé»è­˜åˆ¥
**æ ¸å¿ƒæŠ€è¡“:** Lakeflow Declarative Pipelines (DLT) è³‡æ–™å“è³ªç®¡ç†
**é—œéµæ¦‚å¿µ:** `expect_all` è£é£¾å™¨è¡Œç‚ºã€Quarantine Patternï¼ˆéš”é›¢æ¨¡å¼ï¼‰ã€Streaming è™•ç†
**é¡Œç›®é—œéµå­—ï¼š**
- **LDP pipeline**: Lakeflow Declarative Pipelinesï¼ŒDatabricks çš„å®£å‘Šå¼è³‡æ–™ç®¡ç·šæ¡†æ¶
- **`dlt.expect_all(rules)`**: è³‡æ–™å“è³ªæœŸæœ›è£é£¾å™¨ï¼Œè¨˜éŒ„é©—è­‰çµæœä½†ä¸ä¸Ÿæ£„è³‡æ–™
- **`is_quarantined`**: éš”é›¢æ¨™è¨˜æ¬„ä½ï¼Œç”¨æ–¼æ¨™è¨˜é•åå•†æ¥­è¦å‰‡çš„è³‡æ–™
- **`partition_cols`**: åˆ†å€æ¬„ä½ï¼Œç”¨æ–¼ç‰©ç†åˆ†å€å­˜å„²

---

## âœ… æ­£è§£èªªæ˜
### ç‚ºä»€éº¼ A æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Ÿ

é€™å€‹å‡½æ•¸çš„è¡Œç‚ºå¯ä»¥åˆ†ç‚ºä¸‰å€‹éƒ¨åˆ†ä¾†ç†è§£ï¼š

#### 1. ä¸²æµæ‰€æœ‰è³‡æ–™ï¼ˆä¸éæ¿¾ï¼‰
```python
spark.readStream.table("bronze_reservations")
```
- ä½¿ç”¨ `readStream` å¾ bronze å±¤ä¸²æµè®€å–**æ‰€æœ‰è³‡æ–™**
- æ²’æœ‰ä½¿ç”¨ `filter()` æˆ– `where()`ï¼Œå› æ­¤æ‰€æœ‰è¡Œéƒ½æœƒè¢«è™•ç†

#### 2. æ·»åŠ éš”é›¢æ¨™è¨˜æ¬„ä½
```python
quarantine_rules = "NOT({0})".format(" AND ".join(rules.values()))
# å±•é–‹å¾Œ: "NOT((check_in IS NOT NULL) AND (check_out IS NOT NULL))"
# ç­‰åŒæ–¼: check_in IS NULL OR check_out IS NULL

.withColumn("is_quarantined", expr(quarantine_rules))
```
- ç•¶ `check_in` æˆ– `check_out` ç‚º NULL æ™‚ï¼Œ`is_quarantined = True`
- ç•¶å…©è€…éƒ½ä¸ç‚º NULL æ™‚ï¼Œ`is_quarantined = False`

#### 3. `expect_all` çš„é—œéµè¡Œç‚º
```python
@dlt.expect_all(rules)
```
- **é‡è¦æ¦‚å¿µ**ï¼š`expect_all` åªæœƒ**è¨˜éŒ„**é•åè¦å‰‡çš„è³‡æ–™æ•¸é‡ï¼Œç”¨æ–¼ç›£æ§å’Œå ±å‘Š
- å®ƒ**ä¸æœƒä¸Ÿæ£„**é•åè¦å‰‡çš„è³‡æ–™
- è‹¥è¦ä¸Ÿæ£„ç„¡æ•ˆè³‡æ–™ï¼Œéœ€ä½¿ç”¨ `expect_all_or_drop`

#### 4. åˆ†å€å­˜å„²
```python
@dlt.table(partition_cols=["is_quarantined"])
```
- è¼¸å‡ºè¡¨ä¾æ“š `is_quarantined` æ¬„ä½é€²è¡Œåˆ†å€
- æœ‰æ•ˆè³‡æ–™ï¼ˆ`False`ï¼‰å’Œç„¡æ•ˆè³‡æ–™ï¼ˆ`True`ï¼‰åˆ†åˆ¥å­˜å„²åœ¨ä¸åŒåˆ†å€

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### B. This function partitions the bronze_reservations table...
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- åˆ†å€æ˜¯é‡å°**è¼¸å‡ºè¡¨** `silver_reservations`ï¼Œè€Œéè¼¸å…¥è¡¨ `bronze_reservations`
- æ²’æœ‰ã€Œä¸Ÿæ£„ç„¡æ•ˆåˆ†å€ã€çš„è¡Œç‚ºï¼Œæ‰€æœ‰è³‡æ–™éƒ½æœƒè¢«ä¿ç•™

### C. This function streams only rows with valid check-in and check-out values...
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- `expect_all` ä¸æœƒéæ¿¾è³‡æ–™ï¼Œåªæœƒè¨˜éŒ„é©—è­‰çµæœ
- æ‰€æœ‰è³‡æ–™ï¼ˆåŒ…å«ç„¡æ•ˆè³‡æ–™ï¼‰éƒ½æœƒå¯«å…¥åŒä¸€å¼µè¡¨
- ç„¡æ•ˆè³‡æ–™ä¸¦éå¯«å…¥ã€Œç¨ç«‹åˆ†å€ã€ï¼Œè€Œæ˜¯é€šé `is_quarantined=True` æ¨™è¨˜å¾Œå­˜å„²åœ¨è©²åˆ†å€

### D. This function streams rows based on the quarantine_rules into two separate tables...
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- åªæœ‰ä¸€å¼µè¼¸å‡ºè¡¨ `silver_reservations`
- `is_quarantined` æ˜¯æ¬„ä½åç¨±ï¼Œä¸æ˜¯è¡¨å
- DLT åœ¨æ­¤ç¨‹å¼ç¢¼ä¸­æ²’æœ‰å»ºç«‹ç¬¬äºŒå¼µè¡¨

---

## ğŸ§  è¨˜æ†¶æ³•
### å£è¨£
**ã€Œexpect åªç›£æ§ï¼Œdrop æ‰ä¸Ÿæ£„ï¼›éš”é›¢ç”¨åˆ†å€ï¼Œå…¨éƒ¨éƒ½ä¿ç•™ã€**

### æ¯”è¼ƒè¡¨

| è£é£¾å™¨ | ç„¡æ•ˆè³‡æ–™è™•ç† | ç”¨é€” |
|--------|-------------|------|
| `expect` | ä¿ç•™ä¸¦è¨˜éŒ„ | ç›£æ§è³‡æ–™å“è³ª |
| `expect_or_drop` | ä¸Ÿæ£„ | å¼·åˆ¶è³‡æ–™å“è³ª |
| `expect_or_fail` | åœæ­¢ç®¡ç·š | é—œéµè³‡æ–™é©—è­‰ |
| `expect_all` | ä¿ç•™ä¸¦è¨˜éŒ„æ‰€æœ‰è¦å‰‡ | å¤šè¦å‰‡ç›£æ§ |
| `expect_all_or_drop` | ä¸Ÿæ£„é•åä»»ä¸€è¦å‰‡ | å¤šè¦å‰‡å¼·åˆ¶å“è³ª |
| `expect_all_or_fail` | é•åä»»ä¸€è¦å‰‡åœæ­¢ç®¡ç·š | å¤šè¦å‰‡é—œéµé©—è­‰ |

### Quarantine Pattern è¨­è¨ˆæ€ç¶­
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  silver_reservations                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   is_quarantined=False  â”‚     is_quarantined=True       â”‚
â”‚   (æœ‰æ•ˆè³‡æ–™)             â”‚     (éš”é›¢è³‡æ–™)                 â”‚
â”‚   - å¯ç›´æ¥ç”¨æ–¼ä¸‹æ¸¸åˆ†æ    â”‚     - å¾…äººå·¥å¯©æŸ¥æˆ–è‡ªå‹•ä¿®å¾©      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“š å®˜æ–¹æ–‡ä»¶
- [Manage data quality with Lakeflow Declarative Pipelines expectations](https://docs.databricks.com/en/delta-live-tables/expectations.html)
- [What is Lakeflow Declarative Pipelines?](https://docs.databricks.com/en/delta-live-tables/index.html)

---

**[è¿”å›é¡Œç›®](#question-040)**
