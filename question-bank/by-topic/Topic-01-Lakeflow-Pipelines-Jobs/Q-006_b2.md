# Question #006

---

## é¡Œç›®è³‡è¨Š

### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-006`

### ä¾†æº
**ä¾†æº:** Community

### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L2-Intermediate`

---

## é¡Œç›®å…§å®¹

### é¡Œå¹¹

A data engineering team is building a LDP pipeline to clean and validate product data streaming in from various sources. They notice that some records in the bronze_products table contain invalid price values, specifically some prices are zero or negative, which violates business rules.

To handle this issue, they implemented the following LDP code:

```python
@dlt.table
@dlt.expect_or_drop("positive_price", "price > 0")
def silver_products():
    return spark.readStream.table("bronze_products")

@dlt.table
@dlt.expect_or_drop("invalid_price", "price <= 0")
def quarantine_products():
    return spark.readStream.table("bronze_products")
```

Which of the following correctly describes the result of running this pipeline?

### é¸é …

- **A.** Records with positive prices are loaded into the silver_products table, while records with zero or negative prices are loaded into the quarantine_products table.
- **B.** All records are loaded into the silver_products table, with a flag "quarantine_products" indicating whether the price is valid or not.
- **C.** Records with positive prices are loaded into the silver_products table, while records with zero or negative prices are deleted from the bronze_products table.
- **D.** All records are updated in the bronze_products table with a flag "quarantine_products" that indicates whether the price is valid or not.

---

## æ¨™ç±¤ç³»çµ±

### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `Streaming`, `Data-Quality`, `ETL-Patterns`

### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** `Execution-Behavior`, `Concept-Confusion`

### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** Data Engineering / Development

---

## ç­”æ¡ˆèˆ‡ä¾†æº

### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `A`

### ç­”æ¡ˆä¾†æº
- **ä¾†æºæ¨™è¨»ç­”æ¡ˆ:** A
- **ç¤¾ç¾¤å…±è­˜:** A

---

# é¡Œç›®è§£æ

---

## ğŸ“ è€ƒé»è­˜åˆ¥

**æ ¸å¿ƒæŠ€è¡“:** Delta Live Tables (DLT) / Lakeflow Declarative Pipelines (LDP)
**é—œéµæ¦‚å¿µ:** expect_or_drop, Data Quality Expectations, Quarantine Pattern

**é¡Œç›®é—œéµå­—ï¼š**
- **LDP (Lakeflow Declarative Pipelines)**: DLT çš„æ–°åç¨±ã€‚
- **expect_or_drop**: ä¸ç¬¦åˆæœŸæœ›çš„è¨˜éŒ„æœƒè¢«ä¸Ÿæ£„ã€‚
- **Quarantine pattern**: å°‡ç„¡æ•ˆè³‡æ–™åˆ†æµåˆ°éš”é›¢è¡¨çš„è¨­è¨ˆæ¨¡å¼ã€‚

---

## âœ… æ­£è§£èªªæ˜

### ç‚ºä»€éº¼ A æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Ÿ

**æŠ€è¡“åŸç†ï¼š**

1. **`@dlt.expect_or_drop` è¡Œç‚º**:
   é€™å€‹è£é£¾å™¨å®šç¾©äº†è³‡æ–™å“è³ªæœŸæœ›ã€‚ç•¶è¨˜éŒ„ä¸ç¬¦åˆæ¢ä»¶æ™‚ï¼Œè©²è¨˜éŒ„æœƒè¢«ã€Œä¸Ÿæ£„ã€ï¼ˆä¸å¯«å…¥ç›®æ¨™è¡¨ï¼‰ï¼Œè€Œä¸æ˜¯å ±éŒ¯ã€‚

2. **é›™è¡¨åˆ†æµæ¨¡å¼**:
   ```python
   # silver_products: åªä¿ç•™ price > 0 çš„è¨˜éŒ„
   @dlt.expect_or_drop("positive_price", "price > 0")

   # quarantine_products: åªä¿ç•™ price <= 0 çš„è¨˜éŒ„
   @dlt.expect_or_drop("invalid_price", "price <= 0")
   ```

3. **è³‡æ–™æµå‘**:
   - `bronze_products` â†’ **price > 0** â†’ `silver_products`
   - `bronze_products` â†’ **price <= 0** â†’ `quarantine_products`
   - `bronze_products` **ä¿æŒä¸è®Š**ï¼ˆä¾†æºè¡¨ä¸å—å½±éŸ¿ï¼‰

**æµç¨‹åœ–ï¼š**

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   bronze_products   â”‚
                    â”‚    (ä¿æŒä¸è®Š)        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                                 â”‚
              â–¼                                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ silver_products â”‚             â”‚ quarantine_products â”‚
    â”‚  (price > 0)    â”‚             â”‚   (price <= 0)      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### B - æ‰€æœ‰è¨˜éŒ„å¯«å…¥ silver + åŠ  flag

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

- **ä¸æ˜¯ expect_or_drop çš„è¡Œç‚º**: `expect_or_drop` æœƒä¸Ÿæ£„ä¸ç¬¦åˆçš„è¨˜éŒ„ï¼Œä¸æ˜¯åŠ  flagã€‚
- **å¦‚éœ€æ­¤è¡Œç‚º**: æ‡‰ä½¿ç”¨å…¶ä»–æ–¹å¼ï¼Œå¦‚ `when().otherwise()` åŠ æ¬„ä½ã€‚

### C - åˆªé™¤ bronze ä¸­çš„ç„¡æ•ˆè¨˜éŒ„

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

- **ä¾†æºè¡¨ä¸æœƒè¢«ä¿®æ”¹**: DLT ä¸æœƒè‡ªå‹•åˆªé™¤ä¾†æºè¡¨çš„è³‡æ–™ã€‚
- **Bronze å±¤è¨­è¨ˆåŸå‰‡**: Bronze å±¤é€šå¸¸ä¿ç•™åŸå§‹è³‡æ–™ï¼Œä¸åšåˆªé™¤ã€‚
- **å–®å‘è³‡æ–™æµ**: DLT çš„è³‡æ–™åªæœƒå‘ä¸‹æ¸¸æµå‹•ï¼Œä¸æœƒå›é ­ä¿®æ”¹ä¸Šæ¸¸ã€‚

### D - æ›´æ–° bronze è¡¨ä¸¦åŠ  flag

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

- **åŒæ¨£é•å DLT è¨­è¨ˆ**: DLT ä¸æœƒä¿®æ”¹ä¾†æºè¡¨ã€‚
- **æ··æ·†æ¦‚å¿µ**: é€™æè¿°çš„æ˜¯ä¸€ç¨® ETL åæ¨¡å¼ï¼Œä¸æ˜¯ DLT çš„å·¥ä½œæ–¹å¼ã€‚

---

## ğŸ§  è¨˜æ†¶æ³•

### å£è¨£

**ã€Œexpect_or_dropï¼šç¬¦åˆå°±ç•™ï¼Œä¸ç¬¦å°±ä¸Ÿã€**

### DLT Expectations æ¯”è¼ƒè¡¨

| è£é£¾å™¨ | ä¸ç¬¦åˆæ™‚çš„è¡Œç‚º | é©ç”¨å ´æ™¯ |
|--------|---------------|----------|
| `@dlt.expect` | è¨˜éŒ„æŒ‡æ¨™ï¼Œç¹¼çºŒè™•ç† | ç›£æ§å“è³ªï¼Œä¸é˜»æ–· |
| `@dlt.expect_or_drop` | **ä¸Ÿæ£„è©²è¨˜éŒ„** | éæ¿¾ç„¡æ•ˆè³‡æ–™ |
| `@dlt.expect_or_fail` | Pipeline å¤±æ•— | åš´æ ¼å“è³ªè¦æ±‚ |

### Quarantine Patternï¼ˆéš”é›¢æ¨¡å¼ï¼‰

```python
# æ¨™æº–æ¨¡å¼ï¼šä¸€å€‹è¡¨è™•ç†æœ‰æ•ˆè³‡æ–™ï¼Œå¦ä¸€å€‹è¡¨æ”¶é›†ç„¡æ•ˆè³‡æ–™
@dlt.table
@dlt.expect_or_drop("valid", "condition = true")
def clean_data(): ...

@dlt.table
@dlt.expect_or_drop("invalid", "condition = false")  # åå‘æ¢ä»¶
def quarantine_data(): ...
```

---

## ğŸ“š å®˜æ–¹æ–‡ä»¶

- [DLT Expectations](https://docs.databricks.com/delta-live-tables/expectations.html)
- [expect_or_drop](https://docs.databricks.com/delta-live-tables/expectations.html#drop-invalid-records)
- [Quarantine Pattern](https://docs.databricks.com/delta-live-tables/expectations.html#quarantine-invalid-data)

---

**[è¿”å›é¡Œç›®](#question-006)**
