# Question #042

---

## é¡Œç›®è³‡è¨Š
### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-042`
### ä¾†æº
**ä¾†æº:** Community
### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L2-Intermediate`

---

## é¡Œç›®å…§å®¹
### é¡Œå¹¹
<!-- âš ï¸ ä¿æŒè‹±æ–‡åŸæ–‡ï¼Œä¸è¦ç¿»è­¯ -->
A finance analytics team manages a Delta Lake table in Unity Catalog called "transactions" with columns: id, amount, region, and account_manager. They want to apply row filtering on this table so that:

- Finance team members can see all transactions, while
- Other users can only see records from the US region.

Which of the following user-defined functions help achieve this?

### é¸é …
<!-- âš ï¸ ä¿æŒè‹±æ–‡åŸæ–‡ï¼Œä¸è¦ç¿»è­¯ -->
- **A.**
```sql
CREATE FUNCTION us_filter(region STRING)
RETURN IF(IS_ACCOUNT_GROUP_MEMBER('finance_team'), true, region='US');
```
- **B.**
```sql
CREATE FUNCTION us_filter(region STRING)
RETURN CASE
  WHEN IS_ACCOUNT_GROUP_MEMBER('finance_team') THEN region='US'
  ELSE true END
```
- **C.**
```sql
CREATE FUNCTION us_filter(region STRING)
RETURN CASE
  WHEN IS_ACCOUNT_GROUP_MEMBER('finance_team') THEN true
  ELSE region END
```
- **D.**
```sql
CREATE FUNCTION us_filter(region STRING)
RETURN IF(IS_ACCOUNT_GROUP_MEMBER('finance_team'), region='US', true);
```

---

## æ¨™ç±¤ç³»çµ±
### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `Unity-Catalog`, `UC-Permissions`, `Access-Control`
### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** `Logical-Trap`
### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** Data Engineering / Security & Governance

---

## ç­”æ¡ˆèˆ‡ä¾†æº
### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `A`
### ç­”æ¡ˆä¾†æº
- **ä¾†æºæ¨™è¨»ç­”æ¡ˆ:** A
- **ç¤¾ç¾¤å…±è­˜:** A

---

# é¡Œç›®è§£æ

---

## ğŸ“ è€ƒé»è­˜åˆ¥
**æ ¸å¿ƒæŠ€è¡“:** Unity Catalog Row-Level Security (Row Filtering)
**é—œéµæ¦‚å¿µ:** Row Filter Functionsã€`IS_ACCOUNT_GROUP_MEMBER()`ã€æ¢ä»¶é‚è¼¯
**é¡Œç›®é—œéµå­—ï¼š**
- **Row filtering**: Unity Catalog æä¾›çš„è¡Œç´šå®‰å…¨æ©Ÿåˆ¶
- **IS_ACCOUNT_GROUP_MEMBER()**: æª¢æŸ¥ç•¶å‰ç”¨æˆ¶æ˜¯å¦å±¬æ–¼æŒ‡å®šç¾¤çµ„
- **UDF (User-Defined Function)**: è‡ªè¨‚å‡½æ•¸ï¼Œç”¨æ–¼å¯¦ç¾éæ¿¾é‚è¼¯

---

## âœ… æ­£è§£èªªæ˜
### ç‚ºä»€éº¼ A æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Ÿ

#### éœ€æ±‚åˆ†æ
| ç”¨æˆ¶é¡å‹ | å¯è¦‹è³‡æ–™ | å‡½æ•¸è¿”å›å€¼ |
|---------|---------|-----------|
| Finance team æˆå“¡ | **æ‰€æœ‰**äº¤æ˜“ | `true` (ä¸éæ¿¾) |
| å…¶ä»–ç”¨æˆ¶ | åªæœ‰ **US region** | `region='US'` |

#### é¸é … A é‚è¼¯æ‹†è§£
```sql
IF(IS_ACCOUNT_GROUP_MEMBER('finance_team'), true, region='US')
--  â†‘ æ¢ä»¶                                    â†‘ ç‚ºçœŸæ™‚è¿”å›  â†‘ ç‚ºå‡æ™‚è¿”å›
```

1. **æ¢ä»¶åˆ¤æ–·**ï¼šæª¢æŸ¥ç”¨æˆ¶æ˜¯å¦ç‚º `finance_team` æˆå“¡
2. **ç‚ºçœŸæ™‚**ï¼šè¿”å› `true` â†’ è©²è¡Œ**é¡¯ç¤º**ï¼ˆä¸éæ¿¾ï¼‰
3. **ç‚ºå‡æ™‚**ï¼šè¿”å› `region='US'` â†’ åªæœ‰ç•¶ region ç‚º 'US' æ™‚æ‰é¡¯ç¤º

#### Row Filter çš„é‹ä½œåŸç†
```sql
-- æ­¥é©Ÿ 1: å»ºç«‹éæ¿¾å‡½æ•¸
CREATE FUNCTION us_filter(region STRING)
RETURN IF(IS_ACCOUNT_GROUP_MEMBER('finance_team'), true, region='US');

-- æ­¥é©Ÿ 2: å°‡å‡½æ•¸æ‡‰ç”¨åˆ°è¡¨æ ¼
ALTER TABLE transactions SET ROW FILTER us_filter ON (region);

-- æ­¥é©Ÿ 3: ç•¶ç”¨æˆ¶æŸ¥è©¢æ™‚ï¼Œç³»çµ±è‡ªå‹•å¥—ç”¨éæ¿¾
SELECT * FROM transactions;
-- Finance team: çœ‹åˆ°æ‰€æœ‰è³‡æ–™
-- å…¶ä»–ç”¨æˆ¶: åªçœ‹åˆ° region='US' çš„è³‡æ–™
```

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### B. CASE WHEN ... THEN region='US' ELSE true
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
```sql
RETURN CASE
  WHEN IS_ACCOUNT_GROUP_MEMBER('finance_team') THEN region='US'  -- âŒ é‚è¼¯åäº†
  ELSE true END                                                   -- âŒ é‚è¼¯åäº†
```
- **Finance team åè€Œè¢«é™åˆ¶**åªèƒ½çœ‹ US region
- **å…¶ä»–ç”¨æˆ¶åè€Œèƒ½çœ‹æ‰€æœ‰è³‡æ–™**ï¼ˆè¿”å› trueï¼‰
- å®Œå…¨èˆ‡éœ€æ±‚ç›¸åï¼

### C. CASE WHEN ... THEN true ELSE region
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
```sql
RETURN CASE
  WHEN IS_ACCOUNT_GROUP_MEMBER('finance_team') THEN true
  ELSE region END  -- âŒ è¿”å› STRINGï¼Œä¸æ˜¯ BOOLEAN
```
- `region` æ˜¯ STRING é¡å‹ï¼ˆå¦‚ 'US', 'EU'ï¼‰
- Row Filter å‡½æ•¸å¿…é ˆè¿”å› **BOOLEAN**
- è¿”å› 'US' å­—ä¸²ç„¡æ³•ä½œç‚ºéæ¿¾æ¢ä»¶

### D. IF(..., region='US', true)
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
```sql
RETURN IF(IS_ACCOUNT_GROUP_MEMBER('finance_team'), region='US', true);
--                                                  â†‘ ç‚ºçœŸæ™‚    â†‘ ç‚ºå‡æ™‚
```
- **Finance team åªèƒ½çœ‹ US region**ï¼ˆèˆ‡éœ€æ±‚ç›¸åï¼‰
- **å…¶ä»–ç”¨æˆ¶èƒ½çœ‹æ‰€æœ‰è³‡æ–™**ï¼ˆèˆ‡éœ€æ±‚ç›¸åï¼‰
- èˆ‡é¸é … B ç›¸åŒéŒ¯èª¤ï¼šæ¢ä»¶é †åºåäº†

---

## ğŸ§  è¨˜æ†¶æ³•
### å£è¨£
**ã€ŒIF ä¸‰åƒæ•¸ï¼šæ¢ä»¶ã€çœŸå€¼ã€å‡å€¼ã€**

### IF å‡½æ•¸è¨˜æ†¶æ³•
```
IF(condition, value_when_true, value_when_false)
         â†‘           â†‘                â†‘
      åˆ¤æ–·æ¢ä»¶     æ¢ä»¶ç‚ºçœŸæ™‚        æ¢ä»¶ç‚ºå‡æ™‚
```

### Row Filter è¨­è¨ˆæ€ç¶­
```
éœ€æ±‚ï¼šæŸç¾¤çµ„çœ‹å…¨éƒ¨ï¼Œå…¶ä»–äººå—é™åˆ¶

å‡½æ•¸è¨­è¨ˆï¼š
IF(æ˜¯ç‰¹æ¬Šç¾¤çµ„, true, éæ¿¾æ¢ä»¶)
    â†“           â†“      â†“
   åˆ¤æ–·        æ”¾è¡Œ   é™åˆ¶æ¢ä»¶
```

### å¸¸è¦‹éŒ¯èª¤æ¨¡å¼
| éŒ¯èª¤é¡å‹ | æè¿° | å¦‚ä½•é¿å… |
|---------|------|---------|
| æ¢ä»¶åè½‰ | æŠŠã€Œç‰¹æ¬Šæ”¾è¡Œã€å¯«æˆã€Œç‰¹æ¬Šå—é™ã€ | å…ˆå¯«å‡ºéœ€æ±‚è¡¨æ ¼ |
| é¡å‹éŒ¯èª¤ | è¿”å› STRING è€Œé BOOLEAN | ç¢ºèªå‡½æ•¸è¿”å›æ¯”è¼ƒè¡¨é”å¼ |

---

## ğŸ“š å®˜æ–¹æ–‡ä»¶
- [Row filters and column masks](https://docs.databricks.com/en/data-governance/unity-catalog/row-and-column-filters.html)
- [SQL language reference - IS_ACCOUNT_GROUP_MEMBER](https://docs.databricks.com/en/sql/language-manual/functions/is_account_group_member.html)

---

**[è¿”å›é¡Œç›®](#question-042)**
