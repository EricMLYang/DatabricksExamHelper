# Question #058

---

## é¡Œç›®è³‡è¨Š
### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-058`
### ä¾†æº
**ä¾†æº:** Community
### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L2-Intermediate`

---

## é¡Œç›®å…§å®¹
### é¡Œå¹¹
<!-- âš ï¸ ä¿æŒè‹±æ–‡åŸæ–‡ï¼Œä¸è¦ç¿»è­¯ -->
The data engineering team has the following query for processing customers' requests to be forgotten:

```sql
DELETE FROM customers
WHERE customer_id IN
(SELECT customer_id FROM delete_requests)
```

Which statement describes the results of executing this query?

### é¸é …
<!-- âš ï¸ ä¿æŒè‹±æ–‡åŸæ–‡ï¼Œä¸è¦ç¿»è­¯ -->
- **A.** The identified will be deleted from the both customers and delete_requests tables, and their associated data files will be permanently purged from the tables directories.
- **B.** The identified records will be deleted from both customers and delete_requests tables, but they will still be accessible in the table history until VACUUM commands are run.
- **C.** The identified records will be deleted from the customers table, but they will still be accessible in the table history until a VACUUM command is run.
- **D.** The identified records will be deleted from the customers tables, and their associated data files will be permanently purged from the table directory.

---

## æ¨™ç±¤ç³»çµ±
### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `Delta-Lake`, `Security`
### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** `Execution-Behavior`
### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** Data Engineering / Data Governance

---

## ç­”æ¡ˆèˆ‡ä¾†æº
### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `C`
### ç­”æ¡ˆä¾†æº
- **ä¾†æºæ¨™è¨»ç­”æ¡ˆ:** C
- **ç¤¾ç¾¤å…±è­˜:** C

---

# é¡Œç›®è§£æ

---

## ğŸ“ è€ƒé»è­˜åˆ¥
**æ ¸å¿ƒæŠ€è¡“:** Delta Lake DELETE èˆ‡ Time Travel
**é—œéµæ¦‚å¿µ:** DELETE è¡Œç‚ºã€è³‡æ–™æª”æ¡ˆç®¡ç†ã€VACUUMã€GDPR åˆè¦
**é¡Œç›®é—œéµå­—ï¼š**
- **requests to be forgotten**: GDPR çš„ã€Œè¢«éºå¿˜æ¬Šã€
- **DELETE FROM**: åˆªé™¤æ“ä½œ
- **table history**: è¡¨æ ¼æ­·å²ï¼ˆTime Travelï¼‰

---

## âœ… æ­£è§£èªªæ˜
### ç‚ºä»€éº¼ C æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Ÿ

Delta Lake çš„ DELETE æ“ä½œæœ‰ç‰¹æ®Šçš„è¡Œç‚ºç‰¹æ€§ï¼š

#### DELETE çš„å¯¦éš›è¡Œç‚º
```
DELETE æ“ä½œä¸æœƒï¼š
âŒ ç›´æ¥åˆªé™¤åŸå§‹æª”æ¡ˆ
âŒ å½±éŸ¿ delete_requests è¡¨æ ¼

DELETE æ“ä½œæœƒï¼š
âœ… å»ºç«‹æ–°ç‰ˆæœ¬çš„è³‡æ–™æª”æ¡ˆï¼ˆä¸å«è¢«åˆªé™¤çš„è¨˜éŒ„ï¼‰
âœ… åœ¨ Transaction Log æ¨™è¨˜èˆŠæª”æ¡ˆç‚ºã€Œå·²åˆªé™¤ã€
âœ… ä¿ç•™èˆŠæª”æ¡ˆä¾› Time Travel ä½¿ç”¨
```

#### Delta Lake æª”æ¡ˆæ¼”è®Šåœ–
```
åŸ·è¡Œå‰ï¼š
customers/
â”œâ”€â”€ _delta_log/
â”‚   â””â”€â”€ 00000000000000000000.json
â””â”€â”€ part-00000-xxx.parquet  â† åŒ…å«æ‰€æœ‰å®¢æˆ¶è³‡æ–™

åŸ·è¡Œ DELETE å¾Œï¼š
customers/
â”œâ”€â”€ _delta_log/
â”‚   â”œâ”€â”€ 00000000000000000000.json
â”‚   â””â”€â”€ 00000000000000000001.json  â† æ–°ç‰ˆæœ¬ï¼šæŒ‡å‘æ–°æª”æ¡ˆ
â”œâ”€â”€ part-00000-xxx.parquet  â† èˆŠæª”æ¡ˆï¼šä»å­˜åœ¨ï¼
â””â”€â”€ part-00001-yyy.parquet  â† æ–°æª”æ¡ˆï¼šä¸å«è¢«åˆªé™¤çš„è¨˜éŒ„

Time Travel å¯å­˜å–èˆŠç‰ˆæœ¬ï¼š
SELECT * FROM customers VERSION AS OF 0
-- ä»å¯çœ‹åˆ°ã€Œå·²åˆªé™¤ã€çš„è³‡æ–™ï¼
```

#### ç‚ºä»€éº¼éœ€è¦ VACUUMï¼Ÿ
```sql
-- æ°¸ä¹…åˆªé™¤èˆŠæª”æ¡ˆ
VACUUM customers RETAIN 0 HOURS

-- æ³¨æ„ï¼šéœ€è¦å…ˆåœç”¨å®‰å…¨æª¢æŸ¥ï¼ˆç”Ÿç”¢ç’°å¢ƒè«‹è¬¹æ…ï¼‰
SET spark.databricks.delta.retentionDurationCheck.enabled = false
```

#### GDPR åˆè¦å®Œæ•´æµç¨‹
```python
# æ­¥é©Ÿ 1: åŸ·è¡Œåˆªé™¤
spark.sql("""
    DELETE FROM customers
    WHERE customer_id IN (SELECT customer_id FROM delete_requests)
""")

# æ­¥é©Ÿ 2: åŸ·è¡Œ VACUUM æ°¸ä¹…æ¸…é™¤
spark.sql("VACUUM customers RETAIN 0 HOURS")

# ç¾åœ¨è³‡æ–™æ‰çœŸæ­£è¢«æ°¸ä¹…åˆªé™¤
```

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### A. ...deleted from both customers and delete_requests tables...permanently purged...
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- DELETE èªå¥åªä½œç”¨æ–¼ **customers** è¡¨æ ¼
- **ä¸æœƒ**å½±éŸ¿ delete_requests è¡¨æ ¼
- ä¸æœƒ**ç«‹å³**æ°¸ä¹…æ¸…é™¤æª”æ¡ˆ

### B. ...deleted from both customers and delete_requests tables...
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- DELETE åªåˆªé™¤ customers è¡¨æ ¼çš„è¨˜éŒ„
- ä¸æœƒåˆªé™¤ delete_requests çš„è¨˜éŒ„
- delete_requests åªæ˜¯ä½œç‚ºæ¢ä»¶å­æŸ¥è©¢

### D. ...permanently purged from the table directory.
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- DELETE **ä¸æœƒ**æ°¸ä¹…æ¸…é™¤æª”æ¡ˆ
- éœ€è¦åŸ·è¡Œ VACUUM æ‰èƒ½æ¸…é™¤
- é€™æ˜¯ Delta Lake æ”¯æ´ Time Travel çš„åŸºç¤

---

## ğŸ§  è¨˜æ†¶æ³•
### å£è¨£
**ã€ŒDELETE åªæ¨™è¨˜ï¼ŒVACUUM æ‰æ¸…é™¤ï¼›Time Travel è¦å°å¿ƒï¼ŒGDPR è¦ VACUUMã€**

### Delta Lake DELETE è¡Œç‚ºåœ–
```
DELETE åŸ·è¡Œ
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å»ºç«‹ä¸å«åˆªé™¤è¨˜éŒ„çš„æ–°æª”æ¡ˆ          â”‚
â”‚ 2. æ›´æ–° Transaction Log             â”‚
â”‚ 3. èˆŠæª”æ¡ˆä¿ç•™ä¾› Time Travel         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“
VACUUM åŸ·è¡Œ
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. åˆªé™¤èˆŠç‰ˆæœ¬æª”æ¡ˆ                    â”‚
â”‚ 2. Time Travel å¤±æ•ˆï¼ˆè©²ç‰ˆæœ¬ï¼‰        â”‚
â”‚ 3. è³‡æ–™æ°¸ä¹…åˆªé™¤                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### GDPR åˆè¦æ¸…å–®
| æ­¥é©Ÿ | æ“ä½œ | ä½œç”¨ |
|------|------|------|
| 1 | DELETE | å¾ç•¶å‰ç‰ˆæœ¬ç§»é™¤è³‡æ–™ |
| 2 | VACUUM | æ°¸ä¹…åˆªé™¤èˆŠæª”æ¡ˆ |
| 3 | é©—è­‰ | ç¢ºèª Time Travel ç„¡æ³•å­˜å– |

### å¸¸è¦‹èª¤è§£æ¾„æ¸…
| èª¤è§£ | å¯¦éš›æƒ…æ³ |
|------|---------|
| DELETE æœƒåˆªé™¤æª”æ¡ˆ | åªæœƒå»ºç«‹æ–°æª”æ¡ˆ |
| å­æŸ¥è©¢è¡¨æ ¼æœƒè¢«åˆªé™¤ | åªæœ‰ FROM å¾Œçš„è¡¨æ ¼å—å½±éŸ¿ |
| åˆªé™¤å¾Œè³‡æ–™ç„¡æ³•æ¢å¾© | Time Travel å¯æ¢å¾©ï¼ˆé™¤é VACUUMï¼‰|

---

## ğŸ“š å®˜æ–¹æ–‡ä»¶
- [Implementing GDPR Right to be Forgotten in Delta Lake](https://www.databricks.com/blog/2022/03/23/implementing-the-gdpr-right-to-be-forgotten-in-delta-lake.html)
- [Remove files no longer referenced by a Delta table](https://docs.databricks.com/en/delta/vacuum.html)

---

**[è¿”å›é¡Œç›®](#question-058)**
