# Q-083

## é¡Œç›®è³‡è¨Š

**ID:** `Q-083`  
**ä¾†æº:** Official Practice Exam (Source label: #383)  
**é›£åº¦:** `L3-Advanced`

---

## é¡Œç›®å…§å®¹

### é¡Œå¹¹

All records from an Apache Kafka producer are being ingested into a single Delta Lake table with the following schema:

```
key BINARY, value BINARY, topic STRING, partition LONG, offset LONG, timestamp LONG
```

There are 5 unique topics being ingested. Only the "registration" topic contains Personal Identifiable Information (PII). The company wishes to restrict access to PII. The company also wishes to only retain records containing PII in this table for 14 days after initial ingestion. However, for non-PII information, it would like to retain these records indefinitely.

Which of the following solutions meets the requirements?

### é¸é …

- **A.** All data should be deleted biweekly; Delta Lake's time travel functionality should be leveraged to maintain a history of non-PII information.
- **B.** Data should be partitioned by the registration field, allowing ACLs and delete statements to be set for the PII directory.
- **C.** Because the value field is stored as binary data, this information is not considered PII and no special precautions should be taken.
- **D.** Separate object storage containers should be specified based on the partition field, allowing isolation at the storage level.
- **E.** Data should be partitioned by the topic field, allowing ACLs and delete statements to leverage partition boundaries.

---

## æ¨™ç±¤ç³»çµ±

**Topics:** `Streaming`, `Delta-Lake`, `Security`  
**Traps:** `Partition-Strategy`  
**Domain:** `Data Governance & Security`

---

## å®˜æ–¹ç­”æ¡ˆèˆ‡ç¤¾ç¾¤è¨è«–

**å®˜æ–¹æ­£ç¢ºç­”æ¡ˆ:** D  
**ç¤¾ç¾¤æŠ•ç¥¨çµæœ:** E (83%)

---

## ğŸ“ è€ƒé»è­˜åˆ¥

### ä¸»è¦è€ƒé»
**æ ¸å¿ƒæŠ€è¡“:** Delta Lake è³‡æ–™åˆ†å€ï¼ˆPartitioningï¼‰+ è³‡æ–™æ²»ç†ï¼ˆData Governanceï¼‰  
**çŸ¥è­˜é ˜åŸŸ:** å®‰å…¨èˆ‡æ²»ç†ï¼ˆSecurity & Governanceï¼‰  
**é—œéµæ¦‚å¿µ:** 
- PII è³‡æ–™éš”é›¢ç­–ç•¥
- åˆ†å€é‚Šç•Œï¼ˆPartition Boundariesï¼‰èˆ‡å­˜å–æ§åˆ¶
- å·®ç•°åŒ–è³‡æ–™ä¿ç•™æ”¿ç­–ï¼ˆDifferential Retention Policyï¼‰

### æ¬¡è¦è€ƒé»
- Kafka ä¸²æµæ”å–è‡³ Delta Lake
- ACLï¼ˆAccess Control Listsï¼‰æ‡‰ç”¨
- å„²å­˜å±¤ç´šéš”é›¢ï¼ˆStorage-level Isolationï¼‰

---

## âœ… æ­£è§£èªªæ˜

### ç‚ºä»€éº¼é¸é …çˆ­è­°å¾ˆå¤§ï¼Ÿ

**âš ï¸ é‡è¦æç¤ºï¼šå®˜æ–¹ç­”æ¡ˆ D vs ç¤¾ç¾¤ç­”æ¡ˆ E çš„çˆ­è­°**

æ­¤é¡Œæ˜¯ç¶“å…¸çš„ã€Œå®˜æ–¹ç­”æ¡ˆèˆ‡ç¤¾ç¾¤å…±è­˜ä¸ä¸€è‡´ã€æ¡ˆä¾‹ã€‚è®“æˆ‘å€‘åˆ†æå…©è€…çš„ç†ç”±ï¼š

---

### é¸é … E çš„æ”¯æŒç†ç”±ï¼ˆç¤¾ç¾¤ 83% æ”¯æŒï¼‰

**æŠ€è¡“åŸç†:**
```python
# æŒ‰ topic åˆ†å€ï¼Œè®“ PII è³‡æ–™åœ¨ç¨ç«‹ç›®éŒ„
spark.read.format("kafka")
  .option("subscribe", "...")
  .load()
  .writeStream
  .partitionBy("topic")  # â† æŒ‰ topic åˆ†å€
  .format("delta")
  .start("/data/kafka_ingestion")
```

åˆ†å€å¾Œçš„ç›®éŒ„çµæ§‹ï¼š
```
/data/kafka_ingestion/
  â”œâ”€â”€ topic=registration/      â† PII è³‡æ–™
  â”œâ”€â”€ topic=user_activity/     â† é PII
  â”œâ”€â”€ topic=system_logs/       â† é PII
  â””â”€â”€ ...
```

**ç¬¦åˆéœ€æ±‚:**
1. âœ… **å­˜å–æ§åˆ¶**ï¼šå¯å° `topic=registration` ç›®éŒ„è¨­å®š ACLï¼Œé™åˆ¶åªæœ‰æˆæ¬Šäººå“¡å­˜å–
2. âœ… **å·®ç•°åŒ–åˆªé™¤**ï¼šå¯é‡å° PII åˆ†å€åŸ·è¡Œå®šæœŸåˆªé™¤
   ```sql
   DELETE FROM kafka_table 
   WHERE topic = 'registration' 
     AND timestamp < current_timestamp() - INTERVAL 14 DAYS
   ```
3. âœ… **é PII è³‡æ–™æ°¸ä¹…ä¿ç•™**ï¼šå…¶ä»–åˆ†å€ä¸å—å½±éŸ¿

**å¯¦å‹™å„ªå‹¢:**
- ä½¿ç”¨ Delta Lake åŸç”Ÿåˆ†å€æ©Ÿåˆ¶
- ACL è¨­å®šç°¡å–®ç›´è§€ï¼ˆé‡å°ç›®éŒ„ï¼‰
- DELETE èªå¥å¯åˆ©ç”¨åˆ†å€è£å‰ªï¼ˆPartition Pruningï¼‰ï¼Œæ•ˆèƒ½é«˜æ•ˆ

---

### é¸é … D çš„æ”¯æŒç†ç”±ï¼ˆå®˜æ–¹ç­”æ¡ˆï¼‰

**æŠ€è¡“åŸç†:**

é¡Œç›®ä¸­æœ‰å€‹å®¹æ˜“å¿½ç•¥çš„æ¬„ä½ï¼š`partition LONG`ï¼ˆé€™æ˜¯ Kafka çš„ partitionï¼Œä¸æ˜¯ topicï¼ï¼‰

å®˜æ–¹èªç‚ºæ‡‰è©²ï¼š
```python
# æ ¹æ“š Kafka partition æ¬„ä½ï¼Œå°‡è³‡æ–™å¯«å…¥ä¸åŒçš„å„²å­˜å®¹å™¨
spark.read.format("kafka")
  .load()
  .writeStream
  .foreachBatch(lambda df, batchId: 
    # æ ¹æ“š partition æ¬„ä½æ±ºå®šå„²å­˜ä½ç½®
    df.filter("partition == 0").write.save("s3://bucket-0/")
    df.filter("partition == 1").write.save("s3://bucket-1/")
  )
  .start()
```

**å®˜æ–¹çš„å‡è¨­é‚è¼¯:**
- å¦‚æœ PII è³‡æ–™å›ºå®šåœ¨ç‰¹å®š Kafka partitionï¼ˆä¾‹å¦‚ partition 0ï¼‰
- å‰‡å¯åœ¨å„²å­˜å±¤ç´šå®Œå…¨éš”é›¢ï¼ˆä¸åŒçš„ S3 bucket æˆ– Azure Storage Containerï¼‰
- é€™æ¨£å¯å¯¦ç¾æœ€åš´æ ¼çš„å­˜å–æ§åˆ¶ï¼ˆé›²ç«¯ IAM å±¤ç´šï¼‰

**å•é¡Œé»:**
1. âŒ é¡Œç›®æ²’èªª PII è³‡æ–™é›†ä¸­åœ¨ç‰¹å®š Kafka partition
2. âŒ å¯¦å‹™ä¸Š Kafka partition æ˜¯ç‚ºäº†å¹³è¡Œè™•ç†ï¼Œä¸æ˜¯ç‚ºäº†è³‡æ–™åˆ†é¡
3. âŒ åŒä¸€å€‹ topicï¼ˆregistrationï¼‰çš„è³‡æ–™æœƒåˆ†æ•£åœ¨å¤šå€‹ partition

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### é¸é … Aï¼šåˆ©ç”¨ Time Travel ä¿ç•™æ­·å²

**éŒ¯èª¤åŸå› :**
```sql
-- å‡è¨­æ¯å…©é€±åˆªé™¤æ‰€æœ‰è³‡æ–™
DELETE FROM kafka_table WHERE true;  -- å…¨éƒ¨åˆªæ‰

-- æƒ³é€é Time Travel å­˜å–èˆŠçš„é PII è³‡æ–™ï¼Ÿ
SELECT * FROM kafka_table VERSION AS OF 10;  -- â† å•é¡Œä¾†äº†
```

**ç‚ºä»€éº¼ä¸å¯è¡Œ:**
1. âŒ Time Travel æœ‰ä¿ç•™æœŸé™ï¼ˆé è¨­ 30 å¤©ï¼‰ï¼Œç„¡æ³•ã€Œæ°¸ä¹…ä¿ç•™ã€
2. âŒ åˆªé™¤å…¨éƒ¨è³‡æ–™å¾Œï¼ŒTime Travel çš„æ­·å²ç‰ˆæœ¬ä¹Ÿæœƒåœ¨ VACUUM å¾Œè¢«æ¸…ç†
3. âŒ ç„¡æ³•å¯¦ç¾ã€Œåªåˆªé™¤ PIIï¼Œä¿ç•™é PIIã€çš„å·®ç•°åŒ–éœ€æ±‚

**æ¦‚å¿µæ··æ·†:**
- Time Travel æ˜¯ç”¨ä¾†æŸ¥è©¢æ­·å²ç‰ˆæœ¬ï¼Œä¸æ˜¯è³‡æ–™ä¿ç•™ç­–ç•¥
- VACUUM é è¨­æœƒæ¸…ç† 7 å¤©å‰çš„æª”æ¡ˆï¼Œç„¡æ³•æ°¸ä¹…ä¿ç•™

---

### é¸é … Bï¼šæŒ‰ registration æ¬„ä½åˆ†å€

**éŒ¯èª¤åŸå› :**
```
âŒ Schema ä¸­æ²’æœ‰ registration æ¬„ä½ï¼
å¯¦éš› Schema: key, value, topic, partition, offset, timestamp
```

**é™·é˜±è¨­è¨ˆ:**
- é¡Œç›®æåˆ°ã€Œregistration topicã€
- é¸é …åˆ»æ„å¯«ã€Œregistration fieldã€æ··æ·†è¦–è½
- å¯¦éš›æ‡‰è©²æ˜¯æŒ‰ `topic` æ¬„ä½åˆ†å€ï¼Œä¸¦ç¯©é¸å€¼ç‚º 'registration' çš„è¨˜éŒ„

---

### é¸é … Cï¼šBinary è³‡æ–™ä¸ç®— PII

**éŒ¯èª¤åŸå› :**
```python
# value æ¬„ä½é›–ç„¶æ˜¯ BINARYï¼Œä½†å¯èƒ½åŒ…å« PII
value: b'{"name":"John","email":"john@example.com"}'
      â†‘ è§£ç¢¼å¾Œä»æ˜¯ PII è³‡æ–™
```

**æ¦‚å¿µéŒ¯èª¤:**
1. âŒ è³‡æ–™æ ¼å¼ï¼ˆBinary/Stringï¼‰ä¸å½±éŸ¿æ˜¯å¦ç‚º PII
2. âŒ PII çš„åˆ¤å®šåŸºæ–¼ã€Œå…§å®¹æ˜¯å¦èƒ½è­˜åˆ¥å€‹äººã€ï¼Œèˆ‡ç·¨ç¢¼æ–¹å¼ç„¡é—œ
3. âŒ é•åè³‡æ–™æ²»ç†çš„åŸºæœ¬åŸå‰‡

---

### é¸é … Dï¼šæŒ‰ partition æ¬„ä½éš”é›¢å„²å­˜

**çˆ­è­°é»:**
- å®˜æ–¹èªç‚ºé€™æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Œä½†å¯¦å‹™ä¸Šæœ‰å¾ˆå¤§å•é¡Œ
- `partition` æ¬„ä½æ˜¯ Kafka çš„æŠ€è¡“åˆ†å€ï¼Œä¸æ˜¯é‚è¼¯åˆ†é¡
- åŒä¸€å€‹ topicï¼ˆå¦‚ registrationï¼‰æœƒåˆ†æ•£åœ¨å¤šå€‹ partition

**å‡è¨­æƒ…å¢ƒï¼ˆå®˜æ–¹å¯èƒ½çš„æ€è·¯ï¼‰:**
å¦‚æœæ¶æ§‹è¨­è¨ˆæ™‚ï¼Œå°±è®“ PII topic å›ºå®šå¯«å…¥ç‰¹å®š Kafka partitionï¼š
```python
# Producer ç«¯è¨­è¨ˆ
producer.send(
  topic="registration",  # PII topic
  partition=0,           # å›ºå®šå¯«å…¥ partition 0
  value=pii_data
)
```

**å•é¡Œ:**
1. âŒ é¡Œç›®æ²’æœ‰èªªæ˜é€™ç¨®è¨­è¨ˆ
2. âŒ é€™æœƒçŠ§ç‰² Kafka çš„å¹³è¡Œè™•ç†èƒ½åŠ›
3. âŒ å¯¦å‹™ä¸Šå¾ˆå°‘é€™æ¨£åš

---

## ğŸ§  è¨˜æ†¶æ³•èˆ‡æœ€ä½³å¯¦è¸

### å£è¨£ï¼šã€Œé‚è¼¯åˆ†é¡ç”¨ topicï¼ŒæŠ€è¡“åˆ†å€ç”¨ partitionã€

| åˆ†å€æ¬„ä½ | ç”¨é€” | é©åˆå ´æ™¯ |
|---------|------|---------|
| **topic** | é‚è¼¯åˆ†é¡ï¼ˆæ¥­å‹™å«ç¾©ï¼‰ | å€åˆ† PII / é PIIï¼Œè¨­å®š ACL |
| **partition** | æŠ€è¡“åˆ†å€ï¼ˆæ•ˆèƒ½æœ€ä½³åŒ–ï¼‰ | Kafka å¹³è¡Œè™•ç†ï¼Œä¸æ‡‰ç”¨æ–¼æ¥­å‹™é‚è¼¯ |

### PII è³‡æ–™éš”é›¢çš„ä¸‰ç¨®ç­–ç•¥

| ç­–ç•¥ | å¯¦ç¾æ–¹å¼ | å„ªé» | ç¼ºé» |
|-----|---------|-----|-----|
| **1. åˆ†å€éš”é›¢** | `PARTITION BY topic` | ç°¡å–®ã€æ•ˆèƒ½å¥½ | éœ€è¦ ACL æ”¯æ´ |
| **2. è¡¨æ ¼åˆ†é›¢** | PII ç¨ç«‹è¡¨æ ¼ | å®Œå…¨éš”é›¢ | ç®¡ç†è¤‡é›œ |
| **3. å„²å­˜å±¤éš”é›¢** | ä¸åŒ Storage Container | æœ€åš´æ ¼ | æ¶æ§‹è¤‡é›œ |

**æ¨è–¦ï¼šé¸é … Eï¼ˆåˆ†å€éš”é›¢ï¼‰æœ€ç¬¦åˆå¯¦å‹™**

### å¯¦å‹™ç¯„ä¾‹

```python
# å¯«å…¥æ™‚æŒ‰ topic åˆ†å€
spark.readStream.format("kafka") \
  .option("subscribe", "registration,user_activity,system_logs") \
  .load() \
  .writeStream \
  .partitionBy("topic") \  # â† é—œéµï¼
  .format("delta") \
  .start("/mnt/kafka_data")

# è¨­å®š ACLï¼ˆåªè®“ PII ç®¡ç†å“¡å­˜å– registrationï¼‰
# Databricks SQL:
GRANT SELECT ON TABLE kafka_data WHERE topic = 'registration' 
TO `pii_admin_group`;

# å®šæœŸæ¸…ç† PII è³‡æ–™
DELETE FROM kafka_data 
WHERE topic = 'registration' 
  AND timestamp < current_timestamp() - INTERVAL 14 DAYS;
```

---

## ğŸ“š å»¶ä¼¸é–±è®€

### å®˜æ–¹æ–‡ä»¶
1. [Delta Lake Table Partitioning](https://docs.databricks.com/delta/table-partitions.html)
2. [Data Governance Best Practices](https://docs.databricks.com/security/privacy/personal-data.html)
3. [Unity Catalog Row and Column Filters](https://docs.databricks.com/data-governance/unity-catalog/manage-privileges/row-column-filters.html)

### ç›¸é—œæ¦‚å¿µ
- **PIIï¼ˆPersonal Identifiable Informationï¼‰:** å¯è­˜åˆ¥ç‰¹å®šå€‹äººçš„è³‡è¨Šï¼ˆå§“åã€èº«ä»½è­‰ã€ä¿¡ç”¨å¡è™Ÿï¼‰
- **Partition Pruning:** æŸ¥è©¢æ™‚åªæƒæç›¸é—œåˆ†å€ï¼Œæå‡æ•ˆèƒ½
- **GDPR Right to be Forgotten:** æ­ç›Ÿ GDPR è¦æ±‚èƒ½åˆªé™¤å€‹äººè³‡æ–™

---

## ğŸ¯ è€ƒè©¦å»ºè­°

**å¦‚æœé‡åˆ°é€™é¡Œ:**
1. **å„ªå…ˆé¸ E**ï¼ˆç¤¾ç¾¤å…±è­˜ + å¯¦å‹™æœ€ä½³å¯¦è¸ï¼‰
2. å¦‚æœ E ä¸åœ¨é¸é …ï¼Œå†è€ƒæ…® Dï¼ˆå®˜æ–¹ç­”æ¡ˆï¼‰
3. è¨˜ä½ï¼š`topic` æ¬„ä½æ˜¯é‚è¼¯åˆ†é¡ï¼Œ`partition` æ¬„ä½æ˜¯æŠ€è¡“åˆ†å€

**é™·é˜±è­˜åˆ¥:**
- é¸é … B çš„ã€Œregistration fieldã€é™·é˜±ï¼ˆschema ä¸­æ²’æœ‰æ­¤æ¬„ä½ï¼‰
- é¸é … C çš„ã€ŒBinary ä¸ç®— PIIã€è¬¬è«–
- é¸é … D çš„ã€Œpartition æ¬„ä½æ··æ·†ã€ï¼ˆæŠ€è¡“ vs æ¥­å‹™é‚è¼¯ï¼‰

**æ ¸å¿ƒè§€å¿µ:**
âœ… PII éš”é›¢è¦ç”¨ã€Œæ¥­å‹™é‚è¼¯æ¬„ä½ã€ï¼ˆtopicï¼‰ï¼Œä¸æ˜¯ã€ŒæŠ€è¡“åˆ†å€æ¬„ä½ã€ï¼ˆpartitionï¼‰  
âœ… åˆ†å€é‚Šç•Œå¯æä¾› ACL å’Œ DELETE çš„å¤©ç„¶é‚Šç•Œ  
âœ… Delta Lake åˆ†å€æ˜¯è³‡æ–™æ²»ç†çš„æœ‰æ•ˆå·¥å…·
