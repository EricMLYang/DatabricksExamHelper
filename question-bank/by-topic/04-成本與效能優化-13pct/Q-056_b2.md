# Question #056

---

## é¡Œç›®è³‡è¨Š
### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-056`
### ä¾†æº
**ä¾†æº:** Community
### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L2-Intermediate`

---

## é¡Œç›®å…§å®¹
### é¡Œå¹¹
<!-- âš ï¸ ä¿æŒè‹±æ–‡åŸæ–‡ï¼Œä¸è¦ç¿»è­¯ -->
The data engineering team wants to know if the tables that they maintain in the Lakehouse are over-partitioned.

Which of the following is an indicator that a Delta Lake table is over-partitioned?

### é¸é …
<!-- âš ï¸ ä¿æŒè‹±æ–‡åŸæ–‡ï¼Œä¸è¦ç¿»è­¯ -->
- **A.** If most partitions in the table have less than 1 GB of data
- **B.** If the data in the table continues to arrive indefinitely
- **C.** If most partitions in the table have more than 1 GB of data
- **D.** If the number of partitions in the table are too low

---

## æ¨™ç±¤ç³»çµ±
### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `Delta-Optimization`, `Partitioning`, `Spark-Performance`
### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** `Number-Trap`, `Concept-Confusion`
### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** Data Engineering / Performance Optimization

---

## ç­”æ¡ˆèˆ‡ä¾†æº
### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `A`
### ç­”æ¡ˆä¾†æº
- **ä¾†æºæ¨™è¨»ç­”æ¡ˆ:** A
- **ç¤¾ç¾¤å…±è­˜:** A

---

# é¡Œç›®è§£æ

---

## ğŸ“ è€ƒé»è­˜åˆ¥
**æ ¸å¿ƒæŠ€è¡“:** Delta Lake Partitioning / åˆ†å€å„ªåŒ–
**é—œéµæ¦‚å¿µ:** Over-partitioningã€åˆ†å€å¤§å°ã€Small Files Problem
**é¡Œç›®é—œéµå­—ï¼š**
- **over-partitioned**: éåº¦åˆ†å€
- **indicator**: è­˜åˆ¥æŒ‡æ¨™
- **less than 1 GB**: é—œéµæ•¸å­—

---

## âœ… æ­£è§£èªªæ˜
### ç‚ºä»€éº¼ A æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Ÿ

**åˆ†å€å°æ–¼ 1 GB æ˜¯éåº¦åˆ†å€çš„å…¸å‹æŒ‡æ¨™**ã€‚

#### Over-Partitioning çš„å•é¡Œ
```
æ­£å¸¸åˆ†å€ vs éåº¦åˆ†å€ï¼š

æ­£å¸¸åˆ†å€ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ partition=2024-01  â”‚  5 GB (å¤§æª”æ¡ˆ)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ partition=2024-02  â”‚  4 GB (å¤§æª”æ¡ˆ)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ partition=2024-03  â”‚  6 GB (å¤§æª”æ¡ˆ)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
âœ… æª”æ¡ˆå¤§ï¼ŒæŸ¥è©¢æ•ˆç‡é«˜

éåº¦åˆ†å€ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 01-01  â”‚ 01-02  â”‚ 01-03  â”‚  ...   â”‚
â”‚ 50MB   â”‚ 30MB   â”‚ 45MB   â”‚  ...   â”‚  â† æ¯å€‹åˆ†å€éƒ½å¾ˆå°
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 01-04  â”‚ 01-05  â”‚ 01-06  â”‚  ...   â”‚
â”‚ 20MB   â”‚ 15MB   â”‚ 35MB   â”‚  ...   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
âŒ å¤§é‡å°æª”æ¡ˆï¼Œæ•ˆèƒ½ä¸‹é™
```

#### ç‚ºä»€éº¼ 1 GB æ˜¯æ¨™æº–ï¼Ÿ
| åˆ†å€å¤§å° | ç‹€æ…‹ | èªªæ˜ |
|----------|------|------|
| **> 1 GB** | æ­£å¸¸ | æª”æ¡ˆå¤ å¤§ï¼Œæƒææ•ˆç‡é«˜ |
| **< 1 GB** | éåº¦åˆ†å€ | å°æª”æ¡ˆå•é¡Œï¼Œæ•ˆèƒ½å·® |
| **< 100 MB** | åš´é‡éåº¦åˆ†å€ | éœ€è¦ç«‹å³è™•ç† |

#### Over-Partitioning çš„è² é¢å½±éŸ¿
```
è² é¢å½±éŸ¿ï¼š
â”œâ”€â”€ å¤§é‡å°æª”æ¡ˆ (Small Files Problem)
â”‚   â””â”€â”€ å¢åŠ  metadata ç®¡ç†è² æ“”
â”œâ”€â”€ ç„¡æ³•è·¨åˆ†å€åˆä½µæª”æ¡ˆ
â”‚   â””â”€â”€ OPTIMIZE åªèƒ½åœ¨åˆ†å€å…§å£“ç¸®
â”œâ”€â”€ å„²å­˜æˆæœ¬å¢åŠ 
â”‚   â””â”€â”€ å°æª”æ¡ˆçš„å„²å­˜é–‹éŠ·æ›´å¤§
â”œâ”€â”€ æŸ¥è©¢æ•ˆèƒ½ä¸‹é™
â”‚   â””â”€â”€ æ›´å¤šçš„æª”æ¡ˆé–‹å•Ÿ/é—œé–‰æ“ä½œ
â””â”€â”€ Plan æ™‚é–“è®Šé•·
    â””â”€â”€ éœ€è¦è™•ç†æ›´å¤š metadata
```

#### å¦‚ä½•è­˜åˆ¥ Over-Partitioning
```sql
-- æª¢æŸ¥åˆ†å€å¤§å°
DESCRIBE DETAIL my_table;

-- æª¢æŸ¥æ¯å€‹åˆ†å€çš„æª”æ¡ˆçµ±è¨ˆ
SELECT
  _metadata.file_path,
  _metadata.file_size
FROM my_table
WHERE partition_col = 'value';

-- ä½¿ç”¨ System Tables (æ¨è–¦)
SELECT
  table_name,
  partition_values,
  size_in_bytes / (1024*1024*1024) as size_gb
FROM system.information_schema.table_partitions
WHERE size_in_bytes < 1073741824  -- < 1GB
```

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### B. If the data in the table continues to arrive indefinitely
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- é€™æè¿°çš„æ˜¯**ä¸²æµè³‡æ–™**ç‰¹æ€§
- èˆ‡åˆ†å€ç­–ç•¥ç„¡é—œ
- æŒçºŒåˆ°é”çš„è³‡æ–™å¯ä»¥æœ‰é©ç•¶çš„åˆ†å€ç­–ç•¥

### C. If most partitions in the table have more than 1 GB of data
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- **æ°å¥½ç›¸å** - é€™æ˜¯å¥åº·åˆ†å€çš„æŒ‡æ¨™
- åˆ†å€å¤§æ–¼ 1 GB è¡¨ç¤ºåˆ†å€ç­–ç•¥é©ç•¶
- é€™æ˜¯æˆ‘å€‘**æƒ³è¦**é”åˆ°çš„ç‹€æ…‹

### D. If the number of partitions in the table are too low
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- åˆ†å€æ•¸é‡å°‘è¡¨ç¤º**under-partitioningï¼ˆåˆ†å€ä¸è¶³ï¼‰**
- èˆ‡ over-partitioning ç›¸å
- å¯èƒ½å°è‡´è³‡æ–™å‚¾æ–œæˆ–æƒæéå¤šè³‡æ–™

---

## ğŸ§  è¨˜æ†¶æ³•
### å£è¨£
**ã€Œåˆ†å€å°æ–¼ 1Gï¼Œå°æª”æ¡ˆå¤§å•é¡Œã€**

### åˆ†å€å¤§å°æŒ‡å—
```
åˆ†å€å¤§å°åˆ¤æ–·ï¼š
â”œâ”€â”€ < 100 MB  â†’ åš´é‡éåº¦åˆ†å€ ğŸ”´
â”œâ”€â”€ < 1 GB    â†’ éåº¦åˆ†å€ ğŸŸ¡
â”œâ”€â”€ 1-10 GB   â†’ ç†æƒ³ç¯„åœ ğŸŸ¢
â””â”€â”€ > 10 GB   â†’ å¯èƒ½éœ€è¦æ›´å¤šåˆ†å€ ğŸŸ¡
```

### Over vs Under Partitioning
| å•é¡Œ | ç—‡ç‹€ | è§£æ±ºæ–¹æ¡ˆ |
|------|------|----------|
| **Over-partitioning** | åˆ†å€ < 1 GB | æ¸›å°‘åˆ†å€æ¬„ä½ |
| **Under-partitioning** | åˆ†å€ >> 10 GB | å¢åŠ åˆ†å€æ¬„ä½ |
| **No partitioning needed** | è¡¨æ ¼ < 1 TB | è€ƒæ…® Liquid Clustering |

### æœ€ä½³å¯¦è¸
```
åˆ†å€ç­–ç•¥æ±ºç­–ï¼š
â”œâ”€â”€ è¡¨æ ¼ < 1 TB
â”‚   â””â”€â”€ ä¸åˆ†å€ï¼Œä½¿ç”¨ Liquid Clustering
â”œâ”€â”€ è¡¨æ ¼ > 1 TB
â”‚   â””â”€â”€ ä½¿ç”¨ä½åŸºæ•¸æ¬„ä½åˆ†å€ï¼ˆå¹´/æœˆï¼‰
â””â”€â”€ æª¢æŸ¥æŒ‡æ¨™
    â”œâ”€â”€ æ¯å€‹åˆ†å€ > 1 GB âœ…
    â”œâ”€â”€ æ¯å€‹åˆ†å€ < 1 GB âŒ éåº¦åˆ†å€
    â””â”€â”€ ä½¿ç”¨ DESCRIBE DETAIL ç›£æ§
```

### ç›¸é—œå„ªåŒ–æŠ€è¡“
| æŠ€è¡“ | ç”¨é€” | é©ç”¨å ´æ™¯ |
|------|------|----------|
| **Partitioning** | è³‡æ–™åˆ†å€ | å¤§è¡¨æ ¼ï¼Œä½åŸºæ•¸ç¯©é¸ |
| **Z-ORDER** | è³‡æ–™æ’åº | é«˜åŸºæ•¸ç¯©é¸æ¬„ä½ |
| **Liquid Clustering** | å‹•æ…‹èšé¡ | æ›¿ä»£å‚³çµ±åˆ†å€ |
| **OPTIMIZE** | å£“ç¸®æª”æ¡ˆ | åˆ†å€å…§çš„å°æª”æ¡ˆ |

---

## ğŸ“š å®˜æ–¹æ–‡ä»¶
- [Delta Lake Table Partitioning](https://docs.databricks.com/tables/partitions.html)
- [When to Partition Tables](https://docs.databricks.com/tables/partitions.html#when-to-partition-tables)
- [Optimize Delta Lake Performance](https://docs.databricks.com/delta/optimizations/file-management.html)

---

**[è¿”å›é¡Œç›®](#question-056)**
