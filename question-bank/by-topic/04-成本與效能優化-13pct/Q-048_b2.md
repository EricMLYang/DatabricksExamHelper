# Question #048

---

## é¡Œç›®è³‡è¨Š
### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-048`
### ä¾†æº
**ä¾†æº:** Community
### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L2-Intermediate`

---

## é¡Œç›®å…§å®¹
### é¡Œå¹¹
<!-- âš ï¸ ä¿æŒè‹±æ–‡åŸæ–‡ï¼Œä¸è¦ç¿»è­¯ -->
Which of the following statements best describes dynamic file pruning in Apache Spark?

### é¸é …
<!-- âš ï¸ ä¿æŒè‹±æ–‡åŸæ–‡ï¼Œä¸è¦ç¿»è­¯ -->
- **A.** An optimization technique that dynamically repartitions files into smaller chunks at runtime to balance workload across executors.
- **B.** An optimization technique that skips reading irrelevant data files during query execution based on runtime filter information.
- **C.** An optimization technique that automatically compresses large files during Spark job execution to prune storage usage.
- **D.** An optimization technique that duplicates data files across worker nodes to improve data locality and query performance.

---

## æ¨™ç±¤ç³»çµ±
### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `Spark-Performance`, `Delta-Lake`
### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** (ç„¡)
### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** Data Engineering / Performance Optimization

---

## ç­”æ¡ˆèˆ‡ä¾†æº
### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `B`
### ç­”æ¡ˆä¾†æº
- **ä¾†æºæ¨™è¨»ç­”æ¡ˆ:** B
- **ç¤¾ç¾¤å…±è­˜:** B

---

# é¡Œç›®è§£æ

---

## ğŸ“ è€ƒé»è­˜åˆ¥
**æ ¸å¿ƒæŠ€è¡“:** Dynamic File Pruning (DFP)
**é—œéµæ¦‚å¿µ:** åŸ·è¡Œæ™‚æœŸæª”æ¡ˆè·³éã€Join å„ªåŒ–
**é¡Œç›®é—œéµå­—ï¼š**
- **dynamic file pruning**: å‹•æ…‹æª”æ¡ˆä¿®å‰ª
- **skips reading irrelevant data files**: è·³éè®€å–ä¸ç›¸é—œçš„æª”æ¡ˆ
- **runtime filter information**: åŸ·è¡Œæ™‚æœŸéæ¿¾è³‡è¨Š

---

## âœ… æ­£è§£èªªæ˜
### ç‚ºä»€éº¼ B æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Ÿ

**Dynamic File Pruning (DFP)** æ˜¯ä¸€ç¨®åœ¨**åŸ·è¡Œæ™‚æœŸ**æ ¹æ“š Join æ¢ä»¶**è·³éä¸ç›¸é—œæª”æ¡ˆ**çš„å„ªåŒ–æŠ€è¡“ã€‚

#### DFP é‹ä½œåŸç†
| éšæ®µ | èªªæ˜ |
|------|------|
| **è¨ˆåŠƒéšæ®µ** | è­˜åˆ¥å¯å¥—ç”¨ DFP çš„ Join æŸ¥è©¢ |
| **åŸ·è¡Œéšæ®µ** | å¾å°è¡¨å–å¾—éæ¿¾å€¼ |
| **å„ªåŒ–éšæ®µ** | ç”¨é€™äº›å€¼è·³éå¤§è¡¨ä¸­ä¸ç›¸é—œçš„æª”æ¡ˆ |

#### DFP é‹ä½œæµç¨‹
```
å‚³çµ± Joinï¼ˆç„¡ DFPï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¤§è¡¨ï¼šè®€å–æ‰€æœ‰æª”æ¡ˆï¼ˆ100 å€‹ï¼‰          â”‚
â”‚      â†“                              â”‚
â”‚ å°è¡¨ï¼šè®€å–æ‰€æœ‰æª”æ¡ˆ                    â”‚
â”‚      â†“                              â”‚
â”‚ Joinï¼šéæ¿¾å‡ºç¬¦åˆæ¢ä»¶çš„è³‡æ–™            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä½¿ç”¨ DFPï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å°è¡¨ï¼šå…ˆè®€å–ï¼Œå–å¾—éæ¿¾å€¼              â”‚
â”‚      â†“                              â”‚
â”‚ å¤§è¡¨ï¼šåªè®€å–ç›¸é—œæª”æ¡ˆï¼ˆ10 å€‹ï¼‰         â”‚  â† è·³é 90 å€‹æª”æ¡ˆï¼
â”‚      â†“                              â”‚
â”‚ Joinï¼šæ›´å¿«å®Œæˆ                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### DFP å…¸å‹å ´æ™¯
```sql
-- äº‹å¯¦è¡¨ Join ç¶­åº¦è¡¨
SELECT *
FROM sales_fact f           -- å¤§è¡¨ï¼ˆ10TBï¼‰
JOIN date_dim d             -- å°è¡¨ï¼ˆ1MBï¼‰
ON f.date_key = d.date_key
WHERE d.year = 2024         -- éæ¿¾æ¢ä»¶

-- DFP å„ªåŒ–éç¨‹ï¼š
-- 1. å…ˆè®€å– date_dimï¼Œå–å¾— year=2024 çš„ date_key å€¼
-- 2. ç”¨é€™äº› date_key å€¼ï¼Œè·³é sales_fact ä¸­ä¸åŒ…å«é€™äº›å€¼çš„æª”æ¡ˆ
-- 3. å¤§å¹…æ¸›å°‘ I/O
```

#### ç‚ºä»€éº¼å«ã€Œå‹•æ…‹ã€ï¼Ÿ
- **éœæ…‹ä¿®å‰ª**ï¼šåœ¨è¨ˆåŠƒéšæ®µå°±çŸ¥é“éæ¿¾æ¢ä»¶ï¼ˆå¦‚ WHERE year = 2024ï¼‰
- **å‹•æ…‹ä¿®å‰ª**ï¼šåœ¨åŸ·è¡Œæ™‚æ‰çŸ¥é“éæ¿¾å€¼ï¼ˆä¾†è‡ª Join çš„å¦ä¸€å´ï¼‰

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### A. ...dynamically repartitions files into smaller chunks...balance workload...
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- é€™æè¿°çš„æ˜¯ **Adaptive Query Execution (AQE)** çš„éƒ¨åˆ†åŠŸèƒ½
- AQE å¯ä»¥å‹•æ…‹èª¿æ•´ partition æ•¸é‡
- DFP æ˜¯é—œæ–¼ã€Œè·³éæª”æ¡ˆã€ï¼Œä¸æ˜¯ã€Œé‡æ–°åˆ†å€ã€

### C. ...automatically compresses large files...prune storage usage
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- é€™æè¿°çš„æ˜¯**å£“ç¸®**åŠŸèƒ½
- DFP ä¸æ¶‰åŠå£“ç¸®
- DFP æ˜¯æ¸›å°‘ã€Œè®€å–ã€ï¼Œä¸æ˜¯æ¸›å°‘ã€Œå„²å­˜ã€

### D. ...duplicates data files across worker nodes...improve data locality
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- é€™æè¿°çš„æ˜¯**è³‡æ–™è¤‡è£½/æœ¬åœ°åŒ–**ç­–ç•¥
- DFP ä¸æœƒè¤‡è£½è³‡æ–™
- DFP æ˜¯ã€Œè·³éã€æª”æ¡ˆï¼Œä¸æ˜¯ã€Œè¤‡è£½ã€æª”æ¡ˆ

---

## ğŸ§  è¨˜æ†¶æ³•
### å£è¨£
**ã€ŒDFP å‹•æ…‹è·³æª”æ¡ˆï¼ŒJoin å°è¡¨å…ˆè®€ä¾†ã€**

### Spark å„ªåŒ–æŠ€è¡“å°ç…§è¡¨
| æŠ€è¡“ | åŠŸèƒ½ | é—œéµå­— |
|------|------|--------|
| **Dynamic File Pruning** | è·³éä¸ç›¸é—œæª”æ¡ˆ | runtime filter |
| **Data Skipping** | æ ¹æ“šçµ±è¨ˆè³‡æ–™è·³éæª”æ¡ˆ | file statistics |
| **Predicate Pushdown** | å°‡éæ¿¾æ¢ä»¶ä¸‹æ¨ | WHERE clause |
| **Partition Pruning** | è·³éä¸ç›¸é—œåˆ†å€ | partition column |

### DFP é©ç”¨æ¢ä»¶
```
DFP æœ€ä½³ä½¿ç”¨å ´æ™¯ï¼š
â”œâ”€â”€ Star Schema æŸ¥è©¢ï¼ˆäº‹å¯¦è¡¨ + ç¶­åº¦è¡¨ï¼‰
â”œâ”€â”€ å¤§è¡¨ Join å°è¡¨
â”œâ”€â”€ å°è¡¨æœ‰éæ¿¾æ¢ä»¶
â””â”€â”€ å¤§è¡¨æ˜¯ Delta Lake / Parquet æ ¼å¼
```

### èˆ‡å…¶ä»–å„ªåŒ–çš„é—œä¿‚
```
æŸ¥è©¢å„ªåŒ–å±¤æ¬¡ï¼š
â”œâ”€â”€ Partition Pruning  â†’ è·³éæ•´å€‹åˆ†å€
â”œâ”€â”€ Data Skipping      â†’ æ ¹æ“šçµ±è¨ˆè·³éæª”æ¡ˆ
â”œâ”€â”€ Dynamic File Pruning â†’ Join æ™‚å‹•æ…‹è·³éæª”æ¡ˆ â† æœ¬é¡Œ
â””â”€â”€ Predicate Pushdown  â†’ æ¸›å°‘è®€å–çš„è³‡æ–™é‡
```

### è¨˜æ†¶æŠ€å·§
- **Dynamic** = å‹•æ…‹ = åŸ·è¡Œæ™‚æ‰æ±ºå®š
- **File** = æª”æ¡ˆ = ä»¥æª”æ¡ˆç‚ºå–®ä½
- **Pruning** = ä¿®å‰ª = è·³éä¸éœ€è¦çš„

---

## ğŸ“š å®˜æ–¹æ–‡ä»¶
- [Dynamic file pruning](https://docs.databricks.com/en/optimizations/dynamic-file-pruning.html)
- [Optimize performance with file management](https://docs.databricks.com/en/delta/optimize.html)

---

**[è¿”å›é¡Œç›®](#question-048)**
