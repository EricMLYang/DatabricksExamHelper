# Question #049

---

## é¡Œç›®è³‡è¨Š
### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-049`
### ä¾†æº
**ä¾†æº:** Community
### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L2-Intermediate`

---

## é¡Œç›®å…§å®¹
### é¡Œå¹¹
<!-- âš ï¸ ä¿æŒè‹±æ–‡åŸæ–‡ï¼Œä¸è¦ç¿»è­¯ -->
A data engineer is analyzing demographic segments from a Delta table named customers, which stores millions of customer records including personal details such as customer_id, name, birth_date, email, and country. The team wants to create a "senior customer" segment for a marketing campaign targeting customers born on or before January 1, 1970. The engineer writes the following query:

```sql
SELECT *
FROM customers
WHERE birth_date <= '1970-01-01';
```

However, the table has not been partitioned on the birth_date column and no Z-Order indexing has been applied.

Given this setup, what will most likely happen in terms of query performance?

### é¸é …
<!-- âš ï¸ ä¿æŒè‹±æ–‡åŸæ–‡ï¼Œä¸è¦ç¿»è­¯ -->
- **A.** The query will perform a full table scan, reading all data files from storage.
- **B.** The query will only read table metadata since it contains all column statistics.
- **C.** The query will skip most files since dynamic file pruning is enabled by default.
- **D.** The query will leverage data skipping since the filter column is among the first 32 columns.

---

## æ¨™ç±¤ç³»çµ±
### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `Delta-Lake`, `Delta-Optimization`, `Spark-Performance`
### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** `Performance-Misconception`
### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** Data Engineering / Performance Optimization

---

## ç­”æ¡ˆèˆ‡ä¾†æº
### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `A`
### ç­”æ¡ˆä¾†æº
- **ä¾†æºæ¨™è¨»ç­”æ¡ˆ:** A
- **ç¤¾ç¾¤å…±è­˜:** A

---

# é¡Œç›®è§£æ

---

## ğŸ“ è€ƒé»è­˜åˆ¥
**æ ¸å¿ƒæŠ€è¡“:** Delta Lake Data Skipping èˆ‡æŸ¥è©¢å„ªåŒ–
**é—œéµæ¦‚å¿µ:** åˆ†å€ã€Z-Orderã€çµ±è¨ˆè³‡è¨Šèˆ‡ Data Skipping çš„é—œä¿‚
**é¡Œç›®é—œéµå­—ï¼š**
- **not been partitioned**: æ²’æœ‰åˆ†å€
- **no Z-Order indexing**: æ²’æœ‰ Z-Order å„ªåŒ–
- **full table scan**: å®Œæ•´æƒææ‰€æœ‰æª”æ¡ˆ

---

## âœ… æ­£è§£èªªæ˜
### ç‚ºä»€éº¼ A æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Ÿ

åœ¨é€™å€‹æƒ…å¢ƒä¸­ï¼Œé›–ç„¶ Delta Lake æœƒæ”¶é›†çµ±è¨ˆè³‡è¨Šï¼Œä½†å› ç‚º**è³‡æ–™æ²’æœ‰è¢«ç‰©ç†æ’åº**ï¼ŒData Skipping çš„æ•ˆæœæœƒéå¸¸æœ‰é™ã€‚

#### é—œéµæ¦‚å¿µï¼šData Skipping çš„é‹ä½œæ¢ä»¶
```
Data Skipping æœ‰æ•ˆçš„æ¢ä»¶ï¼š
1. éæ¿¾æ¬„ä½åœ¨å‰ 32 æ¬„ï¼ˆæœ‰çµ±è¨ˆè³‡è¨Šï¼‰
2. è³‡æ–™åœ¨æª”æ¡ˆä¸­æœ‰è‰¯å¥½çš„æ’åˆ—ï¼ˆç›¸ä¼¼å€¼åœ¨åŒä¸€æª”æ¡ˆï¼‰

ç¼ºå°‘ #2 çš„æƒ…æ³ï¼š
- é›–ç„¶æœ‰ min/max çµ±è¨ˆï¼Œä½†æ¯å€‹æª”æ¡ˆéƒ½å¯èƒ½åŒ…å«å…¨ç¯„åœçš„å€¼
- å°è‡´ç„¡æ³•è·³éä»»ä½•æª”æ¡ˆ
```

#### ç‚ºä»€éº¼æœƒç™¼ç”Ÿ Full Table Scanï¼Ÿ
```
æ²’æœ‰åˆ†å€æˆ– Z-Order çš„è³‡æ–™åˆ†å¸ƒï¼š

File 1: birth_date = [1950, 1985, 1960, 2000, 1970, ...]  â†’ min=1950, max=2000
File 2: birth_date = [1990, 1955, 1972, 1965, 1980, ...]  â†’ min=1955, max=1990
File 3: birth_date = [1968, 2005, 1945, 1988, 1975, ...]  â†’ min=1945, max=2005
...

æŸ¥è©¢æ¢ä»¶ï¼šbirth_date <= '1970-01-01'

æª¢æŸ¥çµ±è¨ˆè³‡è¨Šï¼š
- File 1: min=1950 <= 1970? YES â†’ éœ€è¦è®€å–
- File 2: min=1955 <= 1970? YES â†’ éœ€è¦è®€å–
- File 3: min=1945 <= 1970? YES â†’ éœ€è¦è®€å–
- ...æ‰€æœ‰æª”æ¡ˆéƒ½å¯èƒ½åŒ…å«ç¬¦åˆæ¢ä»¶çš„è³‡æ–™
```

#### å°æ¯”ï¼šæœ‰ Z-Order çš„æƒ…æ³
```sql
-- å…ˆåŸ·è¡Œ Z-Order å„ªåŒ–
OPTIMIZE customers ZORDER BY (birth_date)

-- å„ªåŒ–å¾Œçš„è³‡æ–™åˆ†å¸ƒï¼š
File 1: birth_date = [1945, 1948, 1950, 1952, ...]  â†’ min=1945, max=1960
File 2: birth_date = [1961, 1963, 1965, 1968, ...]  â†’ min=1961, max=1970
File 3: birth_date = [1971, 1975, 1980, 1985, ...]  â†’ min=1971, max=1990
File 4: birth_date = [1991, 1995, 2000, 2005, ...]  â†’ min=1991, max=2010

æŸ¥è©¢ï¼šbirth_date <= '1970-01-01'
- File 1: max=1960 <= 1970? YES â†’ è®€å–
- File 2: max=1970 <= 1970? YES â†’ è®€å–
- File 3: min=1971 > 1970? YES â†’ è·³é âœ“
- File 4: min=1991 > 1970? YES â†’ è·³é âœ“
```

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### B. The query will only read table metadata...
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- å…ƒè³‡æ–™åªåŒ…å«çµ±è¨ˆè³‡è¨Šï¼Œä¸åŒ…å«å¯¦éš›è³‡æ–™
- æŸ¥è©¢éœ€è¦è¿”å›ç¬¦åˆæ¢ä»¶çš„**è³‡æ–™åˆ—**ï¼Œå¿…é ˆè®€å–è³‡æ–™æª”æ¡ˆ
- ç´”å…ƒè³‡æ–™æŸ¥è©¢åªé©ç”¨æ–¼ `DESCRIBE` ç­‰æŒ‡ä»¤

### C. ...dynamic file pruning is enabled by default.
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- **Dynamic File Pruning (DFP)** æ˜¯é‡å° **JOIN** æ“ä½œçš„å„ªåŒ–
- æœ¬é¡Œæ˜¯å–®è¡¨éæ¿¾æŸ¥è©¢ï¼Œä¸æ¶‰åŠ DFP
- DFP éœ€è¦ç¶­åº¦è¡¨çš„å»£æ’­ä¾†éæ¿¾äº‹å¯¦è¡¨

### D. ...data skipping since the filter column is among the first 32 columns.
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- é›–ç„¶ `birth_date` å¯èƒ½åœ¨å‰ 32 æ¬„ï¼Œçµ±è¨ˆè³‡è¨Šæœƒè¢«æ”¶é›†
- ä½†çµ±è¨ˆè³‡è¨Šï¼ˆmin/maxï¼‰**åªæœ‰åœ¨è³‡æ–™æ’åˆ—è‰¯å¥½æ™‚æ‰æœ‰æ•ˆ**
- æ²’æœ‰åˆ†å€æˆ– Z-Orderï¼Œè³‡æ–™æ•£å¸ƒåœ¨æ‰€æœ‰æª”æ¡ˆä¸­
- min/max ç¯„åœæœƒæ¶µè“‹æ•´å€‹æ—¥æœŸç¯„åœï¼Œç„¡æ³•è·³éæª”æ¡ˆ

---

## ğŸ§  è¨˜æ†¶æ³•
### å£è¨£
**ã€Œçµ±è¨ˆåªæ˜¯æ¢ä»¶ï¼Œæ’åˆ—æ‰æ˜¯é—œéµï¼›æ²’æœ‰åˆ†å€ Z-Orderï¼Œæƒæå…¨è¡¨å…ä¸äº†ã€**

### Data Skipping æ•ˆæœå…¬å¼
```
Data Skipping æ•ˆæœ = çµ±è¨ˆè³‡è¨Š Ã— è³‡æ–™æ’åˆ—å“è³ª

çµ±è¨ˆè³‡è¨Šï¼šå‰ 32 æ¬„è‡ªå‹•æ”¶é›† âœ“
è³‡æ–™æ’åˆ—å“è³ªï¼š
  - åˆ†å€ (Partitioning) â†’ å¼·åˆ¶æ’åˆ—
  - Z-Order â†’ æª”æ¡ˆå…§æ’åˆ—
  - ç„¡å„ªåŒ– â†’ éš¨æ©Ÿåˆ†å¸ƒ âœ—
```

### å„ªåŒ–ç­–ç•¥é¸æ“‡
| æƒ…å¢ƒ | æ¨è–¦ç­–ç•¥ |
|------|---------|
| ä½åŸºæ•¸æ¬„ä½ï¼ˆå¦‚ countryï¼‰| åˆ†å€ (Partitioning) |
| é«˜åŸºæ•¸æ¬„ä½ï¼ˆå¦‚ date, idï¼‰| Z-Order / Liquid Clustering |
| å¤šæ¬„ä½éæ¿¾ | Z-Order å¤šæ¬„ä½ |
| æœªçŸ¥æŸ¥è©¢æ¨¡å¼ | Liquid Clusteringï¼ˆè‡ªå‹•å„ªåŒ–ï¼‰|

### å¸¸è¦‹èª¤è§£æ¾„æ¸…
| èª¤è§£ | å¯¦éš›æƒ…æ³ |
|------|---------|
| æœ‰çµ±è¨ˆè³‡è¨Šå°±æœƒ Data Skip | éœ€è¦è³‡æ–™æ’åˆ—è‰¯å¥½ |
| Z-Order æ˜¯è‡ªå‹•çš„ | éœ€è¦æ‰‹å‹•åŸ·è¡Œ OPTIMIZE |
| åˆ†å€è§£æ±ºæ‰€æœ‰å•é¡Œ | é«˜åŸºæ•¸æ¬„ä½ä¸é©åˆåˆ†å€ |

---

## ğŸ“š å®˜æ–¹æ–‡ä»¶
- [Delta Lake data skipping](https://docs.databricks.com/en/delta/data-skipping.html)
- [Use Z-ORDER to optimize data](https://docs.databricks.com/en/delta/optimize.html#z-order)
- [Liquid clustering for Delta tables](https://docs.databricks.com/en/delta/liquid-clustering.html)

---

**[è¿”å›é¡Œç›®](#question-049)**
