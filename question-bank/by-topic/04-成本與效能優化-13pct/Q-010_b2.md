# Question #010

---

## 題目資訊

### 題目編號
**ID:** `Q-010`

### 來源
**來源:** Community

### 難度等級
**難度:** `L2-Intermediate`

---

## 題目內容

### 題幹

Which of the following statements best describes deletion vectors in Delta Lake?

### 選項

- **A.** Temporary files that store deleted rows until they are archived in a separate table partition called "_deletion_log".
- **B.** Metadata structures that track which rows in a data file have been logically deleted without physically rewriting the file.
- **C.** Indexes that accelerate queries on deleted rows by storing their physical locations directly in Unity Catalog volumes.
- **D.** Data structures that permanently remove deleted rows from all data files in a Delta Lake table.

---

## 標籤系統

### Topic Tags (技術主題標籤)
**Topics:** `Delta-Lake`, `Delta-Optimization`, `Spark-Performance`

### Trap Tags (陷阱類型標籤)
**Traps:** `Concept-Confusion`

### Knowledge Domain (知識領域)
**Domain:** Data Engineering / Development

---

## 答案與來源

### 正確答案
**正解:** `B`

### 答案來源
- **來源標註答案:** B
- **社群共識:** B

---

# 題目解析

---

## 📍 考點識別

**核心技術:** Delta Lake / Deletion Vectors
**關鍵概念:** Logical deletion, Metadata tracking, Write amplification reduction

**題目關鍵字：**
- **Deletion vectors**: Delta Lake 的刪除向量功能。
- **Logically deleted**: 邏輯刪除 vs 物理刪除。
- **Without rewriting**: 避免重寫整個檔案。

---

## ✅ 正解說明

### 為什麼 B 是正確答案？

**技術原理：**

1. **Deletion Vectors 的概念**:
   Deletion Vectors 是 Delta Lake 的效能優化功能，用於追蹤哪些行已被刪除，而不需要重寫整個 Parquet 檔案。

2. **運作方式**:
   - 當執行 DELETE、UPDATE、MERGE 時
   - Delta Lake 建立一個小型的 metadata 檔案（deletion vector）
   - 記錄被刪除行在原始檔案中的位置
   - 查詢時自動跳過這些被標記的行
   - 原始 Parquet 檔案保持不變

3. **效益**:
   - **減少寫入放大 (Write Amplification)**: 不需要重寫整個大檔案
   - **加速 DELETE/UPDATE/MERGE**: 操作速度大幅提升
   - **降低 I/O**: 只寫入小型 metadata 檔案

**傳統 vs Deletion Vectors：**

```
傳統方式（無 Deletion Vectors）：
┌─────────────────────┐      DELETE      ┌─────────────────────┐
│ 原始檔案 (1GB)       │  ─────────────>  │ 重寫整個檔案 (1GB)   │
│ 100 萬行            │                  │ 99.99 萬行          │
└─────────────────────┘                  └─────────────────────┘

使用 Deletion Vectors：
┌─────────────────────┐      DELETE      ┌─────────────────────┐
│ 原始檔案 (1GB)       │  ─────────────>  │ 原始檔案 (保持不變)  │
│ 保持不變            │                  │ + DV 檔案 (幾 KB)   │
└─────────────────────┘                  └─────────────────────┘
```

---

## ❌ 錯誤選項排除

### A - 暫存檔案 + _deletion_log 分區

**為什麼錯誤？**

- **沒有 _deletion_log 分區**: 這不是 Delta Lake 的設計。
- **DV 存在 _delta_log**: Deletion vectors 資訊記錄在 transaction log 中。
- **不是暫存檔案**: DV 是持久化的 metadata。

### C - 在 Unity Catalog volumes 存儲索引

**為什麼錯誤？**

- **與 Unity Catalog volumes 無關**: DV 存儲在表格目錄中，不是 UC volumes。
- **不是用於加速查詢已刪除行**: 是用於跳過已刪除行。
- **不是索引**: 是 metadata bitmap。

### D - 永久移除已刪除行

**為什麼錯誤？**

- **邏輯刪除，非物理刪除**: DV 只是標記，不會立即移除資料。
- **物理清理需要 VACUUM 或 OPTIMIZE**: 透過這些命令才會真正移除被刪除的資料。
- **DV 的設計目的**: 就是為了避免立即物理刪除。

---

## 🧠 記憶法

### 口訣

**「DV 標記行，不重寫檔案」**

- **D**eletion **V**ectors = 標記已刪除的行
- 保持原始檔案不變

### Deletion Vectors 特性

| 特性 | 說明 |
|------|------|
| 啟用方式 | `delta.enableDeletionVectors = true` |
| 適用操作 | DELETE, UPDATE, MERGE |
| 儲存位置 | 表格目錄中的 DV 檔案 |
| 清理時機 | VACUUM / OPTIMIZE 時合併 |

### Delta Lake 優化功能比較

| 功能 | 用途 | 優化重點 |
|------|------|----------|
| **Deletion Vectors** | 追蹤已刪除行 | 減少寫入放大 |
| **Liquid Clustering** | 動態資料組織 | 查詢效能 |
| **Z-ORDER** | 多欄位排序 | 跳過檔案 |
| **Photon** | 查詢引擎 | 執行速度 |

---

## 📚 官方文件

- [Deletion Vectors](https://docs.databricks.com/delta/deletion-vectors.html)
- [Delta Lake Optimizations](https://docs.databricks.com/delta/optimizations/index.html)
- [Delta Lake Internals](https://delta.io/blog/2023-07-05-deletion-vectors/)

---

**[返回題目](#question-010)**
