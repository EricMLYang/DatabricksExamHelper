# Question #058

---

## é¡Œç›®è³‡è¨Š
### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-058`
### ä¾†æº
**ä¾†æº:** Community
### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L2-Intermediate`

---

## é¡Œç›®å…§å®¹
### é¡Œå¹¹
<!-- âš ï¸ ä¿æŒè‹±æ–‡åŸæ–‡ï¼Œä¸è¦ç¿»è­¯ -->
The data engineering team has a pipeline that ingest Kafka source data into a Multiplex bronze table. This Delta table is partitioned based on the topic and month columns.

A new data engineer notices that the 'user_activity' topic contains Personal Identifiable Information (PII) that needs to to be deleted every two months based on the company's Service-Level Agreement (SLA).

Which statement describes how table partitioning can help to meet this requirement?

### é¸é …
<!-- âš ï¸ ä¿æŒè‹±æ–‡åŸæ–‡ï¼Œä¸è¦ç¿»è­¯ -->
- **A.** Table partitioning allows delete queries to leverage partition boundaries.
- **B.** Table partitioning reduces query latency when deleting large data files
- **C.** Table partitioning does not allow to time travel the PII data after deletion
- **D.** Table partitioning allows immediate files deletion without running VACUUM command

---

## æ¨™ç±¤ç³»çµ±
### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `Partitioning`, `Delta-Lake`, `Security`
### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** `Concept-Confusion`, `Side-Effect`
### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** Data Engineering / Data Governance

---

## ç­”æ¡ˆèˆ‡ä¾†æº
### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `A`
### ç­”æ¡ˆä¾†æº
- **ä¾†æºæ¨™è¨»ç­”æ¡ˆ:** A
- **ç¤¾ç¾¤å…±è­˜:** A

---

# é¡Œç›®è§£æ

---

## ğŸ“ è€ƒé»è­˜åˆ¥
**æ ¸å¿ƒæŠ€è¡“:** Delta Lake Partitioning / è³‡æ–™åˆªé™¤æ•ˆç‡
**é—œéµæ¦‚å¿µ:** åˆ†å€é‚Šç•Œã€é«˜æ•ˆåˆªé™¤ã€PII åˆè¦
**é¡Œç›®é—œéµå­—ï¼š**
- **partitioned based on topic and month**: æŒ‰ä¸»é¡Œå’Œæœˆä»½åˆ†å€
- **delete every two months**: å®šæœŸåˆªé™¤
- **partition boundaries**: åˆ†å€é‚Šç•Œ

---

## âœ… æ­£è§£èªªæ˜
### ç‚ºä»€éº¼ A æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Ÿ

**åˆ†å€è®“åˆªé™¤æ“ä½œå¯ä»¥æ²¿è‘—åˆ†å€é‚Šç•Œé€²è¡Œ**ï¼Œå¤§å¹…æå‡åˆªé™¤æ•ˆç‡ã€‚

#### åˆ†å€åˆªé™¤ vs éåˆ†å€åˆªé™¤
```
æœ‰åˆ†å€çš„åˆªé™¤ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ topic=user_activity                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ month=2024-01 â”‚ â† ç›´æ¥åˆªé™¤æ•´å€‹åˆ†å€ï¼ˆå¿«é€Ÿï¼‰   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                             â”‚
â”‚ month=2024-02 â”‚ â† ç›´æ¥åˆªé™¤æ•´å€‹åˆ†å€ï¼ˆå¿«é€Ÿï¼‰   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                             â”‚
â”‚ month=2024-03 â”‚ ä¿ç•™                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç„¡åˆ†å€çš„åˆªé™¤ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ‰€æœ‰è³‡æ–™æ··åœ¨ä¸€èµ·                              â”‚
â”‚ â”Œâ”€â”â”Œâ”€â”â”Œâ”€â”â”Œâ”€â”â”Œâ”€â”â”Œâ”€â”â”Œâ”€â”â”Œâ”€â”â”Œâ”€â”â”Œâ”€â”             â”‚
â”‚ â”‚âœ—â”‚â”‚âœ“â”‚â”‚âœ—â”‚â”‚âœ“â”‚â”‚âœ“â”‚â”‚âœ—â”‚â”‚âœ—â”‚â”‚âœ“â”‚â”‚âœ—â”‚â”‚âœ“â”‚ â† é€è¡Œæƒæ  â”‚
â”‚ â””â”€â”˜â””â”€â”˜â””â”€â”˜â””â”€â”˜â””â”€â”˜â””â”€â”˜â””â”€â”˜â””â”€â”˜â””â”€â”˜â””â”€â”˜             â”‚
â”‚ éœ€è¦é‡å¯«æ‰€æœ‰æª”æ¡ˆï¼ˆç·©æ…¢ï¼‰                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### åˆ†å€é‚Šç•Œåˆªé™¤çš„å„ªå‹¢
| å„ªå‹¢ | èªªæ˜ |
|------|------|
| **é«˜æ•ˆåˆªé™¤** | æ•´å€‹åˆ†å€çš„æª”æ¡ˆå¯ä»¥ä¸€æ¬¡æ¨™è¨˜åˆªé™¤ |
| **æ¸›å°‘é‡å¯«** | ä¸éœ€è¦é‡å¯«å…¶ä»–åˆ†å€çš„æª”æ¡ˆ |
| **ç²¾ç¢ºæ§åˆ¶** | æŒ‰æ™‚é–“ï¼ˆæœˆä»½ï¼‰ç²¾ç¢ºåˆªé™¤éæœŸè³‡æ–™ |
| **åˆè¦å‹å–„** | å®¹æ˜“æ»¿è¶³ GDPR/HIPAA ç­‰æ³•è¦è¦æ±‚ |

#### å¯¦éš›æ“ä½œç¯„ä¾‹
```sql
-- åˆ©ç”¨åˆ†å€é‚Šç•Œåˆªé™¤ï¼ˆé«˜æ•ˆï¼‰
DELETE FROM bronze_multiplex
WHERE topic = 'user_activity'
  AND month < '2024-03';

-- Spark æœƒè­˜åˆ¥é€™æ˜¯åˆ†å€æ¢ä»¶
-- åªæ¨™è¨˜éœ€è¦åˆªé™¤çš„åˆ†å€æª”æ¡ˆ
-- ä¸éœ€è¦æƒææˆ–é‡å¯«å…¶ä»–åˆ†å€
```

#### åˆ†å€åˆªé™¤çš„å…§éƒ¨é‹ä½œ
```
åˆªé™¤æµç¨‹ï¼š
1. è§£æ WHERE æ¢ä»¶
2. è­˜åˆ¥ç¬¦åˆæ¢ä»¶çš„åˆ†å€
   â””â”€â”€ topic='user_activity' AND month IN ('2024-01', '2024-02')
3. åœ¨ Delta Log ä¸­æ¨™è¨˜é€™äº›åˆ†å€çš„æª”æ¡ˆç‚ºã€Œå·²åˆªé™¤ã€
4. ä¸éœ€è¦è®€å–æˆ–é‡å¯«é€™äº›æª”æ¡ˆçš„å…§å®¹
5. å¾ŒçºŒ VACUUM æœƒå¯¦éš›ç§»é™¤æª”æ¡ˆ
```

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### B. Table partitioning reduces query latency when deleting large data files
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- åˆ†å€ä¸»è¦æ˜¯**ç°¡åŒ–åˆªé™¤é‚è¼¯**å’Œ**æ¸›å°‘æƒæç¯„åœ**
- ã€Œæ¸›å°‘æŸ¥è©¢å»¶é²ã€çš„èªªæ³•ä¸å¤ ç²¾ç¢º
- åˆ†å€çš„å„ªå‹¢æ˜¯**ç²¾ç¢ºå®šä½**ï¼Œè€Œéå–®ç´”ã€Œæ¸›å°‘å»¶é²ã€
- å°æ–¼å¤§æª”æ¡ˆçš„åˆªé™¤ï¼Œåˆ†å€çš„å¥½è™•æ˜¯é¿å…é‡å¯«ï¼Œä¸æ˜¯æ¸›å°‘å»¶é²

### C. Table partitioning does not allow to time travel the PII data after deletion
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- **å®Œå…¨éŒ¯èª¤** - Time Travel èˆ‡åˆ†å€ç„¡é—œ
- åˆªé™¤å¾Œï¼ŒTime Travel ä»ç„¶å¯ä»¥å­˜å–èˆŠç‰ˆæœ¬è³‡æ–™
- éœ€è¦åŸ·è¡Œ VACUUM æ‰èƒ½çœŸæ­£ç§»é™¤æ­·å²ç‰ˆæœ¬
- åˆ†å€ä¸æœƒé˜»æ­¢ Time Travel

```sql
-- åˆªé™¤å¾Œä»å¯ Time Travel
SELECT * FROM bronze_multiplex VERSION AS OF 10
WHERE topic = 'user_activity';
-- é€™ä»ç„¶å¯ä»¥å­˜å–å·²åˆªé™¤çš„è³‡æ–™ï¼
```

### D. Table partitioning allows immediate files deletion without running VACUUM command
**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**
- **å®Œå…¨éŒ¯èª¤** - åˆ†å€ä¸æœƒæ”¹è®Š Delta Lake çš„åˆªé™¤æ©Ÿåˆ¶
- Delta Lake çš„ DELETE æ˜¯**é‚è¼¯åˆªé™¤**ï¼ˆæ¨™è¨˜åˆªé™¤ï¼‰
- å¯¦éš›æª”æ¡ˆç§»é™¤**ä»éœ€è¦ VACUUM**
- åˆ†å€åªæ˜¯è®“åˆªé™¤æ“ä½œæ›´é«˜æ•ˆï¼Œä¸æœƒè·³é VACUUM

```sql
-- åˆªé™¤å¾Œæª”æ¡ˆä»å­˜åœ¨
DELETE FROM bronze_multiplex WHERE month = '2024-01';
-- æª”æ¡ˆåªæ˜¯è¢«æ¨™è¨˜ç‚ºåˆªé™¤ï¼Œä»åœ¨å„²å­˜ä¸­

-- éœ€è¦ VACUUM æ‰æœƒå¯¦éš›ç§»é™¤
VACUUM bronze_multiplex RETAIN 0 HOURS;
-- ç¾åœ¨æª”æ¡ˆæ‰è¢«å¯¦éš›åˆªé™¤
```

---

## ğŸ§  è¨˜æ†¶æ³•
### å£è¨£
**ã€Œåˆ†å€åˆªé™¤æ²¿é‚Šç•Œï¼Œé«˜æ•ˆç²¾æº–ä¸é‡å¯«ã€**

### åˆ†å€å°åˆªé™¤çš„å¹«åŠ©
```
åˆ†å€åˆªé™¤çš„å¥½è™•ï¼š
â”œâ”€â”€ ç²¾ç¢ºå®šä½ â†’ åªè™•ç†ç‰¹å®šåˆ†å€
â”œâ”€â”€ é¿å…é‡å¯« â†’ ä¸éœ€è¦é‡å¯«å…¶ä»–åˆ†å€
â”œâ”€â”€ é«˜æ•ˆæ¨™è¨˜ â†’ æ•´å€‹åˆ†å€ä¸€æ¬¡è™•ç†
â””â”€â”€ åˆè¦å‹å–„ â†’ æŒ‰æ™‚é–“é€±æœŸåˆªé™¤
```

### Delta Lake åˆªé™¤æµç¨‹
| æ­¥é©Ÿ | æ“ä½œ | æ™‚æ©Ÿ |
|------|------|------|
| 1. DELETE | é‚è¼¯åˆªé™¤ï¼ˆæ¨™è¨˜ï¼‰ | ç«‹å³ |
| 2. Time Travel | ä»å¯å­˜å–èˆŠç‰ˆæœ¬ | ä¿ç•™æœŸå…§ |
| 3. VACUUM | å¯¦éš›ç§»é™¤æª”æ¡ˆ | æ‰‹å‹•åŸ·è¡Œ |

### åˆ†å€è¨­è¨ˆå»ºè­°
```
PII è³‡æ–™åˆªé™¤å ´æ™¯ï¼š
â”œâ”€â”€ æŒ‰æ™‚é–“åˆ†å€ï¼ˆæœˆ/æ—¥ï¼‰
â”‚   â””â”€â”€ ä¾¿æ–¼æŒ‰æ™‚é–“ç¯„åœåˆªé™¤
â”œâ”€â”€ è¨­å®šé©ç•¶çš„ä¿ç•™æœŸ
â”‚   â””â”€â”€ VACUUM RETAIN X HOURS
â””â”€â”€ è‡ªå‹•åŒ–åˆªé™¤ + VACUUM
    â””â”€â”€ ä½¿ç”¨ Databricks Jobs æ’ç¨‹
```

### åˆ†å€ vs ç„¡åˆ†å€çš„åˆªé™¤æ•ˆèƒ½
| æƒ…å¢ƒ | åˆ†å€è¡¨ | éåˆ†å€è¡¨ |
|------|--------|----------|
| åˆªé™¤ 1 å€‹æœˆè³‡æ–™ | å¿«ï¼ˆåƒ…æ¨™è¨˜åˆ†å€ï¼‰ | æ…¢ï¼ˆæƒæå…¨è¡¨ï¼‰ |
| æª”æ¡ˆé‡å¯« | ç„¡ | å¯èƒ½éœ€è¦ |
| VACUUM æ•ˆç‡ | é«˜ï¼ˆæŒ‰åˆ†å€æ¸…ç†ï¼‰ | ä½ |

---

## ğŸ“š å®˜æ–¹æ–‡ä»¶
- [Delta Lake Table Partitioning](https://docs.databricks.com/tables/partitions.html)
- [Delete from a Delta Table](https://docs.databricks.com/delta/delete.html)
- [Remove Files with VACUUM](https://docs.databricks.com/delta/vacuum.html)

---

**[è¿”å›é¡Œç›®](#question-058)**
