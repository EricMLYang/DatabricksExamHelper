# Question #031

---

## é¡Œç›®è³‡è¨Š
### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-031`

### ä¾†æº
**ä¾†æº:** Sample / Batch 1

### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L2-Intermediate`

---

## é¡Œç›®å…§å®¹
### é¡Œå¹¹
A data engineer is analyzing a Spark job via the Spark UI. They have the following summary metrics for 27 completed tasks in a particular stage:

| Metric | Min | 25th percentile | Median | 75th percentile | Max |
|--------|-----|-----------------|--------|-----------------|-----|
| Duration | 0.1s | 0.3s | 0.5s | 0.8s | 8s |
| Input Size | 10 MB | 50 MB | 80 MB | 100 MB | 500 MB |

Which conclusion can the data engineer draw from the above statistics?

### é¸é …
- **A.** Number of tasks are operating over empty or near empty partitions

- **B.** All tasks are operating over partitions with even amounts of data

- **C.** All tasks are operating over partitions with larger skewed amounts of data.

- **D.** Number of tasks are operating over partitions with larger skewed amounts of data.

---

## æ¨™ç±¤ç³»çµ±
### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `Spark-UI`, `Performance-Tuning`, `Data-Skew`

### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** `Concept-Confusion`

### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** Data Engineering / Performance Optimization

---

## ç­”æ¡ˆèˆ‡ä¾†æº
### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `D`

### ç­”æ¡ˆä¾†æº
- **ä¾†æºæ¨™è¨»ç­”æ¡ˆ:** D
- **ç¤¾ç¾¤å…±è­˜:** D

---

# é¡Œç›®è§£æ

---

## ğŸ“ è€ƒé»è­˜åˆ¥

**æ ¸å¿ƒæŠ€è¡“:** Spark UI æ•ˆèƒ½åˆ†æèˆ‡è³‡æ–™å‚¾æ–œè¨ºæ–·

**é—œéµæ¦‚å¿µ:**
- Spark UI æŒ‡æ¨™è§£è®€
- è³‡æ–™å‚¾æ–œ (Data Skew) çš„è­˜åˆ¥
- Task åŸ·è¡Œæ™‚é–“èˆ‡è³‡æ–™é‡çš„é—œä¿‚

**é¡Œç›®é—œéµå­—ï¼š**
- **Spark UI**: æ•ˆèƒ½ç›£æ§ä»‹é¢
- **summary metrics**: çµ±è¨ˆæ‘˜è¦
- **Max vs 75th percentile**: é›¢ç¾¤å€¼åˆ†æ

---

## âœ… æ­£è§£èªªæ˜

### ç‚ºä»€éº¼ D æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Ÿ

**æŠ€è¡“åŸç†ï¼š**

å¾ Spark UI çš„çµ±è¨ˆæ•¸æ“šå¯ä»¥çœ‹å‡ºï¼Œ**Max å€¼é è¶…é 75th percentile**ï¼š
- Duration: Max (8s) æ˜¯ 75th percentile (0.8s) çš„ **10 å€**
- Input Size: Max (500 MB) æ˜¯ 75th percentile (100 MB) çš„ **5 å€**

é€™è¡¨ç¤ºæœ‰**å°‘æ•¸ taskï¼ˆstraggler tasksï¼‰è™•ç†äº†ä¸æˆæ¯”ä¾‹çš„å¤§é‡è³‡æ–™**ã€‚

#### è³‡æ–™å‚¾æ–œçš„è¨ºæ–·æŒ‡æ¨™

| æŒ‡æ¨™æ¯”è¼ƒ | æ­£å¸¸æƒ…æ³ | å‚¾æ–œæƒ…æ³ |
|---------|---------|---------|
| **Max vs Median** | ç›¸è¿‘ï¼ˆ< 2xï¼‰ | å·®è·å¤§ï¼ˆ> 5xï¼‰ |
| **Max vs 75th** | ç›¸è¿‘ï¼ˆ< 1.5xï¼‰ | å·®è·å¤§ï¼ˆ> 3xï¼‰ |
| **æ‰€æœ‰ç™¾åˆ†ä½** | ç·Šå¯†èšé›† | åˆ†æ•£ã€é•·å°¾åˆ†ä½ˆ |

#### æœ¬é¡Œæ•¸æ“šåˆ†æ

```
Duration åˆ†ä½ˆï¼š
Min -------- 25th -------- Median -------- 75th -------- Max
0.1s        0.3s          0.5s            0.8s          8s
                                            â†‘            â†‘
                                          æ­£å¸¸        ç•°å¸¸é«˜ï¼ˆ10xï¼‰

Input Size åˆ†ä½ˆï¼š
Min -------- 25th -------- Median -------- 75th -------- Max
10MB        50MB          80MB            100MB         500MB
                                            â†‘            â†‘
                                          æ­£å¸¸        ç•°å¸¸é«˜ï¼ˆ5xï¼‰
```

#### çµè«–

- å¤§å¤šæ•¸ taskï¼ˆåˆ° 75th percentileï¼‰è™•ç†æ™‚é–“å’Œè³‡æ–™é‡éƒ½å¾ˆæ­£å¸¸
- **å°‘æ•¸ task**ï¼ˆè¶…é 75th percentileï¼‰è™•ç†äº†**å¤§é‡å‚¾æ–œçš„è³‡æ–™**
- é€™æ˜¯å…¸å‹çš„ã€Œ**straggler task**ã€å•é¡Œ

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### é¸é … A
**Number of tasks are operating over empty or near empty partitions**

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

1. **Min å€¼ä¸æ˜¯é›¶æˆ–æ¥è¿‘é›¶**ï¼š
   - Min Duration = 0.1sï¼ˆæœ‰å¯¦éš›å·¥ä½œï¼‰
   - Min Input Size = 10 MBï¼ˆæœ‰å¯¦éš›è³‡æ–™ï¼‰

2. **ç©ºåˆ†å€çš„ç‰¹å¾µ**ï¼š
   - å¦‚æœæœ‰ç©ºåˆ†å€ï¼ŒMin æœƒæ¥è¿‘ 0
   - Duration å’Œ Input Size çš„ Min éƒ½æ‡‰è©²æ¥µä½

---

### é¸é … B
**All tasks are operating over partitions with even amounts of data**

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

1. **è³‡æ–™åˆ†ä½ˆæ˜é¡¯ä¸å‡å‹»**ï¼š
   - Max å’Œ 75th percentile å·®è·å¤ªå¤§
   - å‡å‹»åˆ†ä½ˆæ™‚ï¼Œæ‰€æœ‰ç™¾åˆ†ä½æ•¸æ‡‰è©²æ¥è¿‘

2. **å‡å‹»åˆ†ä½ˆçš„ç‰¹å¾µ**ï¼š
```
å‡å‹»åˆ†ä½ˆæ™‚ï¼š
Min â‰ˆ 25th â‰ˆ Median â‰ˆ 75th â‰ˆ Max
ä¾‹å¦‚ï¼š80MB, 85MB, 90MB, 95MB, 100MB
```

---

### é¸é … C
**All tasks are operating over partitions with larger skewed amounts of data**

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

1. **é—œéµå­—ã€ŒAllã€ä¸æ­£ç¢º**ï¼š
   - ä¸æ˜¯ã€Œæ‰€æœ‰ã€task éƒ½æœ‰å‚¾æ–œå•é¡Œ
   - åªæœ‰ã€Œéƒ¨åˆ†ã€taskï¼ˆé‚£äº›è¶…é 75th percentile çš„ï¼‰è™•ç†äº†å¤§é‡è³‡æ–™

2. **25th åˆ° 75th percentile çš„ task æ˜¯æ­£å¸¸çš„**ï¼š
   - å¤§éƒ¨åˆ† task çš„æŒ‡æ¨™éƒ½åœ¨åˆç†ç¯„åœå…§
   - åªæœ‰å°‘æ•¸ task æ˜¯ straggler

---

## ğŸ§  è¨˜æ†¶æ³•

### å£è¨£
**ã€ŒMax è¶…é 75th å¥½å¹¾å€ï¼Œå°‘æ•¸ Task è™•ç†è³‡æ–™å‚¾æ–œã€**
â†’ Max é è¶… 75th percentile è¡¨ç¤ºæœ‰å°‘æ•¸ task è™•ç†äº†ä¸æˆæ¯”ä¾‹çš„å¤§é‡è³‡æ–™

### Spark UI è³‡æ–™å‚¾æ–œè¨ºæ–·

| ç¾è±¡ | è¨ºæ–· | è§£æ±ºæ–¹æ¡ˆ |
|------|------|---------|
| Max >> 75th percentile | è³‡æ–™å‚¾æ–œ | Saltingã€Repartition |
| Min â‰ˆ 0 | ç©ºåˆ†å€ | Coalesceã€èª¿æ•´åˆ†å€æ•¸ |
| æ‰€æœ‰æŒ‡æ¨™ç›¸è¿‘ | å‡å‹»åˆ†ä½ˆ | ç†æƒ³ç‹€æ…‹ |
| Median >> Mean | é•·å°¾åˆ†ä½ˆ | æª¢æŸ¥è³‡æ–™å“è³ª |

### è³‡æ–™å‚¾æ–œè§£æ±ºæ–¹æ¡ˆ

```python
# 1. Salting - åŠ é¹½æ‰“æ•£å‚¾æ–œçš„ key
from pyspark.sql.functions import rand, col

df_salted = df.withColumn("salt", (rand() * 10).cast("int"))
df_salted = df_salted.withColumn(
    "salted_key",
    concat(col("skewed_column"), lit("_"), col("salt"))
)

# 2. Repartition - é‡æ–°åˆ†å€
df_repartitioned = df.repartition(100, "key_column")

# 3. Broadcast Join - å°å°è¡¨ä½¿ç”¨å»£æ’­
from pyspark.sql.functions import broadcast
result = large_df.join(broadcast(small_df), "key")
```

### Spark UI é‡è¦æŒ‡æ¨™ä½ç½®

```
Spark UI
â”œâ”€â”€ Stages
â”‚   â”œâ”€â”€ Stage Details
â”‚   â”‚   â”œâ”€â”€ Summary Metrics â† çœ‹é€™è£¡
â”‚   â”‚   â”‚   â”œâ”€â”€ Duration
â”‚   â”‚   â”‚   â”œâ”€â”€ GC Time
â”‚   â”‚   â”‚   â”œâ”€â”€ Input Size
â”‚   â”‚   â”‚   â”œâ”€â”€ Output Size
â”‚   â”‚   â”‚   â””â”€â”€ Shuffle Read/Write
â”‚   â”‚   â””â”€â”€ Tasks
â”‚   â”‚       â””â”€â”€ å€‹åˆ¥ Task è©³æƒ…
```

---

## ğŸ“š å®˜æ–¹æ–‡ä»¶

- [Spark UI Overview](https://spark.apache.org/docs/latest/web-ui.html)
- [Debugging Data Skew](https://docs.databricks.com/en/optimizations/skew.html)
- [Performance Tuning](https://docs.databricks.com/en/optimizations/index.html)

---

**[è¿”å›é¡Œç›®](#question-031)**
