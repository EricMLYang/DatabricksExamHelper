# Question #015

---

## é¡Œç›®è³‡è¨Š
### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-015`

### ä¾†æº
**ä¾†æº:** Sample / Batch 1

### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L1-Basic`

---

## é¡Œç›®å…§å®¹
### é¡Œå¹¹
A data engineer is tasked with creating a comprehensive dashboard to track and analyze the consumption of computing resources across various workloads in their organization. To accomplish this, the engineer writes the following SQL query against the usage system table:

```sql
SELECT
    identity_metadata.run_as,
    sku_name,
    usage_date,
    usage_quantity
FROM system.billing.usage
WHERE usage_unit = 'DBU'
```

Which of the following statements most accurately describes the purpose and level of detail provided by this query?

### é¸é …
- **A.** It monitors the detailed DBU consumption for each type of computing resource per workspace.

- **B.** It monitors the detailed DBU consumption for each pipeline run per compute type.

- **C.** It monitors the detailed DBU consumption for each type of computing resource per user.

- **D.** It monitors the detailed DBU consumption for each job run per compute type.

---

## æ¨™ç±¤ç³»çµ±
### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `Databricks-SQL`, `Audit-Logging`

### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** `Concept-Confusion`

### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** Data Engineering / Platform Administration

---

## ç­”æ¡ˆèˆ‡ä¾†æº
### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `C`

### ç­”æ¡ˆä¾†æº
- **ä¾†æºæ¨™è¨»ç­”æ¡ˆ:** C
- **ç¤¾ç¾¤å…±è­˜:** C

---

# é¡Œç›®è§£æ

---

## ğŸ“ è€ƒé»è­˜åˆ¥

**æ ¸å¿ƒæŠ€è¡“:** Databricks System Tables - è¨ˆè²»èˆ‡ä½¿ç”¨é‡ç›£æ§

**é—œéµæ¦‚å¿µ:**
- `system.billing.usage` ç³»çµ±è¡¨æ ¼çš„çµæ§‹èˆ‡ç”¨é€”
- `identity_metadata.run_as` æ¬„ä½çš„æ„ç¾©
- `sku_name` æ¬„ä½èˆ‡è¨ˆç®—è³‡æºé¡å‹çš„å°æ‡‰

**é¡Œç›®é—œéµå­—ï¼š**
- **system.billing.usage**: Databricks çš„ç³»çµ±è¨ˆè²»è¡¨ï¼Œè¿½è¹¤æ‰€æœ‰ DBU ä½¿ç”¨é‡
- **identity_metadata.run_as**: åŸ·è¡Œå·¥ä½œè² è¼‰çš„ä½¿ç”¨è€…æˆ–æœå‹™ä¸»é«”èº«ä»½
- **sku_name**: è¨ˆç®—è³‡æºçš„ SKU åç¨±ï¼ˆå¦‚ ALL_PURPOSE_COMPUTE, JOBS_COMPUTEï¼‰
- **usage_unit = 'DBU'**: ç¯©é¸ä»¥ Databricks Unit ç‚ºå–®ä½çš„ä½¿ç”¨é‡è¨˜éŒ„
- **usage_quantity**: å¯¦éš›çš„ DBU æ¶ˆè€—æ•¸é‡

---

## âœ… æ­£è§£èªªæ˜

### ç‚ºä»€éº¼ C æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Ÿ

**æŠ€è¡“åŸç†ï¼š**

é€™å€‹æŸ¥è©¢å¾ `system.billing.usage` ç³»çµ±è¡¨æ ¼ä¸­æ“·å–è³‡æ–™ï¼Œé€éé¸å–çš„æ¬„ä½çµ„åˆï¼Œæä¾›äº†**æŒ‰ä½¿ç”¨è€…**èˆ‡**æŒ‰è¨ˆç®—è³‡æºé¡å‹**çš„ DBU æ¶ˆè€—æ˜ç´°ã€‚

#### æ¬„ä½è§£æ

| æ¬„ä½ | èªªæ˜ | å°æ‡‰åˆ†æç¶­åº¦ |
|------|------|-------------|
| `identity_metadata.run_as` | åŸ·è¡Œå·¥ä½œè² è¼‰çš„èº«ä»½ï¼ˆä½¿ç”¨è€…æˆ–æœå‹™ä¸»é«”ï¼‰ | **Per User** |
| `sku_name` | è¨ˆç®—è³‡æºé¡å‹ï¼ˆå¦‚ ALL_PURPOSE_COMPUTE, JOBS_COMPUTE, SERVERLESS_SQLï¼‰ | **Per Compute Type** |
| `usage_date` | ä½¿ç”¨æ—¥æœŸ | æ™‚é–“ç¶­åº¦ |
| `usage_quantity` | DBU æ¶ˆè€—é‡ | æ•¸å€¼æŒ‡æ¨™ |

#### å¸¸è¦‹çš„ sku_name å€¼

```
ALL_PURPOSE_COMPUTE      - é€šç”¨è¨ˆç®—å¢é›†
JOBS_COMPUTE             - Jobs è¨ˆç®—å¢é›†
SERVERLESS_SQL           - Serverless SQL Warehouse
SERVERLESS_REAL_TIME     - Serverless Real-time Inference
DLT_CORE                 - Delta Live Tables (Core)
DLT_PRO                  - Delta Live Tables (Pro)
DLT_ADVANCED             - Delta Live Tables (Advanced)
```

#### æŸ¥è©¢çµæœç¯„ä¾‹

```
+------------------+---------------------+------------+----------------+
| run_as           | sku_name            | usage_date | usage_quantity |
+------------------+---------------------+------------+----------------+
| alice@company.com| ALL_PURPOSE_COMPUTE | 2024-01-15 | 125.5          |
| bob@company.com  | JOBS_COMPUTE        | 2024-01-15 | 89.2           |
| alice@company.com| SERVERLESS_SQL      | 2024-01-15 | 45.0           |
| service_principal| DLT_PRO             | 2024-01-15 | 200.0          |
+------------------+---------------------+------------+----------------+
```

å¾çµæœå¯ä»¥çœ‹å‡ºï¼Œé€™æ˜¯**æŒ‰ä½¿ç”¨è€…ï¼ˆper userï¼‰**èˆ‡**æŒ‰è¨ˆç®—è³‡æºé¡å‹ï¼ˆper compute typeï¼‰**çš„æ˜ç´°æŸ¥è©¢ã€‚

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### é¸é … A
**It monitors the detailed DBU consumption for each type of computing resource per workspace.**

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

1. **æŸ¥è©¢æœªåŒ…å« workspace è³‡è¨Š**ï¼š
   - è‹¥è¦æŒ‰ workspace åˆ†æï¼Œéœ€è¦é¸å– `workspace_id` æ¬„ä½
   - ç›®å‰æŸ¥è©¢é¸å–çš„æ˜¯ `identity_metadata.run_as`ï¼ˆä½¿ç”¨è€…ï¼‰ï¼Œä¸æ˜¯ workspace

2. **æ­£ç¢ºçš„ workspace åˆ†ææŸ¥è©¢**ï¼š
```sql
-- è‹¥è¦æŒ‰ workspace åˆ†æï¼Œæ‡‰è©²é€™æ¨£å¯«ï¼š
SELECT
    workspace_id,
    sku_name,
    usage_date,
    SUM(usage_quantity) as total_dbu
FROM system.billing.usage
WHERE usage_unit = 'DBU'
GROUP BY workspace_id, sku_name, usage_date
```

---

### é¸é … B
**It monitors the detailed DBU consumption for each pipeline run per compute type.**

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

1. **æŸ¥è©¢æœªåŒ…å« pipeline ç›¸é—œè³‡è¨Š**ï¼š
   - è‹¥è¦è¿½è¹¤ pipeline runï¼Œéœ€è¦ç¯©é¸ `usage_metadata` ä¸­çš„ pipeline ç›¸é—œæ¬„ä½
   - `identity_metadata.run_as` æ˜¯ä½¿ç”¨è€…èº«ä»½ï¼Œä¸æ˜¯ pipeline è­˜åˆ¥ç¢¼

2. **Pipeline åˆ†æéœ€è¦ä¸åŒæŸ¥è©¢**ï¼š
```sql
-- è‹¥è¦è¿½è¹¤ DLT Pipeline æ¶ˆè€—ï¼Œéœ€è¦ï¼š
SELECT
    usage_metadata.pipeline_id,
    sku_name,
    SUM(usage_quantity) as total_dbu
FROM system.billing.usage
WHERE sku_name LIKE 'DLT%'
GROUP BY usage_metadata.pipeline_id, sku_name
```

---

### é¸é … D
**It monitors the detailed DBU consumption for each job run per compute type.**

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

1. **æŸ¥è©¢æœªåŒ…å« job run ç›¸é—œè³‡è¨Š**ï¼š
   - è‹¥è¦è¿½è¹¤æ¯æ¬¡ job runï¼Œéœ€è¦ä½¿ç”¨ `usage_metadata.job_id` å’Œ `usage_metadata.job_run_id`
   - ç›®å‰æŸ¥è©¢åªæœ‰ä½¿ç”¨è€…èº«ä»½ï¼Œç„¡æ³•å€åˆ†å€‹åˆ¥çš„ job run

2. **Job Run åˆ†æéœ€è¦ä¸åŒæŸ¥è©¢**ï¼š
```sql
-- è‹¥è¦è¿½è¹¤æ¯æ¬¡ Job Run çš„æ¶ˆè€—ï¼š
SELECT
    usage_metadata.job_id,
    usage_metadata.job_run_id,
    sku_name,
    SUM(usage_quantity) as total_dbu
FROM system.billing.usage
WHERE usage_metadata.job_id IS NOT NULL
GROUP BY usage_metadata.job_id, usage_metadata.job_run_id, sku_name
```

---

## ğŸ§  è¨˜æ†¶æ³•

### å£è¨£
**ã€Œrun_as çœ‹äººé ­ï¼Œsku_name çœ‹è³‡æºã€**
â†’ `identity_metadata.run_as` è¿½è¹¤ä½¿ç”¨è€…ï¼Œ`sku_name` è¿½è¹¤è¨ˆç®—è³‡æºé¡å‹

### system.billing.usage é—œéµæ¬„ä½å°ç…§è¡¨

| åˆ†æç¶­åº¦ | ä½¿ç”¨æ¬„ä½ | ç¯„ä¾‹å€¼ |
|---------|---------|--------|
| **æŒ‰ä½¿ç”¨è€…** | `identity_metadata.run_as` | `alice@company.com` |
| **æŒ‰ Workspace** | `workspace_id` | `1234567890` |
| **æŒ‰ Job** | `usage_metadata.job_id` | `98765` |
| **æŒ‰ Job Run** | `usage_metadata.job_run_id` | `12345` |
| **æŒ‰ Pipeline** | `usage_metadata.pipeline_id` | `abc-123-def` |
| **æŒ‰è¨ˆç®—é¡å‹** | `sku_name` | `JOBS_COMPUTE` |
| **æŒ‰æ—¥æœŸ** | `usage_date` | `2024-01-15` |

### å¿«é€Ÿåˆ¤æ–·æŠ€å·§

çœ‹åˆ° `identity_metadata.run_as` â†’ ä¸€å®šæ˜¯ã€Œ**per user**ã€çš„åˆ†æ
çœ‹åˆ° `workspace_id` â†’ æ˜¯ã€Œ**per workspace**ã€çš„åˆ†æ
çœ‹åˆ° `usage_metadata.job_run_id` â†’ æ˜¯ã€Œ**per job run**ã€çš„åˆ†æ

---

## ğŸ“š å®˜æ–¹æ–‡ä»¶

- [System Tables - Billing Usage](https://docs.databricks.com/en/administration-guide/system-tables/billing.html)
- [Monitor Usage with System Tables](https://docs.databricks.com/en/administration-guide/system-tables/index.html)
- [identity_metadata Schema](https://docs.databricks.com/en/administration-guide/system-tables/billing.html#identity-metadata)

---

**[è¿”å›é¡Œç›®](#question-015)**
