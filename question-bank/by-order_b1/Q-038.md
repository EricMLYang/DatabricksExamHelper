# Question #038

---

## é¡Œç›®è³‡è¨Š
### é¡Œç›®ç·¨è™Ÿ
**ID:** `Q-038`

### ä¾†æº
**ä¾†æº:** Sample / Batch 1

### é›£åº¦ç­‰ç´š
**é›£åº¦:** `L3-Advanced`

---

## é¡Œç›®å…§å®¹
### é¡Œå¹¹
A data engineer is configuring the following CDC data processing using AUTO CDC APIs in Lakeflow Declarative Pipelines:

```sql
CREATE FLOW cdc_flow AS AUTO CDC INTO silver_transactions
FROM stream(bronze_transactions)
KEYS (transaction_id)
_________________________
COLUMNS *
```

The engineer wants to define the processing order of source records and handle late-arriving data using a composite key of multiple columns, ordering by transaction_timestamp first, and in case of ties, by version_number.

Which option correctly fills in the blank to meet this requirement?

### é¸é …
- **A.** SEQUENCE BY STRUCT (transaction_timestamp, version_number)

- **B.** SEQUENCE BY (transaction_timestamp, version_number)

- **C.** ORDER BY STRUCT (transaction_timestamp, version_number)

- **D.** ORDER BY transaction_timestamp, version_number

---

## æ¨™ç±¤ç³»çµ±
### Topic Tags (æŠ€è¡“ä¸»é¡Œæ¨™ç±¤)
**Topics:** `Lakeflow-DLT`, `CDC`, `SEQUENCE-BY`

### Trap Tags (é™·é˜±é¡å‹æ¨™ç±¤)
**Traps:** `Syntax-Confusion`

### Knowledge Domain (çŸ¥è­˜é ˜åŸŸ)
**Domain:** Data Engineering / CDC Processing

---

## ç­”æ¡ˆèˆ‡ä¾†æº
### æ­£ç¢ºç­”æ¡ˆ
**æ­£è§£:** `A`

### ç­”æ¡ˆä¾†æº
- **ä¾†æºæ¨™è¨»ç­”æ¡ˆ:** A
- **ç¤¾ç¾¤å…±è­˜:** A

---

# é¡Œç›®è§£æ

---

## ğŸ“ è€ƒé»è­˜åˆ¥

**æ ¸å¿ƒæŠ€è¡“:** Lakeflow Declarative Pipelines AUTO CDC èªæ³•

**é—œéµæ¦‚å¿µ:**
- SEQUENCE BY å­å¥çš„ç”¨é€”
- STRUCT ç”¨æ–¼è¤‡åˆæ’åºéµ
- è™•ç†é²åˆ°è³‡æ–™ï¼ˆlate-arriving dataï¼‰

**é¡Œç›®é—œéµå­—ï¼š**
- **processing order**: è™•ç†é †åº
- **late-arriving data**: é²åˆ°è³‡æ–™
- **composite key**: è¤‡åˆéµ
- **in case of ties**: å¹³æ‰‹æ™‚çš„è™•ç†

---

## âœ… æ­£è§£èªªæ˜

### ç‚ºä»€éº¼ A æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Ÿ

**æŠ€è¡“åŸç†ï¼š**

åœ¨ AUTO CDC ä¸­ï¼Œ`SEQUENCE BY` ç”¨æ–¼å®šç¾©è¨˜éŒ„çš„è™•ç†é †åºã€‚ç•¶éœ€è¦**å¤šæ¬„ä½è¤‡åˆæ’åº**æ™‚ï¼Œå¿…é ˆä½¿ç”¨ `STRUCT` ä¾†åŒ…è£å¤šå€‹æ¬„ä½ã€‚

#### SEQUENCE BY STRUCT çš„åŠŸèƒ½

| åŠŸèƒ½ | èªªæ˜ |
|------|------|
| **å®šç¾©é †åº** | æ±ºå®šè¨˜éŒ„çš„è™•ç†é †åº |
| **è™•ç†é²åˆ°è³‡æ–™** | ç¢ºä¿å³ä½¿è³‡æ–™å»¶é²åˆ°é”ä¹Ÿèƒ½æ­£ç¢ºæ’åº |
| **è¤‡åˆæ’åº** | STRUCT å…è¨±å¤šæ¬„ä½æ’åº |
| **å»é‡é‚è¼¯** | ç›¸åŒ KEY æ™‚ï¼Œä¿ç•™æœ€æ–°çš„è¨˜éŒ„ |

#### å®Œæ•´èªæ³•

```sql
CREATE FLOW cdc_flow AS AUTO CDC INTO silver_transactions
FROM stream(bronze_transactions)
KEYS (transaction_id)
SEQUENCE BY STRUCT (transaction_timestamp, version_number)
COLUMNS *
```

#### STRUCT æ’åºé‚è¼¯

```
STRUCT (transaction_timestamp, version_number) çš„æ’åºé‚è¼¯ï¼š

1. å…ˆæŒ‰ transaction_timestamp æ’åº
2. å¦‚æœ timestamp ç›¸åŒï¼Œå†æŒ‰ version_number æ’åº

ç¯„ä¾‹ï¼š
Record A: timestamp=10:00, version=1 â†’ æ’åºå€¼ (10:00, 1)
Record B: timestamp=10:00, version=2 â†’ æ’åºå€¼ (10:00, 2)
Record C: timestamp=10:01, version=1 â†’ æ’åºå€¼ (10:01, 1)

æ’åºçµæœï¼šA < B < C
æœ€çµ‚ä¿ç•™ï¼šCï¼ˆæœ€æ–°çš„è¨˜éŒ„ï¼‰
```

#### è™•ç†é²åˆ°è³‡æ–™

```
è³‡æ–™åˆ°é”é †åº          SEQUENCE BY æ’åºå¾Œ
    â”‚                      â”‚
    â–¼                      â–¼
Record C (10:01)      Record A (10:00, v1)
Record A (10:00)  â†’   Record B (10:00, v2)
Record B (10:00)      Record C (10:01, v1) â† ä¿ç•™é€™å€‹

å³ä½¿ Record A æ¯” Record C æ™šåˆ°é”ï¼Œ
SEQUENCE BY ç¢ºä¿æŒ‰æ™‚é–“æˆ³æ­£ç¢ºè™•ç†
```

---

## âŒ éŒ¯èª¤é¸é …æ’é™¤

### é¸é … B
**SEQUENCE BY (transaction_timestamp, version_number)**

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

1. **èªæ³•ä¸æ­£ç¢º**ï¼š
   - `SEQUENCE BY` å¾Œé¢ç›´æ¥ç”¨æ‹¬è™Ÿä¸æ˜¯æœ‰æ•ˆèªæ³•
   - è¤‡åˆæ’åº**å¿…é ˆ**ä½¿ç”¨ `STRUCT`

2. **æ­£ç¢º vs éŒ¯èª¤**ï¼š
```sql
-- âŒ éŒ¯èª¤ï¼šæ‹¬è™Ÿä¸èƒ½ç›´æ¥åŒ…è£å¤šæ¬„ä½
SEQUENCE BY (col1, col2)

-- âœ… æ­£ç¢ºï¼šä½¿ç”¨ STRUCT
SEQUENCE BY STRUCT (col1, col2)

-- âœ… ä¹Ÿæ­£ç¢ºï¼šå–®ä¸€æ¬„ä½ä¸éœ€è¦ STRUCT
SEQUENCE BY col1
```

---

### é¸é … C
**ORDER BY STRUCT (transaction_timestamp, version_number)**

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

1. **é—œéµå­—éŒ¯èª¤**ï¼š
   - CDC è™•ç†ä½¿ç”¨ `SEQUENCE BY`ï¼Œä¸æ˜¯ `ORDER BY`
   - `ORDER BY` ç”¨æ–¼ä¸€èˆ¬æŸ¥è©¢æ’åº

2. **èªç¾©ä¸åŒ**ï¼š
   - `SEQUENCE BY`ï¼šå®šç¾©**CDC è™•ç†é †åº**å’Œ**é²åˆ°è³‡æ–™è™•ç†**
   - `ORDER BY`ï¼šä¸€èˆ¬ SQL æŸ¥è©¢çš„**çµæœæ’åº**

---

### é¸é … D
**ORDER BY transaction_timestamp, version_number**

**ç‚ºä»€éº¼éŒ¯èª¤ï¼Ÿ**

1. **å…©å€‹éŒ¯èª¤**ï¼š
   - ä½¿ç”¨äº† `ORDER BY` è€Œé `SEQUENCE BY`
   - æ²’æœ‰ä½¿ç”¨ `STRUCT`

---

## ğŸ§  è¨˜æ†¶æ³•

### å£è¨£
**ã€ŒCDC æ’åºç”¨ SEQUENCEï¼Œå¤šæ¬„ä½æ’åºåŒ… STRUCTã€**
â†’ AUTO CDC çš„é †åºå®šç¾©ç”¨ SEQUENCE BYï¼›è¤‡åˆæ’åºç”¨ STRUCT åŒ…è£

### AUTO CDC å®Œæ•´èªæ³•

```sql
CREATE FLOW flow_name AS AUTO CDC INTO target_table
FROM stream(source_table)
KEYS (primary_key_columns)           -- ä¸»éµ
SEQUENCE BY STRUCT (col1, col2, ...)  -- æ’åºæ¬„ä½ï¼ˆè¤‡åˆï¼‰
-- æˆ– SEQUENCE BY single_column       -- æ’åºæ¬„ä½ï¼ˆå–®ä¸€ï¼‰
COLUMNS * | (column_list)             -- è¦è™•ç†çš„æ¬„ä½
[IGNORE NULL UPDATES]                 -- é¸ç”¨ï¼šå¿½ç•¥ null æ›´æ–°
[APPLY AS DELETE WHEN condition]      -- é¸ç”¨ï¼šåˆªé™¤æ¢ä»¶
[APPLY AS TRUNCATE WHEN condition]    -- é¸ç”¨ï¼šæˆªæ–·æ¢ä»¶
```

### SEQUENCE BY ä½¿ç”¨å ´æ™¯

| å ´æ™¯ | èªæ³• |
|------|------|
| **å–®ä¸€æ’åºæ¬„ä½** | `SEQUENCE BY timestamp` |
| **è¤‡åˆæ’åºæ¬„ä½** | `SEQUENCE BY STRUCT (timestamp, version)` |
| **è™•ç†é²åˆ°è³‡æ–™** | è‡ªå‹•æ ¹æ“š SEQUENCE BY é‡æ–°æ’åº |

### AUTO CDC vs æ‰‹å‹• CDC

| æ–¹å¼ | é©ç”¨å ´æ™¯ | è¤‡é›œåº¦ |
|------|---------|--------|
| **AUTO CDC** | æ¨™æº– CDC æ ¼å¼ | ç°¡å–® |
| **æ‰‹å‹• APPLY CHANGES** | è‡ªè¨‚ CDC é‚è¼¯ | éˆæ´»ä½†è¤‡é›œ |

```sql
-- AUTO CDCï¼ˆç°¡åŒ–èªæ³•ï¼‰
CREATE FLOW ... AS AUTO CDC INTO ...

-- æ‰‹å‹• APPLY CHANGESï¼ˆå®Œæ•´æ§åˆ¶ï¼‰
APPLY CHANGES INTO target_table
FROM source_stream
KEYS (id)
SEQUENCE BY timestamp
STORED AS SCD TYPE 1 | 2
```

---

## ğŸ“š å®˜æ–¹æ–‡ä»¶

- [AUTO CDC in DLT](https://docs.databricks.com/en/delta-live-tables/cdc.html)
- [APPLY CHANGES API](https://docs.databricks.com/en/delta-live-tables/cdc.html#apply-changes-apis)
- [Lakeflow Declarative Pipelines](https://docs.databricks.com/en/delta-live-tables/index.html)

---

**[è¿”å›é¡Œç›®](#question-038)**
