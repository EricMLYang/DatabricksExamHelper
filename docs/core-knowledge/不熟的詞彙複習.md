## coalesce 是什麼？

一句話：coalesce(n) 是 Spark 用來把 partition 數量「減少」的方法，而且通常不會 shuffle（不會把資料全網路重分配）。

✅ 只能 變少：例如 4000 → 2000 可以；2000 → 4000 不行

✅ 多數情況 不 shuffle：它會把多個原本的 partitions「併到」較少的 partitions 上（盡量走同一 executor 的資料）

🎯 常見用途：

寫檔前把太多小檔變少（例如原本 20,000 個 partitions，寫出會超多小檔）

對比：repartition(n) 可以變多也可以變少，但通常會 shuffle（成本大）。


## AQE 是什麼？

AQE = Adaptive Query Execution（自適應查詢執行）
**一句話：**Spark 會在「跑到一半」看到真實資料量之後，動態調整執行計畫，讓效能更好。

AQE 主要會做三類優化（很常考）：

Shuffle partitions 合併（coalesce shuffle partitions）
如果某些 shuffle partitions 太小，AQE 會把它們合併，減少 task 數量、降低 overhead。

這時會用到像 spark.sql.adaptive.advisoryPartitionSizeInBytes 這種參數（它是「建議」每個 shuffle partition 的大小目標）。

動態切換 Join 策略
例如原本以為表很大用 Sort-Merge Join，跑到一半發現其實很小，就改成 Broadcast Join。

處理資料傾斜（skew join）
某些 key 特別大導致某些 partitions 超大、某些 task 跑超久，AQE 會拆 skew partition 改善