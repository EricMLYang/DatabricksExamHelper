⸻

Databricks / PySpark 錯誤訊息解讀：考前快覽（可直接放 MD）

目標：考試快速判斷「這錯誤屬於哪一類」＋實務快速定位「你該看哪一句、查哪個東西」。

⸻

1) 先抓三件事：Exception 類型 / 最後一行 / given input

(1) Exception 類型（第一個大寫名詞）
常見像：AnalysisException, ParseException, SparkException, Py4JJavaError, StreamingQueryException

(2) 最後一行通常最有用（Spark 很愛把真正原因放最後）
例如這題最後一行就是：
	•	cannot resolve 'xxx' given input columns: [...]

(3) 看到 given input columns: 就直接對照 schema
它等於在跟你說：
「我找不到你給的欄位名；我現在手上真正有的欄位是這些。」

⸻

2) 先判斷：這錯誤是「分析期」還是「執行期」？

A. AnalysisException（分析期 / Logical Plan）

特徵關鍵字：
	•	cannot resolve ... given input columns
	•	ambiguous reference
	•	unresolved attribute
	•	Table or view not found
	•	UNSUPPORTED_FEATURE, INVALID_SCHEMA, requires...

代表什麼？
Spark 還沒跑起來就知道不對：欄位名、表名、語意、型別推導/欄位解析出問題。

考試超常見的誤用：
	•	把欄位當字串："col" + 1, 3 * "col", df.select("a" + "b")
	•	忘了 col() / expr() / selectExpr()
	•	欄位名拼錯、大小寫、或被 alias 改名後還用舊名字
	•	join 後欄位同名導致 ambiguous reference

✅ 看到 AnalysisException 的第一反射：
「我是不是寫錯欄位名 / 欄位引用方式 / join 後沒加前綴或 alias？」

⸻

B. 執行期錯誤（Runtime / Job 跑到一半才炸）

常見類型與特徵：

SparkException / Task failed / ExecutorLostFailure
	•	通常是資料問題、序列化、UDF、資源不足、shuffle 爆炸、OOM
	•	會看到 stage / task retry

ArithmeticException、NumberFormatException
	•	除以 0、字串轉數字失敗、cast 失敗（有時是 runtime）

✅ 看到這類錯誤的第一反射：
「是不是某些資料列有髒資料 / 特例值 / 轉型失敗？是不是要用 try_cast / 條件過濾？」

⸻

3) PySpark traceback 怎麼看：不要被 Py4J 嚇到

Py4JJavaError

意思： Python 只是「轉呼叫」Spark/Java，真正錯在 JVM 端。
讀法： 往下找 Caused by: 的第一個「有意義的 Spark/SQL exception」。

考試技巧：看到 Py4J，不要慌，真正答案幾乎都在 Caused by: ...Exception: ... 那行。

⸻

4) 「欄位相關」錯誤的速查表（考試最常出）

4.1 cannot resolve 'X' given input columns: [...]

最常見原因：
	•	欄位名拼錯 / 不存在
	•	你傳的是字串運算後的結果（像本題）
	•	你以為是欄位，其實是 Python 變數/字串
	•	欄位在前一步 rename / select 後已經不叫那個名字了

快速處理：
	•	看 given input columns 有沒有你以為的欄位
	•	df.columns / df.printSchema()
	•	確認你用的是 col("x") 或 expr("x")，而不是 "x"

⸻

4.2 ambiguous reference（join 後欄位同名）

原因： 兩邊都有 id，你寫 select("id") Spark 不知道要哪個。
解法：
	•	df1.alias("a").join(df2.alias("b"), ...).select("a.id")
	•	或 join 前先 rename

⸻

4.3 欄位名含特殊字元 / 點號

Databricks 會顯示像這題的 fully-qualified：
	•	spark_catalog.database.table.heartrate

解讀：
	•	這是「來源欄位的血統」，不是你一定要這樣寫。
	•	但如果你的欄位名真的含 . 或空白，要用反引號：
	•	col("`a.b`") 或 selectExpr("a.b")

⸻

5) 考試常考的「Column vs String」判斷法

你要做欄位運算： 一律想成「Column 物件」
	•	✅ col("heartrate") * 3
	•	✅ expr("heartrate * 3")
	•	✅ df.selectExpr("heartrate * 3 as hr3")

你傳進去的是純欄位名： 才能用字串
	•	✅ df.select("heartrate")
	•	❌ df.select(3 * "heartrate")（Python 先把字串處理掉了）

心法：
只要你在 Python 層做了 + - * /，就要懷疑自己是不是在對字串做運算，而不是對 Column 做運算。

⸻

6) 最小排查流程（實務也適用）
	1.	先看 Exception 類型
	•	AnalysisException → 先查欄位/表/語意
	•	Py4JJavaError → 往下找 Caused by
	2.	抓最後一個有意義的訊息
	3.	遇到 given input columns，直接對照 schema
	4.	懷疑 Column/字串混用時
	•	把所有欄位引用改成 col() / expr() 試一次（最常直接解）

⸻

如果你願意，我也可以把這份快覽再「壓縮成一頁」版本（更像考前小抄），或按照你們 repo 的風格加上 ## TL;DR 與「錯誤訊息 → 直覺判斷」的對照表。